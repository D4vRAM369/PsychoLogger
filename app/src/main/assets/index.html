<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bit√°cora Psicon√°utica</title>
    <style>
        :root {
            --primary-purple: #8B5CF6;
            --secondary-pink: #EC4899;
            --accent-cyan: #06B6D4;
            --accent-orange: #F97316;
            --dark-bg: #0F0F23;
            --darker-bg: #080813;
            --card-bg: #1A1A2E;
            --text-light: #E5E7EB;
            --text-muted: #9CA3AF;
            --border-color: rgba(139, 92, 246, 0.3);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body {
            background: var(--dark-bg);
            min-height: 100vh;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            color: var(--text-light);
            overflow-x: hidden;
        }
        body::before {
            content: '';
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: linear-gradient(135deg, var(--dark-bg) 0%, var(--darker-bg) 100%);
            z-index: -10;
        }
        .psychedelic-bg {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: -5; opacity: 0.3;
            background:
                radial-gradient(circle at 25% 75%, var(--primary-purple) 0%, transparent 35%),
                radial-gradient(circle at 75% 25%, var(--secondary-pink) 0%, transparent 35%),
                radial-gradient(circle at 50% 50%, var(--accent-cyan) 0%, transparent 35%),
                radial-gradient(circle at 80% 80%, var(--accent-orange) 0%, transparent 30%),
                radial-gradient(circle at 20% 20%, var(--secondary-pink) 0%, transparent 30%),
                radial-gradient(circle at 60% 10%, var(--primary-purple) 0%, transparent 25%);
            animation: psychedelicMove 25s ease-in-out infinite;
        }
        @keyframes psychedelicMove {
            0%,100%{transform:scale(1)rotate(0deg)translateX(0)translateY(0);opacity:.3;}
            20%{transform:scale(1.4)rotate(72deg)translateX(30px)translateY(-25px);opacity:.4;}
            40%{transform:scale(.7)rotate(144deg)translateX(-25px)translateY(30px);opacity:.2;}
            60%{transform:scale(1.2)rotate(216deg)translateX(-30px)translateY(-15px);opacity:.35;}
            80%{transform:scale(.9)rotate(288deg)translateX(20px)translateY(25px);opacity:.25;}
        }
        .container {
            max-width: 1200px; margin: 0 auto; padding: 1rem; min-height: 100vh;
            display: flex; flex-direction: column; background: transparent; position: relative; z-index: 5;
            padding-top: 1.5rem;
        }
        .header {
            text-align: center; margin-bottom: 2rem; padding: 2rem 0; position: relative;
        }
        .header-content {
            display: flex; align-items: center; justify-content: center; gap: 2rem; flex-wrap: wrap;
        }
        .mystical-symbol {
            font-size: 3rem; opacity: 0.7; animation: symbolGlow 4s ease-in-out infinite alternate; user-select: none;
        }
        .mystical-symbol.left { color: var(--accent-cyan); animation: symbolRotate 8s linear infinite; }
        .mystical-symbol.right { color: var(--secondary-pink); animation: symbolRotateReverse 8s linear infinite; }
        @keyframes symbolGlow {
            0% { opacity: 0.7; transform: scale(1) rotate(0deg); text-shadow: 0 0 10px currentColor;}
            100% { opacity: 1; transform: scale(1.1) rotate(360deg); text-shadow: 0 0 20px currentColor, 0 0 30px currentColor;}
        }
        @keyframes symbolRotate { 0%{transform:rotate(0)scale(1);}50%{transform:rotate(180deg)scale(1.1);}100%{transform:rotate(360deg)scale(1);} }
        @keyframes symbolRotateReverse { 0%{transform:rotate(0)scale(1);}50%{transform:rotate(-180deg)scale(1.1);}100%{transform:rotate(-360deg)scale(1);} }
        .header-title { display: flex; flex-direction: column; align-items: center; }
        .header h1 {
            font-size: 2.5rem; font-weight: 800;
            background: linear-gradient(135deg, var(--primary-purple), var(--secondary-pink), var(--accent-cyan));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text; margin-bottom: 0.5rem;
            animation: colorShift 3s ease-in-out infinite;
        }
        @keyframes colorShift { 0%,100%{filter:hue-rotate(0deg);}50%{filter:hue-rotate(90deg);} }
        .header p { color: var(--text-muted); font-size: 1.1rem; }
        .main-content {
            flex: 1; display: grid; grid-template-columns: 300px 1fr; gap: 2rem; margin-bottom: 5rem;
        }
        .sidebar { background: var(--card-bg); border-radius: 20px; padding: 1.5rem; border: 1px solid var(--border-color); height: fit-content; backdrop-filter: blur(10px);}
        .sidebar h3 { margin-bottom: 1rem; color: var(--primary-purple); font-size: 1.2rem;}
        .substance-list { list-style: none; }
        .substance-item {
            padding: 0.75rem; margin-bottom: 0.5rem;
            background: rgba(139, 92, 246, 0.1); border-radius: 12px; cursor: pointer;
            transition: all 0.3s ease; border: 1px solid transparent;
            display: flex; justify-content: space-between; align-items: center; position: relative;
        }
        .substance-item:hover { background: rgba(139,92,246,0.2); border-color: var(--primary-purple); transform: translateX(5px);}
        .substance-item.active {
            background: linear-gradient(135deg, var(--primary-purple), var(--secondary-pink));
            border-color: var(--accent-cyan); transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(139, 92, 246, 0.3);
        }
        .substance-count {
            background: var(--accent-cyan); color: var(--dark-bg); border-radius: 50%; width: 24px; height: 24px;
            display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: bold;
        }
        .substance-delete {
            background: var(--secondary-pink); border: none; color: white; width: 22px; height: 22px; border-radius: 50%;
            cursor: pointer; font-size: 1rem; opacity: 0; transition: opacity 0.3s;
            margin-left: 7px; display: flex; align-items: center; justify-content: center;
        }
        .substance-item:hover .substance-delete { opacity: 1; }
        .add-substance-btn { width: 100%; padding: 0.75rem; background: linear-gradient(135deg, var(--accent-orange), var(--secondary-pink)); border: none; border-radius: 12px; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s ease; margin-top: 1rem;}
        .add-substance-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(249, 115, 22, 0.3);}
        .calendar-container { background: var(--card-bg); border-radius: 20px; padding: 2rem; border: 1px solid var(--border-color); backdrop-filter: blur(10px);}
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;}
        .calendar-nav { display: flex; gap: 1rem; align-items: center;}
        .nav-btn { background: var(--primary-purple); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center;}
        .nav-btn:hover { background: var(--secondary-pink); transform: scale(1.1);}
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: var(--border-color); border-radius: 12px; overflow: hidden;}
        .calendar-day { aspect-ratio: 1; background: var(--darker-bg); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease; position: relative; font-weight: 500;}
        .calendar-day:hover { background: rgba(139, 92, 246, 0.2);}
        .calendar-day.has-entry { background: linear-gradient(135deg, var(--primary-purple), var(--secondary-pink)); color: white;}
        .calendar-day.has-entry::after { content: ''; position: absolute; top: 5px; right: 5px; width: 8px; height: 8px; background: var(--accent-cyan); border-radius: 50%;}
        .substance-indicators { position: absolute; bottom: 2px; left: 50%; transform: translateX(-50%); display: flex; gap: 2px;}
        .substance-dot { width: 6px; height: 6px; border-radius: 50%;}
        .color-picker-container { margin: 1rem 0;}
        .color-options { display: grid; grid-template-columns: repeat(6, 1fr); gap: 0.5rem; margin-top: 0.5rem;}
        .color-option { width: 40px; height: 40px; border-radius: 50%; border: 3px solid transparent; cursor: pointer; transition: all 0.3s ease; position: relative;}
        .color-option:hover { transform: scale(1.1); border-color: var(--text-light);}
        .color-option.selected { border-color: var(--accent-cyan); transform: scale(1.2);}
        .color-option.selected::after { content: '‚úì'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-weight: bold; text-shadow: 0 0 3px rgba(0,0,0,0.8);}
        .day-header { background: var(--primary-purple); color: white; font-weight: 600; font-size: 0.9rem;}
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--card-bg); border-top: 1px solid var(--border-color);
            padding: 0.5rem 0; /* Menos padding vertical para evitar 2 filas */
            z-index: 1000; backdrop-filter: blur(20px);
        }
        .nav-container {
            max-width: 1200px; margin: 0 auto;
            display: flex; flex-direction: row;
            justify-content: center; align-items: center; /* Horizontal, centrado */
            gap: 0.5rem;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center;
            cursor: pointer; transition: all 0.3s ease;
            padding: 0.5rem 1rem; border-radius: 12px; min-width: 80px;
        }
        .nav-item:hover { background: rgba(139, 92, 246, 0.1); transform: translateY(-2px);}
        .nav-item.active { background: linear-gradient(135deg, var(--primary-purple), var(--secondary-pink)); color: white;}
        .nav-icon { width: 24px; height: 24px; margin-bottom: 0.1rem;}
        .nav-label { font-size: 0.8rem; font-weight: 500;}
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8); z-index: 1000; backdrop-filter: blur(5px);
            justify-content: center; align-items: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: var(--card-bg); border-radius: 20px; padding: 2rem;
            max-width: 500px; width: 90vw; max-height: 90vh; overflow-y: auto;
            border: 1px solid var(--border-color); position: relative; animation: modalSlideIn 0.3s ease;
        }
        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-50px);}
            to { opacity: 1; transform: translateY(0);}
        }
        .close-btn { position: absolute; top: 1rem; right: 1rem; background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer; transition: color 0.3s ease;}
        .close-btn:hover { color: var(--text-light);}
        .form-group { margin-bottom: 1.5rem;}
        .form-group label { display: block; margin-bottom: 0.5rem; color: var(--primary-purple); font-weight: 600;}
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 0.75rem; background: var(--darker-bg); border: 1px solid var(--border-color); border-radius: 12px; color: var(--text-light); font-size: 1rem;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none; border-color: var(--primary-purple); box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }
        .btn-primary { background: linear-gradient(135deg, var(--primary-purple), var(--secondary-pink)); border: none; color: white; padding: 0.75rem 2rem; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;}
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(139, 92, 246, 0.3);}
        .btn-secondary { background: var(--accent-cyan); color: white; border: none; border-radius: 12px; padding: 0.7rem 2rem; font-weight: 600; margin-top: 0.7rem; cursor: pointer;}
        .resources-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-top: 2rem;}
        .resource-card { background: var(--card-bg); border-radius: 16px; padding: 1.5rem; border: 1px solid var(--border-color); transition: all 0.3s ease; text-decoration: none; color: inherit; cursor: pointer;}
        .resource-card:hover { transform: translateY(-5px); border-color: var(--primary-purple); box-shadow: 0 20px 40px rgba(139, 92, 246, 0.1);}
        .resource-card h4 { color: var(--accent-cyan); margin-bottom: 0.5rem;}
        .entry-item { background: var(--darker-bg); border-radius: 12px; padding: 1rem; margin-bottom: 1rem; border: 1px solid var(--border-color);}
        .entry-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;}
        .entry-substance { color: var(--primary-purple); font-weight: 600;}
        .entry-time { color: var(--text-muted); font-size: 0.9rem;}
        .entry-dose { color: var(--accent-cyan); font-weight: 500; margin-bottom: 0.5rem;}
        .entry-notes { color: var(--text-muted); font-size: 0.9rem;}
                @media (max-width: 950px) {
            .main-content { grid-template-columns: 1fr; gap: 1rem;}
            .nav-container { flex-wrap: nowrap; overflow-x: auto; }
            .nav-item { min-width: 75px; padding: 0.5rem 0.5rem;}
        }
        @media (max-width: 600px) {
            .container { padding: 0.3rem; }
            .calendar-container, .sidebar { padding: 1rem; border-radius: 12px; }
            .header h1 { font-size: 1.3rem; }
            .resources-grid { grid-template-columns: 1fr; }
            .bottom-nav { padding: 0.2rem 0; }
            .nav-item { min-width: 60px; padding: 0.5rem 0.2rem;}
            .modal-content { padding: 1rem; }
        }
    </style>
</head>
<body>
<div class="psychedelic-bg"></div>
<div class="container">
    <header class="header">
        <div class="header-content">
            <div class="mystical-symbol left">üëÅÔ∏è</div>
            <div class="header-title">
                <h1>Bit√°cora Psicon√°utica</h1>
                <p>Tu compa√±ero de viaje para un consumo consciente y responsable</p>
            </div>
            <div class="mystical-symbol right">üóùÔ∏è</div>
        </div>
    </header>
    <main id="main-content" class="main-content">
        <div id="calendar-view" class="view active">
            <div class="sidebar">
                <h3>Sustancias</h3>
                <ul id="substance-list" class="substance-list"></ul>
                <button class="add-substance-btn" onclick="openModal('substanceModal')">+ A√±adir Sustancia</button>
            </div>
            <div class="calendar-container">
                <div class="calendar-header">
                    <h2 id="current-month">Enero 2025</h2>
                    <div class="calendar-nav">
                        <button class="nav-btn" onclick="previousMonth()">‚Äπ</button>
                        <button class="nav-btn" onclick="nextMonth()">‚Ä∫</button>
                    </div>
                </div>
                <div class="calendar-grid" id="calendar-grid"></div>
            </div>
        </div>
        <div id="stats-view" class="view" style="display:none;">
            <div class="calendar-container">
                <h2>Estad√≠sticas y An√°lisis</h2>
                <div class="resources-grid" id="stats-content"></div>
            </div>
        </div>
        <div id="resources-view" class="view" style="display:none;">
            <div class="calendar-container">
                <h2>Recursos y Harm Reduction</h2>
                <div class="resources-grid">
                    <div class="resource-card" onclick="openExternalURL('https://erowid.org')">
                        <h4>Erowid</h4>
                        <p>Base de datos completa sobre sustancias psicoactivas, experiencias y efectos</p>
                    </div>
                    <div class="resource-card" onclick="openExternalURL('https://tripsit.me')">
                        <h4>TripSit</h4>
                        <p>Informaci√≥n sobre interacciones, dosificaci√≥n y asistencia en tiempo real</p>
                    </div>
                    <div class="resource-card" onclick="openExternalURL('https://maps.org')">
                        <h4>MAPS</h4>
                        <p>Organizaci√≥n sin √°nimo de lucro que investiga los potenciales usos m√©dicos, legales y culturales de los psicod√©licos</p>
                    </div>
                    <div class="resource-card" onclick="openExternalURL('https://psychonautwiki.org')">
                        <h4>PsychonautWiki</h4>
                        <p>Enciclopedia cient√≠fica de sustancias psicoactivas y sus efectos</p>
                    </div>
                </div>
            </div>
        </div>
        <div id="data-view" class="view" style="display:none;">
            <div class="calendar-container">
                <h2>Gesti√≥n de Datos</h2>
                <div class="resources-grid">
                    <div class="resource-card">
                        <h4>Exportar Datos (CSV)</h4>
                        <p>Descargar todos tus datos en formato CSV</p>
                        <button class="btn-primary" onclick="exportToCSV()">Exportar CSV</button>
                    </div>
                    <div class="resource-card">
                        <h4>Importar Datos (CSV)</h4>
                        <p>Cargar datos desde un archivo CSV</p>
                        <input type="file" id="csvFileInput" class="file-input" accept=".csv" onchange="importFromCSV(this)">
                        <label for="csvFileInput" class="file-label">Seleccionar CSV</label>
                    </div>
                    <div class="resource-card">
                        <h4>Limpiar Datos</h4>
                        <p>Eliminar todos los datos almacenados</p>
                        <button class="btn-secondary" onclick="clearAllData()">Limpiar Todo</button>
                    </div>
                    <div class="resource-card">
                        <h4>√öltimo autobackup</h4>
                        <p id="last-backup-info"></p>
                    </div>
                </div>
            </div>
        </div>
        <div id="profile-view" class="view" style="display:none;">
            <div class="calendar-container">
                <h2>Mi Perfil Psicon√°utico</h2>
                <div class="form-group">
                    <label>Nickname</label>
                    <input type="text" id="userNickname" placeholder="Tu nombre de psicon√°uta...">
                </div>
                <div class="form-group">
                    <label>Telegram</label>
                    <input type="text" id="userTelegram" placeholder="@tuusuario">
                </div>
                <div class="form-group">
                    <label>Instagram</label>
                    <input type="text" id="userInstagram" placeholder="@tuusuario">
                </div>
                <div class="form-group">
                    <label>Reddit</label>
                    <input type="text" id="userReddit" placeholder="u/tuusuario">
                </div>
                <div class="form-group">
                    <label>Discord</label>
                    <input type="text" id="userDiscord" placeholder="nombre#1234">
                </div>
                <button class="btn-primary" onclick="saveProfile()">Guardar Perfil</button>
                <button class="btn-secondary" onclick="shareProfile()">Compartir Perfil</button>
                <div id="profile-share" style="margin-top:1.5rem;"></div>
            </div>
        </div>
    </main>
</div>
<nav class="bottom-nav">
    <div class="nav-container">
        <div class="nav-item active" onclick="switchView('calendar'); event.stopPropagation();">
            <div class="nav-icon">üìÖ</div>
            <div class="nav-label">Calendario</div>
        </div>
        <div class="nav-item" onclick="openModal('entryModal'); event.stopPropagation();">
            <div class="nav-icon">‚ûï</div>
            <div class="nav-label">A√±adir</div>
        </div>
        <div class="nav-item" onclick="switchView('data'); event.stopPropagation();">
            <div class="nav-icon">üíæ</div>
            <div class="nav-label">Datos</div>
        </div>
        <div class="nav-item" onclick="switchView('stats'); event.stopPropagation();">
            <div class="nav-icon">üìä</div>
            <div class="nav-label">Stats</div>
        </div>
        <div class="nav-item" onclick="switchView('resources'); event.stopPropagation();">
            <div class="nav-icon">üîó</div>
            <div class="nav-label">Recursos</div>
        </div>
        <div class="nav-item" onclick="switchView('profile'); event.stopPropagation();">
            <div class="nav-icon">üë§</div>
            <div class="nav-label">Perfil</div>
        </div>
    </div>
</nav>
<!-- Modals -->
<div id="entryModal" class="modal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeModal('entryModal')">√ó</button>
        <h3>Nuevo Registro</h3>
        <form id="entryForm">
            <div class="form-group">
                <label>Sustancia</label>
                <select id="entrySubstance"></select>
            </div>
            <div class="form-group">
                <label>Dosis</label>
                <input type="number" id="entryDose" placeholder="100" step="0.1">
            </div>
            <div class="form-group">
                <label>Unidad</label>
                <select id="entryUnit">
                    <option>Œºg (microgramos)</option>
                    <option>mg (miligramos)</option>
                    <option>g (gramos)</option>
                    <option>Pastilla</option>
                    <option>Tripi</option>
                    <option>Medio tripi</option>
                    <option>Cuarto de tripi</option>
                    <option>Raya</option>
                    <option>Tirito</option>
                </select>
            </div>
            <div class="form-group">
                <label>Fecha y Hora</label>
                <input type="datetime-local" id="entryDateTime">
            </div>
            <div class="form-group">
                <label>Notas</label>
                <textarea id="entryNotes" placeholder="Set, setting, experiencia..."></textarea>
            </div>
            <button type="submit" class="btn-primary">Guardar Registro</button>
        </form>
    </div>
</div>
<div id="substanceModal" class="modal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeModal('substanceModal')">√ó</button>
        <h3>Nueva Sustancia</h3>
        <form id="substanceForm">
            <div class="form-group">
                <label>Nombre de la Sustancia</label>
                <input type="text" id="substanceName" placeholder="ej: 2C-B, DMT, Ketamina...">
            </div>
            <div class="form-group">
                <label>Color de identificaci√≥n</label>
                <div class="color-picker-container">
                    <div class="color-options" id="colorOptions"></div>
                </div>
            </div>
            <div class="form-group">
                <label>Categor√≠a</label>
                <select id="substanceCategory">
                    <option>Psicod√©lico</option>
                    <option>Estimulante</option>
                    <option>Depresivo</option>
                    <option>Disociativo</option>
                    <option>Ente√≥geno</option>
                </select>
            </div>
            <div class="form-group">
                <label>Unidad de medida principal</label>
                <select id="substanceUnit">
                    <option>Œºg (microgramos)</option>
                    <option>mg (miligramos)</option>
                    <option>g (gramos)</option>
                    <option>Pastilla</option>
                    <option>Tripi</option>
                </select>
            </div>
            <button type="submit" class="btn-primary">A√±adir Sustancia</button>
        </form>
    </div>
</div>
<div id="dayModal" class="modal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeModal('dayModal')">√ó</button>
        <h3 id="dayModalTitle">D√≠a seleccionado</h3>
        <div id="dayEntries"></div>
    </div>
</div>
<script>
    let currentMonth = new Date();
    let currentView = 'calendar';
    let selectedColor = '#8B5CF6';
    let selectedSubstance = null;
    const availableColors = [
        '#8B5CF6', '#06B6D4', '#F97316', '#EF4444', '#10B981', '#F59E0B', '#EC4899', '#6366F1', '#84CC16', '#F43F5E', '#A855F7', '#14B8A6'
    ];
    const defaultSubstances = {
        lsd: { name: 'LSD', color: '#8B5CF6', entries: {} },
        ketamina: { name: 'Ketamina', color: '#06B6D4', entries: {} },
        mdma: { name: 'MDMA', color: '#F97316', entries: {} }
    };
    function loadData() {
        try {
            const stored = localStorage.getItem('psycho-logger-data');
            return stored ? JSON.parse(stored) : JSON.parse(JSON.stringify(defaultSubstances));
        } catch (e) { return JSON.parse(JSON.stringify(defaultSubstances)); }
    }
    function saveData(data) {
        localStorage.setItem('psycho-logger-data', JSON.stringify(data));
    }
    let substanceData = loadData();
    function updateSubstanceList() {
        const list = document.getElementById('substance-list');
        const select = document.getElementById('entrySubstance');
        if (!list || !select) return;
        list.innerHTML = ''; select.innerHTML = '';
        Object.keys(substanceData).forEach(key => {
            const substance = substanceData[key];
            const count = Object.values(substance.entries || {}).reduce((a,b)=>a+b.length,0);
            const listItem = document.createElement('li');
            listItem.className = 'substance-item';
            listItem.dataset.substance = key;
            listItem.innerHTML = `
                <div style="display:flex;align-items:center;gap:0.5rem;">
                    <div style="width:12px;height:12px;border-radius:50%;background:${substance.color};"></div>
                    ${substance.name}
                </div>
                <span class="substance-count">${count}</span>
                <button class="substance-delete" title="Eliminar" onclick="deleteSubstance('${key}',event)">üóëÔ∏è</button>
            `;
            listItem.onclick = e => { if (!e.target.classList.contains('substance-delete')) selectSubstance(key); };
            list.appendChild(listItem);
            const option = document.createElement('option');
            option.value = key; option.textContent = substance.name;
            select.appendChild(option);
        });
    }
    window.deleteSubstance = function(key, ev){
        ev.stopPropagation();
        if(confirm("¬øEliminar la sustancia y todos sus registros?")) {
            delete substanceData[key];
            saveData(substanceData);
            updateSubstanceList();
            generateCalendar();
            updateStats();
        }
    };
    function generateColorPicker() {
        const colorOptions = document.getElementById('colorOptions');
        if (!colorOptions) return;
        colorOptions.innerHTML = '';
        availableColors.forEach(color => {
            const colorOption = document.createElement('div');
            colorOption.className = 'color-option';
            colorOption.style.backgroundColor = color;
            colorOption.dataset.color = color;
            if (color === selectedColor) colorOption.classList.add('selected');
            colorOption.onclick = () => {
                document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
                colorOption.classList.add('selected');
                selectedColor = color;
            };
            colorOptions.appendChild(colorOption);
        });
    }
    function selectSubstance(substanceKey) {
        selectedSubstance = selectedSubstance === substanceKey ? null : substanceKey;
        document.querySelectorAll('.substance-item').forEach(item => item.classList.remove('active'));
        if (selectedSubstance) {
            const activeItem = document.querySelector(`[data-substance="${selectedSubstance}"]`);
            if (activeItem) activeItem.classList.add('active');
        }
        generateCalendar();
    }
    function generateCalendar() {
        const grid = document.getElementById('calendar-grid');
        const monthYear = document.getElementById('current-month');
        if (!grid || !monthYear) return;
        grid.innerHTML = '';
        const monthNames = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
        let title = `${monthNames[currentMonth.getMonth()]} ${currentMonth.getFullYear()}`;
        if (selectedSubstance) title += ` - ${substanceData[selectedSubstance].name}`;
        monthYear.textContent = title;
        const dayHeaders = ['L','M','X','J','V','S','D'];
        dayHeaders.forEach(day => {
            const dayHeader = document.createElement('div');
            dayHeader.className = 'calendar-day day-header';
            dayHeader.textContent = day;
            grid.appendChild(dayHeader);
        });
        const firstDay = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
        const startDate = new Date(firstDay);
        startDate.setDate(startDate.getDate() - (firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1));
        for(let i=0;i<42;i++){
            const date = new Date(startDate); date.setDate(startDate.getDate()+i);
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day';
            dayElement.textContent = date.getDate();
            const dateString = date.toISOString().split('T')[0];
            let dayEntries = [];
            if (selectedSubstance) {
                const substance = substanceData[selectedSubstance];
                if (substance.entries && substance.entries[dateString])
                    substance.entries[dateString].forEach(entry => dayEntries.push({
                        ...entry, substance:selectedSubstance, substanceName:substance.name, color:substance.color
                    }));
            } else {
                Object.keys(substanceData).forEach(substanceKey => {
                    const substance = substanceData[substanceKey];
                    if (substance.entries && substance.entries[dateString])
                        substance.entries[dateString].forEach(entry => dayEntries.push({
                            ...entry, substance:substanceKey, substanceName:substance.name, color:substance.color
                        }));
                });
            }
            if (dayEntries.length > 0) {
                dayElement.classList.add('has-entry');
                if (selectedSubstance) {
                    dayElement.style.background = `linear-gradient(135deg, ${substanceData[selectedSubstance].color}, ${adjustColorBrightness(substanceData[selectedSubstance].color, -20)})`;
                } else {
                    dayElement.style.background = 'linear-gradient(135deg, var(--primary-purple), var(--secondary-pink))';
                }
                if (!selectedSubstance) {
                    const indicators = document.createElement('div');
                    indicators.className = 'substance-indicators';
                    const uniqueSubstances = [...new Set(dayEntries.map(e=>e.substance))];
                    uniqueSubstances.forEach(substanceKey => {
                        const dot = document.createElement('div');
                        dot.className = 'substance-dot';
                        dot.style.backgroundColor = substanceData[substanceKey].color;
                        indicators.appendChild(dot);
                    });
                    dayElement.appendChild(indicators);
                }
            }
            if(date.getMonth() !== currentMonth.getMonth()) dayElement.style.opacity = '0.3';
            dayElement.onclick = () => openDayModal(date, dayEntries);
            grid.appendChild(dayElement);
        }
    }
    function adjustColorBrightness(hex, percent) {
        const num = parseInt(hex.replace('#',''),16);
        let r = (num >> 16) + percent;
        let g = ((num >> 8) & 0x00FF) + percent;
        let b = (num & 0x0000FF) + percent;
        r = Math.max(Math.min(255,r),0); g = Math.max(Math.min(255,g),0); b = Math.max(Math.min(255,b),0);
        return "#" + (g | (r << 8) | (b << 16)).toString(16).padStart(6,0);
    }
    function previousMonth() { currentMonth.setMonth(currentMonth.getMonth() - 1); generateCalendar();}
    function nextMonth() { currentMonth.setMonth(currentMonth.getMonth() + 1); generateCalendar();}
    function switchView(view) {
        document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
        const navItems = document.querySelectorAll('.nav-item');
        navItems.forEach(item => {
            const label = item.querySelector('.nav-label').textContent.toLowerCase();
            if ((view === 'calendar' && label === 'calendario') ||
                (view === 'stats' && label === 'stats') ||
                (view === 'resources' && label === 'recursos')) item.classList.add('active');
        });
        document.querySelectorAll('.view').forEach(viewEl => viewEl.style.display = 'none');
        const viewElement = document.getElementById(view + '-view');
        if (viewElement) viewElement.style.display = 'block';
        if (view === 'stats') updateStats();
        currentView = view;
    }
    function openModal(modalId) {
        if (modalId === 'entryModal') {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            const dateTimeInput = document.getElementById('entryDateTime');
            if (dateTimeInput) dateTimeInput.value = now.toISOString().slice(0, 16);
        } else if (modalId === 'substanceModal') {
            selectedColor = availableColors[0];
            generateColorPicker();
        }
        const modal = document.getElementById(modalId);
        if (modal) modal.classList.add('active');
    }
    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) modal.classList.remove('active');
    }
    function openDayModal(date, entries) {
        const modal = document.getElementById('dayModal');
        const title = document.getElementById('dayModalTitle');
        const content = document.getElementById('dayEntries');
        if (!modal || !title || !content) return;
        title.textContent = date.toLocaleDateString('es-ES', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
        if(entries && entries.length > 0) {
            content.innerHTML = entries.map(entry => `
                <div class="entry-item">
                    <div class="entry-header">
                        <span class="entry-substance">${entry.substanceName}</span>
                        <span class="entry-time">${entry.time}</span>
                    </div>
                    <div class="entry-dose"><strong>Dosis:</strong> ${entry.dose} ${entry.unit}</div>
                    ${entry.notes ? `<div class="entry-notes">${entry.notes}</div>` : ''}
                </div>
            `).join('');
        } else {
            content.innerHTML = '<p style="text-align: center; color: var(--text-muted);">No hay registros para este d√≠a</p>';
        }
        modal.classList.add('active');
    }
    function initFormHandlers() {
        const entryForm = document.getElementById('entryForm');
        if (entryForm) {
            entryForm.onsubmit = function(e) {
                e.preventDefault();
                const substance = document.getElementById('entrySubstance').value;
                const dose = document.getElementById('entryDose').value;
                const unit = document.getElementById('entryUnit').value;
                const dateTimeValue = document.getElementById('entryDateTime').value;
                const notes = document.getElementById('entryNotes').value;
                if (!substance || !dose || !dateTimeValue) { alert('Por favor completa todos los campos obligatorios'); return;}
                const dateTime = new Date(dateTimeValue);
                const dateString = dateTime.toISOString().split('T')[0];
                const timeString = dateTime.toTimeString().slice(0, 5);
                if (!substanceData[substance].entries) substanceData[substance].entries = {};
                if (!substanceData[substance].entries[dateString]) substanceData[substance].entries[dateString] = [];
                substanceData[substance].entries[dateString].push({
                    time: timeString, dose: dose, unit: unit, notes: notes
                });
                saveData(substanceData);
                updateSubstanceList(); generateCalendar(); updateStats();
                entryForm.reset(); closeModal('entryModal');
            };
        }
        const substanceForm = document.getElementById('substanceForm');
        if (substanceForm) {
            substanceForm.onsubmit = function(e) {
                e.preventDefault();
                const name = document.getElementById('substanceName').value;
                const category = document.getElementById('substanceCategory').value;
                const unit = document.getElementById('substanceUnit').value;
                if (!name) { alert('Por favor ingresa el nombre de la sustancia'); return;}
                const key = name.toLowerCase().replace(/[^a-z0-9]/g,'');
                if (substanceData[key]) { alert('Esta sustancia ya existe'); return;}
                substanceData[key] = {
                    name: name, category: category, unit: unit, color: selectedColor, entries: {}
                };
                saveData(substanceData);
                updateSubstanceList(); generateCalendar();
                substanceForm.reset(); closeModal('substanceModal');
            };
        }
    }
    function updateStats() {
        const statsContent = document.getElementById('stats-content');
        if (!statsContent) return;
        const totalEntries = Object.values(substanceData).reduce((total,substance)=>
            total+Object.values(substance.entries||{}).reduce((a,b)=>a+b.length,0),0);
        const mostUsed = Object.entries(substanceData).reduce((max,[k,substance])=>{
            const count = Object.values(substance.entries||{}).reduce((a,b)=>a+b.length,0);
            return count > max.count ? {name:substance.name,count} : max;
        },{name:'Ninguna',count:0});
        const recentEntries = [];
        Object.entries(substanceData).forEach(([key,substance])=>{
            if(substance.entries) Object.entries(substance.entries).forEach(([date,entries])=>{
                entries.forEach(entry=>recentEntries.push({date:new Date(date),substance:substance.name,...entry}));
            });
        });
        recentEntries.sort((a,b)=>b.date-a.date);
        const lastEntry = recentEntries[0];
        const daysSinceLastUse = lastEntry ? Math.floor((new Date()-lastEntry.date)/(1000*60*60*24)) : 0;
        statsContent.innerHTML = `
            <div class="resource-card">
                <h4>Frecuencia de Uso</h4>
                <p><strong>Total de registros:</strong> ${totalEntries}</p>
                <p><strong>Sustancia m√°s usada:</strong> ${mostUsed.name} (${mostUsed.count} veces)</p>
                <p><strong>√öltima vez:</strong> ${lastEntry ? `hace ${daysSinceLastUse} d√≠as` : 'Sin registros'}</p>
            </div>
            <div class="resource-card">
                <h4>Patrones</h4>
                <p><strong>Promedio mensual:</strong> ${(totalEntries/3).toFixed(1)} usos</p>
                <p><strong>Sustancias registradas:</strong> ${Object.keys(substanceData).length}</p>
            </div>
            <div class="resource-card">
                <h4>Recomendaciones</h4>
                <p><strong>Espaciado recomendado:</strong> 7-14 d√≠as entre usos</p>
                <p><strong>Recuerda:</strong> La moderaci√≥n es clave para un uso responsable</p>
            </div>
        `;
    }

    // --- Exportar a CSV ---
function exportToCSV() {
    let csv = "Sustancia,Fecha,Hora,Dosis,Unidad,Notas\n";
    Object.entries(substanceData).forEach(([key,sub])=>{
        Object.entries(sub.entries||{}).forEach(([date,entries])=>{
            entries.forEach(entry=>{
                csv += `"${sub.name}","${date}","${entry.time}","${entry.dose}","${entry.unit}","${entry.notes?.replace(/"/g,'""')||''}"\n`;
            });
        });
    });
    const blob = new Blob([csv],{type:"text/csv"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = "bitacora_psiconautica.csv";
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
}

// --- Importar desde CSV ---
function importFromCSV(input) {
    if (!input.files.length) return;
    const file = input.files[0];
    const reader = new FileReader();
    reader.onload = function(e){
        const lines = e.target.result.split("\n").slice(1).filter(Boolean);
        lines.forEach(line=>{
            const [sustancia,fecha,hora,dosis,unidad,notas] = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(s=>s.replace(/^"|"$/g,""));
            let key = sustancia.toLowerCase().replace(/[^a-z0-9]/g,'');
            if (!substanceData[key]) substanceData[key] = { name:sustancia, color:availableColors[Math.floor(Math.random()*availableColors.length)], entries:{} };
            if (!substanceData[key].entries[fecha]) substanceData[key].entries[fecha] = [];
            substanceData[key].entries[fecha].push({ time:hora, dose:dosis, unit:unidad, notes:notas });
        });
        saveData(substanceData);
        updateSubstanceList(); generateCalendar(); updateStats();
        alert("Datos importados correctamente.");
    };
    reader.readAsText(file);
}

// --- Limpiar datos ---
function clearAllData() {
    if (confirm("¬øSeguro que quieres eliminar todos los datos? ¬°No se puede deshacer!")) {
        localStorage.clear();
        substanceData = JSON.parse(JSON.stringify(defaultSubstances));
        saveData(substanceData);
        updateSubstanceList(); generateCalendar(); updateStats();
        alert("Todos los datos han sido eliminados.");
    }
}

// --- Perfil ---
const profileFields = ["userNickname","userTelegram","userInstagram","userReddit","userDiscord"];
function saveProfile(){
    profileFields.forEach(id=>{
        localStorage.setItem(id, document.getElementById(id).value.trim());
    });
    alert("Perfil guardado");
}
function loadProfile(){
    profileFields.forEach(id=>{
        if(document.getElementById(id))
            document.getElementById(id).value = localStorage.getItem(id)||"";
    });
}
function shareProfile(){
    let txt = `üí´ Perfil Psicon√°utico üí´\n`;
    profileFields.forEach(id=>{
        let val = localStorage.getItem(id)||"";
        if(val) txt += `${id.replace("user","")}: ${val}\n`;
    });
    let shareBox = document.getElementById('profile-share');
    shareBox.innerHTML = `<textarea style="width:100%;min-height:90px;">${txt}</textarea>
    <button class="btn-primary" onclick="navigator.clipboard.writeText(document.querySelector('#profile-share textarea').value)">Copiar</button>`;
}

// --- Autobackup local cada 24h ---
function doAutoBackup() {
    let lastBackup = localStorage.getItem('auto-backup-timestamp');
    let now = Date.now();
    if(!lastBackup || now-parseInt(lastBackup)>24*60*60*1000) {
        // Guardar backup
        let backupName = "backup_psiconautica_" + new Date().toISOString().replace(/[:.]/g,'_').slice(0,19) + ".json";
        let data = JSON.stringify({substanceData, profile:{}});
        profileFields.forEach(id=>{ data.profile = data.profile||{}; data.profile[id]=localStorage.getItem(id)||""; });
        const blob = new Blob([data], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = backupName;
        document.body.appendChild(a); a.click(); a.remove();
        URL.revokeObjectURL(url);
        localStorage.setItem('auto-backup-timestamp', String(now));
        updateLastBackupInfo();
    }
}
function updateLastBackupInfo(){
    const el = document.getElementById('last-backup-info');
    if(!el) return;
    let t = localStorage.getItem('auto-backup-timestamp');
    if(t) el.textContent = "√öltimo backup: " + new Date(parseInt(t)).toLocaleString();
    else el.textContent = "A√∫n no se ha realizado ning√∫n backup autom√°tico.";
}

// -- Hookear al inicializar la app --
function initApp() {
    updateSubstanceList(); generateCalendar(); updateStats();
    initFormHandlers(); initModalCloseHandlers(); generateColorPicker();
    loadProfile(); updateLastBackupInfo(); doAutoBackup();
    setInterval(doAutoBackup, 10*60*1000); // chequea cada 10 min
}

    function initModalCloseHandlers() {
        document.querySelectorAll('.modal').forEach(modal => {
            modal.onclick = (e) => { if(e.target === modal) modal.classList.remove('active'); };
        });
    }
    function openExternalURL(url) {
        // En Android WebView usa intent:// y fallback a _blank para navegador normal
        if (window.AndroidWebView && window.AndroidWebView.openExternalUrl) {
            window.AndroidWebView.openExternalUrl(url);
        } else if (window.navigator && window.navigator.userAgent && /Android/i.test(window.navigator.userAgent)) {
            window.open(url, '_system');
        } else {
            window.open(url, '_blank');
        }
    }
    function initApp() {
        updateSubstanceList(); generateCalendar(); updateStats();
        initFormHandlers(); initModalCloseHandlers(); generateColorPicker();
    }
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', initApp);
    else initApp();
</script>
</body>
</html>
