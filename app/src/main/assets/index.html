<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bit√°cora Psicon√°utica</title>
    <style>
        :root {
            --primary-purple: #8B5CF6;
            --secondary-pink: #EC4899;
            --accent-cyan: #06B6D4;
            --accent-orange: #F97316;
            --dark-bg: #0F0F23;
            --darker-bg: #080813;
            --card-bg: #1A1A2E;
            --text-light: #E5E7EB;
            --text-muted: #9CA3AF;
            --border-color: rgba(139, 92, 246, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            background: var(--dark-bg);
            min-height: 100vh;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            color: var(--text-light);
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, var(--dark-bg) 0%, var(--darker-bg) 100%);
            z-index: -10;
        }

        .animated-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -5;
            opacity: 0.15;
            background:
                radial-gradient(circle at 25% 75%, var(--primary-purple) 0%, transparent 40%),
                radial-gradient(circle at 75% 25%, var(--secondary-pink) 0%, transparent 40%),
                radial-gradient(circle at 50% 50%, var(--accent-cyan) 0%, transparent 40%);
            animation: backgroundMove 20s ease-in-out infinite;
        }

        @keyframes backgroundMove {
            0%, 100% {
                transform: scale(1) rotate(0deg);
                opacity: 0.15;
            }
            50% {
                transform: scale(1.1) rotate(180deg);
                opacity: 0.25;
            }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 5;
            padding-top: 1.5rem;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 2rem 0;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .mystical-symbol {
            font-size: 3rem;
            opacity: 0.8;
            animation: symbolGlow 4s ease-in-out infinite alternate;
            user-select: none;
        }

        .mystical-symbol.left {
            color: var(--accent-cyan);
        }

        .mystical-symbol.right {
            color: var(--secondary-pink);
        }

        @keyframes symbolGlow {
            0% {
                opacity: 0.8;
                transform: scale(1);
                filter: drop-shadow(0 0 10px currentColor);
            }
            100% {
                opacity: 1;
                transform: scale(1.1);
                filter: drop-shadow(0 0 20px currentColor);
            }
        }

        .header-title {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-purple), var(--secondary-pink), var(--accent-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            animation: colorShift 3s ease-in-out infinite;
        }

        @keyframes colorShift {
            0%, 100% { filter: hue-rotate(0deg); }
            50% { filter: hue-rotate(90deg); }
        }

        .header p {
            color: var(--text-muted);
            font-size: 1.1rem;
        }

        .main-content {
            flex: 1;
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2rem;
            margin-bottom: 5rem;
        }

        .sidebar {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            height: fit-content;
            backdrop-filter: blur(10px);
        }

        .sidebar h3 {
            margin-bottom: 1rem;
            color: var(--primary-purple);
            font-size: 1.2rem;
        }

        .substance-list {
            list-style: none;
        }

        .substance-item {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: rgba(139, 92, 246, 0.1);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .substance-item:hover {
            background: rgba(139, 92, 246, 0.2);
            border-color: var(--primary-purple);
            transform: translateX(5px);
        }

        .substance-item.active {
            background: linear-gradient(135deg, var(--primary-purple), var(--secondary-pink));
            border-color: var(--accent-cyan);
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(139, 92, 246, 0.3);
        }

        .substance-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
        }

        .substance-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .substance-count {
            background: var(--accent-cyan);
            color: var(--dark-bg);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .edit-substance-btn {
            background: var(--accent-cyan);
            border: none;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            opacity: 0.7;
            margin-right: 8px;
        }

        .edit-substance-btn:hover {
            opacity: 1;
            background: var(--primary-purple);
            transform: scale(1.1);
        }

        .delete-substance-btn {
            background: var(--secondary-pink);
            border: none;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            opacity: 0.7;
        }

        .delete-substance-btn:hover {
            opacity: 1;
            background: #dc2626;
            transform: scale(1.1);
        }

        .add-substance-btn {
            width: 100%;
            padding: 0.75rem;
            background: linear-gradient(135deg, var(--accent-orange), var(--secondary-pink));
            border: none;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 1rem;
        }

        .add-substance-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(249, 115, 22, 0.3);
        }

        .calendar-container {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 2rem;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .calendar-nav {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .nav-btn {
            background: var(--primary-purple);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-btn:hover {
            background: var(--secondary-pink);
            transform: scale(1.1);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: var(--border-color);
            border-radius: 12px;
            overflow: hidden;
        }

        .calendar-day {
            aspect-ratio: 1;
            background: var(--darker-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            font-weight: 500;
        }

        .calendar-day:hover {
            opacity: 0.8;
            transform: scale(1.05);
        }

        .calendar-day.has-entry {
            color: white;
            font-weight: 600;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }

        .calendar-day.has-entry.single-substance {
        /* Color s√≥lido para una sola sustancia */
        }

        .calendar-day.has-entry.multiple-substances {
        /* Gradiente para m√∫ltiples sustancias */
            position: relative;
        }

        .calendar-day.has-entry.multiple-substances::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: inherit;
            z-index: -1;
        }

        .substance-indicators {
            position: absolute;
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 2px;
        }

        .substance-dot {
            width: 4px;
            height: 4px;
            border-radius: 50%;
            box-shadow: 0 0 2px rgba(0,0,0,0.3);
        }

        .day-header {
            background: var(--primary-purple);
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border-top: 1px solid var(--border-color);
            padding: 1rem;
            backdrop-filter: blur(20px);
            z-index: 1000;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 0.5rem;
            border-radius: 12px;
            min-width: 70px;
        }

        .nav-item:hover {
            background: rgba(139, 92, 246, 0.1);
            transform: translateY(-2px);
        }

        .nav-item.active {
            background: linear-gradient(135deg, var(--primary-purple), var(--secondary-pink));
            color: white;
        }

        .nav-icon {
            width: 24px;
            height: 24px;
            margin-bottom: 0.25rem;
        }

        .nav-label {
            font-size: 0.7rem;
            font-weight: 500;
        }

        /* Modal fixes for Android */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            backdrop-filter: blur(5px);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .modal.active {
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 0.5rem;
            overflow-y: auto;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 2rem;
            max-width: 500px;
            width: calc(100% - 2rem);
            margin: 2rem auto;
            min-height: auto;
            border: 1px solid var(--border-color);
            position: relative;
            animation: modalSlideIn 0.3s ease;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
        }

        /* Ensure modal content is centered on small screens */
        @media (max-height: 800px) {
            .modal-content {
                margin: 1rem auto;
            }
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.3s ease;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .close-btn:hover {
            color: var(--text-light);
            background: rgba(139, 92, 246, 0.1);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--primary-purple);
            font-weight: 600;
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-shadow: 0 0 10px rgba(139, 92, 246, 0.3);
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            background: var(--darker-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-light);
            font-size: 1rem;
        }

        /* Estilos mejorados para selectores */
        .form-group select {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, 
                rgba(139, 92, 246, 0.1) 0%, 
                rgba(236, 72, 153, 0.1) 50%, 
                rgba(6, 182, 212, 0.1) 100%);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            color: var(--text-light);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            position: relative;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%238B5CF6' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6,9 12,15 18,9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 20px;
            padding-right: 3rem;
        }

        .form-group select:hover {
            border-color: var(--primary-purple);
            box-shadow: 0 0 25px rgba(139, 92, 246, 0.4);
            transform: translateY(-3px);
            background: linear-gradient(135deg, 
                rgba(139, 92, 246, 0.15) 0%, 
                rgba(236, 72, 153, 0.15) 50%, 
                rgba(6, 182, 212, 0.15) 100%);
        }

        .form-group select:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 30px rgba(6, 182, 212, 0.5);
            background: linear-gradient(135deg, 
                rgba(139, 92, 246, 0.2) 0%, 
                rgba(236, 72, 153, 0.2) 50%, 
                rgba(6, 182, 212, 0.2) 100%);
        }

        /* Estilos para las opciones del selector */
        .form-group select option {
            background: var(--card-bg);
            color: var(--text-light);
            padding: 0.5rem;
            border: none;
        }

        .form-group select option:hover {
            background: linear-gradient(135deg, 
                rgba(139, 92, 246, 0.2) 0%, 
                rgba(236, 72, 153, 0.2) 100%);
        }

        /* Estilos para optgroup */
        .form-group select optgroup {
            background: linear-gradient(135deg, 
                rgba(139, 92, 246, 0.3) 0%, 
                rgba(6, 182, 212, 0.3) 100%);
            color: var(--accent-cyan);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 0.5rem;
        }

        /* Estilos para input de n√∫mero */
        .form-group input[type="number"] {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, 
                rgba(139, 92, 246, 0.1) 0%, 
                rgba(236, 72, 153, 0.1) 50%, 
                rgba(6, 182, 212, 0.1) 100%);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            color: var(--text-light);
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
        }

        .form-group input[type="number"]:hover {
            border-color: var(--primary-purple);
            box-shadow: 0 0 25px rgba(139, 92, 246, 0.4);
            transform: translateY(-3px);
        }

        .form-group input[type="number"]:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 30px rgba(6, 182, 212, 0.5);
        }

        /* Estilos para input de fecha y hora */
        .form-group input[type="datetime-local"] {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, 
                rgba(139, 92, 246, 0.1) 0%, 
                rgba(236, 72, 153, 0.1) 50%, 
                rgba(6, 182, 212, 0.1) 100%);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            color: var(--text-light);
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
        }

        .form-group input[type="datetime-local"]:hover {
            border-color: var(--primary-purple);
            box-shadow: 0 0 25px rgba(139, 92, 246, 0.4);
            transform: translateY(-3px);
        }

        .form-group input[type="datetime-local"]:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 30px rgba(6, 182, 212, 0.5);
        }

        /* ===== ESTILOS PARA DI√ÅLOGOS PERSONALIZADOS ===== */
        
        .custom-dialog {
            background: var(--card-bg) !important;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(20px);
        }

        .custom-dialog-header {
            padding: 1.5rem 1.5rem 0.5rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .custom-dialog-header h3 {
            margin: 0;
            color: var(--text-light);
            font-size: 1.25rem;
            font-weight: 600;
            text-align: center;
        }

        .custom-dialog-body {
            padding: 1.5rem;
            text-align: center;
        }

        .custom-dialog-body p {
            margin: 0;
            color: var(--text-muted);
            font-size: 1rem;
            line-height: 1.5;
        }

        .custom-dialog-actions {
            padding: 0 1.5rem 1.5rem 1.5rem;
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .custom-dialog-actions button {
            flex: 1;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-size: 0.9rem;
        }

        .custom-dialog-actions .btn-primary {
            background: linear-gradient(135deg, var(--primary-purple), var(--secondary-pink));
            color: white;
            margin-bottom: 0;
        }

        .custom-dialog-actions .btn-secondary {
            background: var(--darker-bg);
            color: var(--text-light);
            border: 1px solid var(--border-color);
            margin-bottom: 0;
        }

        .custom-dialog-actions .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(139, 92, 246, 0.3);
        }

        .custom-dialog-actions .btn-secondary:hover {
            background: var(--border-color);
            transform: translateY(-2px);
        }

        /* Estilos para el modal de auto-cierre */
        .custom-dialog.auto-close {
            animation: slideInUp 0.3s ease-out;
        }

        .custom-dialog.auto-close.fade-out {
            animation: fadeOut 0.3s ease-in forwards;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-30px);
            }
        }

        /* Barra de progreso para auto-cierre */
        .auto-close-progress {
            width: 100%;
            height: 3px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            margin-top: 0.5rem;
            overflow: hidden;
        }

        .progress-bar {
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, var(--accent-cyan), var(--accent-orange));
            border-radius: 2px;
            transition: width 2s linear;
        }

        /* ===== ESTILOS PARA BOTONES PRINCIPALES ===== */
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-purple), var(--secondary-pink));
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-success {
            background: linear-gradient(135deg, #10B981, #059669);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }

        .btn-success:active {
            transform: translateY(0);
        }

        /* ===== EMOJI PICKER ===== */
        .emoji-picker {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .emoji-picker input {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 0.5rem;
            color: var(--text-light);
            transition: all 0.3s ease;
        }

        .emoji-picker input:focus {
            border-color: var(--accent-cyan);
            box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
            outline: none;
        }

        .emoji-suggestion {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-align: center;
        }

        .resources-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .resource-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            text-decoration: none;
            color: inherit;
            cursor: pointer;
        }

        .resource-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary-purple);
            box-shadow: 0 20px 40px rgba(139, 92, 246, 0.1);
        }

        .resource-card h4 {
            color: var(--accent-cyan);
            margin-bottom: 0.5rem;
        }

        .entry-item {
            background: var(--darker-bg);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border-color);
        }

        .entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .entry-substance {
            color: var(--primary-purple);
            font-weight: 600;
        }

        .entry-time {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .entry-dose {
            color: var(--accent-cyan);
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .entry-notes {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .color-picker-container {
            margin: 1rem 0;
        }

        .color-options {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .color-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .color-option:hover {
            transform: scale(1.1);
            border-color: var(--text-light);
        }

        .color-option.selected {
            border-color: var(--accent-cyan);
            transform: scale(1.2);
        }

        .color-option.selected::after {
            content: '‚úì';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            text-shadow: 0 0 3px rgba(0,0,0,0.8);
        }

        .profile-section {
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: var(--darker-bg);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .profile-section h4 {
            color: var(--accent-cyan);
            margin-bottom: 1rem;
        }

        .char-counter {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-align: right;
            margin-top: 0.5rem;
        }

        .file-input {
            display: none;
        }

        .file-label {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            background: var(--accent-orange);
            color: white;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            width: 100%;
            margin-bottom: 0.5rem;
        }

        .file-label:hover {
            background: var(--secondary-pink);
            transform: translateY(-2px);
        }

         .profile-card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            border: 1px solid var(--border-color);
            max-width: 400px;
            margin: 0 auto;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-purple), var(--secondary-pink));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            margin: 0 auto 1rem;
        }

        .social-share-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }

        .social-share-btn {
            padding: 0.75rem;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .twitter-btn {
            background: #1DA1F2;
            color: white;
        }

        .whatsapp-btn {
            background: #25D366;
            color: white;
        }

        .telegram-btn {
            background: #0088cc;
            color: white;
        }

        .reddit-btn {
            background: #FF4500;
            color: white;
        }

        .favorite-substance {
            background: var(--darker-bg);
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            border: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .remove-btn {
            background: var(--secondary-pink);
            border: none;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .btn-edit, .btn-delete {
            background: var(--accent-cyan);
            border: none;
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            margin-right: 0.5rem;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .btn-delete {
            background: var(--secondary-pink);
        }

        .btn-edit:hover {
            background: var(--accent-orange);
        }

        .btn-delete:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }

        .entry-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid var(--border-color);
        }

        .quote-item {
            background: var(--darker-bg);
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            border-left: 4px solid var(--accent-cyan);
            position: relative;
        }

        .quote-text {
            font-style: italic;
            margin-bottom: 0.5rem;
        }

        .quote-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .header h1 {
                font-size: 2rem;
            }

            .header-content {
                gap: 1rem;
            }

            .mystical-symbol {
                font-size: 2rem;
            }

            .calendar-container {
                padding: 1rem;
            }

            .nav-label {
                font-size: 0.6rem;
            }

            .nav-item {
                min-width: 60px;
            }

            .modal-content {
                margin: 1rem;
                width: calc(100% - 2rem);
                padding: 1.5rem;
            }
        }

        /* ===== DROPDOWNS PERSONALIZADOS ===== */
        
        .custom-dropdown {
            position: relative;
            width: 100%;
            margin-bottom: 0.5rem;
        }

        .dropdown-header {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, 
                rgba(139, 92, 246, 0.1) 0%, 
                rgba(236, 72, 153, 0.1) 50%, 
                rgba(6, 182, 212, 0.1) 100%);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            color: var(--text-light);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dropdown-header:hover {
            border-color: var(--primary-purple);
            box-shadow: 0 0 25px rgba(139, 92, 246, 0.4);
            transform: translateY(-3px);
            background: linear-gradient(135deg, 
                rgba(139, 92, 246, 0.15) 0%, 
                rgba(236, 72, 153, 0.15) 50%, 
                rgba(6, 182, 212, 0.15) 100%);
        }

        .dropdown-header.active {
            border-color: var(--accent-cyan);
            box-shadow: 0 0 30px rgba(6, 182, 212, 0.5);
            background: linear-gradient(135deg, 
                rgba(139, 92, 246, 0.2) 0%, 
                rgba(236, 72, 153, 0.2) 50%, 
                rgba(6, 182, 212, 0.2) 100%);
        }

        .dropdown-text {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .dropdown-arrow {
            font-size: 0.8rem;
            transition: transform 0.3s ease;
            color: var(--accent-cyan);
        }

        .dropdown-header.active .dropdown-arrow {
            transform: rotate(180deg);
        }

        .dropdown-options {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            right: 0;
            background: linear-gradient(135deg, 
                rgba(26, 26, 46, 0.95) 0%, 
                rgba(15, 15, 35, 0.95) 100%);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            backdrop-filter: blur(20px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            max-height: 250px;
            overflow-y: auto;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: inherit;
            scrollbar-width: thin;
            scrollbar-color: var(--accent-cyan) rgba(139, 92, 246, 0.1);
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }

        .dropdown-options.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-option {
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 1px solid rgba(139, 92, 246, 0.1);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            min-height: 48px;
        }

        .dropdown-option:last-child {
            border-bottom: none;
        }

        .dropdown-option:hover {
            background: linear-gradient(135deg, 
                rgba(139, 92, 246, 0.2) 0%, 
                rgba(236, 72, 153, 0.2) 100%);
            transform: translateX(5px);
        }

        .dropdown-option.selected {
            background: linear-gradient(135deg, 
                rgba(139, 92, 246, 0.3) 0%, 
                rgba(6, 182, 212, 0.3) 100%);
            border-left: 4px solid var(--accent-cyan);
        }

        .dropdown-option::before {
            content: '';
            width: 6px;
            height: 6px;
            background: var(--accent-cyan);
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .dropdown-option:hover::before {
            opacity: 1;
        }

        .option-emoji {
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
        }

        .option-text {
            flex: 1;
            color: var(--text-light);
            font-weight: 500;
        }

        .dropdown-option.selected .option-text {
            color: var(--accent-cyan);
            font-weight: 600;
        }

        /* Estilos para headers de categor√≠as */
        .dropdown-option.category-header {
            background: linear-gradient(135deg, 
                rgba(139, 92, 246, 0.3) 0%, 
                rgba(6, 182, 212, 0.3) 100%);
            color: var(--accent-cyan);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 1rem;
            cursor: default;
            border-left: 4px solid var(--accent-cyan);
        }

        .dropdown-option.category-header:hover {
            background: linear-gradient(135deg, 
                rgba(139, 92, 246, 0.4) 0%, 
                rgba(6, 182, 212, 0.4) 100%);
            transform: none;
        }

        .dropdown-option.category-header .option-text {
            color: var(--accent-cyan);
            font-weight: 700;
        }

        .dropdown-option.category-header:first-child {
            border-top-left-radius: 14px;
            border-top-right-radius: 14px;
        }

        /* Scrollbar personalizado para dropdowns */
        .dropdown-options::-webkit-scrollbar {
            width: 8px;
        }

        .dropdown-options::-webkit-scrollbar-track {
            background: rgba(139, 92, 246, 0.1);
            border-radius: 4px;
            margin: 4px 0;
        }

        .dropdown-options::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--primary-purple), var(--accent-cyan));
            border-radius: 4px;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .dropdown-options::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, var(--secondary-pink), var(--accent-cyan));
            transform: scale(1.1);
        }

        .dropdown-options::-webkit-scrollbar-corner {
            background: transparent;
        }

        /* Z-index espec√≠fico para cada dropdown en orden */
        #entrySubstanceDropdown { z-index: 1006; }
        #entryUnitDropdown { z-index: 1005; }
        #entrySetDropdown { z-index: 1004; }
        #entrySettingDropdown { z-index: 1003; }
    </style>
</head>
<body>
<div class="animated-bg"></div>

<div class="container">
    <header class="header">
        <div class="header-content">
            <div class="mystical-symbol left">üëÅÔ∏è</div>
            <div class="header-title">
                <h1>Bit√°cora Psicon√°utica</h1>
                <p>Tu compa√±ero de viaje para un consumo consciente y responsable</p>
            </div>
            <div class="mystical-symbol right">üóùÔ∏è</div>
        </div>
    </header>

    <main id="main-content" class="main-content">
        <!-- Calendar View (Default) -->
        <div id="calendar-view" class="view active">
            <div class="sidebar">
                <h3>Sustancias</h3>
                <ul id="substance-list" class="substance-list">
                    <!-- Se llenar√°n din√°micamente -->
                </ul>
                <button class="add-substance-btn" onclick="openModal('substanceModal')">
                    + A√±adir Sustancia
                </button>
            </div>

            <div class="calendar-container">
                <div class="calendar-header">
                    <h2 id="current-month">Enero 2025</h2>
                    <div class="calendar-nav">
                        <button class="nav-btn" onclick="previousMonth()">‚Äπ</button>
                        <button class="nav-btn" onclick="nextMonth()">‚Ä∫</button>
                    </div>
                </div>
                <div class="calendar-grid" id="calendar-grid">
                    <!-- Calendar will be generated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Stats View -->
        <div id="stats-view" class="view" style="display: none;">
            <div class="calendar-container">
                <h2>Estad√≠sticas y An√°lisis</h2>
                <div class="resources-grid" id="stats-content">
                    <!-- Se llenar√°n din√°micamente -->
                </div>
            </div>
        </div>

        <!-- Resources View -->
        <div id="resources-view" class="view" style="display: none;">
            <div class="calendar-container">
                <h2>Recursos y Harm Reduction</h2>
                <div class="resources-grid">
                    <div class="resource-card" onclick="openExternalURL('https://erowid.org')">
                        <h4>Erowid</h4>
                        <p>Base de datos completa sobre sustancias psicoactivas, experiencias y
                            efectos</p>
                    </div>
                    <div class="resource-card" onclick="openExternalURL('https://tripsit.me')">
                        <h4>TripSit</h4>
                        <p>Informaci√≥n sobre interacciones, dosificaci√≥n y asistencia en tiempo
                            real</p>
                    </div>
                    <div class="resource-card" onclick="openExternalURL('https://maps.org')">
                        <h4>MAPS</h4>
                        <p>Organizaci√≥n sin √°nimo de lucro que investiga los potenciales usos
                            m√©dicos, legales y culturales de los psicod√©licos</p>
                    </div>
                    <div class="resource-card"
                         onclick="openExternalURL('https://psychonautwiki.org')">
                        <h4>PsychonautWiki</h4>
                        <p>Enciclopedia cient√≠fica de sustancias psicoactivas y sus efectos</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data View -->
        <div id="data-view" class="view" style="display: none;">
            <div class="calendar-container">
                <h2>Gesti√≥n de Datos</h2>
                <div class="resources-grid">
                    <div class="resource-card">
                        <h4>Exportar Datos</h4>
                        <p>Descargar todos tus datos en formato CSV</p>
                        <button class="btn-primary" onclick="validateDataBeforeExport()">Exportar CSV</button>
                    </div>
                    <div class="resource-card">
                        <h4>Importar Datos</h4>
                        <p>Cargar datos desde un archivo CSV</p>
                        <input type="file" id="csvFileInput" accept=".csv" style="display: none;"
                               onchange="importFromCSV(this)">
                        <button class="file-label" onclick="forceFileSelect()"
                                style="border: none; width: 100%;">üìÅ Seleccionar CSV
                        </button>
                    </div>
                    <div class="resource-card">
                        <h4>Limpiar Datos</h4>
                        <p>Eliminar todos los datos almacenados</p>
                        <button class="btn-secondary" onclick="clearAllData()">Limpiar Todo</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <div class="nav-container">
                <div class="nav-item active" onclick="switchView('calendar')">
                    <div class="nav-icon">üìÖ</div>
                    <div class="nav-label">Calendario</div>
                </div>
                <div class="nav-item" onclick="openModal('entryModal'); resetEditMode();">
                    <div class="nav-icon">‚ûï</div>
                    <div class="nav-label">A√±adir</div>
                </div>
                <div class="nav-item" onclick="switchView('stats')">
                    <div class="nav-icon">üìä</div>
                    <div class="nav-label">Stats</div>
                </div>
                <div class="nav-item" onclick="switchView('resources')">
                    <div class="nav-icon">üîó</div>
                    <div class="nav-label">Recursos</div>
                </div>
                <div class="nav-item" onclick="switchView('data')">
                    <div class="nav-icon">üíæ</div>
                    <div class="nav-label">Datos</div>
                </div>
            </div>
        </nav>

        <!-- Add Entry Modal -->
        <div id="entryModal" class="modal">
            <div class="modal-content">
                <button class="close-btn" onclick="closeModal('entryModal')">√ó</button>
                <h3>Nuevo Registro</h3>
                <form id="entryForm">
                    <div class="form-group">
                        <label>Sustancia *</label>
                        <div class="custom-dropdown" id="entrySubstanceDropdown">
                            <div class="dropdown-header"
                                 onclick="toggleDropdown('entrySubstanceDropdown')">
                                <span class="dropdown-text">Selecciona una sustancia...</span>
                                <span class="dropdown-arrow">‚ñº</span>
                            </div>
                            <div class="dropdown-options" id="entrySubstanceOptions">
                                <!-- Se llenar√°n din√°micamente -->
                            </div>
                            <input type="hidden" id="entrySubstance" name="entrySubstance" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Dosis *</label>
                        <input type="number" id="entryDose" placeholder="Cantidad" step="0.01"
                               min="0" required>
                    </div>

                    <div class="form-group">
                        <label>Unidad *</label>
                        <div class="custom-dropdown" id="entryUnitDropdown">
                            <div class="dropdown-header"
                                 onclick="toggleDropdown('entryUnitDropdown')">
                                <span class="dropdown-text">Seleccionar unidad...</span>
                                <span class="dropdown-arrow">‚ñº</span>
                            </div>
                            <div class="dropdown-options" id="entryUnitOptions">
                                <!-- Psicod√©licos -->
                                <div class="dropdown-option category-header"
                                     data-category="psicodelicos">
                                    <span class="option-emoji">üååüí´üåà</span>
                                    <span class="option-text">PSICOD√âLICOS</span>
                                </div>
                                <div class="dropdown-option" data-value="ug"
                                     onclick="selectOption('entryUnitDropdown', 'ug', 'Œºg (microgramos)', 'üß™')">
                                    <span class="option-emoji">üß™</span>
                                    <span class="option-text">Œºg (microgramos)</span>
                                </div>
                                <div class="dropdown-option" data-value="mg"
                                     onclick="selectOption('entryUnitDropdown', 'mg', 'mg (miligramos)', 'üíä')">
                                    <span class="option-emoji">üíä</span>
                                    <span class="option-text">mg (miligramos)</span>
                                </div>
                                <div class="dropdown-option" data-value="tripi"
                                     onclick="selectOption('entryUnitDropdown', 'tripi', 'tripi completo', 'üååüåà')">
                                    <span class="option-emoji">üååüåà</span>
                                    <span class="option-text">tripi completo</span>
                                </div>
                                <div class="dropdown-option" data-value="medio-tripi"
                                     onclick="selectOption('entryUnitDropdown', 'medio-tripi', '1/2 tripi', 'üåà')">
                                    <span class="option-emoji">üåà</span>
                                    <span class="option-text">1/2 tripi</span>
                                </div>
                                <div class="dropdown-option" data-value="cuarto-tripi"
                                     onclick="selectOption('entryUnitDropdown', 'cuarto-tripi', '1/4 tripi', 'üåà')">
                                    <span class="option-emoji">üåà</span>
                                    <span class="option-text">1/4 tripi</span>
                                </div>
                                <div class="dropdown-option" data-value="octavo-tripi"
                                     onclick="selectOption('entryUnitDropdown', 'octavo-tripi', '1/8 tripi', 'üåà')">
                                    <span class="option-emoji">üåà</span>
                                    <span class="option-text">1/8 tripi</span>
                                </div>

                                <!-- Hongos/Plantas -->
                                <div class="dropdown-option category-header" data-category="hongos">
                                    <span class="option-emoji">üçÑ</span>
                                    <span class="option-text">HONGOS/PLANTAS</span>
                                </div>
                                <div class="dropdown-option" data-value="g"
                                     onclick="selectOption('entryUnitDropdown', 'mg', 'mg (miligramos)', 'üåøüçÑ')">
                                    <span class="option-emoji">üåøüçÑ</span>
                                    <span class="option-text">mg (miligramos)</span>
                                </div>
                                <div class="dropdown-option" data-value="g"
                                     onclick="selectOption('entryUnitDropdown', 'g', 'g (gramos)', 'üçÑ')">
                                    <span class="option-emoji">üçÑ</span>
                                    <span class="option-text">g (gramos)</span>
                                </div>
                                <div class="dropdown-option" data-value="seta"
                                     onclick="selectOption('entryUnitDropdown', 'seta', 'seta completa', 'üçÑ')">
                                    <span class="option-emoji">üçÑ</span>
                                    <span class="option-text">seta completa</span>
                                </div>
                                <div class="dropdown-option" data-value="media-seta"
                                     onclick="selectOption('entryUnitDropdown', 'media-seta', '1/2 seta', 'üçÑ')">
                                    <span class="option-emoji">üçÑ</span>
                                    <span class="option-text">1/2 seta</span>
                                </div>

                                <!-- Estimulantes/MDMA -->
                                <div class="dropdown-option category-header"
                                     data-category="estimulantes">
                                    <span class="option-emoji">üî•</span>
                                    <span class="option-text">ESTIMULANTES/MDMA</span>
                                </div>
                                <div class="dropdown-option" data-value="pastilla"
                                     onclick="selectOption('entryUnitDropdown', 'pastilla', 'pastilla completa', 'üíä')">
                                    <span class="option-emoji">üíä</span>
                                    <span class="option-text">pastilla completa</span>
                                </div>
                                <div class="dropdown-option" data-value="media-pastilla"
                                     onclick="selectOption('entryUnitDropdown', 'media-pastilla', '1/2 pastilla', 'üíä')">
                                    <span class="option-emoji">üíä</span>
                                    <span class="option-text">1/2 pastilla</span>
                                </div>
                                <div class="dropdown-option" data-value="cuarto-pastilla"
                                     onclick="selectOption('entryUnitDropdown', 'cuarto-pastilla', '1/4 pastilla', 'üíä')">
                                    <span class="option-emoji">üíä</span>
                                    <span class="option-text">1/4 pastilla</span>
                                </div>
                                <div class="dropdown-option" data-value="punto"
                                     onclick="selectOption('entryUnitDropdown', 'punto', 'punto/bomba', 'üí£')">
                                    <span class="option-emoji">üí£</span>
                                    <span class="option-text">punto/bomba</span>
                                </div>

                                <!-- Polvo/Cristal -->
                                <div class="dropdown-option category-header" data-category="polvo">
                                    <span class="option-emoji">‚ùÑÔ∏è</span>
                                    <span class="option-text">POLVO/CRISTAL</span>
                                </div>
                                <div class="dropdown-option" data-value="raya"
                                     onclick="selectOption('entryUnitDropdown', 'raya', 'raya/l√≠nea', 'üëÉ')">
                                    <span class="option-emoji">üëÉ</span>
                                    <span class="option-text">raya</span>
                                </div>
                                <div class="dropdown-option" data-value="tirito"
                                     onclick="selectOption('entryUnitDropdown', 'tirito', 'tirito', 'üëÉ')">
                                    <span class="option-emoji">üëÉ</span>
                                    <span class="option-text">tirito</span>
                                </div>
                                <div class="dropdown-option" data-value="bump"
                                     onclick="selectOption('entryUnitDropdown', 'bump', 'bump', 'üîπ')">
                                    <span class="option-emoji">üîπ</span>
                                    <span class="option-text">bump</span>
                                </div>
                                <div class="dropdown-option" data-value="key"
                                     onclick="selectOption('entryUnitDropdown', 'key', 'key bump', 'üîë')">
                                    <span class="option-emoji">üîë</span>
                                    <span class="option-text">key bump</span>
                                </div>

                                <!-- L√≠quidos -->
                                <div class="dropdown-option category-header"
                                     data-category="liquidos">
                                    <span class="option-emoji">üíß</span>
                                    <span class="option-text">L√çQUIDOS</span>
                                </div>
                                <div class="dropdown-option" data-value="ml"
                                     onclick="selectOption('entryUnitDropdown', 'ml', 'ml (mililitros)', 'üíß')">
                                    <span class="option-emoji">üíß</span>
                                    <span class="option-text">ml (mililitros)</span>
                                </div>
                                <div class="dropdown-option" data-value="gotas"
                                     onclick="selectOption('entryUnitDropdown', 'gotas', 'gotas', 'üíß')">
                                    <span class="option-emoji">üíß</span>
                                    <span class="option-text">gotas</span>
                                </div>
                                <div class="dropdown-option" data-value="vial"
                                     onclick="selectOption('entryUnitDropdown', 'vial', 'vial', 'üß™')">
                                    <span class="option-emoji">üß™</span>
                                    <span class="option-text">vial</span>
                                </div>

                                <!-- Otras -->
                                <div class="dropdown-option category-header" data-category="otras">
                                    <span class="option-emoji">üîß</span>
                                    <span class="option-text">OTRAS</span>
                                </div>
                                <div class="dropdown-option" data-value="calada"
                                     onclick="selectOption('entryUnitDropdown', 'calada', 'calada', 'üö¨')">
                                    <span class="option-emoji">üö¨</span>
                                    <span class="option-text">calada</span>
                                </div>
                                <div class="dropdown-option" data-value="inhalacion"
                                     onclick="selectOption('entryUnitDropdown', 'inhalacion', 'inhalaci√≥n', 'üëÉ')">
                                    <span class="option-emoji">üëÉ</span>
                                    <span class="option-text">inhalaci√≥n</span>
                                </div>
                                <div class="dropdown-option" data-value="aplicacion"
                                     onclick="selectOption('entryUnitDropdown', 'aplicacion', 'aplicaci√≥n', 'üÜô')">
                                    <span class="option-emoji">üÜô</span>
                                    <span class="option-text">aplicaci√≥n</span>
                                </div>
                                <div class="dropdown-option" data-value="dosis"
                                     onclick="selectOption('entryUnitDropdown', 'dosis', 'dosis', 'üîµ')">
                                    <span class="option-emoji">üîµ</span>
                                    <span class="option-text">dosis</span>
                                </div>
                                <div class="dropdown-option" data-value="cafe"
                                     onclick="selectOption('entryUnitDropdown', 'cafe', 'Caf√© fr√≠o', '‚òï')">
                                    <span class="option-emoji">‚òï</span>
                                    <span class="option-text">Caf√© fr√≠o</span>
                                </div>
                                <div class="dropdown-option" data-value="cookie"
                                     onclick="selectOption('entryUnitDropdown', 'cookie', 'cookie', 'üç™')">
                                    <span class="option-emoji">üç™</span>
                                    <span class="option-text">cookie</span>
                                </div>
                                <div class="dropdown-option" data-value="cookies"
                                     onclick="selectOption('entryUnitDropdown', 'cookies', 'cookies', 'üç™üç™')">
                                    <span class="option-emoji">üç™üç™</span>
                                    <span class="option-text">cookies</span>
                                </div>
                            </div>
                            <input type="hidden" id="entryUnit" name="entryUnit" value="" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Fecha y Hora *</label>
                        <input type="datetime-local" id="entryDateTime" required>
                    </div>

                    <div class="form-group">
                        <label>Set (Estado mental)</label>
                        <div class="custom-dropdown" id="entrySetDropdown">
                            <div class="dropdown-header"
                                 onclick="toggleDropdown('entrySetDropdown')">
                                <span class="dropdown-text">Seleccionar...</span>
                                <span class="dropdown-arrow">‚ñº</span>
                            </div>
                            <div class="dropdown-options" id="entrySetOptions">
                                <div class="dropdown-option" data-value="excelente"
                                     onclick="selectOption('entrySetDropdown', 'excelente', 'Excelente', 'üòä')">
                                    <span class="option-emoji">üòä</span>
                                    <span class="option-text">Excelente</span>
                                </div>
                                <div class="dropdown-option" data-value="bueno"
                                     onclick="selectOption('entrySetDropdown', 'bueno', 'Bueno', 'üôÇ')">
                                    <span class="option-emoji">üôÇ</span>
                                    <span class="option-text">Bueno</span>
                                </div>
                                <div class="dropdown-option" data-value="neutral"
                                     onclick="selectOption('entrySetDropdown', 'neutral', 'Neutral', 'üòê')">
                                    <span class="option-emoji">üòê</span>
                                    <span class="option-text">Neutral</span>
                                </div>
                                <div class="dropdown-option" data-value="ansioso"
                                     onclick="selectOption('entrySetDropdown', 'ansioso', 'Ansioso', 'üò∞')">
                                    <span class="option-emoji">üò∞</span>
                                    <span class="option-text">Ansioso</span>
                                </div>
                                <div class="dropdown-option" data-value="triste"
                                     onclick="selectOption('entrySetDropdown', 'triste', 'Triste', 'üò¢')">
                                    <span class="option-emoji">üò¢</span>
                                    <span class="option-text">Triste</span>
                                </div>
                                <div class="dropdown-option" data-value="estresado"
                                     onclick="selectOption('entrySetDropdown', 'estresado', 'Estresado', 'üò§')">
                                    <span class="option-emoji">üò§</span>
                                    <span class="option-text">Estresado</span>
                                </div>
                                <div class="dropdown-option" data-value="emocionado"
                                     onclick="selectOption('entrySetDropdown', 'emocionado', 'Emocionado', 'ü§©')">
                                    <span class="option-emoji">ü§©</span>
                                    <span class="option-text">Emocionado</span>
                                </div>
                                <div class="dropdown-option" data-value="introspectivo"
                                     onclick="selectOption('entrySetDropdown', 'introspectivo', 'Introspectivo', 'ü§î')">
                                    <span class="option-emoji">ü§î</span>
                                    <span class="option-text">Introspectivo</span>
                                </div>
                                <div class="dropdown-option" data-value="creativo"
                                     onclick="selectOption('entrySetDropdown', 'creativo', 'Creativo', 'üé®')">
                                    <span class="option-emoji">üé®</span>
                                    <span class="option-text">Creativo</span>
                                </div>
                                <div class="dropdown-option" data-value="curioso"
                                     onclick="selectOption('entrySetDropdown', 'curioso', 'Curioso', 'üßê')">
                                    <span class="option-emoji">üßê</span>
                                    <span class="option-text">Curioso</span>
                                </div>
                                <div class="dropdown-option" data-value="aburrido"
                                     onclick="selectOption('entrySetDropdown', 'aburrido', 'Aburrido', 'üò¥')">
                                    <span class="option-emoji">üò¥</span>
                                    <span class="option-text">Aburrido</span>
                                </div>
                                <div class="dropdown-option" data-value="desanimado"
                                     onclick="selectOption('entrySetDropdown', 'desanimado', 'Desanimado', 'üò®')">
                                    <span class="option-emoji">üò®</span>
                                    <span class="option-text">Desanimado</span>
                                </div>
                                <div class="dropdown-option" data-value="Pain crisis"
                                     onclick="selectOption('entrySetDropdown', 'Pain crisis', 'Pain crisis', 'üö®')">
                                    <span class="option-emoji">üö®</span>
                                    <span class="option-text">Pain crisis</span>
                                </div>
                            </div>
                            <input type="hidden" id="entrySet" name="entrySet">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Setting (Entorno)</label>
                        <div class="custom-dropdown" id="entrySettingDropdown">
                            <div class="dropdown-header"
                                 onclick="toggleDropdown('entrySettingDropdown')">
                                <span class="dropdown-text">Seleccionar...</span>
                                <span class="dropdown-arrow">‚ñº</span>
                            </div>
                            <div class="dropdown-options" id="entrySettingOptions">
                                <div class="dropdown-option" data-value="casa"
                                     onclick="selectOption('entrySettingDropdown', 'casa', 'En casa', 'üè†')">
                                    <span class="option-emoji">üè†</span>
                                    <span class="option-text">En casa</span>
                                </div>
                                <div class="dropdown-option" data-value="programando"
                                     onclick="selectOption('entrySettingDropdown', 'programando', 'Programando/Estudiando', 'üíª')">
                                    <span class="option-emoji">üíª</span>
                                    <span class="option-text">Programando/Estudiando</span>
                                </div>
                                <div class="dropdown-option" data-value="seriefilo"
                                     onclick="selectOption('entrySettingDropdown', 'seriefilo', 'Seriefilo, pelis o m√∫sica', 'üé¨üéµ')">
                                    <span class="option-emoji">üé¨üéµ</span>
                                    <span class="option-text">Seriefilo, pelis o m√∫sica</span>
                                </div>
                                <div class="dropdown-option" data-value="meditacion"
                                     onclick="selectOption('entrySettingDropdown', 'meditacion', 'Meditaci√≥n/Yoga', 'üßò')">
                                    <span class="option-emoji">üßò</span>
                                    <span class="option-text">Meditaci√≥n/Yoga</span>
                                </div>
                                <div class="dropdown-option" data-value="paseo"
                                     onclick="selectOption('entrySettingDropdown', 'paseo', 'Paseo/Calle', 'üö∂')">
                                    <span class="option-emoji">üö∂</span>
                                    <span class="option-text">Paseo/Calle</span>
                                </div>
                                <div class="dropdown-option" data-value="naturaleza"
                                     onclick="selectOption('entrySettingDropdown', 'naturaleza', 'Naturaleza', 'üå≤')">
                                    <span class="option-emoji">üå≤</span>
                                    <span class="option-text">Naturaleza</span>
                                </div>
                                <div class="dropdown-option" data-value="fiesta"
                                     onclick="selectOption('entrySettingDropdown', 'fiesta', 'Fiesta/Evento', 'üéâ')">
                                    <span class="option-emoji">üéâ</span>
                                    <span class="option-text">Fiesta/Evento</span>
                                </div>
                                <div class="dropdown-option" data-value="festival"
                                     onclick="selectOption('entrySettingDropdown', 'festival', 'Festival', 'üé™')">
                                    <span class="option-emoji">üé™</span>
                                    <span class="option-text">Festival</span>
                                </div>
                                <div class="dropdown-option" data-value="amigos"
                                     onclick="selectOption('entrySettingDropdown', 'amigos', 'Con amigos', 'üë•')">
                                    <span class="option-emoji">üë•</span>
                                    <span class="option-text">Con amigos</span>
                                </div>
                                <div class="dropdown-option" data-value="solo"
                                     onclick="selectOption('entrySettingDropdown', 'solo', 'Solo/a', 'üë§')">
                                    <span class="option-emoji">üë§</span>
                                    <span class="option-text">Solo/a</span>
                                </div>
                                <div class="dropdown-option" data-value="pareja"
                                     onclick="selectOption('entrySettingDropdown', 'pareja', 'En pareja', 'üíë')">
                                    <span class="option-emoji">üíë</span>
                                    <span class="option-text">En pareja</span>
                                </div>
                                <div class="dropdown-option" data-value="concierto"
                                     onclick="selectOption('entrySettingDropdown', 'concierto', 'Concierto', 'üéµ')">
                                    <span class="option-emoji">üéµ</span>
                                    <span class="option-text">Concierto</span>
                                </div>
                                <div class="dropdown-option" data-value="ceremonia"
                                     onclick="selectOption('entrySettingDropdown', 'ceremonia', 'Ceremonia', 'üïØÔ∏è')">
                                    <span class="option-emoji">üïØÔ∏è</span>
                                    <span class="option-text">Ceremonia</span>
                                </div>
                            </div>
                            <input type="hidden" id="entrySetting" name="entrySetting">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Notas adicionales</label>
                        <textarea id="entryNotes"
                                  placeholder="ROA (v√≠a de administraci√≥n), efectos esperados, compa√±√≠a, m√∫sica, etc..."
                                  rows="4"></textarea>
                        <small style="color: var(--text-muted); font-size: 0.8rem;">
                            üí° Tip: Incluye ROA (oral, sublingual, nasal, etc.), testing, pureza
                            estimada, etc.
                        </small>
                    </div>

                    <button type="submit" class="btn-primary">üíæ Guardar Registro</button>
                </form>
            </div>
        </div>

        <!-- Add Substance Modal -->
        <div id="substanceModal" class="modal">
            <div class="modal-content">
                <button class="close-btn" onclick="closeModal('substanceModal')">√ó</button>
                <h3>A√±adir Nueva Sustancia</h3>
                <form id="substanceForm" onsubmit="return false;">
                    <div class="form-group">
                        <label>Nombre</label>
                        <input type="text" id="substanceName"
                               placeholder="LSD, MDMA, Psilocibina..." required>
                    </div>
                    <div class="form-group">
                        <label>Emoji Personalizado (opcional)</label>
                        <div class="emoji-picker">
                            <input type="text" id="substanceEmoji" placeholder="üç™" maxlength="4"
                                   style="font-size: 1.5rem; text-align: center; width: 60px;">
                            <button type="button" onclick="suggestEmoji()" class="btn-secondary"
                                    style="padding: 0.5rem; font-size: 0.8rem;">üí° Sugerir
                            </button>
                            <span class="emoji-suggestion">üí° Deja vac√≠o para auto-detectar</span>
                        </div>
                    </div>
                    <div class="color-picker-container">
                        <label>Color Identificativo</label>
                        <div class="color-options">
                            <div class="color-option" data-color="#8B5CF6"
                                 style="background: #8B5CF6"></div>
                            <div class="color-option" data-color="#EC4899"
                                 style="background: #EC4899"></div>
                            <div class="color-option" data-color="#06B6D4"
                                 style="background: #06B6D4"></div>
                            <div class="color-option" data-color="#F97316"
                                 style="background: #F97316"></div>
                            <div class="color-option" data-color="#10B981"
                                 style="background: #10B981"></div>
                            <div class="color-option" data-color="#F59E0B"
                                 style="background: #F59E0B"></div>
                            <div class="color-option" data-color="#EF4444"
                                 style="background: #EF4444"></div>
                            <div class="color-option" data-color="#8B5A2B"
                                 style="background: #8B5A2B"></div>
                            <div class="color-option" data-color="#6366F1"
                                 style="background: #6366F1"></div>
                            <div class="color-option" data-color="#84CC16"
                                 style="background: #84CC16"></div>
                            <div class="color-option" data-color="#F472B6"
                                 style="background: #F472B6"></div>
                            <div class="color-option" data-color="#14B8A6"
                                 style="background: #14B8A6"></div>
                            <!-- Nuevos colores a√±adidos -->
                            <div class="color-option" data-color="#A855F7"
                                 style="background: #A855F7"></div>
                            <div class="color-option" data-color="#E91E63"
                                 style="background: #E91E63"></div>
                            <div class="color-option" data-color="#00BCD4"
                                 style="background: #00BCD4"></div>
                            <div class="color-option" data-color="#FF9800"
                                 style="background: #FF9800"></div>
                            <div class="color-option" data-color="#4CAF50"
                                 style="background: #4CAF50"></div>
                            <div class="color-option" data-color="#FFC107"
                                 style="background: #FFC107"></div>
                            <div class="color-option" data-color="#F44336"
                                 style="background: #F44336"></div>
                            <div class="color-option" data-color="#795548"
                                 style="background: #795548"></div>
                            <div class="color-option" data-color="#3F51B5"
                                 style="background: #3F51B5"></div>
                            <div class="color-option" data-color="#8BC34A"
                                 style="background: #8BC34A"></div>
                            <div class="color-option" data-color="#E91E63"
                                 style="background: #E91E63"></div>
                            <div class="color-option" data-color="#009688"
                                 style="background: #009688"></div>
                            <div class="color-option" data-color="#9C27B0"
                                 style="background: #9C27B0"></div>
                            <div class="color-option" data-color="#FF5722"
                                 style="background: #FF5722"></div>
                            <div class="color-option" data-color="#607D8B"
                                 style="background: #607D8B"></div>
                        </div>
                    </div>
                    <button type="button" class="btn-primary" onclick="addSubstance()">A√±adir
                        Sustancia
                    </button>
                </form>
            </div>
        </div>

        <script>
            // Global variables
            let currentDate = new Date();
            let isEditMode = false;
            let currentEditingEntryId = null;
            let substances = [];
            let entries = [];
            let userProfile = {};
            let selectedSubstanceColor = '#8B5CF6';
            let selectedSubstanceFilter = null;

            // Funci√≥n para sincronizar datos desde localStorage
            function syncDataFromStorage() {
                try {
                    // Cargar sustancias
                    const storedSubstances = localStorage.getItem('substances');
                    if (storedSubstances) {
                        substances = JSON.parse(storedSubstances);
                    } else {
                        substances = getDefaultSubstances();
                        localStorage.setItem('substances', JSON.stringify(substances));
                    }

                    // Cargar entradas
                    const storedEntries = localStorage.getItem('entries');
                    if (storedEntries) {
                        entries = JSON.parse(storedEntries);
                        // Asegurar que todos los registros tengan la estructura completa
                        entries = entries.map(entry => ({
                            id: entry.id || generateUniqueId(),
                            substance: entry.substance || '',
                            dose: entry.dose || 0,
                            unit: entry.unit || '',
                            date: entry.date || new Date().toISOString(),
                            set: entry.set || '',
                            setting: entry.setting || '',
                            notes: entry.notes || '',
                            createdAt: entry.createdAt || new Date().toISOString(),
                            updatedAt: entry.updatedAt || ''
                        }));
                    } else {
                        entries = [];
                        localStorage.setItem('entries', JSON.stringify(entries));
                    }

                    // Cargar perfil de usuario
                    const storedProfile = localStorage.getItem('userProfile');
                    if (storedProfile) {
                        userProfile = JSON.parse(storedProfile);
                    } else {
                        userProfile = {};
                        localStorage.setItem('userProfile', JSON.stringify(userProfile));
                    }


                } catch (error) {
                    console.error('Error sincronizando datos:', error);
                    // En caso de error, resetear a valores por defecto
                    substances = getDefaultSubstances();
                    entries = [];
                    userProfile = {};
                    localStorage.setItem('substances', JSON.stringify(substances));
                    localStorage.setItem('entries', JSON.stringify(entries));
                    localStorage.setItem('userProfile', JSON.stringify(userProfile));
                }
            }

            // Funci√≥n para guardar datos en localStorage
            function saveDataToStorage() {
                try {
                    localStorage.setItem('substances', JSON.stringify(substances));
                    localStorage.setItem('entries', JSON.stringify(entries));
                    localStorage.setItem('userProfile', JSON.stringify(userProfile));
                } catch (error) {
                    console.error('Error guardando datos:', error);
                }
            }

            function safeSetValue(id, value) {
                const el = document.getElementById(id);
                if (el) el.value = value;
            }

            function waitForElement(id, cb, retries = 30, delay = 20) {
                const el = document.getElementById(id);
                if (el) return cb(el);
                if (retries <= 0) return;
              setTimeout(() => waitForElement(id, cb, retries - 1, delay), delay);
            }

            function toLocalDateTimeString(d) {
                const y = d.getFullYear();
                const m = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                const h = String(d.getHours()).padStart(2, '0');
                const min = String(d.getMinutes()).padStart(2, '0');
              return `${y}-${m}-${day}T${h}:${min}`;
            }






            // Funci√≥n para sugerir emoji basado en el nombre de la sustancia
            function suggestEmoji() {
                const substanceNameInput = document.getElementById('substanceName');
                const substanceEmojiInput = document.getElementById('substanceEmoji');

                if (!substanceNameInput || !substanceEmojiInput) {
                    return;
                }

                const substanceName = substanceNameInput.value.trim();
                if (substanceName) {
                    const suggestedEmoji = getSubstanceEmoji(substanceName);
                    substanceEmojiInput.value = suggestedEmoji;
                    showCustomAlert(`üí° Emoji sugerido: ${suggestedEmoji}`, 'üí° Sugerencia');
                } else {
                    showCustomAlert('‚ö†Ô∏è Primero escribe el nombre de la sustancia', '‚ö†Ô∏è Campo Requerido');
                }
            }

            // Funci√≥n para actualizar el dropdown de sustancias
            function updateSubstanceDropdown() {
                if (document.getElementById('entryModal').classList.contains('active')) {
                    populateSubstanceDropdown();
                }
            }

            // Funci√≥n para obtener el emoji apropiado para cada sustancia
            function getSubstanceEmoji(substanceName) {
            const emojiMap = {
                'LSD': 'üåà',
                'Ketamina': '‚ùÑÔ∏è',
                'Opio': 'üåø',
                'MDMA': 'üíé',
                'Coca√≠na': '‚ùÑÔ∏è',
                'Anfetamina': '‚ö°',
                'Cannabis': 'üåø',
                'Psilocibina': 'üçÑ',
                'DMT': 'üëÅÔ∏è',
                'Mescalina': 'üåµ',
                '2C-B': 'ü¶ã',
                'NBOMe': 'üíä',
                'MDA': 'üíé',
                'Meth': '‚ö°',
                'Hero√≠na': 'üåø',
                'Morfina': 'üåø',
                'Fentanilo': 'üíä',
                'Code√≠na': 'üíä',
                'Tramadol': 'üíä',
                'Benzodiazepinas': 'üíä',
                'Alcohol': 'üç∑',
                'Nicotina': 'üö¨',
                'Cafe√≠na': '‚òï',
                'Cookies': 'üç™',
                'Caf√©': '‚òï',
                'Caf√© fr√≠o': 'üßä‚òï',
                'Diacetilmorfina': 'üåø',
                'Heroina': 'üåø',
                'Marihuana': 'üåø',
                'Hach√≠s': 'üåø',
                'Crack': 'üíé',
                'Speed': '‚ö°',
                '√âxtasis': 'üíé',
                'P√≠ldoras': 'üíä',
                'Comprimidos': 'üíä',
                'Gotas': 'üíß',
                'Polvo': '‚ùÑÔ∏è',
                'Cristal': 'üíé',
                'L√≠quido': 'üíß',
                'Vapor': 'üí®',
                'Inhalado': 'üí®',
                'Inyectado': 'üíâ',
                'Oral': 'üëÑ',
                'Nasal': 'üëÉ',
                'Sublingual': 'üëÖ'
            };

            // Buscar coincidencia exacta primero
            if (emojiMap[substanceName]) {
                return emojiMap[substanceName];
            }

            // Buscar coincidencias parciales m√°s inteligentes
            const lowerName = substanceName.toLowerCase();

            // Buscar por palabras clave espec√≠ficas
            if (lowerName.includes('lsd') || lowerName.includes('√°cido')) return 'üåà';
            if (lowerName.includes('ketamina') || lowerName.includes('ket')) return '‚ùÑÔ∏è';
            if (lowerName.includes('opio') || lowerName.includes('hero√≠na') || lowerName.includes('morfina') || lowerName.includes('diacetilmorfina')) return 'üåø';
            if (lowerName.includes('mdma') || lowerName.includes('√©xtasis')) return 'üíé';
            if (lowerName.includes('coca√≠na') || lowerName.includes('coca')) return '‚ùÑÔ∏è';
            if (lowerName.includes('anfetamina') || lowerName.includes('speed') || lowerName.includes('meth')) return '‚ö°';
            if (lowerName.includes('cannabis') || lowerName.includes('marihuana') || lowerName.includes('hach√≠s')) return 'üåø';
            if (lowerName.includes('psilocibina') || lowerName.includes('hongos')) return 'üçÑ';
            if (lowerName.includes('dmt')) return 'üëÅÔ∏è';
            if (lowerName.includes('mescalina') || lowerName.includes('peyote')) return 'üåµ';
            if (lowerName.includes('2c-b') || lowerName.includes('2cb')) return 'ü¶ã';
            if (lowerName.includes('alcohol') || lowerName.includes('vino') || lowerName.includes('cerveza')) return 'üç∑';
            if (lowerName.includes('nicotina') || lowerName.includes('tabaco')) return 'üö¨';
            if (lowerName.includes('cafe√≠na') || lowerName.includes('caf√©') || lowerName.includes('t√©')) return '‚òï';

            // Emojis por categor√≠as generales
            if (lowerName.includes('cookie') || lowerName.includes('galleta') || lowerName.includes('cookies')) return 'üç™';
            if (lowerName.includes('p√≠ldora') || lowerName.includes('comprimido') || lowerName.includes('tableta')) return 'üíä';
            if (lowerName.includes('polvo') || lowerName.includes('cristal')) return '‚ùÑÔ∏è';
            if (lowerName.includes('l√≠quido') || lowerName.includes('gotas')) return 'üíß';
            if (lowerName.includes('vapor') || lowerName.includes('inhalado')) return 'üí®';
            if (lowerName.includes('inyectado')) return 'üíâ';
            if (lowerName.includes('oral') || lowerName.includes('sublingual')) return 'üëÑ';
            if (lowerName.includes('nasal')) return 'üëÉ';

            // Buscar en el mapa de emojis por coincidencias parciales
            for (const [key, emoji] of Object.entries(emojiMap)) {
                if (lowerName.includes(key.toLowerCase()) || key.toLowerCase().includes(lowerName)) {
                    return emoji;
                }
            }

            // Emoji por defecto
            return 'üíä';
        }

        // Default substances
        function getDefaultSubstances() {
            return [
                {
                    id: generateUniqueId(),
                    name: 'LSD',
                    color: '#8B5CF6',
                    createdAt: new Date().toISOString()
                },
                {
                    id: generateUniqueId(),
                    name: 'Ketamina',
                    color: '#06B6D4',
                    createdAt: new Date().toISOString()
                },
                {
                    id: generateUniqueId(),
                    name: 'Opio',
                    color: '#8B5A2B',
                    createdAt: new Date().toISOString()
                }
            ];
        }



        // Funci√≥n para sincronizar datos desde localStorage (para importaci√≥n)
        function syncDataFromStorage() {
            try {
                const storedSubstances = localStorage.getItem('substances');
                const storedEntries = localStorage.getItem('entries');
                const storedProfile = localStorage.getItem('userProfile');
                
                if (storedSubstances) {
                    substances = JSON.parse(storedSubstances);
                }
                
                if (storedEntries) {
                    entries = JSON.parse(storedEntries);
                }
                
                if (storedProfile) {
                    userProfile = JSON.parse(storedProfile);
                }
            } catch (error) {
                console.error('Error sincronizando datos:', error);
            }
        }

        // Funci√≥n espec√≠fica para despu√©s de importaci√≥n
        function refreshAfterImport() {
            try {
                // Forzar recarga desde localStorage
                syncDataFromStorage();
                
                // Regenerar toda la interfaz
                generateCalendar();
                renderSubstanceList();
                renderStats();
                
                // Si hay un modal abierto con entradas, cerrarlo para evitar problemas
                const dayModal = document.getElementById('day-entries-modal');
                if (dayModal) {
                    dayModal.remove();
                }
            } catch (error) {
                console.error('Error refrescando despu√©s de importar:', error);
            }
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
        });

                 function initializeApp() {
             try {
                 // Sincronizar datos desde localStorage
                 syncDataFromStorage();
                 
                 // Initialize UI components
                 generateCalendar();
                 renderSubstanceList();
                 renderStats();

                 // Set current datetime for entry form
                 const now = new Date();
                 const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
                 const dateTimeInput = document.getElementById('entryDateTime');
                 if (dateTimeInput) {
                     dateTimeInput.value = localDateTime;
                 }
             } catch (error) {
                 console.error('Error initializing app:', error);
                 showCustomAlert(`Error al inicializar la aplicaci√≥n: ${error.message}`, '‚ùå Error de Inicializaci√≥n');
             }
         }

        function setupEventListeners() {
            // Entry form
            document.getElementById('entryForm').addEventListener('submit', function(e) {
                e.preventDefault();
                addEntry();
            });

            // Substance form
            document.getElementById('substanceForm').addEventListener('submit', function(e) {
                e.preventDefault();
                addSubstance();
            });

            // Color picker
            document.querySelectorAll('.color-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedSubstanceColor = this.dataset.color;
                });
            });

            // Quote character counter
            const quoteTextarea = document.getElementById('newQuote');
            if (quoteTextarea) {
                quoteTextarea.addEventListener('input', function() {
                    document.getElementById('charCount').textContent = this.value.length;
                });
            }
        }

        // Navigation functions
        function switchView(viewName) {
            // Hide all views
            document.querySelectorAll('.view').forEach(view => {
                view.style.display = 'none';
            });

            // Show selected view
            const targetView = document.getElementById(viewName + '-view');
            if (targetView) {
                targetView.style.display = 'grid';
            } else {
                console.error('View not found:', viewName + '-view');
                return;
            }

            // Update navigation active state
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            const navMapping = {
                'calendar': 0,
                'stats': 2,
                'resources': 3,
                'data': 4,
                'profile': 5
            };

            const navItems = document.querySelectorAll('.nav-item');
            const navIndex = navMapping[viewName];
            if (navItems[navIndex]) {
                navItems[navIndex].classList.add('active');
            }

            // Regenerate content for specific views
            if (viewName === 'stats') {
                renderStats();
            }
        }

        // Modal functions
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.add('active');
            document.body.style.overflow = 'hidden'; // Prevent background scrolling

            // Populate dropdowns when opening modals
            if (modalId === 'entryModal') {
                populateSubstanceDropdown();
                // Reset form for new entry, or prepare for edit if already in edit mode
                if (!isEditMode) {
                    resetEntryForm();
                }
            } else if (modalId === 'substanceModal') {
                // Reset color selection when opening substance modal
                document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
                const firstColorOption = document.querySelector('.color-option');
                if (firstColorOption) {
                    firstColorOption.classList.add('selected');
                    selectedSubstanceColor = firstColorOption.dataset.color;
                }
            } else if (modalId === 'favoritesModal') {
                populateFavoriteDropdown();
                renderFavorites();
            } else if (modalId === 'quotesModal') {
                renderQuotes();
            } else if (modalId === 'socialModal') {
                loadSocialLinks();
            } else if (modalId === 'shareProfileModal') {
                updateProfileCard();
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            document.body.style.overflow = ''; // Restore background scrolling
            resetEditMode(); // Always reset edit mode when closing entry modal
        }

        // Calendar functions
        function generateCalendar() {

            const grid = document.getElementById('calendar-grid');
            const monthName = currentDate.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
            document.getElementById('current-month').textContent = monthName.charAt(0).toUpperCase() + monthName.slice(1);

            // Clear grid
            grid.innerHTML = '';

            // Add day headers
            const dayHeaders = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
            dayHeaders.forEach(day => {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day day-header';
                dayElement.textContent = day;
                grid.appendChild(dayElement);
            });

            // Get first day of month and number of days
            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());

            // Generate calendar days
            for (let i = 0; i < 42; i++) {
                const day = new Date(startDate);
                day.setDate(startDate.getDate() + i);

                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = day.getDate();

                // Check if day has entries
                let dayEntries = entries.filter(entry => {
                    const entryDate = new Date(entry.date);
                    return entryDate.toDateString() === day.toDateString();
                });

                // Apply substance filter if one selected
                if (selectedSubstanceFilter) {
                    dayEntries = dayEntries.filter(entry => entry.substance === selectedSubstanceFilter);
                }

                if (dayEntries.length > 0) {
                    dayElement.classList.add('has-entry');

                    // Get unique substances for this day
                    const uniqueSubstances = [...new Set(dayEntries.map(entry => entry.substance))];

                    if (uniqueSubstances.length === 1) {
                        // Single substance - use solid color
                        const substance = substances.find(s => s.name === uniqueSubstances[0]);
                        const color = substance ? substance.color : '#8B5CF6';
                        dayElement.classList.add('single-substance');
                        dayElement.style.background = color;
                        dayElement.style.boxShadow = `0 0 10px ${color}50`;
                    } else if (uniqueSubstances.length > 1) {
                        // Multiple substances - create gradient
                        const colors = uniqueSubstances.map(substanceName => {
                            const substance = substances.find(s => s.name === substanceName);
                            return substance ? substance.color : '#8B5CF6';
                        });

                        dayElement.classList.add('multiple-substances');

                        if (colors.length === 2) {
                            dayElement.style.background = `linear-gradient(135deg, ${colors[0]} 0%, ${colors[1]} 100%)`;
                        } else if (colors.length === 3) {
                            dayElement.style.background = `linear-gradient(135deg, ${colors[0]} 0%, ${colors[1]} 50%, ${colors[2]} 100%)`;
                        } else {
                            // More than 3 colors - create a more complex gradient
                            const step = 100 / colors.length;
                            const gradientStops = colors.map((color, index) => `${color} ${index * step}%`).join(', ');
                            dayElement.style.background = `linear-gradient(135deg, ${gradientStops})`;
                        }

                        // Add subtle animation for multiple substances
                        dayElement.style.animation = 'colorShift 3s ease-in-out infinite';
                    }

                    // Add substance indicators (small dots)
                    const indicators = document.createElement('div');
                    indicators.className = 'substance-indicators';

                    uniqueSubstances.slice(0, 4).forEach(substanceName => {
                        const substance = substances.find(s => s.name === substanceName);
                        const dot = document.createElement('div');
                        dot.className = 'substance-dot';
                        dot.style.backgroundColor = substance ? substance.color : '#8B5CF6';
                        dot.title = substanceName; // Tooltip
                        indicators.appendChild(dot);
                    });

                    dayElement.appendChild(indicators);
                }

                // Dim days from other months
                if (day.getMonth() !== currentDate.getMonth()) {
                    dayElement.style.opacity = '0.3';
                }

                // Add click event
                dayElement.addEventListener('click', () => showDayEntries(day));

                grid.appendChild(dayElement);
            }
        }

        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            generateCalendar();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            generateCalendar();
        }

        // Function to show entries for a specific day
        function showDayEntries(date) {
            let dayEntries = entries.filter(entry => {
                const entryDate = new Date(entry.date);
                return entryDate.toDateString() === date.toDateString();
            });

            // Apply substance filter if selected
            if (selectedSubstanceFilter) {
                dayEntries = dayEntries.filter(entry => entry.substance === selectedSubstanceFilter);
            }

            if (dayEntries.length === 0) {
                showCustomConfirm(
                    'No hay registros para este d√≠a. ¬øQuieres a√±adir uno?',
                    'üìÖ D√≠a sin Registros',
                    () => addNewEntryForDate(date)
                );
                return;
            }

            let content = `<h3>üìÖ Registros del ${date.toLocaleDateString('es-ES', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            })}</h3>`;

            if (selectedSubstanceFilter) {
                content += `<p style="color: var(--accent-cyan); margin-bottom: 1rem;">Filtrado por: ${selectedSubstanceFilter}</p>`;
            }

                            dayEntries.forEach((entry) => {
                    const time = new Date(entry.date).toLocaleTimeString('es-ES', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    const substance = substances.find(s => s.name === entry.substance);
                    const substanceColor = substance ? substance.color : '#8B5CF6';

                    content += `
                        <div class="entry-item" style="border-left: 4px solid ${substanceColor};">
                            <div class="entry-header">
                                <span class="entry-substance">${entry.substance}</span>
                                <span class="entry-time">${time}</span>
                            </div>
                            <div class="entry-dose">üíä ${entry.dose} ${entry.unit}</div>
                            ${entry.set ? `<div class="entry-meta">üß† Set: ${entry.set}</div>` : ''}
                            ${entry.setting ? `<div class="entry-meta">üèûÔ∏è Setting: ${entry.setting}</div>` : ''}
                            ${entry.notes ? `<div class="entry-notes">üìù ${entry.notes}</div>` : ''}
                            <div class="entry-actions" style="margin-top: 0.5rem;">
                                <button class="btn-edit" data-entry-id="${entry.id}">‚úèÔ∏è Editar</button>
                                <button class="btn-delete" data-entry-id="${entry.id}">üóëÔ∏è Eliminar</button>
                            </div>
                        </div>
                    `;
                });

            content += `
                <div style="margin-top: 1rem; text-align: center;">
                    <button id="add-entry-for-date-btn" class="btn-primary" data-date="${date.getTime()}" style="padding: 0.5rem 1rem; font-size: 1rem;">
                        ‚ûï A√±adir Registro para este D√≠a
                    </button>
                </div>
            `;

            const modalId = 'day-entries-modal';
            const existingModal = document.getElementById(modalId);
            if (existingModal) {
                existingModal.remove();
            }

            const modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <button class="close-btn" id="close-day-modal">√ó</button>
                    ${content}
                </div>
            `;

            document.body.appendChild(modal);
            document.body.style.overflow = 'hidden';

            // Attach event listeners AFTER the modal is in the DOM
            setTimeout(() => {
                document.getElementById('close-day-modal').addEventListener('click', closeDayModal);

                document.querySelectorAll(`#${modalId} .btn-edit`).forEach(button => {
                    button.addEventListener('click', (e) => {
                        const entryId = e.currentTarget.dataset.entryId;
                        editEntryFromCalendar(entryId);
                    });
                });

                document.querySelectorAll(`#${modalId} .btn-delete`).forEach(button => {
                    button.addEventListener('click', (e) => {
                        const entryId = e.currentTarget.dataset.entryId;
                        deleteEntryFromCalendar(entryId);
                    });
                });

                document.getElementById('add-entry-for-date-btn').addEventListener('click', (e) => {
                    const dateString = e.currentTarget.dataset.date;
                    addNewEntryForDate(dateString);
                });
            }, 50); // Small delay to ensure DOM is ready

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeDayModal();
                }
            });
        }

        function closeDayModal() {
            const modal = document.getElementById('day-entries-modal');
            if (modal) {
                modal.remove();
            }
            document.body.style.overflow = '';
        }

        function addNewEntryForDate(dateInput) {
            closeDayModal();
            resetEditMode();
            openModal('entryModal');

            const d = new Date(dateInput);
            const localDateTime = toLocalDateTimeString(d);

            // Espera a que exista el input en WebView:
            waitForElement('entryDateTime', (input) => { input.value = localDateTime; });
        }


        function editEntryFromCalendar(entryId) {
            const entry = entries.find(e => e.id === entryId);
            if (!entry) { showCustomAlert('‚ùå Registro no encontrado', '‚ùå Error'); return; }

            closeDayModal();
            isEditMode = true;
            currentEditingEntryId = entryId;

            populateSubstanceDropdown();

            const substanceHeaderText = document.querySelector('#entrySubstanceDropdown .dropdown-text');
            const substanceHiddenInput = document.getElementById('entrySubstance');
            if (substanceHeaderText && substanceHiddenInput) {
                substanceHiddenInput.value = entry.substance;
                substanceHeaderText.textContent = `${getSubstanceEmoji(entry.substance)} ${entry.substance}`;
            }

            openModal('entryModal'); // tras esto a√∫n puede tardar 1 frame

            waitForElement('entryDose',      el => el.value = entry.dose);
            waitForElement('entryUnit',      el => el.value = entry.unit);
            waitForElement('entryDateTime',  el => el.value = entry.date);
            waitForElement('entrySet',       el => el.value = entry.set || '');
            waitForElement('entrySetting',   el => el.value = entry.setting || '');
            waitForElement('entryNotes',     el => el.value = entry.notes || '');

            const submitBtn = document.querySelector('#entryForm button[type="submit"]');
            if (submitBtn) {
              submitBtn.innerHTML = '‚úÖ Actualizar Registro';
              submitBtn.style.background = 'linear-gradient(135deg, var(--accent-orange), var(--secondary-pink))';
            }
        }



        function deleteEntryFromCalendar(entryId) {
            const entry = entries.find(e => e.id === entryId); // Use === for strict comparison
            if (!entry) {
                alert('‚ùå Registro no encontrado');
                return;
            }

            const confirmMessage = `¬øEst√°s seguro de que quieres eliminar este registro?\n\n${entry.substance} - ${entry.dose} ${entry.unit}\n${new Date(entry.date).toLocaleString('es-ES')}`;

            showCustomConfirm(
                confirmMessage,
                'üóëÔ∏è Confirmar Eliminaci√≥n',
                                 () => {
                     entries = entries.filter(e => e.id !== entryId); // Use !== for strict comparison
                     saveDataToStorage();

                     closeDayModal(); // Close the day entries modal

                    generateCalendar();
                    renderSubstanceList();
                    renderStats();
                    updateProfileCard(); // Update profile stats

                    showAutoCloseAlert('üóëÔ∏è Registro eliminado correctamente', '‚úÖ Eliminado');
                }
            );
        }

        // Substance functions
        function addSubstance() {
            const nameInput = document.getElementById('substanceName');
            if (!nameInput) {
                showCustomAlert('Error: Campo de nombre no encontrado', '‚ùå Error del Sistema');
                return;
            }

            const name = nameInput.value.trim();

            if (!name || name.length === 0) {
                showCustomAlert('Por favor, introduce un nombre para la sustancia', '‚ö†Ô∏è Campo Requerido');
                nameInput.focus();
                return;
            }

            // Verificar si ya existe una sustancia con el mismo nombre (excluyendo la que estamos editando)
            const existingSubstance = substances.find(s =>
                s.name.toLowerCase() === name.toLowerCase() &&
                (!window.isEditingSubstance || s.id !== window.editingSubstanceId)
            );

            if (existingSubstance) {
                showCustomAlert('Esta sustancia ya existe', '‚ö†Ô∏è Sustancia Duplicada');
                return;
            }

            if (window.isEditingSubstance && window.editingSubstanceId) {
                // MODO EDICI√ìN
                const substanceIndex = substances.findIndex(s => s.id === window.editingSubstanceId);
                if (substanceIndex !== -1) {
                    substances[substanceIndex] = {
                        ...substances[substanceIndex],
                        name: name,
                        color: selectedSubstanceColor,
                        updatedAt: new Date().toISOString()
                    };

                                             // Actualizar registros existentes si cambi√≥ el nombre
                         if (substances[substanceIndex].name !== name) {
                             entries.forEach(entry => {
                                 if (entry.substance === substances[substanceIndex].name) {
                                     entry.substance = name;
                                 }
                             });
                         }

                         saveDataToStorage();

                    showAutoCloseAlert(`‚úÖ Sustancia "${name}" actualizada correctamente`, '‚úÖ Sustancia Actualizada', 2000);
                }
            } else {
                // MODO CREACI√ìN
                const emojiInput = document.getElementById('substanceEmoji');
                const customEmoji = emojiInput ? emojiInput.value.trim() : '';
                const substance = {
                    id: generateUniqueId(),
                    name: name,
                    color: selectedSubstanceColor,
                    emoji: customEmoji || getSubstanceEmoji(name), // Usar emoji personalizado o auto-detectar
                    createdAt: new Date().toISOString()
                };

                                     substances.push(substance);
                     saveDataToStorage();

                showAutoCloseAlert(`‚úÖ Sustancia "${name}" a√±adida correctamente`, '‚úÖ Sustancia A√±adida', 2000);
            }

            // Limpiar y actualizar
            renderSubstanceList();
            generateCalendar();
            renderStats();
            updateProfileCard();

            // Actualizar el dropdown de sustancias si est√° abierto
            updateSubstanceDropdown();

            // Cerrar modal y redirigir al calendario despu√©s del alert
            setTimeout(() => {
                closeModal('substanceModal');
                // Redirect to calendar view
                switchView('calendar');
            }, 2500); // Wait for alert to fade out (2000ms) + extra time for smooth transition
            document.getElementById('substanceForm').reset();
            const emojiInput = document.getElementById('substanceEmoji');
            if (emojiInput) {
                emojiInput.value = ''; // Limpiar emoji personalizado
            }

            // Reset color selection
            document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
            selectedSubstanceColor = '#8B5CF6'; // Reset to default

            // Limpiar modo edici√≥n
            window.isEditingSubstance = false;
            window.editingSubstanceId = null;

            // Restaurar bot√≥n y t√≠tulo originales
            const submitBtn = document.querySelector('#substanceModal button[type="submit"]');
            if (submitBtn) {
                submitBtn.innerHTML = 'A√±adir Sustancia';
                submitBtn.style.background = 'linear-gradient(135deg, var(--primary-purple), var(--secondary-pink))';
            }

            const modalTitle = document.querySelector('#substanceModal h3');
            if (modalTitle) {
                modalTitle.innerHTML = '‚ûï A√±adir Nueva Sustancia';
            }
        }

        function renderSubstanceList() {
            const list = document.getElementById('substance-list');
            list.innerHTML = '';

            // Add "All substances" option first
            const allItem = document.createElement('li');
            allItem.className = 'substance-item';
            if (!selectedSubstanceFilter) {
                allItem.classList.add('active');
            }
            allItem.innerHTML = `
                <div class="substance-info">
                    <span>üìã Experiencias registradas</span>
                </div>
                <div class="substance-actions">
                    <span class="substance-count">${entries.length}</span>
                </div>
            `;
            allItem.querySelector('.substance-info').addEventListener('click', () => {
                filterBySubstance(null);
            });
            list.appendChild(allItem);

            substances.forEach(substance => {
                const count = entries.filter(entry => entry.substance === substance.name).length;

                const item = document.createElement('li');
                item.className = 'substance-item';

                // Add active class if this substance is selected
                if (selectedSubstanceFilter === substance.name) {
                    item.classList.add('active');
                }

                item.innerHTML = `
                    <div class="substance-info">
                        <span>${substance.name}</span>
                    </div>
                    <div class="substance-actions">
                        <span class="substance-count">${count}</span>
                        <button class="edit-substance-btn" data-substance-id="${substance.id}" title="Editar sustancia">‚úèÔ∏è</button>
                        <button class="delete-substance-btn" data-substance-id="${substance.id}" title="Eliminar sustancia">√ó</button>
                    </div>
                `;
                item.style.borderLeft = `4px solid ${substance.color}`;
                item.style.backgroundColor = `${substance.color}15`; // Lighten color for background

                // Add click event for filtering (exclude the delete button)
                item.querySelector('.substance-info').addEventListener('click', () => {
                    filterBySubstance(substance.name);
                });

                // Attach event listener for edit button
                item.querySelector('.edit-substance-btn').addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent filtering when clicking edit
                    const substanceId = e.currentTarget.dataset.substanceId;
                    editSubstance(substanceId);
                });

                // Attach event listener for delete button
                item.querySelector('.delete-substance-btn').addEventListener('click', (e) => {
                    const substanceId = e.currentTarget.dataset.substanceId;
                    deleteSubstance(substanceId);
                });

                list.appendChild(item);
            });
        }

        function resetEditMode() {
            isEditMode = false;
            currentEditingEntryId = null;

            const submitBtn = document.querySelector('#entryForm button[type="submit"]');
            if (submitBtn) {
                submitBtn.innerHTML = 'üíæ Guardar Registro';
                submitBtn.style.background = 'linear-gradient(135deg, var(--primary-purple), var(--secondary-pink))';
            }
            resetEntryForm(); // Also reset the form fields
        }

        function resetEntryForm() {
            const form = document.getElementById('entryForm');
            if (form) form.reset();

            // Fecha y hora por defecto: ahora (local)
            const now = new Date();
            const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
                .toISOString()
                .slice(0, 16);
            const dateTimeInput = document.getElementById('entryDateTime');
            if (dateTimeInput) {
                dateTimeInput.value = localDateTime;
            }

            // Sustancia
            const substanceHeaderText = document.querySelector('#entrySubstanceDropdown .dropdown-text');
            const substanceHiddenInput = document.getElementById('entrySubstance');
            if (substanceHeaderText && substanceHiddenInput) {
                substanceHeaderText.textContent = 'Selecciona una sustancia...';
                substanceHiddenInput.value = '';
                document.querySelectorAll('#entrySubstanceDropdown .dropdown-option').forEach(opt => opt.classList.remove('selected'));
            }

            // Unidad (volver a placeholder "Seleccionar unidad...")
            const unitHeaderText = document.querySelector('#entryUnitDropdown .dropdown-text');
            const unitHiddenInput = document.getElementById('entryUnit');
            if (unitHeaderText && unitHiddenInput) {
                unitHeaderText.textContent = 'Seleccionar unidad...';
                unitHiddenInput.value = '';
                document.querySelectorAll('#entryUnitDropdown .dropdown-option').forEach(opt => opt.classList.remove('selected'));
            }

            // Set (estado mental)
            const setHeaderText = document.querySelector('#entrySetDropdown .dropdown-text');
            const setHiddenInput = document.getElementById('entrySet');
            if (setHeaderText && setHiddenInput) {
                setHeaderText.textContent = 'Seleccionar...';
                setHiddenInput.value = '';
                document.querySelectorAll('#entrySetDropdown .dropdown-option').forEach(opt => opt.classList.remove('selected'));
            }

            // Setting (entorno)
            const settingHeaderText = document.querySelector('#entrySettingDropdown .dropdown-text');
            const settingHiddenInput = document.getElementById('entrySetting');
            if (settingHeaderText && settingHiddenInput) {
                settingHeaderText.textContent = 'Seleccionar...';
                settingHiddenInput.value = '';
                document.querySelectorAll('#entrySettingDropdown .dropdown-option').forEach(opt => opt.classList.remove('selected'));
            }

            // Notas
            const notesInput = document.getElementById('entryNotes');
            if (notesInput) notesInput.value = '';
        }

        function filterBySubstance(substanceName) {
            selectedSubstanceFilter = substanceName;
            // Update active state for substances
            document.querySelectorAll('.substance-item').forEach(item => {
                item.classList.remove('active');
            });

            if (substanceName === null) {
                //Mark "Experiencias registradas" as active
                document.querySelector('.substance-item:first-child').classList.add('active');
            } else {
                // Find and mark the specific substance as active
                document.querySelectorAll('.substance-item').forEach(item => {
                   const substanceText = item.querySelector('.substance-info span').textContent;
                    if (substanceText === substanceName) {
                        item.classList.add('active');
                    }
                });
            }

            generateCalendar();
            renderSubstanceList();
            renderStats();
        }

        function deleteSubstance(substanceId) {
            const substance = substances.find(s => s.id === substanceId); // Use === for strict comparison
            if (!substance) return;

            const hasEntries = entries.some(entry => entry.substance === substance.name);

            let confirmMessage = `¬øEst√°s seguro de que quieres eliminar "${substance.name}"?`;
            if (hasEntries) {
                confirmMessage += '\n\n‚ö†Ô∏è Esta sustancia tiene registros asociados. Si la eliminas, tambi√©n se eliminar√°n todos sus registros.';
            }

            showCustomConfirm(
                confirmMessage,
                'üóëÔ∏è Confirmar Eliminaci√≥n',
                () => {
                    // Remove substance
                    substances = substances.filter(s => s.id !== substanceId); // Use !== for strict comparison

                                         // Remove related entries if any
                     if (hasEntries) {
                         entries = entries.filter(entry => entry.substance !== substance.name);
                     }

                     // Clear filter if we're filtering by this substance
                     if (selectedSubstanceFilter === substance.name) {
                         selectedSubstanceFilter = null;
                     }

                     // Guardar todos los datos
                     saveDataToStorage();

                    renderSubstanceList();
                    generateCalendar();
                    renderStats();
                    updateProfileCard(); // Update profile stats

                    showCustomAlert(`"${substance.name}" ha sido eliminada${hasEntries ? ' junto con sus registros' : ''}.`, '‚úÖ Sustancia Eliminada');
                }
            );
        }

        function editSubstance(substanceId) {
            const substance = substances.find(s => s.id === substanceId);
            if (!substance) {
                showCustomAlert('‚ùå Sustancia no encontrada', '‚ùå Error');
                return;
            }

            // Abrir el modal de sustancia en modo edici√≥n
            openModal('substanceModal');

            // Configurar el modal para edici√≥n
            const nameInput = document.getElementById('substanceName');
            if (nameInput) {
                nameInput.value = substance.name;
            }
            selectedSubstanceColor = substance.color;

            // Marcar el color correcto como seleccionado
            document.querySelectorAll('.color-option').forEach(opt => {
                opt.classList.remove('selected');
                if (opt.dataset.color === substance.color) {
                    opt.classList.add('selected');
                }
            });

            // Cambiar el bot√≥n y t√≠tulo
            const submitBtn = document.querySelector('#substanceModal button[type="submit"]');
            if (submitBtn) {
                submitBtn.innerHTML = '‚úÖ Actualizar Sustancia';
                submitBtn.style.background = 'linear-gradient(135deg, var(--accent-orange), var(--secondary-pink))';
            }

            // Cambiar el t√≠tulo del modal
            const modalTitle = document.querySelector('#substanceModal h3');
            if (modalTitle) {
                modalTitle.innerHTML = '‚úèÔ∏è Editar Sustancia';
            }

            // Configurar el modal para actualizar en lugar de crear
            window.editingSubstanceId = substanceId;
            window.isEditingSubstance = true;
        }

        function populateSubstanceDropdown() {


            const dropdownOptions = document.getElementById('entrySubstanceOptions');
            const hiddenInput = document.getElementById('entrySubstance');
            const headerText = document.querySelector('#entrySubstanceDropdown .dropdown-text');
            const currentValue = hiddenInput.value; // Guardar el valor actual

            // Limpiar opciones existentes (excepto la primera placeholder)
            dropdownOptions.innerHTML = '';

            // A√±adir opci√≥n placeholder (no seleccionable)
            const placeholderOption = document.createElement('div');
            placeholderOption.className = 'dropdown-option';
            placeholderOption.setAttribute('data-value', '');
            placeholderOption.style.opacity = '0.6';
            placeholderOption.style.cursor = 'default';
            placeholderOption.innerHTML = `
                <span class="option-emoji">üíä</span>
                <span class="option-text">Selecciona una sustancia...</span>
            `;
            dropdownOptions.appendChild(placeholderOption);

            // A√±adir opciones de sustancias
            substances.forEach(substance => {
                const option = document.createElement('div');
                option.className = 'dropdown-option';
                option.setAttribute('data-value', substance.name);
                const emoji = substance.emoji || getSubstanceEmoji(substance.name);
                option.onclick = function() {
                    selectOption('entrySubstanceDropdown', substance.name, substance.name, emoji);
                };
                option.innerHTML = `
                    <span class="option-emoji">${emoji}</span>
                    <span class="option-text">${substance.name}</span>
                `;
                dropdownOptions.appendChild(option);
            });

            // Forzar reflow para asegurar que el scroll funcione
            dropdownOptions.style.display = 'none';
            dropdownOptions.offsetHeight; // Trigger reflow
            dropdownOptions.style.display = '';

            // Restaurar el valor si estamos en modo edici√≥n
            if (currentValue && isEditMode) {
                hiddenInput.value = currentValue;
                // Buscar y marcar la opci√≥n correspondiente
                const optionToSelect = dropdownOptions.querySelector(`[data-value="${currentValue}"]`);
                if (optionToSelect) {
                    const emoji = optionToSelect.querySelector('.option-emoji').textContent;
                    headerText.textContent = `${emoji} ${currentValue}`;
                    // Marcar la opci√≥n como seleccionada
                    optionToSelect.classList.add('selected');
                }
            }
        }

        // Function to generate truly unique IDs
        function generateUniqueId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
        }

        // Entry functions - Handles both add and edit
        function addEntry() {
            const substanceInput = document.getElementById('entrySubstance');
            const doseInput = document.getElementById('entryDose');
            const unitInput = document.getElementById('entryUnit');
            const dateTimeInput = document.getElementById('entryDateTime');
            const setInput = document.getElementById('entrySet');
            const settingInput = document.getElementById('entrySetting');
            const notesInput = document.getElementById('entryNotes');

            if (!substanceInput || !doseInput || !unitInput || !dateTimeInput) {
                showCustomAlert('Error: Elementos del formulario no encontrados', '‚ùå Error del Sistema');
                return;
            }

            const substance = substanceInput.value;
            const dose = parseFloat(doseInput.value);
            const unit = unitInput.value;
            const dateTime = dateTimeInput.value;
            const set = setInput ? setInput.value : '';
            const setting = settingInput ? settingInput.value : '';
            const notes = notesInput ? notesInput.value.trim() : '';

            // Validaci√≥n mejorada para el campo sustancia
            if (!substance || substance === 'placeholder' || substance === '') {
                showCustomAlert('Por favor, selecciona una sustancia v√°lida', '‚ö†Ô∏è Sustancia Requerida');
                return;
            }

            if (!dose || isNaN(dose) || dose <= 0) {
                showCustomAlert('Por favor, introduce una dosis v√°lida mayor a 0', '‚ö†Ô∏è Dosis Inv√°lida');
                return;
            }

            if (!unit || unit === '') {
                showCustomAlert('Por favor, selecciona una unidad v√°lida', '‚ö†Ô∏è Unidad Requerida');
                return;
            }

            if (!dateTime) {
                showCustomAlert('Por favor, selecciona una fecha y hora v√°lida', '‚ö†Ô∏è Fecha Requerida');
                return;
            }

            if (isEditMode && currentEditingEntryId) {
                // EDIT MODE
                // Buscar usando comparaci√≥n flexible
                let existingEntryIndex = entries.findIndex(e => e.id === currentEditingEntryId);
                if (existingEntryIndex === -1) {
                    existingEntryIndex = entries.findIndex(e => e.id == currentEditingEntryId);
                }
                if (existingEntryIndex === -1) {
                    existingEntryIndex = entries.findIndex(e => String(e.id) === String(currentEditingEntryId));
                }
                if (existingEntryIndex === -1) {
                    existingEntryIndex = entries.findIndex(e => Number(e.id) === Number(currentEditingEntryId));
                }
                
                if (existingEntryIndex === -1) {
                    showCustomAlert('‚ùå Error: Registro no encontrado para actualizar.', '‚ùå Error');
                    resetEditMode();
                    return;
                }

                // Update existing entry
                entries[existingEntryIndex] = {
                    ...entries[existingEntryIndex], // Keep original properties like createdAt
                    substance: substance,
                    dose: dose,
                    unit: unit,
                    date: dateTime,
                    set: set || null, // Store null if empty
                    setting: setting || null, // Store null if empty
                    notes: notes || null, // Store null if empty
                    updatedAt: new Date().toISOString()
                };

                showAutoCloseAlert(`‚úÖ Registro actualizado: ${dose} ${unit} de ${substance}`, '‚úÖ Registro Actualizado', 2000);
                closeModal('entryModal');
                // Redirect to calendar view
                switchView('calendar');
                generateCalendar();
                renderStats();
                renderSubstanceList();

            } else {
               // CREATION MODE
               const entry = {
                   id: generateUniqueId(),
                   substance: substance,
                   dose: dose,
                   unit: unit,
                   date: dateTime,
                   set: set || null,
                   setting: setting || null,
                   notes: notes || null,
                   createdAt: new Date().toISOString()
               };
               entries.push(entry);
               showAutoCloseAlert(`‚úÖ Registro guardado: ${dose} ${unit} de ${substance}`, '‚úÖ Registro Guardado', 2000);

               closeModal('entryModal');
                // Redirect to calendar view
                switchView('calendar');
                generateCalendar();
                renderStats();
                renderSubstanceList();
            }

                             // Save and update
                 saveDataToStorage();

                 generateCalendar();
                 renderSubstanceList();
                 renderStats();

            // Clean up and redirect to calendar
            setTimeout(() => {
                closeModal('entryModal');
                resetEditMode();
                // Redirect to calendar view
                switchView('calendar');
            }, 2500); // Wait for alert to fade out (2000ms) + extra time for smooth transition
        }

        // Stats functions
        function renderStats() {
            const statsContainer = document.getElementById('stats-content');

            if (entries.length === 0) {
                statsContainer.innerHTML = '<div class="resource-card"><h4>No hay datos</h4><p>A√±ade algunos registros para ver estad√≠sticas</p></div>';
                return;
            }

            const totalEntries = entries.length;
            const uniqueSubstances = [...new Set(entries.map(entry => entry.substance))];

            // Calculate average per month based on the span of entries
            let firstEntryDate = entries.length > 0 ? new Date(Math.min(...entries.map(e => new Date(e.date)))) : null;
            let lastEntryDate = entries.length > 0 ? new Date(Math.max(...entries.map(e => new Date(e.date)))) : null;

            let monthsSpan = 0;
            if (firstEntryDate && lastEntryDate) {
                monthsSpan = (lastEntryDate.getFullYear() - firstEntryDate.getFullYear()) * 12;
                monthsSpan -= firstEntryDate.getMonth();
                monthsSpan += lastEntryDate.getMonth();
                monthsSpan = Math.max(1, monthsSpan + 1); // Ensure at least 1 month
            } else {
                monthsSpan = 1; // Default to 1 month if no entries
            }

            const averagePerMonth = (totalEntries / monthsSpan).toFixed(1);


            // Most used substance
            const substanceCount = {};
            entries.forEach(entry => {
                substanceCount[entry.substance] = (substanceCount[entry.substance] || 0) + 1;
            });
            const mostUsed = Object.keys(substanceCount).length > 0 ? Object.keys(substanceCount).reduce((a, b) => substanceCount[a] > substanceCount[b] ? a : b) : 'N/A';

            // Recent activity
            const lastWeek = new Date();
            lastWeek.setDate(lastWeek.getDate() - 7);
            const recentEntries = entries.filter(entry => new Date(entry.date) > lastWeek).length;

            statsContainer.innerHTML = `
                <div class="resource-card">
                    <h4>Registros Totales</h4>
                    <p style="font-size: 2rem; color: var(--accent-cyan); font-weight: bold;">${totalEntries}</p>
                </div>
                <div class="resource-card">
                    <h4>Sustancias √önicas</h4>
                    <p style="font-size: 2rem; color: var(--secondary-pink); font-weight: bold;">${uniqueSubstances.length}</p>
                </div>
                <div class="resource-card">
                    <h4>M√°s Utilizada</h4>
                    <p style="font-size: 1.5rem; color: var(--primary-purple); font-weight: bold;">${mostUsed}</p>
                    <p>${substanceCount[mostUsed] || 0} veces</p>
                </div>
                <div class="resource-card">
                    <h4>Actividad Reciente</h4>
                    <p style="font-size: 2rem; color: var(--accent-orange); font-weight: bold;">${recentEntries}</p>
                    <p>√öltimos 7 d√≠as</p>
                </div>
                <div class="resource-card">
                    <h4>Promedio Mensual</h4>
                    <p style="font-size: 2rem; color: var(--accent-cyan); font-weight: bold;">${averagePerMonth}</p>
                    <p>Registros por mes</p>
                </div>
            `;
        }

        // FUNCI√ìN DE MIGRACI√ìN MEJORADA - A√±ade esto al principio de tu script
        function migrateOldEntries() {
            let updatedCount = 0;

            entries.forEach(entry => {
                let updated = false;

                // Asegurar que todos los campos existan
                if (!entry.hasOwnProperty('set')) {
                    entry.set = '';
                    updated = true;
                }

                if (!entry.hasOwnProperty('setting')) {
                    entry.setting = '';
                    updated = true;
                }

                if (!entry.hasOwnProperty('unit')) {
                    entry.unit = '';
                    updated = true;
                }

                if (!entry.hasOwnProperty('notes')) {
                    entry.notes = '';
                    updated = true;
                }

                if (!entry.hasOwnProperty('createdAt')) {
                    entry.createdAt = new Date().toISOString();
                    updated = true;
                }

                if (!entry.hasOwnProperty('updatedAt')) {
                    entry.updatedAt = '';
                    updated = true;
                }

                if (updated) {
                    updatedCount++;
                }
            });

                             if (updatedCount > 0) {
                     saveDataToStorage();
                     return updatedCount;
                 }
            return 0;
        }

        // FUNCI√ìN DE VALIDACI√ìN ACTUALIZADA - Reemplaza la existente
        function validateDataBeforeExport() {
            // Primero migrar registros antiguos
            const migratedCount = migrateOldEntries();

            if (migratedCount > 0) {
                showCustomAlert(
                    `Se han actualizado ${migratedCount} registros con la nueva estructura. ` +
                    'Ahora puedes exportar correctamente con todos los campos (Set, Setting, etc.).',
                    '‚úÖ Migraci√≥n completada'
                );
                return;
            }

            // Verificar que todos los registros tengan la estructura correcta
            const invalidEntries = entries.filter(entry =>
                !entry.hasOwnProperty('set') || !entry.hasOwnProperty('setting')
            );

            if (invalidEntries.length > 0) {
                showCustomConfirm(
                    `Se encontraron ${invalidEntries.length} registros con estructura incompleta. ` +
                    '¬øDesea corregirlos antes de exportar?',
                    'Estructura de datos incompleta',
                    () => {
                        // Redirigir a la vista de calendario para corregir los registros
                        switchView('calendar');
                    },
                    () => {
                        // Exportar de todos modos
                        exportToCSV();
                    }
                );
            } else {
                exportToCSV();
            }
        }

        // FUNCI√ìN DE EXPORTACI√ìN ACTUALIZADA - Reemplaza la existente
        function exportToCSV() {
            // Primero asegurarnos de que todos los registros est√°n migrados
            migrateOldEntries();

            if (substances.length === 0 && entries.length === 0) {
                alert('No hay datos para exportar');
                return;
            }

            // Crear contenido CSV con formato consistente
            const csvLines = [];

            // Agregar BOM (Byte Order Mark) para UTF-8
            let csvContent = '\uFEFF';

            // Secci√≥n de SUSTANCIAS
            csvLines.push('SUSTANCIAS');
            csvLines.push('ID;Nombre;Color;Emoji;Fecha_Creacion;Fecha_Actualizacion');

            substances.forEach(s => {
                const emoji = s.emoji || getSubstanceEmoji(s.name);
                const updatedAt = s.updatedAt || '';

                csvLines.push(
                    `${s.id};"${s.name.replace(/"/g, '""')}";"${s.color}";"${emoji}";` +
                    `"${s.createdAt}";"${updatedAt}"`
                );
            });

            csvLines.push('');
            csvLines.push('REGISTROS');
            // Asegurar el orden correcto de columnas
            csvLines.push('ID;Sustancia;Dosis;Unidad;Fecha_Hora;Set;Setting;Notas;Fecha_Creacion;Fecha_Actualizacion');

            // Exportar registros - CON MANEJO MEJORADO DE CAMPOS
            entries.forEach(e => {
                const row = [
                    e.id,
                    `"${e.substance.replace(/"/g, '""')}"`,
                    e.dose,
                    `"${(e.unit || '').replace(/"/g, '""')}"`,
                    `"${e.date}"`,
                    `"${(e.set || '').replace(/"/g, '""')}"`,
                    `"${(e.setting || '').replace(/"/g, '""')}"`,
                    `"${(e.notes || '').replace(/"/g, '""')}"`,
                    `"${e.createdAt || ''}"`,
                    `"${e.updatedAt || ''}"`
                ];

                csvLines.push(row.join(';'));
            });

            csvContent += csvLines.join('\n');
            const fileName = `bitacora_psiconautica_${new Date().toISOString().split('T')[0]}.csv`;

            // Crear blob con tipo espec√≠fico para CSV
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);

            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            link.style.display = 'none';

            document.body.appendChild(link);
            link.click();

            // Limpiar despu√©s de descargar
            setTimeout(() => {
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }, 100);

            showCustomAlert(`‚úÖ Archivo exportado correctamente\n\nüìÅ ${fileName}\n\nRevisa tu carpeta de Descargas`);
        }

        // FUNCI√ìN DE IMPORTACI√ìN ACTUALIZADA - Reemplaza la existente
        function importFromCSV(input) {
            const file = input.files[0];

            if (!file) {
                showCustomAlert('‚ùå No se seleccion√≥ ning√∫n archivo');
                return;
            }

            if (!file.name.toLowerCase().endsWith('.csv')) {
                showCustomAlert('‚ùå Solo se permiten archivos .csv');
                input.value = '';
                return;
            }

            const replaceData = confirm(
                '¬øQu√© hacer con los datos actuales?\n\n' +
                'ACEPTAR = Reemplazar todos los datos\n' +
                'CANCELAR = Agregar datos nuevos'
            );

            const reader = new FileReader();

            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    // Normalizar saltos de l√≠nea
                    let lines = csv.replace(/\r\n/g, '\n').replace(/\r/g, '\n').split('\n');

                    let currentSection = '';
                    let substancesImported = 0;
                    let entriesImported = 0;

                    if (replaceData) {
                        substances = [];
                        entries = [];
                    }

                    for (let i = 0; i < lines.length; i++) {
                        const line = lines[i].replace(/^\uFEFF/, '').trim();

                        // Detectar secciones (case-insensitive)
                        if (line.toUpperCase() === 'SUSTANCIAS') {
                            currentSection = 'substances';
                            continue;
                        } else if (line.toUpperCase() === 'REGISTROS') {
                            currentSection = 'entries';
                            continue;
                        }

                        if (line.length === 0) {
                            continue;
                        }

                        const columns = parseCSVLine(line);

                        // Si no hay secciones definidas, asumir formato antiguo
                        if (currentSection === '' && columns.length >= 4) {
                            // Formato antiguo: intentar detectar autom√°ticamente
                            if (isSubstanceLine(columns)) {
                                currentSection = 'substances';
                            } else if (isEntryLine(columns)) {
                                currentSection = 'entries';
                            }
                        }

                        if (currentSection === 'substances' && columns.length >= 4) {
                            const substance = {
                                id: columns[0].replace(/"/g, '') || generateUniqueId(),
                                name: columns[1].replace(/"/g, ''),
                                color: columns[2].replace(/"/g, ''),
                                emoji: columns[3] ? columns[3].replace(/"/g, '') : getSubstanceEmoji(columns[1]),
                                createdAt: columns[4] ? columns[4].replace(/"/g, '') : new Date().toISOString()
                            };

                            if (replaceData || !substances.find(s => s.name.toLowerCase() === substance.name.toLowerCase())) {
                                substances.push(substance);
                                substancesImported++;
                            }
                        } else if (currentSection === 'entries' && columns.length >= 5) {
                            // Formato nuevo con m√°s campos
                            const entry = {
                                id: columns[0].replace(/"/g, '') || generateUniqueId(),
                                substance: columns[1].replace(/"/g, ''),
                                dose: parseFloat(columns[2].replace(/"/g, '').replace(',', '.')) || 0,
                                unit: columns[3].replace(/"/g, ''),
                                date: columns[4].replace(/"/g, ''),
                                set: columns[5] ? columns[5].replace(/"/g, '') : null,
                                setting: columns[6] ? columns[6].replace(/"/g, '') : null,
                                notes: columns[7] ? columns[7].replace(/"/g, '') : null,
                                createdAt: columns[8] ? columns[8].replace(/"/g, '') : new Date().toISOString(),
                                updatedAt: columns[9] ? columns[9].replace(/"/g, '') : null
                            };

                            entries.push(entry);
                            entriesImported++;
                        }
                                            }

                    saveDataToStorage();

                    renderSubstanceList();
                    generateCalendar();
                    renderStats();

                    showCustomAlert(
                        `‚úÖ Importaci√≥n completada\n\n` +
                        `üìã ${substancesImported} sustancias\n` +
                        `üìä ${entriesImported} registros\n\n` +
                        `${replaceData ? 'üîÑ Datos reemplazados' : '‚ûï Datos agregados'}`
                    );

                } catch (error) {
                    console.error('Error al importar:', error);
                    showCustomAlert(`‚ùå Error al procesar archivo:\n\n${error.message}`);
                }
            };

            reader.onerror = function() {
                showCustomAlert('‚ùå Error al leer el archivo');
            };

            reader.readAsText(file, 'UTF-8');

            setTimeout(() => {
                input.value = '';
            }, 1000);
        }

        // Funciones auxiliares para detectar el tipo de l√≠nea
        function isSubstanceLine(columns) {
            // Una l√≠nea de sustancia t√≠picamente tiene: ID, Nombre, Color, Emoji
            return columns.length >= 3 &&
                   !isNaN(columns[0]) && // ID es num√©rico
                   columns[2].startsWith('#'); // Color empieza con #
        }

        function isEntryLine(columns) {
            // Una l√≠nea de entrada t√≠picamente tiene: ID, Sustancia, Dosis, Unidad, Fecha
            return columns.length >= 5 &&
                   !isNaN(columns[0]) && // ID es num√©rico
                   !isNaN(columns[2]); // Dosis es num√©rica
        }

        // Funci√≥n para parsear l√≠neas CSV (mejorada)
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            let quoteChar = '';

            for (let i = 0; i < line.length; i++) {
                const char = line[i];

                if ((char === '"' || char === "'") && !inQuotes) {
                    inQuotes = true;
                    quoteChar = char;
                } else if (char === quoteChar && inQuotes) {
                    inQuotes = false;
                } else if (char === ';' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }

            result.push(current);
            return result;
        }

        // Funci√≥n para generar IDs √∫nicos (necesaria para la importaci√≥n)
        function generateUniqueId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
        }


        // A√ëADE ESTA FUNCI√ìN PARA A√ëADIR UN BOT√ìN DE MIGRACI√ìN
        function addMigrationButton() {
            const dataView = document.getElementById('data-view');
            if (dataView) {
                // Crear contenedor para botones
                const buttonContainer = document.createElement('div');
                buttonContainer.style.marginTop = '2rem';
                buttonContainer.style.padding = '1rem';
                buttonContainer.style.backgroundColor = 'var(--darker-bg)';
                buttonContainer.style.borderRadius = '12px';
                buttonContainer.style.border = '1px solid var(--border-color)';

                // T√≠tulo
                const title = document.createElement('h4');
                title.textContent = 'Migraci√≥n de Datos';
                title.style.color = 'var(--accent-cyan)';
                title.style.marginBottom = '1rem';
                buttonContainer.appendChild(title);

                // Descripci√≥n
                const description = document.createElement('p');
                description.textContent = 'Si tienes registros antiguos, migra primero para incluir todos los campos (Set, Setting, etc.) en las exportaciones.';
                description.style.color = 'var(--text-muted)';
                description.style.marginBottom = '1rem';
                buttonContainer.appendChild(description);

                // Bot√≥n de migraci√≥n
                const migrateButton = document.createElement('button');
                migrateButton.className = 'btn-primary';
                migrateButton.textContent = 'üîÑ Migrar registros antiguos';
                migrateButton.onclick = function() {
                    const migratedCount = migrateOldEntries();
                    if (migratedCount > 0) {
                        showCustomAlert(`‚úÖ ${migratedCount} registros actualizados con la nueva estructura`);
                    } else {
                        showCustomAlert('‚ÑπÔ∏è Todos los registros ya tienen la estructura completa');
                    }
                };
                migrateButton.style.marginRight = '1rem';
                buttonContainer.appendChild(migrateButton);

                // A√±adir al DOM
                dataView.querySelector('.calendar-container').appendChild(buttonContainer);
            }
        }

        // A√ëADE ESTO AL FINAL DE TU ARCHIVO, DESPU√âS DE TODAS LAS FUNCIONES
        document.addEventListener('DOMContentLoaded', function() {
            // A√±adir el bot√≥n de migraci√≥n despu√©s de que se cargue la p√°gina
            setTimeout(addMigrationButton, 2000);

            // Verificar si hay registros que necesiten migraci√≥n
            const needsMigration = entries.some(entry =>
                !entry.hasOwnProperty('set') || !entry.hasOwnProperty('setting')
            );

            if (needsMigration) {
                setTimeout(() => {
                    showCustomAlert(
                        'üìã Se han detectado registros antiguos.\n\n' +
                        'Para exportar correctamente con todos los campos (Set, Setting, etc.), ' +
                        'por favor ve a la pesta√±a "Datos" y haz clic en "Migrar registros antiguos" ' +
                        'antes de exportar.',
                        'Migraci√≥n Requerida'
                    );
                }, 3000);
            }
        });


        function clearAllData() {
            showCustomConfirm(
                '¬øEst√°s seguro de que quieres eliminar todos los datos? Esta acci√≥n no se puede deshacer.',
                'üóëÔ∏è Eliminar Todos los Datos',
                () => {
                    localStorage.removeItem('substances');
                    localStorage.removeItem('entries');
                    localStorage.removeItem('userProfile');

                    substances = getDefaultSubstances(); // Reset to default substances
                    entries = [];
                    userProfile = {};
                    selectedSubstanceFilter = null;

                                             saveDataToStorage(); // Save default substances

                    showCustomAlert('Todos los datos han sido eliminados', 'üóëÔ∏è Datos Eliminados');
                }
            );
        }

        function openExternalURL(url) {
            // Attempt to open in a new window/tab, which is generally handled by the system browser on mobile
            window.open(url, '_blank', 'noopener,noreferrer');
        }


        // ===== Perfil / Tarjeta de perfil =====
        // Funci√≥n segura para refrescar la tarjeta de perfil si existe. Evita errores en vistas donde no est√© presente.
        function updateProfileCard() {
            try {
                const profileCard = document.getElementById('profile-card');
                if (!profileCard) return; // No hay tarjeta de perfil en esta vista

                const profile = JSON.parse(localStorage.getItem('userProfile') || '{}');

                // Datos agregados a partir de entries
                const totalEntries = entries.length;
                const uniqueSubstances = [...new Set(entries.map(e => e.substance))].length;

                profileCard.innerHTML = `
                    <div class="profile-section">
                        <h4>${profile.name || 'Psiconauta'}</h4>
                        <p>${profile.bio || ''}</p>
                        <p><strong>Registros:</strong> ${totalEntries}</p>
                        <p><strong>Sustancias:</strong> ${uniqueSubstances}</p>
                    </div>
                `;
            } catch (err) {
                console.error('updateProfileCard error:', err);
            }
        }



        // Close modals when clicking outside
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('active');
                document.body.style.overflow = '';
                resetEditMode(); // Reset edit mode when any modal is closed by clicking outside
            }
        });

        // Initialize color picker
        document.addEventListener('DOMContentLoaded', function() {
            // Set default color selection for substance modal
            const firstColorOption = document.querySelector('#substanceModal .color-option');
            if (firstColorOption) {
                firstColorOption.classList.add('selected');
                selectedSubstanceColor = firstColorOption.dataset.color;
            }
        });

        // Prevent modal close when clicking inside modal content
        document.addEventListener('click', function(e) {
            if (e.target.closest('.modal-content')) {
                e.stopPropagation();
            }
        });

        function forceFileSelect() {
            const input = document.getElementById('csvFileInput');
            if (input) {
                input.click();
            } else {
                showCustomAlert('Error: Input de archivo no encontrado.', '‚ùå Error');
            }
        }

        // ===== DI√ÅLOGOS PERSONALIZADOS =====

        function showCustomConfirm(message, title, onConfirm) {
            const modalId = 'custom-confirm-modal';
            const existingModal = document.getElementById(modalId);
            if (existingModal) {
                existingModal.remove();
            }

            const modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content custom-dialog">
                    <div class="custom-dialog-header">
                        <h3>${title}</h3>
                    </div>
                    <div class="custom-dialog-body">
                        <p>${message}</p>
                    </div>
                    <div class="custom-dialog-actions">
                        <button class="btn-secondary" onclick="closeCustomConfirm()">Cancelar</button>
                        <button class="btn-primary" onclick="confirmAndClose()">Aceptar</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            document.body.style.overflow = 'hidden';

            // Guardar la funci√≥n de confirmaci√≥n globalmente
            window.pendingConfirmAction = onConfirm;

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeCustomConfirm();
                }
            });
        }

        function showCustomAlert(message, title) {
            const modalId = 'custom-alert-modal';
            const existingModal = document.getElementById(modalId);
            if (existingModal) {
                existingModal.remove();
            }

            const modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content custom-dialog">
                    <div class="custom-dialog-header">
                        <h3>${title}</h3>
                    </div>
                    <div class="custom-dialog-body">
                        <p>${message}</p>
                    </div>
                    <div class="custom-dialog-actions">
                        <button class="btn-primary" onclick="closeCustomAlert()">Aceptar</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            document.body.style.overflow = 'hidden';

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeCustomAlert();
                }
            });
        }

        // Nueva funci√≥n para alertas que se cierran autom√°ticamente
        function showAutoCloseAlert(message, title, autoCloseDelay = 2000) {
            const modalId = 'auto-close-alert-modal';
            const existingModal = document.getElementById(modalId);
            if (existingModal) {
                existingModal.remove();
            }

            const modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content custom-dialog auto-close">
                    <div class="custom-dialog-header">
                        <h3>${title}</h3>
                        <div class="auto-close-progress">
                            <div class="progress-bar"></div>
                        </div>
                    </div>
                    <div class="custom-dialog-body">
                        <p>${message}</p>
                    </div>
                    <div class="custom-dialog-actions">
                        <button class="btn-primary" onclick="closeAutoCloseAlert()">Aceptar</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            document.body.style.overflow = 'hidden';

            // Animar la barra de progreso
            const progressBar = modal.querySelector('.progress-bar');
            if (progressBar) {
                progressBar.style.transition = `width ${autoCloseDelay}ms linear`;
                setTimeout(() => {
                    progressBar.style.width = '0%';
                }, 100);
            }

            // Cerrar autom√°ticamente despu√©s del tiempo especificado
            setTimeout(() => {
                closeAutoCloseAlert();
            }, autoCloseDelay);

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeAutoCloseAlert();
                }
            });
        }

        function closeCustomConfirm() {
            const modal = document.getElementById('custom-confirm-modal');
            if (modal) {
                modal.remove();
            }
            document.body.style.overflow = '';
            window.pendingConfirmAction = null;
        }

        function closeCustomAlert() {
            const modal = document.getElementById('custom-alert-modal');
            if (modal) {
                modal.remove();
            }
            document.body.style.overflow = '';
        }

        function closeAutoCloseAlert() {
            const modal = document.getElementById('auto-close-alert-modal');
            if (modal) {
                const dialog = modal.querySelector('.custom-dialog');
                if (dialog) {
                    // Agregar clase de fade-out para la animaci√≥n
                    dialog.classList.add('fade-out');
                    // Esperar a que termine la animaci√≥n antes de cerrar
                    setTimeout(() => {
                        if (modal && modal.parentNode) {
                            modal.remove();
                        }
                        document.body.style.overflow = '';
                    }, 300); // 300ms = duraci√≥n de la animaci√≥n
                } else {
                    modal.remove();
                    document.body.style.overflow = '';
                }
            }
        }

        function confirmAndClose() {
            if (window.pendingConfirmAction) {
                window.pendingConfirmAction();
            }
            closeCustomConfirm();
                }

            // ===== FUNCIONES PARA DROPDOWNS PERSONALIZADOS =====

            // Variable global para controlar qu√© dropdown est√° abierto
            let openDropdown = null;

            // Funci√≥n para abrir/cerrar dropdowns
            function toggleDropdown(dropdownId) {

                const dropdown = document.getElementById(dropdownId);
                const options = dropdown.querySelector('.dropdown-options');
                const header = dropdown.querySelector('.dropdown-header');

                // Si hay otro dropdown abierto, cerrarlo
                if (openDropdown && openDropdown !== dropdown) {
                    const otherOptions = openDropdown.querySelector('.dropdown-options');
                    const otherHeader = openDropdown.querySelector('.dropdown-header');
                    otherOptions.classList.remove('show');
                    otherHeader.classList.remove('active');
                }

                // Toggle del dropdown actual
                if (options.classList.contains('show')) {

                    options.classList.remove('show');
                    header.classList.remove('active');
                    openDropdown = null;
                } else {

                    options.classList.add('show');
                    header.classList.add('active');
                    openDropdown = dropdown;
                }
            }

            // Funci√≥n para seleccionar una opci√≥n
            function selectOption(dropdownId, value, text, emoji) {
                const dropdown = document.getElementById(dropdownId);
                const headerText = dropdown.querySelector('.dropdown-text');
                const hiddenInput = dropdown.querySelector('input[type="hidden"]');

                // Actualizar el texto mostrado
                headerText.textContent = `${emoji} ${text}`;

                // Actualizar el input hidden
                hiddenInput.value = value;

                // Cerrar el dropdown
                const options = dropdown.querySelector('.dropdown-options');
                const header = dropdown.querySelector('.dropdown-header');
                options.classList.remove('show');
                header.classList.remove('active');
                openDropdown = null;

                // Marcar la opci√≥n como seleccionada
                const allOptions = dropdown.querySelectorAll('.dropdown-option');
                allOptions.forEach(option => {
                    option.classList.remove('selected');
                    if (option.dataset.value === value) {
                        option.classList.add('selected');
                    }
                });

                // Validar que se haya seleccionado una sustancia v√°lida
                if (dropdownId === 'entrySubstanceDropdown' && (!value || value === '')) {
                    headerText.textContent = 'Selecciona una sustancia...';
                    hiddenInput.value = '';
                }
            }

            // Cerrar dropdowns al hacer clic fuera
            document.addEventListener('click', function(e) {
                if (openDropdown && !openDropdown.contains(e.target)) {
                    const options = openDropdown.querySelector('.dropdown-options');
                    const header = openDropdown.querySelector('.dropdown-header');
                    options.classList.remove('show');
                    header.classList.remove('active');
                    openDropdown = null;
                }
            });

            // Cerrar dropdowns con la tecla Escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && openDropdown) {
                    const options = openDropdown.querySelector('.dropdown-options');
                    const header = openDropdown.querySelector('.dropdown-header');
                    options.classList.remove('show');
                    header.classList.remove('active');
                    openDropdown = null;
                }
            });

        </script>

    </main></body>
</html>
