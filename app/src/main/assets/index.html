<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitácora Psiconáutica</title>
    <style>
        :root {
            --primary-purple: #8B5CF6;
            --secondary-pink: #EC4899;
            --accent-cyan: #06B6D4;
            --accent-orange: #F97316;
            --dark-bg: #0F0F23;
            --darker-bg: #080813;
            --card-bg: #1A1A2E;
            --text-light: #E5E7EB;
            --text-muted: #9CA3AF;
            --border-color: rgba(139, 92, 246, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            background: var(--dark-bg);
            min-height: 100vh;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            color: var(--text-light);
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, var(--dark-bg) 0%, var(--darker-bg) 100%);
            z-index: -10;
        }

        .animated-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -5;
            opacity: 0.15;
            background:
                radial-gradient(circle at 25% 75%, var(--primary-purple) 0%, transparent 40%),
                radial-gradient(circle at 75% 25%, var(--secondary-pink) 0%, transparent 40%),
                radial-gradient(circle at 50% 50%, var(--accent-cyan) 0%, transparent 40%);
            animation: backgroundMove 20s ease-in-out infinite;
        }

        @keyframes backgroundMove {
            0%, 100% {
                transform: scale(1) rotate(0deg);
                opacity: 0.15;
            }
            50% {
                transform: scale(1.1) rotate(180deg);
                opacity: 0.25;
            }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 5;
            padding-top: 1.5rem;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 2rem 0;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .mystical-symbol {
            font-size: 3rem;
            opacity: 0.8;
            animation: symbolGlow 4s ease-in-out infinite alternate;
            user-select: none;
        }

        .mystical-symbol.left {
            color: var(--accent-cyan);
        }

        .mystical-symbol.right {
            color: var(--secondary-pink);
        }

        @keyframes symbolGlow {
            0% {
                opacity: 0.8;
                transform: scale(1);
                filter: drop-shadow(0 0 10px currentColor);
            }
            100% {
                opacity: 1;
                transform: scale(1.1);
                filter: drop-shadow(0 0 20px currentColor);
            }
        }

        .header-title {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-purple), var(--secondary-pink), var(--accent-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            animation: colorShift 3s ease-in-out infinite;
        }

        @keyframes colorShift {
            0%, 100% { filter: hue-rotate(0deg); }
            50% { filter: hue-rotate(90deg); }
        }

        .header p {
            color: var(--text-muted);
            font-size: 1.1rem;
        }

        .main-content {
            flex: 1;
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2rem;
            margin-bottom: 5rem;
        }

        .sidebar {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            height: fit-content;
            backdrop-filter: blur(10px);
        }

        .sidebar h3 {
            margin-bottom: 1rem;
            color: var(--primary-purple);
            font-size: 1.2rem;
        }

        .substance-list {
            list-style: none;
        }

        .substance-item {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: rgba(139, 92, 246, 0.1);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .substance-item:hover {
            background: rgba(139, 92, 246, 0.2);
            border-color: var(--primary-purple);
            transform: translateX(5px);
        }

        .substance-item.active {
            background: linear-gradient(135deg, var(--primary-purple), var(--secondary-pink));
            border-color: var(--accent-cyan);
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(139, 92, 246, 0.3);
        }

        .substance-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
        }

        .substance-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .substance-count {
            background: var(--accent-cyan);
            color: var(--dark-bg);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .edit-substance-btn {
            background: var(--accent-cyan);
            border: none;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            opacity: 0.7;
            margin-right: 8px;
        }

        .edit-substance-btn:hover {
            opacity: 1;
            background: var(--primary-purple);
            transform: scale(1.1);
        }

        .delete-substance-btn {
            background: var(--secondary-pink);
            border: none;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            opacity: 0.7;
        }

        .delete-substance-btn:hover {
            opacity: 1;
            background: #dc2626;
            transform: scale(1.1);
        }

        .add-substance-btn {
            width: 100%;
            padding: 0.75rem;
            background: linear-gradient(135deg, var(--accent-orange), var(--secondary-pink));
            border: none;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 1rem;
        }

        .add-substance-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(249, 115, 22, 0.3);
        }

        .calendar-container {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 2rem;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .calendar-nav {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .nav-btn {
            background: var(--primary-purple);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-btn:hover {
            background: var(--secondary-pink);
            transform: scale(1.1);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: var(--border-color);
            border-radius: 12px;
            overflow: hidden;
        }

        .calendar-day {
            aspect-ratio: 1;
            background: var(--darker-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            font-weight: 500;
        }

        .calendar-day:hover {
            opacity: 0.8;
            transform: scale(1.05);
        }

        .calendar-day.has-entry {
            color: white;
            font-weight: 600;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }

        .calendar-day.has-entry.single-substance {
        /* Color sólido para una sola sustancia */
        }

        .calendar-day.has-entry.multiple-substances {
        /* Gradiente para múltiples sustancias */
            position: relative;
        }

        .calendar-day.has-entry.multiple-substances::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: inherit;
            z-index: -1;
        }

        .substance-indicators {
            position: absolute;
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 2px;
        }

        .substance-dot {
            width: 4px;
            height: 4px;
            border-radius: 50%;
            box-shadow: 0 0 2px rgba(0,0,0,0.3);
        }

        .day-header {
            background: var(--primary-purple);
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border-top: 1px solid var(--border-color);
            padding: 1rem;
            backdrop-filter: blur(20px);
            z-index: 1000;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 0.5rem;
            border-radius: 12px;
            min-width: 70px;
        }

        .nav-item:hover {
            background: rgba(139, 92, 246, 0.1);
            transform: translateY(-2px);
        }

        .nav-item.active {
            background: linear-gradient(135deg, var(--primary-purple), var(--secondary-pink));
            color: white;
        }

        .nav-icon {
            width: 24px;
            height: 24px;
            margin-bottom: 0.25rem;
        }

        .nav-label {
            font-size: 0.7rem;
            font-weight: 500;
        }

        /* Modal fixes for Android */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            backdrop-filter: blur(5px);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .modal.active {
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 0.5rem;
            overflow-y: auto;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 2rem;
            max-width: 500px;
            width: calc(100% - 2rem);
            margin: 2rem auto;
            min-height: auto;
            border: 1px solid var(--border-color);
            position: relative;
            animation: modalSlideIn 0.3s ease;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }



        /* Book modal specific styles */
        .book-author-modal {
            color: var(--accent-cyan);
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .book-desc-modal {
            color: var(--text-muted);
            line-height: 1.6;
            margin-bottom: 1.5rem;
        }

        .book-actions {
            text-align: center;
            margin-top: 1.5rem;
        }

        /* Books modal styles */
        .books-list {
            max-height: 97vh;
            overflow-y: auto;
            padding-right: 0.5rem;
        }

        .book-entry {
            background: rgba(139, 92, 246, 0.05);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            transition: all 0.2s ease;
        }

        .book-entry:hover {
            background: rgba(139, 92, 246, 0.1);
            border-color: rgba(139, 92, 246, 0.3);
        }

        .book-entry h4 {
            color: var(--accent-cyan);
            margin: 0 0 0.25rem 0;
            font-size: 1rem;
            font-weight: 600;
        }

        .book-author {
            color: var(--primary-purple);
            font-size: 0.9rem;
            margin: 0 0 0.5rem 0;
            font-weight: 500;
        }

        .book-desc {
            color: var(--text-muted);
            font-size: 0.85rem;
            line-height: 1.4;
            margin: 0;
        }

        /* Books modal specific styles */
        .books-modal-content {
            max-width: 600px !important;
            width: 95% !important;
            max-height: 85vh !important;
        }

        .books-modal-body {
            padding: 0;
        }

        .books-modal-subtitle {
            color: var(--text-muted);
            text-align: center;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .books-modal-grid {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            max-height: 97vh;
            overflow-y: auto;
            padding-right: 0.5rem;
        }

        .modal-book-item {
            background: rgba(139, 92, 246, 0.08);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 12px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        .modal-book-item:hover {
            background: rgba(139, 92, 246, 0.15);
            border-color: rgba(139, 92, 246, 0.4);
            transform: translateX(3px);
        }

        .modal-book-info {
            flex: 1;
            min-width: 0;
        }

        .modal-book-info h5 {
            color: var(--accent-cyan);
            margin: 0 0 0.25rem 0;
            font-size: 1rem;
            font-weight: 600;
            line-height: 1.3;
        }

        .modal-book-author {
            color: var(--primary-purple);
            font-size: 0.85rem;
            margin: 0 0 0.5rem 0;
            font-weight: 500;
        }

        .modal-book-desc {
            color: var(--text-muted);
            font-size: 0.8rem;
            line-height: 1.4;
            margin: 0;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .modal-book-arrow {
            color: var(--accent-cyan);
            font-size: 1.2rem;
            font-weight: bold;
            opacity: 0.7;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .modal-book-item:hover .modal-book-arrow {
            opacity: 1;
            transform: translateX(3px);
        }

        /* Mobile responsive adjustments */
        @media (max-width: 480px) {
            .books-modal-content {
                width: 98% !important;
                margin: 0.5rem auto !important;
                max-height: 90vh !important;
                padding: 1.5rem !important;
            }

            .modal-book-item {
                padding: 0.75rem;
                flex-direction: column;
                align-items: flex-start;
                text-align: left;
                gap: 0.5rem;
            }

            .modal-book-arrow {
                align-self: flex-end;
                margin-top: 0.5rem;
                font-size: 1rem;
            }

            .modal-book-info h5 {
                font-size: 0.95rem;
                line-height: 1.2;
            }

            .modal-book-author {
                font-size: 0.8rem;
                margin-bottom: 0.25rem;
            }

            .modal-book-desc {
                font-size: 0.75rem;
                -webkit-line-clamp: 3;
                line-height: 1.3;
            }

            .books-modal-grid {
                max-height: 97vh;
                gap: 0.5rem;
            }

            .books-modal-subtitle {
                font-size: 0.85rem;
                margin-bottom: 1rem;
            }

            .custom-dialog-header h3 {
                font-size: 1.1rem;
            }
        }

        /* ==== MODAL DE LIBROS (GPT-5 SOLUTION) ==== */
        .hidden { display: none !important; }
        body.modal-open { overflow: hidden; }

        /* contenedor general */
        .books-modal:not(.hidden) {
          display: block;
          position: fixed;
          inset: 0;
          z-index: 99999; /* por encima de cualquier barra/nav */
        }

        /* fondo oscurecido con blur */
        .modal__backdrop {
          position: absolute;
          inset: 0;
          background: rgba(8, 8, 19, 0.6);
          backdrop-filter: blur(4px);
        }

        /* panel */
        .modal__panel {
          position: relative;
          z-index: 100000;
          margin: 0.2vh auto 0.2vh;
          width: min(100vw, 800px);
          min-height: 800px;
          max-height: 100vh;
          background: #111327;
          color: #fff;
          border-radius: 20px;
          box-shadow: 0 20px 60px rgba(0,0,0,.55);
          border: 1px solid rgba(255,255,255,0.08);
          display: flex;
          flex-direction: column;
          overflow: hidden;
        }

        /* cabecera */
        .modal__header {
          display: flex;
          align-items: center;
          justify-content: space-between;
          gap: 12px;
          padding: 16px 18px;
          background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0));
        }
        .modal__title {
          display: flex; align-items: center; gap: 10px;
        }
        .modal__emoji { font-size: 22px; }
        .modal__header h3 {
          font-size: 18px; font-weight: 700; margin: 0;
        }
        .modal__close {
          appearance: none; border: 0; background: #e7e7ff; color: #0c0f25;
          font-weight: 700; border-radius: 12px; width: 40px; height: 40px;
          cursor: pointer;
        }

        /* subtítulo */
        .modal__subtitle {
          margin: 0 18px 8px 18px;
          color: rgba(255,255,255,.75);
          font-size: 14px;
        }

        /* grid scrollable */
        .books-grid {
          padding: 8px 18px 16px 18px;
          overflow: auto;
          -webkit-overflow-scrolling: touch;
          display: grid;
          gap: 12px;
        }
        .book {
          background: #1a1a2e;
          border: 1px solid rgba(255,255,255,0.06);
          border-radius: 16px;
          padding: 14px;
        }
        .book__title { margin: 0 0 6px 0; font-size: 16px; font-weight: 700; }
        .book__meta  { margin: 0 0 6px 0; font-size: 13px; opacity: .9; }
        .book__desc  { margin: 0; font-size: 14px; opacity: .8; }

        /* nota final */
        .modal__note {
          margin: 8px 18px 18px;
          font-size: 12px;
          color: rgba(255,255,255,.75);
        }

        /* Responsive fino para móviles pequeños */
        @media (max-width: 380px) {
          .modal__panel { width: 94vw; }
          .book__title { font-size: 15px; }
          .book__desc  { font-size: 13px; }
        }

        /* Ensure modal content is centered on small screens */
        @media (max-height: 800px) {
            .modal-content {
                margin: 1rem auto;
            }
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.3s ease;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .close-btn:hover {
            color: var(--text-light);
            background: rgba(139, 92, 246, 0.1);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--primary-purple);
            font-weight: 600;
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-shadow: 0 0 10px rgba(139, 92, 246, 0.3);
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            background: var(--darker-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-light);
            font-size: 1rem;
        }

        /* Estilos mejorados para selectores */
        .form-group select {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, 
                rgba(139, 92, 246, 0.1) 0%, 
                rgba(236, 72, 153, 0.1) 50%, 
                rgba(6, 182, 212, 0.1) 100%);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            color: var(--text-light);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            position: relative;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%238B5CF6' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6,9 12,15 18,9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 20px;
            padding-right: 3rem;
        }

        .form-group select:hover {
            border-color: var(--primary-purple);
            box-shadow: 0 0 25px rgba(139, 92, 246, 0.4);
            transform: translateY(-3px);
            background: linear-gradient(135deg, 
                rgba(139, 92, 246, 0.15) 0%, 
                rgba(236, 72, 153, 0.15) 50%, 
                rgba(6, 182, 212, 0.15) 100%);
        }

        .form-group select:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 30px rgba(6, 182, 212, 0.5);
            background: linear-gradient(135deg, 
                rgba(139, 92, 246, 0.2) 0%, 
                rgba(236, 72, 153, 0.2) 50%, 
                rgba(6, 182, 212, 0.2) 100%);
        }

        /* Estilos para las opciones del selector */
        .form-group select option {
            background: var(--card-bg);
            color: var(--text-light);
            padding: 0.5rem;
            border: none;
        }

        .form-group select option:hover {
            background: linear-gradient(135deg, 
                rgba(139, 92, 246, 0.2) 0%, 
                rgba(236, 72, 153, 0.2) 100%);
        }

        /* Estilos para optgroup */
        .form-group select optgroup {
            background: linear-gradient(135deg, 
                rgba(139, 92, 246, 0.3) 0%, 
                rgba(6, 182, 212, 0.3) 100%);
            color: var(--accent-cyan);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 0.5rem;
        }

        /* Estilos para input de número */
        .form-group input[type="number"] {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, 
                rgba(139, 92, 246, 0.1) 0%, 
                rgba(236, 72, 153, 0.1) 50%, 
                rgba(6, 182, 212, 0.1) 100%);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            color: var(--text-light);
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
        }

        .form-group input[type="number"]:hover {
            border-color: var(--primary-purple);
            box-shadow: 0 0 25px rgba(139, 92, 246, 0.4);
            transform: translateY(-3px);
        }

        .form-group input[type="number"]:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 30px rgba(6, 182, 212, 0.5);
        }

        /* Estilos para input de fecha y hora */
        .form-group input[type="datetime-local"] {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, 
                rgba(139, 92, 246, 0.1) 0%, 
                rgba(236, 72, 153, 0.1) 50%, 
                rgba(6, 182, 212, 0.1) 100%);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            color: var(--text-light);
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
        }

        .form-group input[type="datetime-local"]:hover {
            border-color: var(--primary-purple);
            box-shadow: 0 0 25px rgba(139, 92, 246, 0.4);
            transform: translateY(-3px);
        }

        .form-group input[type="datetime-local"]:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 30px rgba(6, 182, 212, 0.5);
        }

        /* ===== ESTILOS PARA DIÁLOGOS PERSONALIZADOS ===== */
        
        .custom-dialog {
            background: var(--card-bg) !important;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(20px);
        }

        .custom-dialog-header {
            padding: 1.5rem 1.5rem 0.5rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .custom-dialog-header h3 {
            margin: 0;
            color: var(--text-light);
            font-size: 1.25rem;
            font-weight: 600;
            text-align: center;
        }

        .custom-dialog-body {
            padding: 1.5rem;
            text-align: center;
        }

        .custom-dialog-body p {
            margin: 0;
            color: var(--text-muted);
            font-size: 1rem;
            line-height: 1.5;
        }

        .custom-dialog-actions {
            padding: 0 1.5rem 1.5rem 1.5rem;
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .custom-dialog-actions button {
            flex: 1;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-size: 0.9rem;
        }

        .custom-dialog-actions .btn-primary {
            background: linear-gradient(135deg, var(--primary-purple), var(--secondary-pink));
            color: white;
            margin-bottom: 0;
        }

        .custom-dialog-actions .btn-secondary {
            background: var(--darker-bg);
            color: var(--text-light);
            border: 1px solid var(--border-color);
            margin-bottom: 0;
        }

        .custom-dialog-actions .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(139, 92, 246, 0.3);
        }

        /* Estilos para el modal de auto-cierre */
        .custom-dialog.auto-close {
            animation: slideInUp 0.3s ease-out;
        }

        .custom-dialog.auto-close.fade-out {
            animation: fadeOut 0.3s ease-in forwards;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-30px);
            }
        }

        /* Barra de progreso para auto-cierre */
        .auto-close-progress {
            width: 100%;
            height: 3px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            margin-top: 0.5rem;
            overflow: hidden;
        }

        .progress-bar {
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, var(--accent-cyan), var(--accent-orange));
            border-radius: 2px;
            transition: width 2s linear;
        }

        /* ===== ESTILOS PARA BOTONES PRINCIPALES ===== */
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-purple), var(--secondary-pink));
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-success {
            background: linear-gradient(135deg, #10B981, #059669);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }

        .btn-success:active {
            transform: translateY(0);
        }

        /* ===== EMOJI PICKER ===== */
        .emoji-picker {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .emoji-picker input {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 0.5rem;
            color: var(--text-light);
            transition: all 0.3s ease;
        }

        .emoji-picker input:focus {
            border-color: var(--accent-cyan);
            box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
            outline: none;
        }

        .emoji-suggestion {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-align: center;
        }

        /* ===== CUSTOM DATETIME PICKER ===== */
        .custom-datetime-selector {
            width: 100%;
        }

        .datetime-display {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg,
                rgba(139, 92, 246, 0.1) 0%,
                rgba(6, 182, 212, 0.1) 100%);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .datetime-display:hover {
            border-color: var(--primary-purple);
            box-shadow: 0 0 25px rgba(139, 92, 246, 0.4);
            transform: translateY(-3px);
        }

        .datetime-text {
            font-size: 1rem;
            color: var(--text-light);
        }

        .datetime-icon {
            font-size: 1.2rem;
            opacity: 0.8;
        }

        /* Modal específico para datetime */
        .datetime-modal {
            max-width: 450px;
            width: 90%;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
        }

        .datetime-picker-container {
            display: flex;
            flex-direction: column;
            gap: 2rem;
            margin: 1.5rem 0;
        }

        .date-section, .time-section {
            background: linear-gradient(135deg,
                rgba(139, 92, 246, 0.05) 0%,
                rgba(6, 182, 212, 0.05) 100%);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
        }

        .date-row, .time-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            justify-content: center;
        }

        .date-field, .time-field {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .date-field label, .time-field label {
            font-size: 0.8rem;
            color: var(--primary-purple);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .date-select, .time-select {
            padding: 0.8rem 1rem;
            background-color: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-light);
            font-size: 1.1rem;
            font-weight: 600;
            font-variant-numeric: tabular-nums;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 80px;
            text-align: center;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image:
                radial-gradient(circle at top left, rgba(139, 92, 246, 0.18), transparent 70%),
                radial-gradient(circle at bottom right, rgba(6, 182, 212, 0.18), transparent 70%),
                url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23A855F7' stroke-width='2'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat, no-repeat, no-repeat;
            background-position: center, center, right 1rem center;
            background-size: 260% 260%, 220% 220%, 0.9rem;
            padding-right: 2.5rem;
        }

        .date-select::-ms-expand, .time-select::-ms-expand {
            display: none;
        }

        .date-select:hover, .time-select:hover {
            border-color: var(--primary-purple);
            box-shadow: 0 0 15px rgba(139, 92, 246, 0.3);
        }

        .date-select:focus, .time-select:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 20px rgba(6, 182, 212, 0.4);
        }

        .date-select option, .time-select option {
            background-color: var(--card-bg);
            color: var(--text-light);
        }

        .date-select option:hover, .time-select option:hover,
        .date-select option:focus, .time-select option:focus {
            background-color: rgba(139, 92, 246, 0.35);
        }

        .date-select option:checked, .time-select option:checked {
            background-color: rgba(6, 182, 212, 0.35);
            color: var(--text-light);
        }

        .custom-select-wrapper {
            position: relative;
            width: 100%;
            min-width: 80px;
        }

        .custom-select-wrapper select {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            pointer-events: none;
        }

        .custom-select-trigger {
            width: 100%;
            padding: 0.85rem 2.75rem 0.85rem 1.1rem;
            border-radius: 12px;
            border: 2px solid var(--border-color);
            background: linear-gradient(135deg,
                rgba(139, 92, 246, 0.18) 0%,
                rgba(6, 182, 212, 0.18) 100%);
            color: var(--text-light);
            font-size: 1.1rem;
            font-weight: 600;
            font-variant-numeric: tabular-nums;
            letter-spacing: 0.02em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.45rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            box-shadow: inset 0 0 15px rgba(8, 9, 34, 0.35);
        }

        .custom-select-trigger::after {
            content: '';
            position: absolute;
            right: 1.05rem;
            top: 50%;
            width: 0.65rem;
            height: 0.65rem;
            border-right: 2px solid rgba(168, 85, 247, 0.85);
            border-bottom: 2px solid rgba(168, 85, 247, 0.85);
            transform: translateY(-50%) rotate(45deg);
            transition: transform 0.3s ease, border-color 0.3s ease;
        }

        .custom-select-wrapper.is-open .custom-select-trigger::after {
            transform: translateY(-50%) rotate(-135deg);
            border-color: var(--accent-cyan);
        }

        .custom-select-trigger:hover {
            border-color: var(--primary-purple);
            box-shadow: 0 0 18px rgba(139, 92, 246, 0.35);
            transform: translateY(-2px);
        }

        .custom-select-wrapper.is-open .custom-select-trigger {
            border-color: var(--accent-cyan);
            box-shadow: 0 0 25px rgba(6, 182, 212, 0.45);
        }

        .custom-select-value {
            text-transform: uppercase;
            font-variant-numeric: tabular-nums;
            letter-spacing: 0.06em;
        }

        .custom-select-dropdown {
            position: absolute;
            top: calc(100% + 0.75rem);
            left: 0;
            right: 0;
            background: rgba(13, 14, 40, 0.95);
            border: 1px solid rgba(139, 92, 246, 0.5);
            border-radius: 16px;
            box-shadow: 0 20px 45px rgba(10, 5, 45, 0.6);
            padding: 0.6rem;
            display: none;
            flex-direction: column;
            gap: 0.35rem;
            max-height: 240px;
            overflow-y: auto;
            z-index: 25;
            backdrop-filter: blur(18px);
            animation: customSelectFadeIn 0.22s ease forwards;
        }

        .custom-select-wrapper.is-open .custom-select-dropdown {
            display: flex;
        }

        .custom-select-option {
            width: 100%;
            border: none;
            border-radius: 12px;
            padding: 0.75rem 0.9rem;
            background: linear-gradient(135deg,
                rgba(60, 52, 110, 0.45) 0%,
                rgba(27, 45, 80, 0.35) 100%);
            color: var(--text-light);
            font-weight: 600;
            font-size: 1rem;
            letter-spacing: 0.04em;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.25s ease;
            position: relative;
        }

        .custom-select-option::after {
            content: '';
            width: 0.5rem;
            height: 0.5rem;
            border-radius: 999px;
            background: rgba(168, 85, 247, 0.0);
            box-shadow: 0 0 0 rgba(168, 85, 247, 0.0);
            transition: all 0.3s ease;
        }

        .custom-select-option:hover {
            transform: translateX(4px);
            background: linear-gradient(135deg,
                rgba(139, 92, 246, 0.45) 0%,
                rgba(6, 182, 212, 0.28) 100%);
            box-shadow: 0 12px 24px rgba(10, 5, 35, 0.45);
        }

        .custom-select-option:hover::after {
            background: rgba(168, 85, 247, 0.6);
            box-shadow: 0 0 12px rgba(168, 85, 247, 0.65);
        }

        .custom-select-option.selected {
            background: linear-gradient(135deg,
                rgba(6, 182, 212, 0.36) 0%,
                rgba(139, 92, 246, 0.52) 100%);
            box-shadow: 0 16px 32px rgba(6, 182, 212, 0.25);
        }

        .custom-select-option.selected::after {
            background: var(--accent-cyan);
            box-shadow: 0 0 14px rgba(6, 182, 212, 0.7);
        }

        .custom-select-dropdown::-webkit-scrollbar {
            width: 6px;
        }

        .custom-select-dropdown::-webkit-scrollbar-track {
            background: rgba(15, 16, 42, 0.4);
            border-radius: 999px;
        }

        .custom-select-dropdown::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, rgba(139, 92, 246, 0.6), rgba(6, 182, 212, 0.6));
            border-radius: 999px;
        }

        @keyframes customSelectFadeIn {
            from {
                opacity: 0;
                transform: translateY(6px) scale(0.98);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .time-separator {
            font-size: 2rem;
            font-weight: bold;
            color: var(--accent-cyan);
            margin: 0 0.5rem;
            margin-top: 1.5rem;
        }

        .datetime-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            flex-wrap: wrap;
        }

        .datetime-actions button {
            flex: 1;
            min-width: 120px;
            padding: 1rem;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }

        .datetime-actions .btn-primary {
            background: linear-gradient(135deg, var(--primary-purple) 0%, var(--accent-cyan) 100%);
            color: white;
        }

        .datetime-actions .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.15), rgba(14, 165, 233, 0.35));
            color: var(--text-light);
            padding: 0.75rem 1.5rem;
            border: 1px solid rgba(6, 182, 212, 0.4);
            border-radius: 14px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.25s ease;
            box-shadow: 0 6px 18px rgba(6, 182, 212, 0.25);
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            border-color: rgba(6, 182, 212, 0.8);
            box-shadow: 0 12px 28px rgba(6, 182, 212, 0.35);
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.3), rgba(14, 165, 233, 0.55));
        }

        .datetime-actions .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .datetime-actions .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
        }

        /* Responsive para pantallas pequeñas */
        @media (max-width: 480px) {
            .date-row, .time-row {
                flex-direction: column;
                gap: 1rem;
            }

            .time-separator {
                margin: 0;
                margin-top: 0.5rem;
            }

            .datetime-actions {
                flex-direction: column;
            }
        }

        .resources-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .resource-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            text-decoration: none;
            color: inherit;
            cursor: pointer;
        }

        .resource-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary-purple);
            box-shadow: 0 20px 40px rgba(139, 92, 246, 0.1);
        }

        .resource-card h4 {
            color: var(--accent-cyan);
            margin-bottom: 0.5rem;
        }

        .backup-folder-row {
            margin-top: 0.75rem;
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
        }

        .backup-path-chip {
            display: block;
            width: 100%;
            padding: 0.45rem 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.86rem;
            font-family: "JetBrains Mono", "SFMono-Regular", Consolas, monospace;
            word-break: break-all;
            overflow-wrap: anywhere;
            white-space: normal;
        }
        
        /* === ESTILOS PARA LA SECCIÓN DE LIBROS === */
        .books-expandable {
            margin-top: 2rem;
            animation: slideDown 0.3s ease-out;
        }
        
        .books-container {
            background: rgba(26, 26, 46, 0.95);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.5rem;
            max-height: 70vh;
            overflow-y: auto;
            backdrop-filter: blur(10px);
        }
        
        .books-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .books-header h3 {
            color: var(--accent-cyan);
            margin: 0;
            font-size: 1.25rem;
        }
        
        .close-books-btn {
            background: var(--primary-purple);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .close-books-btn:hover {
            background: var(--secondary-pink);
            transform: scale(1.1);
        }
        
        .books-grid {
            display: grid;
            gap: 1rem;
            margin: 1rem 0;
        }
        
        .book-item {
            background: rgba(139, 92, 246, 0.1);
            padding: 1.2rem;
            border-radius: 12px;
            border-left: 4px solid var(--accent-cyan);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .book-item:hover {
            background: rgba(139, 92, 246, 0.2);
            transform: translateX(5px);
            box-shadow: 0 4px 8px rgba(139, 92, 246, 0.3);
        }
        
        .book-item h5 {
            color: var(--accent-cyan);
            margin: 0 0 0.5rem 0;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .book-author {
            color: var(--accent-orange);
            font-size: 0.9rem;
            font-weight: 500;
            margin: 0 0 0.5rem 0;
        }
        
        .book-desc {
            color: var(--text-muted);
            font-size: 0.9rem;
            line-height: 1.4;
            margin: 0;
        }
        
        .books-note {
            margin-top: 1.5rem;
            padding: 1rem;
            background: rgba(6, 182, 212, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(6, 182, 212, 0.3);
        }
        
        .books-note p {
            margin: 0;
            color: var(--text-muted);
            font-size: 0.85rem;
            line-height: 1.4;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Responsive para móvil */
        @media (max-width: 768px) {
            .books-container {
                max-height: 97vh;
                padding: 1rem;
            }
            
            .books-header {
                margin-bottom: 1rem;
            }
            
            .book-item {
                padding: 1rem;
            }
            
            .book-item h5 {
                font-size: 1rem;
            }
        }

        .entry-item {
            background: var(--darker-bg);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border-color);
        }

        .entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .entry-substance {
            color: var(--primary-purple);
            font-weight: 600;
        }

        .entry-time {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .entry-dose {
            color: var(--accent-cyan);
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .entry-notes {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .color-picker-container {
            margin: 1rem 0;
        }

        .color-options {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .color-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .color-option:hover {
            transform: scale(1.1);
            border-color: var(--text-light);
        }

        .color-option.selected {
            border-color: var(--accent-cyan);
            transform: scale(1.2);
        }

        .color-option.selected::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            text-shadow: 0 0 3px rgba(0,0,0,0.8);
        }

        .profile-section {
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: var(--darker-bg);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .profile-section h4 {
            color: var(--accent-cyan);
            margin-bottom: 1rem;
        }

        .char-counter {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-align: right;
            margin-top: 0.5rem;
        }

        .file-input {
            display: none;
        }

        .file-label {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            background: var(--accent-orange);
            color: white;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            width: 100%;
            margin-bottom: 0.5rem;
        }

        .file-label:hover {
            background: var(--secondary-pink);
            transform: translateY(-2px);
        }

         .profile-card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            border: 1px solid var(--border-color);
            max-width: 400px;
            margin: 0 auto;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-purple), var(--secondary-pink));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            margin: 0 auto 1rem;
        }

        .social-share-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }

        .social-share-btn {
            padding: 0.75rem;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .twitter-btn {
            background: #1DA1F2;
            color: white;
        }

        .whatsapp-btn {
            background: #25D366;
            color: white;
        }

        .telegram-btn {
            background: #0088cc;
            color: white;
        }

        .reddit-btn {
            background: #FF4500;
            color: white;
        }

        .favorite-substance {
            background: var(--darker-bg);
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            border: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .remove-btn {
            background: var(--secondary-pink);
            border: none;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .btn-edit, .btn-delete {
            background: var(--accent-cyan);
            border: none;
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            margin-right: 0.5rem;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .btn-delete {
            background: var(--secondary-pink);
        }

        .btn-edit:hover {
            background: var(--accent-orange);
        }

        .btn-delete:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }

         .btn-danger {
            background: linear-gradient(135deg, #dc2626, #ef4444);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3);
            width: 100%;
         }

         .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(220, 38, 38, 0.4);
            background: linear-gradient(135deg, #ef4444, #f87171);
         }

         .btn-danger:active {
            transform: translateY(0);
         }

        .entry-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid var(--border-color);
        }

        .quote-item {
            background: var(--darker-bg);
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            border-left: 4px solid var(--accent-cyan);
            position: relative;
        }

        .quote-text {
            font-style: italic;
            margin-bottom: 0.5rem;
        }

        .quote-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .header h1 {
                font-size: 2rem;
            }

            .header-content {
                gap: 1rem;
            }

            .mystical-symbol {
                font-size: 2rem;
            }

            .calendar-container {
                padding: 1rem;
            }

            .nav-label {
                font-size: 0.6rem;
            }

            .nav-item {
                min-width: 60px;
            }

            .modal-content {
                margin: 1rem;
                width: calc(100% - 2rem);
                padding: 1.5rem;
            }
        }

        /* ========================================
           ESTILOS GENERALES PARA ADJUNTOS (Audio / Foto)
           ======================================== */
        .media-attachments-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }

        .media-card {
            border: 2px dashed var(--primary-purple);
            border-radius: 16px;
            padding: 18px;
            background: rgba(139, 92, 246, 0.08); /* primary-purple con alpha */
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.25s ease;
            min-height: 130px;
        }

        .media-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 24px rgba(139, 92, 246, 0.25);
            border-style: solid;
        }

        .media-card.has-attachment {
            border-style: solid;
            background: linear-gradient(
              135deg,
              rgba(139, 92, 246, 0.15),   /* primary-purple */
              rgba(236, 72, 153, 0.12)    /* secondary-pink */
            );
        }

        .media-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .media-card-icon { font-size: 1.8rem; }

        .media-card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-light);
        }

        .media-card-subtitle {
            font-size: 0.95rem;
            color: var(--text-muted);
            line-height: 1.4;
        }

        .media-card-footer {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            font-size: 0.85rem;
            color: var(--accent-cyan);
        }

        /* Preview del modal de Foto */
        .photo-modal-preview {
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            background: rgba(15, 23, 42, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            aspect-ratio: 4 / 3;
            margin-bottom: 16px;
        }
        .photo-modal-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .photo-modal-preview.empty {
            flex-direction: column;
            padding: 24px;
            gap: 12px;
            color: var(--text-muted);
            text-align: center;
            font-size: 0.95rem;
        }

        /* Acciones en el modal de Foto */
        .photo-modal-actions { display: flex; flex-wrap: wrap; gap: 12px; }
        .photo-modal-actions button { flex: 1 1 200px; }
        .photo-extra-actions { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 16px; }
        .photo-extra-actions button { flex: 1 1 140px; }
        .modal-attachment-actions {
            display: none;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 16px;
        }
        .modal-attachment-actions button {
            flex: 1 1 150px;
        }

        /* Botón outline reutilizable */
        .btn-outline {
            border: 2px solid var(--primary-purple);
            background: transparent;
            color: var(--primary-purple);
            padding: 12px 16px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.25s ease;
        }
        .btn-outline:hover {
            background: rgba(139, 92, 246, 0.12); /* alpha del primary */
            transform: translateY(-2px);
        }

        /* Barra de progreso de audio (compartida por UI) */
        .audio-progress-container {
            width: 100%;
            height: 6px;
            background: rgba(139, 92, 246, 0.2);
            border-radius: 3px;
            overflow: hidden;
            position: relative;
        }
        .audio-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-purple), var(--secondary-pink));
            border-radius: 3px;
            width: 0%;
            transition: width 0.1s linear;
        }

        /* Botones de icono */
        .btn-icon-small {
            background: rgba(139, 92, 246, 0.15);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 8px;
            padding: 6px 10px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn-icon-small:hover {
            background: rgba(139, 92, 246, 0.25);
            transform: scale(1.05);
        }
        .btn-icon-small:active { transform: scale(0.95); }

        .btn-icon-large {
            background: var(--primary-purple);
            color: white;
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        }
        .btn-icon-large:hover {
            background: #7c3aed; /* tono más oscuro del primary-purple */
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(139, 92, 246, 0.5);
        }
        .btn-icon-large:active { transform: scale(1); }

        .btn-icon-danger {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn-icon-danger:hover { background: #dc2626; transform: scale(1.05); }
        .btn-icon-danger:active { transform: scale(0.95); }


        /* ===== DROPDOWNS PERSONALIZADOS ===== */
        .custom-dropdown {
            position: relative;
            width: 100%;
            margin-bottom: 0.5rem;
        }

        .dropdown-header {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg,
                rgba(139, 92, 246, 0.1) 0%,
                rgba(236, 72, 153, 0.1) 50%,
                rgba(6, 182, 212, 0.1) 100%);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            color: var(--text-light);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dropdown-header:hover {
            border-color: var(--primary-purple);
            box-shadow: 0 0 25px rgba(139, 92, 246, 0.4);
            transform: translateY(-3px);
            background: linear-gradient(135deg,
                rgba(139, 92, 246, 0.15) 0%,
                rgba(236, 72, 153, 0.15) 50%,
                rgba(6, 182, 212, 0.15) 100%);
        }

        .dropdown-header.active {
            border-color: var(--accent-cyan);
            box-shadow: 0 0 30px rgba(6, 182, 212, 0.5);
            background: linear-gradient(135deg,
                rgba(139, 92, 246, 0.2) 0%,
                rgba(236, 72, 153, 0.2) 50%,
                rgba(6, 182, 212, 0.2) 100%);
        }

        .dropdown-text {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .dropdown-arrow {
            font-size: 0.8rem;
            transition: transform 0.3s ease;
            color: var(--accent-cyan);
        }

        .dropdown-header.active .dropdown-arrow {
            transform: rotate(180deg);
        }

        .dropdown-options {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            right: 0;
            background: linear-gradient(135deg,
                rgba(26, 26, 46, 0.95) 0%,
                rgba(15, 15, 35, 0.95) 100%);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            backdrop-filter: blur(20px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            max-height: 250px;
            overflow-y: auto;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: inherit;
            scrollbar-width: thin;
            scrollbar-color: var(--accent-cyan) rgba(139, 92, 246, 0.1);
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }

        .dropdown-options.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-option {
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 1px solid rgba(139, 92, 246, 0.1);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            min-height: 48px;
        }

        .dropdown-option:last-child {
            border-bottom: none;
        }

        .dropdown-option:hover {
            background: linear-gradient(135deg,
                rgba(139, 92, 246, 0.2) 0%,
                rgba(236, 72, 153, 0.2) 100%);
            transform: translateX(5px);
        }

        .dropdown-option.selected {
            background: linear-gradient(135deg,
                rgba(139, 92, 246, 0.3) 0%,
                rgba(6, 182, 212, 0.3) 100%);
            border-left: 4px solid var(--accent-cyan);
        }

        .dropdown-option::before {
            content: '';
            width: 6px;
            height: 6px;
            background: var(--accent-cyan);
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .dropdown-option:hover::before {
            opacity: 1;
        }

        .option-emoji {
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
        }

        .option-text {
            flex: 1;
            color: var(--text-light);
            font-weight: 500;
        }

        .dropdown-option.selected .option-text {
            color: var(--accent-cyan);
            font-weight: 600;
        }

        /* Estilos para headers de categorías */
        .dropdown-option.category-header {
            background: linear-gradient(135deg,
                rgba(139, 92, 246, 0.3) 0%,
                rgba(6, 182, 212, 0.3) 100%);
            color: var(--accent-cyan);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 1rem;
            cursor: default;
            border-left: 4px solid var(--accent-cyan);
        }

        .dropdown-option.category-header:hover {
            background: linear-gradient(135deg,
                rgba(139, 92, 246, 0.4) 0%,
                rgba(6, 182, 212, 0.4) 100%);
            transform: none;
        }

        .dropdown-option.category-header .option-text {
            color: var(--accent-cyan);
            font-weight: 700;
        }

        .dropdown-option.category-header:first-child {
            border-top-left-radius: 14px;
            border-top-right-radius: 14px;
        }

        /* === ESTILOS PARA CAMPOS PERSONALIZADOS DE UNIDADES === */
        .dropdown-option.custom-input-container {
            background: rgba(139, 92, 246, 0.15);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 8px;
            margin: 0.5rem;
            padding: 0.75rem;
            cursor: default;
            flex-direction: column;
            gap: 0.5rem;
            min-height: auto;
        }

        .dropdown-option.custom-input-container:hover {
            background: rgba(139, 92, 246, 0.2);
            transform: none;
            border-color: var(--accent-cyan);
        }

        .dropdown-option.custom-input-container:hover::before {
            opacity: 0;
        }

        .custom-unit-input {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            width: 100%;
        }

        .custom-unit-field {
            flex: 1;
            background: var(--darker-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.5rem;
            color: var(--text-light);
            font-size: 0.9rem;
            outline: none;
            transition: all 0.3s ease;
        }

        .custom-unit-field::placeholder {
            color: var(--text-muted);
            font-style: italic;
        }

        .custom-unit-field:focus {
            border-color: var(--accent-cyan);
            box-shadow: 0 0 0 2px rgba(6, 182, 212, 0.2);
        }

        .add-custom-unit-btn {
            background: linear-gradient(135deg, var(--primary-purple), var(--accent-cyan));
            border: none;
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .add-custom-unit-btn:hover {
            background: linear-gradient(135deg, var(--secondary-pink), var(--accent-cyan));
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        }

        .add-custom-unit-btn:active {
            transform: translateY(0);
        }

        /* Estilos para unidades personalizadas una vez agregadas */
        .dropdown-option.custom-unit {
            background: rgba(6, 182, 212, 0.1);
            border-left: 3px solid var(--accent-cyan);
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-right: 50px;
        }

        .custom-unit-content {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
        }

        .custom-unit-actions {
            display: flex;
            align-items: center;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.3s ease;
            position: absolute;
            right: 30px;
            top: 50%;
            transform: translateY(-50%);
        }

        .dropdown-option.custom-unit:hover .custom-unit-actions {
            opacity: 1;
        }

        .custom-unit-btn {
            width: 18px;
            height: 18px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            transition: all 0.3s ease;
            margin: 0 1px;
        }

        .edit-custom-unit-btn {
            background: var(--accent-cyan);
            color: white;
        }

        .edit-custom-unit-btn:hover {
            background: var(--primary-purple);
            transform: scale(1.1);
        }

        .delete-custom-unit-btn {
            background: var(--secondary-pink);
            color: white;
        }

        .delete-custom-unit-btn:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        .dropdown-option.custom-unit::after {
            content: '✨';
            position: absolute;
            right: 1rem;
            opacity: 0.7;
            font-size: 0.9rem;
            pointer-events: none;
        }

        .dropdown-option.custom-unit:hover::after {
            opacity: 1;
        }

        /* Responsive para móvil */
        @media (max-width: 768px) {
            .custom-unit-input {
                flex-direction: column;
                gap: 0.5rem;
            }

            .custom-unit-field {
                width: 100%;
            }

            .add-custom-unit-btn {
                width: 100%;
                padding: 0.6rem;
            }
        }

        /* Scrollbar personalizado para dropdowns */
        .dropdown-options::-webkit-scrollbar {
            width: 8px;
        }

        .dropdown-options::-webkit-scrollbar-track {
            background: rgba(139, 92, 246, 0.1);
            border-radius: 4px;
            margin: 4px 0;
        }

        .dropdown-options::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--primary-purple), var(--accent-cyan));
            border-radius: 4px;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .dropdown-options::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, var(--secondary-pink), var(--accent-cyan));
            transform: scale(1.1);
        }

        .dropdown-options::-webkit-scrollbar-corner {
            background: transparent;
        }

        /* Z-index específico para cada dropdown en orden */
        #entrySubstanceDropdown { z-index: 1006; }
        #entryUnitDropdown { z-index: 1005; }
        #entrySetDropdown { z-index: 1004; }
        #entrySettingDropdown { z-index: 1003; }

       .btn-danger {
            background: linear-gradient(135deg, #dc2626, #ef4444);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3);
            width: 100%;
       }

   .btn-danger:hover {
       transform: translateY(-2px);
       box-shadow: 0 8px 25px rgba(220, 38, 38, 0.4);
       background: linear-gradient(135deg, #ef4444, #f87171);
   }

   .btn-danger:active {
       transform: translateY(0);
   }

   /* ========================================
      ESTILOS DE AUDIO - Grabación y Reproducción
      ======================================== */

   /* Botón de grabar (estilo outline con icono de micrófono) */
   .btn-audio-record {
       width: 100%;
       padding: 12px 16px;
       background: transparent;
       border: 2px dashed var(--primary);
       border-radius: 12px;
       color: var(--primary);
       font-size: 0.95rem;
       font-weight: 600;
       cursor: pointer;
       transition: all 0.3s ease;
       display: flex;
       align-items: center;
       justify-content: center;
       gap: 8px;
   }

   .btn-audio-record:hover {
       background: var(--primary-alpha);
       border-style: solid;
       transform: translateY(-2px);
   }

   .btn-audio-record:active {
       transform: translateY(0);
   }

   /* Card de grabación activa (fondo rojizo, animación de pulso) */
   .audio-recording-card {
       background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(248, 113, 113, 0.1));
       border: 2px solid var(--danger);
       border-radius: 12px;
       padding: 16px;
       margin-top: 8px;
   }

   /* Animación de pulso para indicar grabación */
   .recording-pulse {
       width: 12px;
       height: 12px;
       background: var(--danger);
       border-radius: 50%;
       animation: pulse 1.5s ease-in-out infinite;
   }

   @keyframes pulse {
       0%, 100% {
           opacity: 1;
           transform: scale(1);
       }
       50% {
           opacity: 0.4;
           transform: scale(1.3);
       }
   }

   /* Card del reproductor de audio (fondo azul/morado suave) */
   .audio-player-card {
       background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(6, 182, 212, 0.1));
       border: 2px solid var(--primary);
       border-radius: 12px;
       padding: 16px;
       margin-top: 8px;
   }


    </style>
</head>
<body>
<div class="animated-bg"></div>

<div class="container">
    <header class="header">
        <div class="header-content">
            <div class="mystical-symbol left">👁️</div>
            <div class="header-title">
                <h1>Bitácora Psiconáutica</h1>
                <p>Tu compañero de viaje para un consumo consciente y responsable</p>
            </div>
            <div class="mystical-symbol right">🗝️</div>
        </div>
    </header>

    <main id="main-content" class="main-content">
        <!-- Calendar View (Default) -->
        <div id="calendar-view" class="view active">
            <div class="sidebar">
                <h3>Sustancias</h3>
                <ul id="substance-list" class="substance-list">
                    <!-- Se llenarán dinámicamente -->
                </ul>
                <button class="add-substance-btn" onclick="openModal('substanceModal')">
                    + Añadir Sustancia
                </button>
            </div>

            <div class="calendar-container">
                <div class="calendar-header">
                    <h2 id="current-month">Enero 2025</h2>
                    <div class="calendar-nav">
                        <button class="nav-btn" onclick="previousMonth()">‹</button>
                        <button class="nav-btn" onclick="nextMonth()">›</button>
                    </div>
                </div>
                <div class="calendar-grid" id="calendar-grid">
                    <!-- Calendar will be generated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Stats View -->
        <div id="stats-view" class="view" style="display: none;">
            <div class="calendar-container">
                <h2>Estadísticas y Análisis</h2>
                <div class="resources-grid" id="stats-content">
                    <!-- Se llenarán dinámicamente -->
                </div>
            </div>
        </div>

        <!-- Resources View -->
        <div id="resources-view" class="view" style="display: none;">
            <div class="calendar-container">
                <h2>Recursos y Harm Reduction</h2>
                <div class="resources-grid">
                    <div class="resource-card" onclick="openExternalURL('https://erowid.org')">
                        <h4>Erowid</h4>
                        <p>Base de datos completa sobre sustancias psicoactivas, experiencias y
                            efectos</p>
                    </div>
                    <div class="resource-card" onclick="openExternalURL('https://tripsit.me')">
                        <h4>TripSit</h4>
                        <p>Información sobre interacciones, dosificación y asistencia en tiempo
                            real</p>
                    </div>
                    <div class="resource-card" onclick="openExternalURL('https://maps.org')">
                        <h4>MAPS</h4>
                        <p>Organización sin ánimo de lucro que investiga los potenciales usos
                            médicos, legales y culturales de los psicodélicos</p>
                    </div>
                    <div class="resource-card"
                         onclick="openExternalURL('https://psychonautwiki.org')">
                        <h4>PsychonautWiki</h4>
                        <p>Enciclopedia científica de sustancias psicoactivas y sus efectos</p>
                    </div>
                    <div class="resource-card"
                         onclick="openExternalURL('https://www.drugscience.org.uk/')">
                        <h4>DrugsScience</h4>
                        <p>Organización independiente líder en información y educación científica sobre drogas, que ofrece recursos y datos basados en evidencia para promover decisiones informadas y políticas sensatas</p>
                    </div>
                    <div class="resource-card" onclick="openBooksModal()">
                        <h4>📚 Libros Recomendados</h4>
                        <p>Bibliografía esencial sobre psiconáuticos, neurociencia y reducción de riesgos</p>
                    </div>
                </div>

            </div>
        </div>


        <!-- Data View -->
        <div id="data-view" class="view" style="display: none;">
            <div class="calendar-container">
                <h2>Gestión de Datos</h2>
                <div class="resources-grid">
                    <div class="resource-card">
                        <h4>Exportar Datos</h4>
                        <p>Descargar todos tus datos en formato CSV</p>
                        <button class="btn-primary" onclick="validateDataBeforeExport()">📤 Exportar CSV</button>
                    </div>
                    <div class="resource-card">
                        <h4>Importar Datos</h4>
                        <p>Cargar datos desde un archivo CSV</p>
                        <input type="file" id="csvFileInput" accept=".csv" style="display: none;"
                               onchange="importFromCSV(this)">
                        <button class="file-label" onclick="forceFileSelect()"
                                style="border: none; width: 100%;">📁 Seleccionar CSV
                        </button>
                    </div>
                    <div class="resource-card">
                        <h4>Limpiar Datos</h4>
                        <p>Eliminar todos los datos almacenados</p>
                        <button class="btn-danger" onclick="clearAllData()">Limpiar Todo</button>
                    </div>
                    <div class="resource-card">
                        <h4>🔄 Auto-Backup</h4>
                        <p>La app crea una copia completa cada 12 horas cuando detecta cambios recientes.</p>
                        <div>
                            <strong>Último backup:</strong>
                            <span id="backupStatusText">Aún no se ha generado.</span>
                        </div>
                        <div class="backup-folder-row">
                            <strong>Carpeta:</strong>
                            <code id="backupPathText" class="backup-path-chip" title="Android/data/com.d4vram.psychologger/files/backups">Android/data/com.d4vram.psychologger/files/backups</code>
                        </div>
                    </div>
                    <div class="resource-card">
                        <h4>💾 Backup Manual</h4>
                        <p>Crear backup completo (datos + audios)</p>
                        <button class="btn-primary" onclick="createManualBackup()">🗄️ Crear Backup</button>
                    </div>
                    <div class="resource-card">
                        <h4>📥 Importar Backup</h4>
                        <p>Restaura datos, audios y fotos desde un ZIP previamente exportado.</p>
                        <button class="btn-secondary" onclick="promptBackupImport()">📥 Importar Backup</button>
                    </div>
                    <div class="resource-card">
                        <h4>🎤 Exportar Audios</h4>
                        <p>Exportar todas las notas de voz en ZIP</p>
                        <button class="btn-primary" onclick="openAudioExportModal()">📦 Exportar ZIP</button>
                    </div>
                    <div class="resource-card">
                        <h4>📸 Exportar Fotos</h4>
                        <p>Descargar todas las imágenes adjuntas en un ZIP</p>
                        <button class="btn-primary" onclick="exportPhotosZip()">🗂️ Exportar Fotos</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <div class="nav-container">
                <div class="nav-item active" onclick="switchView('calendar')">
                    <div class="nav-icon">📅</div>
                    <div class="nav-label">Calendario</div>
                </div>
                <div class="nav-item" onclick="openModal('entryModal'); resetEditMode();">
                    <div class="nav-icon">➕</div>
                    <div class="nav-label">Añadir</div>
                </div>
                <div class="nav-item" onclick="switchView('stats')">
                    <div class="nav-icon">📊</div>
                    <div class="nav-label">Stats</div>
                </div>
                <div class="nav-item" onclick="switchView('resources')">
                    <div class="nav-icon">🔗</div>
                    <div class="nav-label">Recursos</div>
                </div>
                <div class="nav-item" onclick="switchView('data')">
                    <div class="nav-icon">💾</div>
                    <div class="nav-label">Datos</div>
                </div>
            </div>
        </nav>

        <!-- Add Entry Modal -->
        <div id="entryModal" class="modal">
            <div class="modal-content">
                <button class="close-btn" onclick="closeModal('entryModal')">×</button>
                <h3 id="entryModalTitle">Nuevo Registro</h3>
                <form id="entryForm">
                    <div class="form-group">
                        <label>Sustancia *</label>
                        <div class="custom-dropdown" id="entrySubstanceDropdown">
                            <div class="dropdown-header"
                                 onclick="toggleDropdown('entrySubstanceDropdown')">
                                <span class="dropdown-text">Selecciona una sustancia...</span>
                                <span class="dropdown-arrow">▼</span>
                            </div>
                            <div class="dropdown-options" id="entrySubstanceOptions">
                                <!-- Se llenarán dinámicamente -->
                            </div>
                            <input type="hidden" id="entrySubstance" name="entrySubstance" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Dosis *</label>
                        <input type="number" id="entryDose" placeholder="Cantidad" step="0.01"
                               min="0" required>
                    </div>

                    <div class="form-group">
                        <label>Unidad *</label>
                        <div class="custom-dropdown" id="entryUnitDropdown">
                            <div class="dropdown-header"
                                 onclick="toggleDropdown('entryUnitDropdown')">
                                <span class="dropdown-text">Seleccionar unidad...</span>
                                <span class="dropdown-arrow">▼</span>
                            </div>
                            <div class="dropdown-options" id="entryUnitOptions">
                                <!-- Psicodélicos -->
                                <div class="dropdown-option category-header"
                                     data-category="psicodelicos">
                                    <span class="option-emoji">🌌💫🌈</span>
                                    <span class="option-text">PSICODÉLICOS</span>
                                </div>
                                <div class="dropdown-option" data-value="ug"
                                     onclick="selectOption('entryUnitDropdown', 'ug', 'μg (microgramos)', '🧪')">
                                    <span class="option-emoji">🧪</span>
                                    <span class="option-text">μg (microgramos)</span>
                                </div>
                                <div class="dropdown-option" data-value="mg"
                                     onclick="selectOption('entryUnitDropdown', 'mg', 'mg (miligramos)', '💊')">
                                    <span class="option-emoji">💊</span>
                                    <span class="option-text">mg (miligramos)</span>
                                </div>
                                <div class="dropdown-option" data-value="tripi"
                                     onclick="selectOption('entryUnitDropdown', 'tripi', 'tripi completo', '🌌🌈')">
                                    <span class="option-emoji">🌌🌈</span>
                                    <span class="option-text">tripi completo</span>
                                </div>
                                <div class="dropdown-option" data-value="medio-tripi"
                                     onclick="selectOption('entryUnitDropdown', 'medio-tripi', '1/2 tripi', '🌈')">
                                    <span class="option-emoji">🌈</span>
                                    <span class="option-text">1/2 tripi</span>
                                </div>
                                <div class="dropdown-option" data-value="cuarto-tripi"
                                     onclick="selectOption('entryUnitDropdown', 'cuarto-tripi', '1/4 tripi', '🌈')">
                                    <span class="option-emoji">🌈</span>
                                    <span class="option-text">1/4 tripi</span>
                                </div>
                                <div class="dropdown-option" data-value="octavo-tripi"
                                     onclick="selectOption('entryUnitDropdown', 'octavo-tripi', '1/8 tripi', '🌈')">
                                    <span class="option-emoji">🌈</span>
                                    <span class="option-text">1/8 tripi</span>
                                </div>

                                <!-- Campo personalizado para PSICODÉLICOS -->
                                <div class="dropdown-option custom-input-container" data-category="psicodelicos">
                                    <span class="option-emoji">➕</span>
                                    <div class="custom-unit-input">
                                        <input type="text" placeholder="Añadir unidad personalizada..."
                                               class="custom-unit-field" data-category="psicodelicos">
                                        <button type="button" class="add-custom-unit-btn"
                                                onclick="addCustomUnit('psicodelicos', this)">Añadir</button>
                                    </div>
                                </div>

                                <!-- Hongos/Plantas -->
                                <div class="dropdown-option category-header" data-category="hongos">
                                    <span class="option-emoji">🍄</span>
                                    <span class="option-text">HONGOS/PLANTAS</span>
                                </div>
                                <div class="dropdown-option" data-value="g"
                                     onclick="selectOption('entryUnitDropdown', 'mg', 'mg (miligramos)', '🌿🍄')">
                                    <span class="option-emoji">🌿🍄</span>
                                    <span class="option-text">mg (miligramos)</span>
                                </div>
                                <div class="dropdown-option" data-value="g"
                                     onclick="selectOption('entryUnitDropdown', 'g', 'g (gramos)', '🍄')">
                                    <span class="option-emoji">🍄</span>
                                    <span class="option-text">g (gramos)</span>
                                </div>
                                <div class="dropdown-option" data-value="seta"
                                     onclick="selectOption('entryUnitDropdown', 'seta', 'seta completa', '🍄')">
                                    <span class="option-emoji">🍄</span>
                                    <span class="option-text">seta completa</span>
                                </div>
                                <div class="dropdown-option" data-value="media-seta"
                                     onclick="selectOption('entryUnitDropdown', 'media-seta', '1/2 seta', '🍄')">
                                    <span class="option-emoji">🍄</span>
                                    <span class="option-text">1/2 seta</span>
                                </div>

                                <!-- Campo personalizado para HONGOS/PLANTAS -->
                                <div class="dropdown-option custom-input-container" data-category="hongos">
                                    <span class="option-emoji">➕</span>
                                    <div class="custom-unit-input">
                                        <input type="text" placeholder="Añadir unidad personalizada..."
                                               class="custom-unit-field" data-category="hongos">
                                        <button type="button" class="add-custom-unit-btn"
                                                onclick="addCustomUnit('hongos', this)">Añadir</button>
                                    </div>
                                </div>

                                <!-- Estimulantes/MDMA -->
                                <div class="dropdown-option category-header"
                                     data-category="estimulantes">
                                    <span class="option-emoji">🔥</span>
                                    <span class="option-text">ESTIMULANTES/MDMA</span>
                                </div>
                                <div class="dropdown-option" data-value="pastilla"
                                     onclick="selectOption('entryUnitDropdown', 'pastilla', 'pastilla completa', '💊')">
                                    <span class="option-emoji">💊</span>
                                    <span class="option-text">pastilla completa</span>
                                </div>
                                <div class="dropdown-option" data-value="media-pastilla"
                                     onclick="selectOption('entryUnitDropdown', 'media-pastilla', '1/2 pastilla', '💊')">
                                    <span class="option-emoji">💊</span>
                                    <span class="option-text">1/2 pastilla</span>
                                </div>
                                <div class="dropdown-option" data-value="cuarto-pastilla"
                                     onclick="selectOption('entryUnitDropdown', 'cuarto-pastilla', '1/4 pastilla', '💊')">
                                    <span class="option-emoji">💊</span>
                                    <span class="option-text">1/4 pastilla</span>
                                </div>
                                <div class="dropdown-option" data-value="punto"
                                     onclick="selectOption('entryUnitDropdown', 'punto', 'punto/bomba', '💣')">
                                    <span class="option-emoji">💣</span>
                                    <span class="option-text">punto/bomba</span>
                                </div>



                                <!-- Campo personalizado para ESTIMULANTES/MDMA -->
                                <div class="dropdown-option custom-input-container" data-category="estimulantes">
                                    <span class="option-emoji">➕</span>
                                    <div class="custom-unit-input">
                                        <input type="text" placeholder="Añadir unidad personalizada..."
                                               class="custom-unit-field" data-category="estimulantes">
                                        <button type="button" class="add-custom-unit-btn"
                                                onclick="addCustomUnit('estimulantes', this)">Añadir</button>
                                    </div>
                                </div>

                                <!-- Polvo/Cristal -->
                                <div class="dropdown-option category-header" data-category="polvo">
                                    <span class="option-emoji">❄️</span>
                                    <span class="option-text">POLVO/CRISTAL</span>
                                </div>
                                <div class="dropdown-option" data-value="raya"
                                     onclick="selectOption('entryUnitDropdown', 'raya', 'raya/línea', '👃')">
                                    <span class="option-emoji">👃</span>
                                    <span class="option-text">raya</span>
                                </div>
                                <div class="dropdown-option" data-value="tirito"
                                     onclick="selectOption('entryUnitDropdown', 'tirito', 'tirito', '👃')">
                                    <span class="option-emoji">➖</span>
                                    <span class="option-text">tirito</span>
                                </div>
                                <div class="dropdown-option" data-value="bump"
                                     onclick="selectOption('entryUnitDropdown', 'bump', 'bump', '🔹')">
                                    <span class="option-emoji">🔹</span>
                                    <span class="option-text">bump</span>
                                </div>
                                <div class="dropdown-option" data-value="key"
                                     onclick="selectOption('entryUnitDropdown', 'key', 'key bump', '🔑')">
                                    <span class="option-emoji">🔑</span>
                                    <span class="option-text">key bump</span>
                                </div>

                                <!-- Campo personalizado para Polvo/Cristal -->
                                <div class="dropdown-option custom-input-container" data-category="polvo">
                                    <span class="option-emoji">➕</span>
                                    <div class="custom-unit-input">
                                        <input type="text" placeholder="Añadir unidad personalizada..."
                                               class="custom-unit-field" data-category="polvo">
                                        <button type="button" class="add-custom-unit-btn"
                                                onclick="addCustomUnit('polvo', this)">Añadir</button>
                                    </div>
                                </div>

                                <!-- Líquidos -->
                                <div class="dropdown-option category-header"
                                     data-category="liquidos">
                                    <span class="option-emoji">💧</span>
                                    <span class="option-text">LÍQUIDOS</span>
                                </div>
                                <div class="dropdown-option" data-value="ml"
                                     onclick="selectOption('entryUnitDropdown', 'ml', 'ml (mililitros)', '💧')">
                                    <span class="option-emoji">💧</span>
                                    <span class="option-text">ml (mililitros)</span>
                                </div>
                                <div class="dropdown-option" data-value="gotas"
                                     onclick="selectOption('entryUnitDropdown', 'gotas', 'gotas', '💧')">
                                    <span class="option-emoji">💧</span>
                                    <span class="option-text">gotas</span>
                                </div>
                                <div class="dropdown-option" data-value="vial"
                                     onclick="selectOption('entryUnitDropdown', 'vial', 'vial', '🧪')">
                                    <span class="option-emoji">🧪</span>
                                    <span class="option-text">vial</span>
                                </div>

                                <!-- Campo personalizado para LÍQUIDOS -->
                                <div class="dropdown-option custom-input-container" data-category="liquidos">
                                    <span class="option-emoji">➕</span>
                                    <div class="custom-unit-input">
                                        <input type="text" placeholder="Añadir unidad personalizada..."
                                               class="custom-unit-field" data-category="liquidos">
                                        <button type="button" class="add-custom-unit-btn"
                                                onclick="addCustomUnit('liquidos', this)">Añadir</button>
                                    </div>
                                </div>

                                <!-- Otras -->
                                <div class="dropdown-option category-header" data-category="otras">
                                    <span class="option-emoji">🔧</span>
                                    <span class="option-text">OTRAS</span>
                                </div>
                                <div class="dropdown-option" data-value="calada"
                                     onclick="selectOption('entryUnitDropdown', 'calada', 'calada', '🚬')">
                                    <span class="option-emoji">🚬</span>
                                    <span class="option-text">calada</span>
                                </div>
                                <div class="dropdown-option" data-value="inhalacion"
                                     onclick="selectOption('entryUnitDropdown', 'inhalacion', 'inhalación', '👃')">
                                    <span class="option-emoji">👃</span>
                                    <span class="option-text">inhalación</span>
                                </div>
                                <div class="dropdown-option" data-value="aplicacion"
                                     onclick="selectOption('entryUnitDropdown', 'aplicacion', 'aplicación', '🆙')">
                                    <span class="option-emoji">🆙</span>
                                    <span class="option-text">aplicación</span>
                                </div>
                                <div class="dropdown-option" data-value="dosis"
                                     onclick="selectOption('entryUnitDropdown', 'dosis', 'dosis', '🔵')">
                                    <span class="option-emoji">🔵</span>
                                    <span class="option-text">dosis</span>
                                </div>
                                <div class="dropdown-option" data-value="cafe"
                                     onclick="selectOption('entryUnitDropdown', 'cafe', 'Café frío', '☕')">
                                    <span class="option-emoji">☕</span>
                                    <span class="option-text">Café frío</span>
                                </div>
                                <div class="dropdown-option" data-value="cookie"
                                     onclick="selectOption('entryUnitDropdown', 'cookie', 'cookie', '🍪')">
                                    <span class="option-emoji">🍪</span>
                                    <span class="option-text">cookie</span>
                                </div>
                                <div class="dropdown-option" data-value="cookies"
                                     onclick="selectOption('entryUnitDropdown', 'cookies', 'cookies', '🍪🍪')">
                                    <span class="option-emoji">🍪🍪</span>
                                    <span class="option-text">cookies</span>
                                </div>

                                <!-- Campo personalizado para OTRAS -->

                                <div class="dropdown-option custom-input-container" data-category="otras">
                                    <span class="option-emoji">➕</span>
                                    <div class="custom-unit-input">
                                        <input type="text" placeholder="Añadir unidad personalizada..."
                                               class="custom-unit-field" data-category="otras">
                                        <button type="button" class="add-custom-unit-btn"
                                                onclick="addCustomUnit('otras', this)">Añadir</button>
                                    </div>
                                </div>


                            </div>
                            <input type="hidden" id="entryUnit" name="entryUnit" value="" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Fecha y Hora *</label>
                        <div class="custom-datetime-selector" id="entryDateTimeSelector">
                            <div class="datetime-display" onclick="toggleDateTimeModal()">
                                <span class="datetime-text" id="dateTimeDisplay">Establecer fecha y hora</span>
                                <span class="datetime-icon">📅</span>
                            </div>
                        </div>
                        <!-- Input oculto para compatibilidad -->
                        <input type="datetime-local" id="entryDateTime" required style="display: none;">
                    </div>

                    <div class="form-group">
                        <label>Set (Estado mental)</label>
                        <div class="custom-dropdown" id="entrySetDropdown">
                            <div class="dropdown-header"
                                 onclick="toggleDropdown('entrySetDropdown')">
                                <span class="dropdown-text">Seleccionar...</span>
                                <span class="dropdown-arrow">▼</span>
                            </div>
                            <div class="dropdown-options" id="entrySetOptions">
                                <div class="dropdown-option" data-value="excelente"
                                     onclick="selectOption('entrySetDropdown', 'excelente', 'Excelente', '😊')">
                                    <span class="option-emoji">😊</span>
                                    <span class="option-text">Excelente</span>
                                </div>
                                <div class="dropdown-option" data-value="bueno"
                                     onclick="selectOption('entrySetDropdown', 'bueno', 'Bueno', '🙂')">
                                    <span class="option-emoji">🙂</span>
                                    <span class="option-text">Bueno</span>
                                </div>
                                <div class="dropdown-option" data-value="neutral"
                                     onclick="selectOption('entrySetDropdown', 'neutral', 'Neutral', '😐')">
                                    <span class="option-emoji">😐</span>
                                    <span class="option-text">Neutral</span>
                                </div>
                                <div class="dropdown-option" data-value="ansioso"
                                     onclick="selectOption('entrySetDropdown', 'ansioso', 'Ansioso', '😰')">
                                    <span class="option-emoji">😰</span>
                                    <span class="option-text">Ansioso</span>
                                </div>
                                <div class="dropdown-option" data-value="triste"
                                     onclick="selectOption('entrySetDropdown', 'triste', 'Triste', '😢')">
                                    <span class="option-emoji">😢</span>
                                    <span class="option-text">Triste</span>
                                </div>
                                <div class="dropdown-option" data-value="estresado"
                                     onclick="selectOption('entrySetDropdown', 'estresado', 'Estresado', '😤')">
                                    <span class="option-emoji">😤</span>
                                    <span class="option-text">Estresado</span>
                                </div>
                                <div class="dropdown-option" data-value="emocionado"
                                     onclick="selectOption('entrySetDropdown', 'emocionado', 'Emocionado', '🤩')">
                                    <span class="option-emoji">🤩</span>
                                    <span class="option-text">Emocionado</span>
                                </div>
                                <div class="dropdown-option" data-value="introspectivo"
                                     onclick="selectOption('entrySetDropdown', 'introspectivo', 'Introspectivo', '🤔')">
                                    <span class="option-emoji">🤔</span>
                                    <span class="option-text">Introspectivo</span>
                                </div>
                                <div class="dropdown-option" data-value="creativo"
                                     onclick="selectOption('entrySetDropdown', 'creativo', 'Creativo', '🎨')">
                                    <span class="option-emoji">🎨</span>
                                    <span class="option-text">Creativo</span>
                                </div>
                                <div class="dropdown-option" data-value="curioso"
                                     onclick="selectOption('entrySetDropdown', 'curioso', 'Curioso', '🧐')">
                                    <span class="option-emoji">🧐</span>
                                    <span class="option-text">Curioso</span>
                                </div>
                                <div class="dropdown-option" data-value="aburrido"
                                     onclick="selectOption('entrySetDropdown', 'aburrido', 'Aburrido', '😴')">
                                    <span class="option-emoji">😴</span>
                                    <span class="option-text">Aburrido</span>
                                </div>
                                <div class="dropdown-option" data-value="desanimado"
                                     onclick="selectOption('entrySetDropdown', 'desanimado', 'Desanimado', '😨')">
                                    <span class="option-emoji">😨</span>
                                    <span class="option-text">Desanimado</span>
                                </div>
                                <div class="dropdown-option" data-value="Pain crisis"
                                     onclick="selectOption('entrySetDropdown', 'Pain crisis', 'Pain crisis', '🚨')">
                                    <span class="option-emoji">😵‍💫</span>
                                    <span class="option-text">Colocado</span>
                                </div>
                                <div class="dropdown-option" data-value="Pain crisis"
                                     onclick="selectOption('entrySetDropdown', 'Pain crisis', 'Pain crisis', '🚨')">
                                    <span class="option-emoji">🚨</span>
                                    <span class="option-text">Pain crisis</span>
                                </div>

                                <!-- Campo personalizado para SET -->
                                <div class="dropdown-option custom-input-container" data-category="set">
                                    <span class="option-emoji">➕</span>
                                    <div class="custom-unit-input">
                                        <input type="text" placeholder="Añadir estado mental personalizado..."
                                               class="custom-unit-field" data-category="set">
                                        <button type="button" class="add-custom-unit-btn"
                                                onclick="addCustomSet(this)">Añadir</button>
                                    </div>
                                </div>
                            </div>
                            <input type="hidden" id="entrySet" name="entrySet">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Setting (Entorno)</label>
                        <div class="custom-dropdown" id="entrySettingDropdown">
                            <div class="dropdown-header"
                                 onclick="toggleDropdown('entrySettingDropdown')">
                                <span class="dropdown-text">Seleccionar...</span>
                                <span class="dropdown-arrow">▼</span>
                            </div>
                            <div class="dropdown-options" id="entrySettingOptions">
                                <div class="dropdown-option" data-value="casa"
                                     onclick="selectOption('entrySettingDropdown', 'casa', 'En casa', '🏠')">
                                    <span class="option-emoji">🏠</span>
                                    <span class="option-text">En casa</span>
                                </div>
                                <div class="dropdown-option" data-value="programando"
                                     onclick="selectOption('entrySettingDropdown', 'programando', 'Programando/Estudiando', '💻')">
                                    <span class="option-emoji">💻</span>
                                    <span class="option-text">Programando/Estudiando</span>
                                </div>
                                <div class="dropdown-option" data-value="seriefilo"
                                     onclick="selectOption('entrySettingDropdown', 'seriefilo', 'Seriefilo, pelis o música', '🎬🎵')">
                                    <span class="option-emoji">🎬🎵</span>
                                    <span class="option-text">Seriefilo, pelis o música</span>
                                </div>
                                <div class="dropdown-option" data-value="meditacion"
                                     onclick="selectOption('entrySettingDropdown', 'meditacion', 'Meditación/Yoga', '🧘')">
                                    <span class="option-emoji">🧘</span>
                                    <span class="option-text">Meditación/Yoga</span>
                                </div>
                                <div class="dropdown-option" data-value="paseo"
                                     onclick="selectOption('entrySettingDropdown', 'paseo', 'Paseo/Calle', '🚶')">
                                    <span class="option-emoji">🚶</span>
                                    <span class="option-text">Paseo/Calle</span>
                                </div>
                                <div class="dropdown-option" data-value="naturaleza"
                                     onclick="selectOption('entrySettingDropdown', 'naturaleza', 'Naturaleza', '🌲')">
                                    <span class="option-emoji">🌲</span>
                                    <span class="option-text">Naturaleza</span>
                                </div>
                                <div class="dropdown-option" data-value="fiesta"
                                     onclick="selectOption('entrySettingDropdown', 'fiesta', 'Fiesta/Evento', '🎉')">
                                    <span class="option-emoji">🎉</span>
                                    <span class="option-text">Fiesta/Evento</span>
                                </div>
                                <div class="dropdown-option" data-value="festival"
                                     onclick="selectOption('entrySettingDropdown', 'festival', 'Festival', '🎪')">
                                    <span class="option-emoji">🎪</span>
                                    <span class="option-text">Festival</span>
                                </div>
                                <div class="dropdown-option" data-value="amigos"
                                     onclick="selectOption('entrySettingDropdown', 'amigos', 'Con amigos', '👥')">
                                    <span class="option-emoji">👥</span>
                                    <span class="option-text">Con amigos</span>
                                </div>
                                <div class="dropdown-option" data-value="solo"
                                     onclick="selectOption('entrySettingDropdown', 'solo', 'Solo/a', '👤')">
                                    <span class="option-emoji">👤</span>
                                    <span class="option-text">Solo/a</span>
                                </div>
                                <div class="dropdown-option" data-value="pareja"
                                     onclick="selectOption('entrySettingDropdown', 'pareja', 'En pareja', '💑')">
                                    <span class="option-emoji">💑</span>
                                    <span class="option-text">En pareja</span>
                                </div>
                                <div class="dropdown-option" data-value="concierto"
                                     onclick="selectOption('entrySettingDropdown', 'concierto', 'Concierto', '🎵')">
                                    <span class="option-emoji">🎵</span>
                                    <span class="option-text">Concierto</span>
                                </div>
                                <div class="dropdown-option" data-value="ceremonia"
                                     onclick="selectOption('entrySettingDropdown', 'ceremonia', 'Ceremonia', '🕯️')">
                                    <span class="option-emoji">🕯️</span>
                                    <span class="option-text">Ceremonia</span>
                                </div>

                                <!-- Campo personalizado para SETTING -->
                                <div class="dropdown-option custom-input-container" data-category="setting">
                                    <span class="option-emoji">➕</span>
                                    <div class="custom-unit-input">
                                        <input type="text" placeholder="Añadir entorno personalizado..."
                                               class="custom-unit-field" data-category="setting">
                                        <button type="button" class="add-custom-unit-btn"
                                                onclick="addCustomSetting(this)">Añadir</button>
                                    </div>
                                </div>
                            </div>
                            <input type="hidden" id="entrySetting" name="entrySetting">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Notas adicionales</label>
                        <textarea id="entryNotes"
                                  placeholder="ROA (vía de administración), efectos esperados, compañía, música, etc..."
                                  rows="4"></textarea>
                        <small style="color: var(--text-muted); font-size: 0.8rem;">
                            💡 Tip: Incluye ROA (oral, sublingual, nasal, etc.), testing, pureza
                            estimada, etc.
                        </small>
                    </div>

                    <div class="form-group">
                        <label>Adjuntos</label>
                        <div class="media-attachments-grid">
                            <div class="media-card" id="voiceNoteCard" onclick="openAudioModal()">
                                <div class="media-card-header">
                                    <div class="media-card-icon">🎤</div>
                                    <div>
                                        <div class="media-card-title">Nota de voz</div>
                                        <div class="media-card-subtitle" id="voiceNoteCardSubtitle">Sin nota de voz</div>
                                    </div>
                                </div>
                                <div class="media-card-footer" id="voiceNoteCardFooter">
                                    Pulsa para grabar o escuchar
                                </div>
                            </div>
                            <div class="media-card" id="photoAttachmentCard" onclick="openPhotoModal()">
                                <div class="media-card-header">
                                    <div class="media-card-icon">📷</div>
                                    <div>
                                        <div class="media-card-title">Foto / Imagen</div>
                                        <div class="media-card-subtitle" id="photoCardSubtitle">Sin imagen adjunta</div>
                                    </div>
                                </div>
                                <div class="media-card-footer" id="photoCardFooter">
                                    Captura o selecciona una imagen
                                </div>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn-primary">💾 Guardar Registro</button>
                </form>
            </div>
        </div>

        <!-- Modal Nota de Voz -->
        <div id="audioModal" class="modal">
            <div class="modal-content" style="max-width: 480px;">
                <button class="close-btn" onclick="closeModal('audioModal')">×</button>
                <h3>🎤 Nota de voz</h3>
                <p style="color: var(--text-muted); margin-bottom: 16px; font-size: 0.9rem;">
                    Graba, escucha o elimina la nota de voz asociada a este registro.
                </p>

                <button type="button" id="btnStartRecording" class="btn-audio-record" style="display: none;">
                    🎤 Grabar nota de voz
                </button>

                <div id="recordingCard" class="audio-recording-card" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div class="recording-pulse"></div>
                            <div>
                                <div style="font-weight: 600; color: var(--danger);">Grabando...</div>
                                <div id="recordingTimer" style="font-size: 0.9rem; color: var(--text-muted);">00:00</div>
                            </div>
                        </div>
                        <button type="button" id="btnStopRecording" class="btn-icon-danger">
                            ⏹️ Detener
                        </button>
                    </div>
                </div>

                <div id="audioPlayerCard" class="audio-player-card" style="display: none;">
                    <div style="font-weight: 600; margin-bottom: 12px;">🎤 Nota de voz lista</div>

                    <div class="audio-progress-container">
                        <div id="audioProgressBar" class="audio-progress-bar"></div>
                    </div>

                    <div style="display: flex; justify-content: center; margin-top: 12px;">
                        <button type="button" id="btnPlayPause" class="btn-icon-large">
                            ▶️
                        </button>
                    </div>

                    <div id="audioDuration" style="text-align: center; font-size: 0.85rem; color: var(--text-muted); margin-top: 8px;">
                        00:00
                    </div>

                    <div id="audioModalActions" class="modal-attachment-actions">
                        <button type="button" id="btnSaveAudioAttachment" class="btn-primary">💾 Guardar</button>
                        <button type="button" id="btnShareAudio" class="btn-outline">📤 Compartir</button>
                        <button type="button" id="btnDeleteAudio" class="btn-danger">🗑️ Eliminar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Foto / Imagen -->
        <div id="photoModal" class="modal">
            <div class="modal-content" style="max-width: 520px;">
                <button class="close-btn" onclick="closeModal('photoModal')">×</button>
                <h3>📷 Foto / Imagen</h3>
                <p style="color: var(--text-muted); margin-bottom: 16px; font-size: 0.9rem;">
                    Añade una foto para complementar este registro. Puedes tomarla ahora o elegirla desde tu galería.
                </p>

                <div id="photoPreview" class="photo-modal-preview empty">
                    <div style="font-size: 2rem;">🖼️</div>
                    <div>No hay imagen adjunta todavía</div>
                </div>

                <div class="photo-modal-actions">
                    <button type="button" id="btnCapturePhoto" class="btn-primary">📸 Tomar foto</button>
                    <button type="button" id="btnPickPhoto" class="btn-outline">🖼️ Elegir de galería</button>
                </div>

                <div id="photoExtraActions" class="photo-extra-actions" style="display: none;">
                    <button type="button" id="btnSavePhotoAttachment" class="btn-primary">💾 Guardar</button>
                    <button type="button" id="btnViewPhoto" class="btn-outline">👁️ Ver</button>
                    <button type="button" id="btnSharePhoto" class="btn-outline">📤 Compartir</button>
                    <button type="button" id="btnDeletePhoto" class="btn-danger">🗑️ Eliminar</button>
                </div>
            </div>
        </div>

        <!-- Audio Export Modal -->
        <div id="audioExportModal" class="modal">
            <div class="modal-content" style="max-width: 450px;">
                <button class="close-btn" onclick="closeModal('audioExportModal')">×</button>
                <h3>📦 Exportar Notas de Voz</h3>

                <div style="margin: 20px 0;">
                    <p style="color: var(--text-muted); font-size: 0.9rem;">
                        Exporta todas tus notas de voz en un archivo ZIP. Opcionalmente puedes cifrarlo con contraseña (AES-256).
                    </p>
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="encryptAudioZip" style="width: auto;">
                        <span>🔒 Cifrar con contraseña (AES-256)</span>
                    </label>
                </div>

                <div id="passwordGroup" class="form-group" style="display: none;">
                    <label>Contraseña (mínimo 8 caracteres)</label>
                    <input type="password" id="audioZipPassword" placeholder="Introduce una contraseña fuerte" minlength="8">
                    <small style="color: var(--text-muted); font-size: 0.8rem;">
                        ⚠️ Guarda esta contraseña en un lugar seguro. Sin ella no podrás desencriptar el archivo.
                    </small>
                </div>

                <div style="display: flex; gap: 12px; margin-top: 24px;">
                    <button type="button" class="btn-secondary" onclick="closeModal('audioExportModal')" style="flex: 1;">
                        Cancelar
                    </button>
                    <button type="button" class="btn-primary" onclick="exportAudiosZip()" style="flex: 1;">
                        📤 Exportar
                    </button>
                </div>
            </div>
        </div>

        <!-- Add Substance Modal -->
        <div id="substanceModal" class="modal">
            <div class="modal-content">
                <button class="close-btn" onclick="closeModal('substanceModal')">×</button>
                <h3>Añadir Nueva Sustancia</h3>
                <form id="substanceForm" onsubmit="return false;">
                    <div class="form-group">
                        <label>Nombre</label>
                        <input type="text" id="substanceName"
                               placeholder="LSD, MDMA, Psilocibina..." required>
                    </div>
                    <div class="form-group">
                        <label>Emoji Personalizado (opcional)</label>
                        <div class="emoji-picker">
                            <input type="text" id="substanceEmoji" placeholder="🍪" maxlength="4"
                                   style="font-size: 1.5rem; text-align: center; width: 60px;">
                            <button type="button" onclick="suggestEmoji()" class="btn-secondary"
                                    style="padding: 0.5rem; font-size: 0.8rem;">💡 Sugerir
                            </button>
                            <span class="emoji-suggestion">💡 Deja vacío para auto-detectar</span>
                        </div>
                    </div>
                    <div class="color-picker-container">
                        <label>Color Identificativo</label>
                        <div class="color-options">
                            <div class="color-option" data-color="#8B5CF6"
                                 style="background: #8B5CF6"></div>
                            <div class="color-option" data-color="#EC4899"
                                 style="background: #EC4899"></div>
                            <div class="color-option" data-color="#06B6D4"
                                 style="background: #06B6D4"></div>
                            <div class="color-option" data-color="#F97316"
                                 style="background: #F97316"></div>
                            <div class="color-option" data-color="#10B981"
                                 style="background: #10B981"></div>
                            <div class="color-option" data-color="#F59E0B"
                                 style="background: #F59E0B"></div>
                            <div class="color-option" data-color="#EF4444"
                                 style="background: #EF4444"></div>
                            <div class="color-option" data-color="#8B5A2B"
                                 style="background: #8B5A2B"></div>
                            <div class="color-option" data-color="#6366F1"
                                 style="background: #6366F1"></div>
                            <div class="color-option" data-color="#84CC16"
                                 style="background: #84CC16"></div>
                            <div class="color-option" data-color="#F472B6"
                                 style="background: #F472B6"></div>
                            <div class="color-option" data-color="#14B8A6"
                                 style="background: #14B8A6"></div>
                            <!-- Nuevos colores añadidos -->
                            <div class="color-option" data-color="#A855F7"
                                 style="background: #A855F7"></div>
                            <div class="color-option" data-color="#E91E63"
                                 style="background: #E91E63"></div>
                            <div class="color-option" data-color="#00BCD4"
                                 style="background: #00BCD4"></div>
                            <div class="color-option" data-color="#FF9800"
                                 style="background: #FF9800"></div>
                            <div class="color-option" data-color="#4CAF50"
                                 style="background: #4CAF50"></div>
                            <div class="color-option" data-color="#FFC107"
                                 style="background: #FFC107"></div>
                            <div class="color-option" data-color="#F44336"
                                 style="background: #F44336"></div>
                            <div class="color-option" data-color="#795548"
                                 style="background: #795548"></div>
                            <div class="color-option" data-color="#3F51B5"
                                 style="background: #3F51B5"></div>
                            <div class="color-option" data-color="#8BC34A"
                                 style="background: #8BC34A"></div>
                            <div class="color-option" data-color="#E91E63"
                                 style="background: #E91E63"></div>
                            <div class="color-option" data-color="#009688"
                                 style="background: #009688"></div>
                            <div class="color-option" data-color="#9C27B0"
                                 style="background: #9C27B0"></div>
                            <div class="color-option" data-color="#FF5722"
                                 style="background: #FF5722"></div>
                            <div class="color-option" data-color="#607D8B"
                                 style="background: #607D8B"></div>
                        </div>
                    </div>
                    <button type="button" class="btn-primary" onclick="addSubstance()">Añadir
                        Sustancia
                    </button>
                </form>
            </div>
        </div>


        <script>
            // Global variables
            let currentDate = new Date();
            let isEditMode = false;
            let currentEditingEntryId = null;
            let substances = [];
            let entries = [];
            let userProfile = {};
            let selectedSubstanceColor = '#8B5CF6';
            let selectedSubstanceFilter = null;

            // ========================================
            // VARIABLES GLOBALES DE AUDIO
            // ========================================
            let currentAudioFilename = null;  // Nombre del archivo de audio actual
            let currentPhotoFilename = null;  // Nombre del archivo de foto actual
            let recordingTimerInterval = null;  // Intervalo del timer de grabación
            let isPlaying = false;  // Estado de reproducción

            // ========================================
            // FUNCIONES DE AUDIO - Grabación
            // ========================================

            /**
             * Iniciar grabación de audio
             *
             * CONCEPTO: Llamada al bridge Android
             * Android.startRecording() ejecuta el método en Kotlin
             * Kotlin retorna el nombre del archivo o un mensaje de error
             */
            function startRecording() {
                try {
                    const result = Android.startRecording();

                    if (result.startsWith('ERROR:')) {
                        console.error('Error al grabar:', result);
                        return;
                    }

                    // Guardar el nombre del archivo
                    currentAudioFilename = result;

                    // Actualizar UI
                    updateAudioUI('recording');

                    // Iniciar timer visual
                    startRecordingTimer();

                } catch (error) {
                    console.error('Error al iniciar grabación:', error);
                    Android.showToast('❌ Error: ' + error.message);
                }
            }

            /**
             * Detener grabación y guardar
             */
            function stopRecording() {
                try {
                    const result = Android.stopRecording();
                    const data = JSON.parse(result);

                    if (data.error) {
                        console.error('Error al detener:', data.error);
                        return;
                    }

                    // Guardar información del audio
                    currentAudioFilename = data.filename;

                    // Detener timer
                    stopRecordingTimer();

                    // Actualizar UI para mostrar reproductor
                    updateAudioUI('player');

                    console.log('Audio grabado:', data.filename, 'Duración:', data.duration + 'ms');

                } catch (error) {
                    console.error('Error al detener grabación:', error);
                    Android.showToast('❌ Error: ' + error.message);
                }
            }

            /**
             * Eliminar audio actual
             */
            function deleteAudio() {
                if (!currentAudioFilename) return;

                if (confirm('¿Eliminar esta nota de voz?')) {
                    // Detener reproducción si está activa
                    if (isPlaying) {
                        Android.stopAudio();
                        isPlaying = false;
                    }

                    // Eliminar archivo
                    const result = Android.deleteAudio(currentAudioFilename);

                    if (result === 'OK') {
                        currentAudioFilename = null;
                        updateAudioUI('initial');
                        Android.showToast('🗑️ Nota de voz eliminada');
                    } else {
                        console.error('Error al eliminar:', result);
                    }
                }
            }

            /**
             * Compartir audio actual
             */
            function shareAudio() {
                if (!currentAudioFilename) return;
                Android.shareAudio(currentAudioFilename);
            }

            function confirmAudioAttachment() {
                if (!currentAudioFilename) {
                    showCustomAlert('No hay ninguna nota de voz para guardar.', '🎤 Sin nota de voz');
                    return;
                }

                updateVoiceNoteCard();
                closeModal('audioModal');
                if (typeof Android !== 'undefined' && Android.showToast) {
                    Android.showToast('🎤 Nota de voz lista para este registro');
                }
            }

            // ========================================
            // FUNCIONES DE AUDIO - Reproducción
            // ========================================

            /**
             * Toggle play/pause
             */
            function togglePlayPause() {
                if (!currentAudioFilename) return;

                if (isPlaying) {
                    Android.pauseAudio();
                    isPlaying = false;
                    updatePlayButton('▶️');
                } else {
                    const isPlayingCheck = Android.isPlayingAudio();

                    if (isPlayingCheck === 'true') {
                        // Ya estaba reproduciéndose, resumir
                        Android.resumeAudio();
                    } else {
                        // Iniciar nueva reproducción
                        const result = Android.playAudio(currentAudioFilename);
                        if (result.startsWith('ERROR:')) {
                            console.error('Error al reproducir:', result);
                            Android.showToast('❌ ' + result);
                            return;
                        }
                    }

                    isPlaying = true;
                    updatePlayButton('⏸️');
                }
            }

            /**
             * Callback invocado por Kotlin cuando el audio termina
             *
             * CONCEPTO: Callbacks desde Android a JavaScript
             * Kotlin llama window.onAudioCompleted()
             * Este callback se ejecuta automáticamente
             */
            window.onAudioCompleted = function() {
                isPlaying = false;
                updatePlayButton('▶️');
                updateAudioProgress(0);
            };

            /**
             * Callback de progreso invocado por Kotlin cada 100ms
             *
             * @param progress Float entre 0.0 y 1.0
             * @param currentMs Posición actual en milisegundos
             * @param totalMs Duración total en milisegundos
             */
            window.onAudioProgressUpdate = function(progress, currentMs, totalMs) {
                updateAudioProgress(progress);
                updateAudioDuration(currentMs, totalMs);
            };

            /**
             * Callback de errores de audio
             */
            window.onAudioError = function(message) {
                console.error('Error de audio:', message);
                isPlaying = false;
                updatePlayButton('▶️');
            };

            // ========================================
            // FUNCIONES DE UI - Actualización de Interfaz
            // ========================================

            /**
             * Actualiza la UI según el estado del audio
             *
             * @param state 'initial' | 'recording' | 'player'
             *
             * CONCEPTO: Gestión de estados en UI
             * Solo uno de los 3 elementos es visible a la vez:
             * - btnStartRecording: Estado inicial (sin audio)
             * - recordingCard: Durante grabación
             * - audioPlayerCard: Cuando hay audio listo
             */
            function updateAudioUI(state) {
                const btnStart = document.getElementById('btnStartRecording');
                const recordingCard = document.getElementById('recordingCard');
                const playerCard = document.getElementById('audioPlayerCard');
                const modalActions = document.getElementById('audioModalActions');
                const saveAudioBtn = document.getElementById('btnSaveAudioAttachment');

                if (!btnStart || !recordingCard || !playerCard) {
                    return;
                }

                // Ocultar todo primero
                btnStart.style.display = 'none';
                recordingCard.style.display = 'none';
                playerCard.style.display = 'none';

                // Mostrar el elemento correspondiente
                if (state === 'initial') {
                    btnStart.style.display = 'block';
                } else if (state === 'recording') {
                    recordingCard.style.display = 'block';
                } else if (state === 'player') {
                    playerCard.style.display = 'block';
                    updatePlayButton('▶️');
                    updateAudioProgress(0);
                }

                if (modalActions) {
                    const shouldShowActions = state === 'player' && !!currentAudioFilename;
                    modalActions.style.display = shouldShowActions ? 'flex' : 'none';
                }
                if (saveAudioBtn) {
                    saveAudioBtn.disabled = !currentAudioFilename;
                }

                updateVoiceNoteCard();
            }

            /**
             * Actualiza el icono del botón play/pause
             */
            function updatePlayButton(icon) {
                const btn = document.getElementById('btnPlayPause');
                if (btn) btn.textContent = icon;
            }

            /**
             * Actualiza la barra de progreso de reproducción
             *
             * @param progress Float entre 0.0 y 1.0
             */
            function updateAudioProgress(progress) {
                const bar = document.getElementById('audioProgressBar');
                if (bar) {
                    bar.style.width = (progress * 100) + '%';
                }
            }

            /**
             * Actualiza el texto de duración "00:15 / 01:23"
             */
            function updateAudioDuration(currentMs, totalMs) {
                const durationEl = document.getElementById('audioDuration');
                if (durationEl) {
                    const current = formatTime(currentMs);
                    const total = formatTime(totalMs);
                    durationEl.textContent = `${current} / ${total}`;
                }
            }

            /**
             * Actualiza el estado visual de la tarjeta de nota de voz
             */
            function updateVoiceNoteCard() {
                const card = document.getElementById('voiceNoteCard');
                const subtitle = document.getElementById('voiceNoteCardSubtitle');
                const footer = document.getElementById('voiceNoteCardFooter');

                if (!card || !subtitle || !footer) return;

                if (currentAudioFilename) {
                    card.classList.add('has-attachment');
                    subtitle.textContent = 'Nota de voz lista';
                    footer.textContent = 'Pulsa para escuchar o eliminar';
                } else {
                    card.classList.remove('has-attachment');
                    subtitle.textContent = 'Sin nota de voz';
                    footer.textContent = 'Pulsa para grabar o escuchar';
                }
            }

            /**
             * Abre el modal de nota de voz sincronizando el estado previo
             */
            function openAudioModal() {
                updateAudioUI(currentAudioFilename ? 'player' : 'initial');
                updateVoiceNoteCard();
                openModal('audioModal');
            }

            /**
             * Actualiza la tarjeta de foto adjunta
             */
            function updatePhotoCard() {
                const card = document.getElementById('photoAttachmentCard');
                const subtitle = document.getElementById('photoCardSubtitle');
                const footer = document.getElementById('photoCardFooter');

                if (!card || !subtitle || !footer) return;

                if (currentPhotoFilename) {
                    card.classList.add('has-attachment');
                    subtitle.textContent = 'Imagen adjunta lista';
                    footer.textContent = 'Pulsa para verla o cambiarla';
                } else {
                    card.classList.remove('has-attachment');
                    subtitle.textContent = 'Sin imagen adjunta';
                    footer.textContent = 'Captura o selecciona una imagen';
                }
            }

            /**
             * Actualiza la vista previa del modal de foto y sus acciones
             */
            function updatePhotoModalControls() {
                const preview = document.getElementById('photoPreview');
                const extraActions = document.getElementById('photoExtraActions');
                const saveButton = document.getElementById('btnSavePhotoAttachment');

                if (!preview) return;

                if (!currentPhotoFilename) {
                    if (extraActions) extraActions.style.display = 'none';
                    if (saveButton) saveButton.disabled = true;
                    preview.classList.add('empty');
                    preview.innerHTML = `
                        <div style="font-size: 2rem;">🖼️</div>
                        <div>No hay imagen adjunta todavía</div>
                    `;
                    return;
                }

                if (extraActions) extraActions.style.display = 'flex';
                if (saveButton) saveButton.disabled = false;
                preview.classList.remove('empty');

                try {
                    const dataUrl = (typeof Android !== 'undefined' && Android.getPhotoPreview)
                        ? Android.getPhotoPreview(currentPhotoFilename)
                        : '';

                    if (dataUrl) {
                        preview.innerHTML = `<img src="${dataUrl}" alt="Foto adjunta">`;
                    } else {
                        preview.classList.add('empty');
                        preview.innerHTML = `
                            <div style="font-size: 2rem;">🖼️</div>
                            <div>No se pudo cargar la vista previa</div>
                        `;
                    }
                } catch (error) {
                    console.error('Error obteniendo vista previa de la foto:', error);
                    preview.classList.add('empty');
                    preview.innerHTML = `
                        <div style="font-size: 2rem;">⚠️</div>
                        <div>No se pudo cargar la vista previa</div>
                    `;
                }
            }

            /**
             * Abre el modal de foto asegurando que la vista previa esté actualizada
             */
            function openPhotoModal() {
                updatePhotoCard();
                updatePhotoModalControls();
                openModal('photoModal');
            }

            /**
             * Inicia la captura de foto con la cámara
             */
            function capturePhotoFromCamera() {
                if (typeof Android === 'undefined' || !Android.capturePhoto) {
                    showCustomAlert('Esta función solo está disponible en Android.', '❌ No disponible');
                    return;
                }
                Android.capturePhoto();
            }

            /**
             * Permite elegir una imagen desde la galería
             */
            function pickPhotoFromGallery() {
                if (typeof Android === 'undefined' || !Android.pickPhotoFromGallery) {
                    showCustomAlert('Esta función solo está disponible en Android.', '❌ No disponible');
                    return;
                }
                Android.pickPhotoFromGallery();
            }

            function viewPhotoAttachment() {
                if (!currentPhotoFilename) {
                    showCustomAlert('No hay ninguna imagen adjunta todavía.', '📷 Sin imagen');
                    return;
                }
                if (typeof Android !== 'undefined' && Android.viewPhoto) {
                    Android.viewPhoto(currentPhotoFilename);
                }
            }

            function sharePhotoAttachment() {
                if (!currentPhotoFilename) {
                    showCustomAlert('No hay ninguna imagen adjunta que compartir.', '📷 Sin imagen');
                    return;
                }
                if (typeof Android !== 'undefined' && Android.sharePhoto) {
                    Android.sharePhoto(currentPhotoFilename);
                }
            }

            function deletePhotoAttachment() {
                if (!currentPhotoFilename) {
                    showCustomAlert('No hay ninguna imagen adjunta que eliminar.', '📷 Sin imagen');
                    return;
                }

                showCustomConfirm(
                    '¿Eliminar la imagen adjunta?',
                    '🗑️ Eliminar foto',
                    () => {
                        if (typeof Android !== 'undefined' && Android.deletePhoto) {
                            const result = Android.deletePhoto(currentPhotoFilename);
                            if (result === 'OK') {
                                currentPhotoFilename = null;
                                updatePhotoCard();
                                updatePhotoModalControls();
                                Android.showToast('🗑️ Foto eliminada');
                            } else {
                                showCustomAlert(result || 'No se pudo eliminar la foto.', '❌ Error');
                            }
                        }
                    }
                );
            }

            function confirmPhotoAttachment() {
                if (!currentPhotoFilename) {
                    showCustomAlert('No hay ninguna imagen para guardar.', '📷 Sin imagen');
                    return;
                }

                updatePhotoCard();
                updatePhotoModalControls();
                closeModal('photoModal');
                if (typeof Android !== 'undefined' && Android.showToast) {
                    Android.showToast('📷 Imagen lista para este registro');
                }
            }

            window.onPhotoCaptured = function(filename) {
                if (!filename) {
                    return;
                }
                currentPhotoFilename = filename;
                updatePhotoCard();
                updatePhotoModalControls();
                if (typeof Android !== 'undefined' && Android.showToast) {
                    Android.showToast('📷 Foto guardada');
                }
            };

            window.onPhotoCaptureError = function(message) {
                console.error('Error capturando foto:', message);
                if (message) {
                    showCustomAlert(message, '❌ Error al capturar foto');
                }
            };

            /**
             * Timer de grabación (actualiza cada 1 segundo)
             *
             * CONCEPTO: setInterval en JavaScript
             * Ejecuta una función cada X milisegundos
             * Guarda el ID para poder detenerlo con clearInterval()
             */
            function startRecordingTimer() {
                let startTime = Date.now();

                recordingTimerInterval = setInterval(() => {
                    const elapsed = Date.now() - startTime;
                    const timerEl = document.getElementById('recordingTimer');
                    if (timerEl) {
                        timerEl.textContent = formatTime(elapsed);
                    }
                }, 1000);  // Actualizar cada 1 segundo
            }

            function stopRecordingTimer() {
                if (recordingTimerInterval) {
                    clearInterval(recordingTimerInterval);
                    recordingTimerInterval = null;
                }
            }

            /**
             * Formatea milisegundos a formato "mm:ss"
             *
             * CONCEPTO: Manipulación de tiempo
             * Math.floor() redondea hacia abajo
             * padStart(2, '0') añade ceros a la izquierda: "5" → "05"
             *
             * @param ms Milisegundos
             * @return String formato "02:35"
             */
            function formatTime(ms) {
                const totalSeconds = Math.floor(ms / 1000);
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;
                return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }

            // Función para sincronizar datos desde localStorage
            function syncDataFromStorage() {
                try {
                    // Cargar sustancias
                    const storedSubstances = localStorage.getItem('substances');
                    if (storedSubstances) {
                        substances = JSON.parse(storedSubstances);
                    } else {
                        substances = getDefaultSubstances();
                        localStorage.setItem('substances', JSON.stringify(substances));
                    }

                    // Cargar entradas
                    const storedEntries = localStorage.getItem('entries');
                    if (storedEntries) {
                        entries = JSON.parse(storedEntries);
                        // Asegurar que todos los registros tengan la estructura completa
                        entries = entries.map(entry => ({
                            id: entry.id || generateUniqueId(),
                            substance: entry.substance || '',
                            dose: entry.dose || 0,
                            unit: entry.unit || '',
                            date: entry.date || new Date().toISOString(),
                            set: entry.set || '',
                            setting: entry.setting || '',
                            notes: entry.notes || '',
                            audioPath: entry.audioPath || null,
                            photoPath: entry.photoPath || null,
                            createdAt: entry.createdAt || new Date().toISOString(),
                            updatedAt: entry.updatedAt || ''
                        }));
                    } else {
                        entries = [];
                        localStorage.setItem('entries', JSON.stringify(entries));
                    }

                    // Cargar perfil de usuario
                    const storedProfile = localStorage.getItem('userProfile');
                    if (storedProfile) {
                        userProfile = JSON.parse(storedProfile);
                    } else {
                        userProfile = {};
                        localStorage.setItem('userProfile', JSON.stringify(userProfile));
                    }


                } catch (error) {
                    console.error('Error sincronizando datos:', error);
                    // En caso de error, resetear a valores por defecto
                    substances = getDefaultSubstances();
                    entries = [];
                    userProfile = {};
                    localStorage.setItem('substances', JSON.stringify(substances));
                    localStorage.setItem('entries', JSON.stringify(entries));
                    localStorage.setItem('userProfile', JSON.stringify(userProfile));
                }
            }

            // Función para guardar datos en localStorage
            function saveDataToStorage() {
                try {
                    localStorage.setItem('substances', JSON.stringify(substances));
                    localStorage.setItem('entries', JSON.stringify(entries));
                    localStorage.setItem('userProfile', JSON.stringify(userProfile));
                    notifyBackupDataChanged();
                } catch (error) {
                    console.error('Error guardando datos:', error);
                }
            }

            function safeParseJSON(rawValue, fallback) {
                if (!rawValue) {
                    return fallback;
                }
                try {
                    return JSON.parse(rawValue);
                } catch (error) {
                    console.warn('No se pudo parsear JSON, usando fallback.', error);
                    return fallback;
                }
            }

            function collectBackupPayload() {
                return {
                    substances: substances,
                    entries: entries,
                    userProfile: userProfile,
                    customUnits: safeParseJSON(localStorage.getItem('psychologger_custom_units'), {}),
                    customSets: safeParseJSON(localStorage.getItem('psychologger_custom_sets'), []),
                    customSettings: safeParseJSON(localStorage.getItem('psychologger_custom_settings'), []),
                    timestamp: new Date().toISOString(),
                    version: '1.0'
                };
            }

            function notifyBackupDataChanged() {
                try {
                    if (window.Android && typeof Android.cacheLocalStorageSnapshot === 'function') {
                        const payload = collectBackupPayload();
                        Android.cacheLocalStorageSnapshot(JSON.stringify(payload));
                    }
                } catch (error) {
                    console.error('Error al notificar snapshot de backup:', error);
                }
            }

            function refreshBackupStatus() {
                const statusEl = document.getElementById('backupStatusText');
                const pathEl = document.getElementById('backupPathText');
                if (!statusEl || !pathEl) return;

                let fallbackPath = 'Android/data/com.d4vram.psychologger/files/backups';

                try {
                    if (window.Android && typeof Android.getBackupsDirectory === 'function') {
                        const actualPath = Android.getBackupsDirectory();
                        if (actualPath) {
                            fallbackPath = actualPath;
                        }
                    }
                } catch (error) {
                    console.warn('No se pudo obtener la carpeta de backups:', error);
                }

                const prettyPath = fallbackPath
                    .replace(/^\/storage\/emulated\/0\//, '')
                    .replace(/^\/sdcard\//, '')
                    .replace(/^\/data\/user\/0\//, 'data/user/0/');
                pathEl.textContent = prettyPath.trim();
                pathEl.setAttribute('title', fallbackPath);

                try {
                    if (window.Android && typeof Android.getLastBackupInfo === 'function') {
                        const raw = Android.getLastBackupInfo();
                        if (!raw) {
                            statusEl.textContent = 'Aún no se ha generado un backup.';
                            return;
                        }
                        const info = JSON.parse(raw);
                        const typeLabel = info.type === 'auto' ? 'Automático' : 'Manual';
                        const formatted = info.formattedDate || new Date(info.timestamp).toLocaleString();
                        statusEl.textContent = `${typeLabel} · ${formatted}`;
                    } else {
                        statusEl.textContent = 'Aún no se ha generado un backup.';
                    }
                } catch (error) {
                    console.error('Error al consultar el estado del backup:', error);
                    statusEl.textContent = 'No se pudo leer el estado del backup.';
                }
            }

            function safeSetValue(id, value) {
                const el = document.getElementById(id);
                if (el) el.value = value;
            }

            function waitForElement(id, cb, retries = 30, delay = 20) {
                const el = document.getElementById(id);
                if (el) return cb(el);
                if (retries <= 0) return;
              setTimeout(() => waitForElement(id, cb, retries - 1, delay), delay);
            }

            function toLocalDateTimeString(d) {
                const y = d.getFullYear();
                const m = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                const h = String(d.getHours()).padStart(2, '0');
                const min = String(d.getMinutes()).padStart(2, '0');
              return `${y}-${m}-${day}T${h}:${min}`;
            }


            // Función para sugerir emoji basado en el nombre de la sustancia
            function suggestEmoji() {
                const substanceNameInput = document.getElementById('substanceName');
                const substanceEmojiInput = document.getElementById('substanceEmoji');

                if (!substanceNameInput || !substanceEmojiInput) {
                    return;
                }

                const substanceName = substanceNameInput.value.trim();
                if (substanceName) {
                    const suggestedEmoji = getSubstanceEmoji(substanceName);
                    substanceEmojiInput.value = suggestedEmoji;
                    showCustomAlert(`💡 Emoji sugerido: ${suggestedEmoji}`, '💡 Sugerencia');
                } else {
                    showCustomAlert('⚠️ Primero escribe el nombre de la sustancia', '⚠️ Campo Requerido');
                }
            }

            // Función para actualizar el dropdown de sustancias
            function updateSubstanceDropdown() {
                if (document.getElementById('entryModal').classList.contains('active')) {
                    populateSubstanceDropdown();
                }
            }

            // Función para obtener el emoji apropiado para cada sustancia
            function getSubstanceEmoji(substanceName) {
            const emojiMap = {
                'LSD': '🌈',
                'Ketamina': '❄️',
                'Opio': '🌿',
                'MDMA': '💎',
                'Cocaína': '❄️',
                'Anfetamina': '⚡',
                'Cannabis': '🌿',
                'Psilocibina': '🍄',
                'DMT': '👁️',
                'Mescalina': '🌵',
                '2C-B': '🦋',
                'NBOMe': '💊',
                'MDA': '💎',
                'Meth': '⚡',
                'Heroína': '🌿',
                'Morfina': '🌿',
                'Fentanilo': '💊',
                'Codeína': '💊',
                'Tramadol': '💊',
                'Benzodiazepinas': '💊',
                'Alcohol': '🍷',
                'Nicotina': '🚬',
                'Cafeína': '☕',
                'Cookies': '🍪',
                'Café': '☕',
                'Café frío': '🧊☕',
                'Diacetilmorfina': '🌿',
                'Heroina': '🌿',
                'Marihuana': '🌿',
                'Hachís': '🌿',
                'Crack': '💎',
                'Speed': '⚡',
                'Éxtasis': '💎',
                'Píldoras': '💊',
                'Comprimidos': '💊',
                'Gotas': '💧',
                'Polvo': '❄️',
                'Cristal': '💎',
                'Líquido': '💧',
                'Vapor': '💨',
                'Inhalado': '💨',
                'Inyectado': '💉',
                'Oral': '👄',
                'Nasal': '👃',
                'Sublingual': '👅'
            };

            // Buscar coincidencia exacta primero
            if (emojiMap[substanceName]) {
                return emojiMap[substanceName];
            }

            // Buscar coincidencias parciales más inteligentes
            const lowerName = substanceName.toLowerCase();

            // Buscar por palabras clave específicas
            if (lowerName.includes('lsd') || lowerName.includes('ácido')) return '🌈';
            if (lowerName.includes('ketamina') || lowerName.includes('ket')) return '❄️';
            if (lowerName.includes('opio') || lowerName.includes('heroína') || lowerName.includes('morfina') || lowerName.includes('diacetilmorfina')) return '🌿';
            if (lowerName.includes('mdma') || lowerName.includes('éxtasis')) return '💎';
            if (lowerName.includes('cocaína') || lowerName.includes('coca')) return '❄️';
            if (lowerName.includes('anfetamina') || lowerName.includes('speed') || lowerName.includes('meth')) return '⚡';
            if (lowerName.includes('cannabis') || lowerName.includes('marihuana') || lowerName.includes('hachís')) return '🌿';
            if (lowerName.includes('psilocibina') || lowerName.includes('hongos')) return '🍄';
            if (lowerName.includes('dmt')) return '👁️';
            if (lowerName.includes('mescalina') || lowerName.includes('peyote')) return '🌵';
            if (lowerName.includes('2c-b') || lowerName.includes('2cb')) return '🦋';
            if (lowerName.includes('alcohol') || lowerName.includes('vino') || lowerName.includes('cerveza')) return '🍷';
            if (lowerName.includes('nicotina') || lowerName.includes('tabaco')) return '🚬';
            if (lowerName.includes('cafeína') || lowerName.includes('café') || lowerName.includes('té')) return '☕';

            // Emojis por categorías generales
            if (lowerName.includes('cookie') || lowerName.includes('galleta') || lowerName.includes('cookies')) return '🍪';
            if (lowerName.includes('píldora') || lowerName.includes('comprimido') || lowerName.includes('tableta')) return '💊';
            if (lowerName.includes('polvo') || lowerName.includes('cristal')) return '❄️';
            if (lowerName.includes('líquido') || lowerName.includes('gotas')) return '💧';
            if (lowerName.includes('vapor') || lowerName.includes('inhalado')) return '💨';
            if (lowerName.includes('inyectado')) return '💉';
            if (lowerName.includes('oral') || lowerName.includes('sublingual')) return '👄';
            if (lowerName.includes('nasal')) return '👃';

            // Buscar en el mapa de emojis por coincidencias parciales
            for (const [key, emoji] of Object.entries(emojiMap)) {
                if (lowerName.includes(key.toLowerCase()) || key.toLowerCase().includes(lowerName)) {
                    return emoji;
                }
            }

            // Emoji por defecto
            return '💊';
        }

        // Default substances
        function getDefaultSubstances() {
            return [
                {
                    id: generateUniqueId(),
                    name: 'LSD',
                    color: '#8B5CF6',
                    createdAt: new Date().toISOString()
                },
                {
                    id: generateUniqueId(),
                    name: 'Ketamina',
                    color: '#06B6D4',
                    createdAt: new Date().toISOString()
                },
                {
                    id: generateUniqueId(),
                    name: 'Opio',
                    color: '#8B5A2B',
                    createdAt: new Date().toISOString()
                }
            ];
        }
        // Función específica para después de importación
        function refreshAfterImport() {
            try {
                // Forzar recarga desde localStorage
                syncDataFromStorage();
                
                // Regenerar toda la interfaz
                generateCalendar();
                renderSubstanceList();
                renderStats();
                
                // Si hay un modal abierto con entradas, cerrarlo para evitar problemas
                const dayModal = document.getElementById('day-entries-modal');
                if (dayModal) {
                    dayModal.remove();
                }
            } catch (error) {
                console.error('Error refrescando después de importar:', error);
            }
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
            refreshBackupStatus();
        });

                 function initializeApp() {
             try {
                 // Sincronizar datos desde localStorage
                 syncDataFromStorage();
                 
                 // Initialize UI components
                 generateCalendar();
                 renderSubstanceList();
                 renderStats();
                 
                 // Cargar unidades personalizadas
                 loadCustomUnits();

                 // Cargar sets y settings personalizados
                 loadCustomSetsAndSettings();

                 // Set current datetime for entry form
                 const now = new Date();
                 const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
                 const dateTimeInput = document.getElementById('entryDateTime');
                 if (dateTimeInput) {
                     dateTimeInput.value = localDateTime;
                     // Actualizar también el display personalizado
                     currentSelectedDate = new Date(localDateTime);
                     updateDateTimeDisplay();
                 }

                 // Mantener snapshot actualizado aun después de la carga inicial
                 notifyBackupDataChanged();
             } catch (error) {
                 console.error('Error initializing app:', error);
                 showCustomAlert(`Error al inicializar la aplicación: ${error.message}`, '❌ Error de Inicialización');
             }
         }

        function setupEventListeners() {
            // Entry form
            document.getElementById('entryForm').addEventListener('submit', function(e) {
                e.preventDefault();
                addEntry();
            });

            // Substance form
            document.getElementById('substanceForm').addEventListener('submit', function(e) {
                e.preventDefault();
                addSubstance();
            });

            // Color picker
            document.querySelectorAll('.color-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedSubstanceColor = this.dataset.color;
                });
            });

            // Quote character counter
            const quoteTextarea = document.getElementById('newQuote');
            if (quoteTextarea) {
                quoteTextarea.addEventListener('input', function() {
                    document.getElementById('charCount').textContent = this.value.length;
                });
            }

            // Book items click handlers
            document.querySelectorAll('.book-item').forEach(bookItem => {
                bookItem.addEventListener('click', function() {
                    const title = this.querySelector('h5').textContent;
                    const author = this.querySelector('.book-author').textContent;
                    const description = this.querySelector('.book-desc').textContent;

                    showBookModal(title, author, description);
                });
            });

            // ========================================
            // EVENT LISTENERS DE AUDIO
            // ========================================
            const btnStartRec = document.getElementById('btnStartRecording');
            if (btnStartRec) btnStartRec.addEventListener('click', startRecording);

            const btnStopRec = document.getElementById('btnStopRecording');
            if (btnStopRec) btnStopRec.addEventListener('click', stopRecording);

            const btnPlay = document.getElementById('btnPlayPause');
            if (btnPlay) btnPlay.addEventListener('click', togglePlayPause);

            const btnDel = document.getElementById('btnDeleteAudio');
            if (btnDel) btnDel.addEventListener('click', deleteAudio);

            const btnShare = document.getElementById('btnShareAudio');
            if (btnShare) btnShare.addEventListener('click', shareAudio);

            const btnSaveAudio = document.getElementById('btnSaveAudioAttachment');
            if (btnSaveAudio) btnSaveAudio.addEventListener('click', confirmAudioAttachment);

            // Inicializar UI de audio
            updateAudioUI('initial');

            const btnCapturePhoto = document.getElementById('btnCapturePhoto');
            if (btnCapturePhoto) btnCapturePhoto.addEventListener('click', capturePhotoFromCamera);

            const btnPickPhoto = document.getElementById('btnPickPhoto');
            if (btnPickPhoto) btnPickPhoto.addEventListener('click', pickPhotoFromGallery);

            const btnViewPhoto = document.getElementById('btnViewPhoto');
            if (btnViewPhoto) btnViewPhoto.addEventListener('click', viewPhotoAttachment);

            const btnSharePhoto = document.getElementById('btnSharePhoto');
            if (btnSharePhoto) btnSharePhoto.addEventListener('click', sharePhotoAttachment);

            const btnDeletePhoto = document.getElementById('btnDeletePhoto');
            if (btnDeletePhoto) btnDeletePhoto.addEventListener('click', deletePhotoAttachment);

            const btnSavePhoto = document.getElementById('btnSavePhotoAttachment');
            if (btnSavePhoto) btnSavePhoto.addEventListener('click', confirmPhotoAttachment);

            updateVoiceNoteCard();
            updatePhotoCard();
            updatePhotoModalControls();
        }

        // Navigation functions
        function switchView(viewName) {
            // Hide all views
            document.querySelectorAll('.view').forEach(view => {
                view.style.display = 'none';
            });

            // Show selected view
            const targetView = document.getElementById(viewName + '-view');
            if (targetView) {
                targetView.style.display = 'grid';
            } else {
                console.error('View not found:', viewName + '-view');
                return;
            }

            // Update navigation active state
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            const navMapping = {
                'calendar': 0,
                'stats': 2,
                'resources': 3,
                'data': 4,
                'profile': 5
            };

            const navItems = document.querySelectorAll('.nav-item');
            const navIndex = navMapping[viewName];
            if (navItems[navIndex]) {
                navItems[navIndex].classList.add('active');
            }

            // Regenerate content for specific views
            if (viewName === 'stats') {
                renderStats();
            } else if (viewName === 'data') {
                refreshBackupStatus();
            }
        }

        // Modal functions
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.add('active');
            document.body.style.overflow = 'hidden'; // Prevent background scrolling

            // Populate dropdowns when opening modals
            if (modalId === 'entryModal') {
                populateSubstanceDropdown();
                // Reset form for new entry, or prepare for edit if already in edit mode
                if (!isEditMode) {
                    resetEntryForm();
                }
            } else if (modalId === 'substanceModal') {
                // Reset color selection when opening substance modal
                document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
                const firstColorOption = document.querySelector('.color-option');
                if (firstColorOption) {
                    firstColorOption.classList.add('selected');
                    selectedSubstanceColor = firstColorOption.dataset.color;
                }
            } else if (modalId === 'favoritesModal') {
                populateFavoriteDropdown();
                renderFavorites();
            } else if (modalId === 'quotesModal') {
                renderQuotes();
            } else if (modalId === 'socialModal') {
                loadSocialLinks();
            } else if (modalId === 'shareProfileModal') {
                updateProfileCard();
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) {
                return;
            }

            modal.classList.remove('active');

            const anyActiveModal = document.querySelector('.modal.active');
            document.body.style.overflow = anyActiveModal ? 'hidden' : '';

            if (modalId === 'entryModal') {
                resetEditMode(); // Solo resetear el formulario principal
            }
        }

        // ===== FUNCIONES DEL DATETIME PICKER PERSONALIZADO =====

        // Variables globales para el datetime picker
        let currentSelectedDate = new Date();

        function toggleDateTimeModal() {
            const modal = document.getElementById('dateTimeModal');
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            initializeDateTimePicker();
        }

        function closeDateTimeModal() {
            const modal = document.getElementById('dateTimeModal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
            closeAllCustomSelects();
        }

        function initializeDateTimePicker() {
            // Obtener fecha actual del input oculto o usar fecha actual
            const hiddenInput = document.getElementById('entryDateTime');
            if (hiddenInput.value) {
                currentSelectedDate = new Date(hiddenInput.value);
            } else {
                currentSelectedDate = new Date();
            }

            populateSelects();
            updateSelectValues();
            enhanceDateTimeSelects();
        }

        function populateSelects() {
            const currentYear = new Date().getFullYear();

            // Poblar días (1-31)
            const daySelect = document.getElementById('daySelect');
            daySelect.innerHTML = '';
            for (let i = 1; i <= 31; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i.toString().padStart(2, '0');
                daySelect.appendChild(option);
            }

            // Poblar meses (0-11, pero mostrar 1-12)
            const monthSelect = document.getElementById('monthSelect');
            monthSelect.innerHTML = '';
            const monthNames = ['ene', 'feb', 'mar', 'abr', 'may', 'jun',
                               'jul', 'ago', 'sep', 'oct', 'nov', 'dic'];
            for (let i = 0; i < 12; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = monthNames[i];
                monthSelect.appendChild(option);
            }

            // Poblar años (año actual - 5 hasta año actual + 5)
            const yearSelect = document.getElementById('yearSelect');
            yearSelect.innerHTML = '';
            for (let i = currentYear - 5; i <= currentYear + 5; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                yearSelect.appendChild(option);
            }

            // Poblar horas (0-23)
            const hourSelect = document.getElementById('hourSelect');
            hourSelect.innerHTML = '';
            for (let i = 0; i < 24; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i.toString().padStart(2, '0');
                hourSelect.appendChild(option);
            }

            // Poblar minutos (0-59)
            const minuteSelect = document.getElementById('minuteSelect');
            minuteSelect.innerHTML = '';
            for (let i = 0; i < 60; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i.toString().padStart(2, '0');
                minuteSelect.appendChild(option);
            }
        }

        function updateSelectValues() {
            document.getElementById('daySelect').value = currentSelectedDate.getDate();
            document.getElementById('monthSelect').value = currentSelectedDate.getMonth();
            document.getElementById('yearSelect').value = currentSelectedDate.getFullYear();
            document.getElementById('hourSelect').value = currentSelectedDate.getHours();
            document.getElementById('minuteSelect').value = currentSelectedDate.getMinutes();
        }

        function enhanceDateTimeSelects() {
            const selectIds = ['daySelect', 'monthSelect', 'yearSelect', 'hourSelect', 'minuteSelect'];
            selectIds.forEach(setupCustomSelect);
        }

        function setupCustomSelect(selectId) {
            const select = document.getElementById(selectId);
            if (!select) return;

            const wrapper = select.closest('.custom-select-wrapper');
            if (!wrapper) return;

            const trigger = wrapper.querySelector('.custom-select-trigger');
            const dropdown = wrapper.querySelector('.custom-select-dropdown');
            const valueSpan = wrapper.querySelector('.custom-select-value');

            if (!trigger || !dropdown || !valueSpan) return;

            const dropdownId = `${selectId}Dropdown`;
            dropdown.id = dropdownId;
            trigger.setAttribute('aria-controls', dropdownId);

            dropdown.innerHTML = '';
            Array.from(select.options).forEach(option => {
                const optionButton = document.createElement('button');
                optionButton.type = 'button';
                optionButton.className = 'custom-select-option';
                optionButton.dataset.value = option.value;
                optionButton.textContent = option.textContent;
                if (option.value === select.value) {
                    optionButton.classList.add('selected');
                }
                optionButton.addEventListener('click', event => {
                    event.preventDefault();
                    event.stopPropagation();
                    if (select.value !== option.value) {
                        select.value = option.value;
                        select.dispatchEvent(new Event('change'));
                    } else {
                        updateCustomSelectDisplay(select);
                    }
                    wrapper.classList.remove('is-open');
                    trigger.setAttribute('aria-expanded', 'false');
                });
                dropdown.appendChild(optionButton);
            });

            if (!trigger.dataset.customSelectTriggerBound) {
                trigger.dataset.customSelectTriggerBound = 'true';
                trigger.addEventListener('click', event => {
                    event.preventDefault();
                    event.stopPropagation();
                    if (wrapper.classList.contains('is-open')) {
                        wrapper.classList.remove('is-open');
                        trigger.setAttribute('aria-expanded', 'false');
                    } else {
                        closeAllCustomSelects(wrapper);
                        wrapper.classList.add('is-open');
                        trigger.setAttribute('aria-expanded', 'true');
                        const selectedOption = dropdown.querySelector('.custom-select-option.selected');
                        if (selectedOption) {
                            selectedOption.scrollIntoView({ block: 'nearest' });
                        }
                    }
                });
            }

            if (!select.dataset.customSelectBound) {
                select.dataset.customSelectBound = 'true';
                select.addEventListener('change', () => {
                    updateCustomSelectDisplay(select);
                    updateDateFromSelects();
                });
            }

            updateCustomSelectDisplay(select);
        }

        function updateCustomSelectDisplay(selectElement) {
            const wrapper = selectElement.closest('.custom-select-wrapper');
            if (!wrapper) return;

            const triggerValue = wrapper.querySelector('.custom-select-value');
            const dropdown = wrapper.querySelector('.custom-select-dropdown');
            const selectedOption = selectElement.options[selectElement.selectedIndex];

            if (triggerValue) {
                triggerValue.textContent = selectedOption ? selectedOption.textContent : '--';
            }

            if (dropdown) {
                dropdown.querySelectorAll('.custom-select-option').forEach(button => {
                    button.classList.toggle('selected', button.dataset.value === selectElement.value);
                });
            }
        }

        function closeAllCustomSelects(exceptWrapper = null) {
            document.querySelectorAll('.custom-select-wrapper.is-open').forEach(wrapper => {
                if (wrapper === exceptWrapper) return;
                wrapper.classList.remove('is-open');
                const trigger = wrapper.querySelector('.custom-select-trigger');
                if (trigger) {
                    trigger.setAttribute('aria-expanded', 'false');
                }
            });
        }

        document.addEventListener('click', event => {
            if (!event.target.closest('.custom-select-wrapper')) {
                closeAllCustomSelects();
            }
        });

        document.addEventListener('keydown', event => {
            if (event.key === 'Escape') {
                closeAllCustomSelects();
            }
        });

        function updateDateFromSelects() {
            const day = parseInt(document.getElementById('daySelect').value);
            const month = parseInt(document.getElementById('monthSelect').value);
            const year = parseInt(document.getElementById('yearSelect').value);
            const hour = parseInt(document.getElementById('hourSelect').value);
            const minute = parseInt(document.getElementById('minuteSelect').value);

            currentSelectedDate = new Date(year, month, day, hour, minute);
        }

        function setDateTime() {
            // Actualizar input oculto
            const isoString = currentSelectedDate.toISOString().slice(0, 16);
            document.getElementById('entryDateTime').value = isoString;

            // Actualizar display
            updateDateTimeDisplay();

            // Cerrar modal
            closeDateTimeModal();
        }

        function clearDateTime() {
            document.getElementById('entryDateTime').value = '';
            document.getElementById('dateTimeDisplay').textContent = 'Establecer fecha y hora';
            closeDateTimeModal();
        }

        function updateDateTimeDisplay() {
            const dateDisplay = document.getElementById('dateTimeDisplay');
            const options = {
                weekday: 'short',
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            dateDisplay.textContent = currentSelectedDate.toLocaleDateString('es-ES', options);
        }

        // Calendar functions
        function generateCalendar() {

            const grid = document.getElementById('calendar-grid');
            const monthName = currentDate.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
            document.getElementById('current-month').textContent = monthName.charAt(0).toUpperCase() + monthName.slice(1);

            // Clear grid
            grid.innerHTML = '';

            // Add day headers
            const dayHeaders = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
            dayHeaders.forEach(day => {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day day-header';
                dayElement.textContent = day;
                grid.appendChild(dayElement);
            });

            // Get first day of month and number of days
            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());

            // Generate calendar days
            for (let i = 0; i < 42; i++) {
                const day = new Date(startDate);
                day.setDate(startDate.getDate() + i);

                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = day.getDate();

                // Check if day has entries
                let dayEntries = entries.filter(entry => {
                    const entryDate = new Date(entry.date);
                    return entryDate.toDateString() === day.toDateString();
                });

                // Apply substance filter if one selected
                if (selectedSubstanceFilter) {
                    dayEntries = dayEntries.filter(entry => entry.substance === selectedSubstanceFilter);
                }

                if (dayEntries.length > 0) {
                    dayElement.classList.add('has-entry');

                    // Get unique substances for this day
                    const uniqueSubstances = [...new Set(dayEntries.map(entry => entry.substance))];

                    if (uniqueSubstances.length === 1) {
                        // Single substance - use solid color
                        const substance = substances.find(s => s.name === uniqueSubstances[0]);
                        const color = substance ? substance.color : '#8B5CF6';
                        dayElement.classList.add('single-substance');
                        dayElement.style.background = color;
                        dayElement.style.boxShadow = `0 0 10px ${color}50`;
                    } else if (uniqueSubstances.length > 1) {
                        // Multiple substances - create gradient
                        const colors = uniqueSubstances.map(substanceName => {
                            const substance = substances.find(s => s.name === substanceName);
                            return substance ? substance.color : '#8B5CF6';
                        });

                        dayElement.classList.add('multiple-substances');

                        if (colors.length === 2) {
                            dayElement.style.background = `linear-gradient(135deg, ${colors[0]} 0%, ${colors[1]} 100%)`;
                        } else if (colors.length === 3) {
                            dayElement.style.background = `linear-gradient(135deg, ${colors[0]} 0%, ${colors[1]} 50%, ${colors[2]} 100%)`;
                        } else {
                            // More than 3 colors - create a more complex gradient
                            const step = 100 / colors.length;
                            const gradientStops = colors.map((color, index) => `${color} ${index * step}%`).join(', ');
                            dayElement.style.background = `linear-gradient(135deg, ${gradientStops})`;
                        }

                        // Add subtle animation for multiple substances
                        dayElement.style.animation = 'colorShift 3s ease-in-out infinite';
                    }

                    // Add substance indicators (small dots)
                    const indicators = document.createElement('div');
                    indicators.className = 'substance-indicators';

                    uniqueSubstances.slice(0, 4).forEach(substanceName => {
                        const substance = substances.find(s => s.name === substanceName);
                        const dot = document.createElement('div');
                        dot.className = 'substance-dot';
                        dot.style.backgroundColor = substance ? substance.color : '#8B5CF6';
                        dot.title = substanceName; // Tooltip
                        indicators.appendChild(dot);
                    });

                    dayElement.appendChild(indicators);
                }

                // Dim days from other months
                if (day.getMonth() !== currentDate.getMonth()) {
                    dayElement.style.opacity = '0.3';
                }

                // Add click event
                dayElement.addEventListener('click', () => showDayEntries(day));

                grid.appendChild(dayElement);
            }
        }

        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            generateCalendar();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            generateCalendar();
        }

        // Function to show entries for a specific day
        function showDayEntries(date) {
            let dayEntries = entries.filter(entry => {
                const entryDate = new Date(entry.date);
                return entryDate.toDateString() === date.toDateString();
            });

            // Apply substance filter if selected
            if (selectedSubstanceFilter) {
                dayEntries = dayEntries.filter(entry => entry.substance === selectedSubstanceFilter);
            }

            if (dayEntries.length === 0) {
                showCustomConfirm(
                    'No hay registros para este día. ¿Quieres añadir uno?',
                    '📅 Día sin Registros',
                    () => addNewEntryForDate(date)
                );
                return;
            }

            let content = `<h3>📅 Registros del ${date.toLocaleDateString('es-ES', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            })}</h3>`;

            if (selectedSubstanceFilter) {
                content += `<p style="color: var(--accent-cyan); margin-bottom: 1rem;">Filtrado por: ${selectedSubstanceFilter}</p>`;
            }

                            dayEntries.forEach((entry) => {
                    const time = new Date(entry.date).toLocaleTimeString('es-ES', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    const substance = substances.find(s => s.name === entry.substance);
                    const substanceColor = substance ? substance.color : '#8B5CF6';

                    content += `
                        <div class="entry-item" style="border-left: 4px solid ${substanceColor};">
                            <div class="entry-header">
                                <span class="entry-substance">${entry.substance}</span>
                                <span class="entry-time">${time}</span>
                            </div>
                            <div class="entry-dose">💊 ${entry.dose} ${entry.unit}</div>
                            ${entry.set ? `<div class="entry-meta">🧠 Set: ${entry.set}</div>` : ''}
                            ${entry.setting ? `<div class="entry-meta">🏞️ Setting: ${entry.setting}</div>` : ''}
                            ${entry.notes ? `<div class="entry-notes">📝 ${entry.notes}</div>` : ''}
                            ${(entry.audioPath || entry.photoPath) ? `
                                <div class="entry-meta">
                                    📎 Adjuntos:
                                    ${entry.audioPath ? '<span style="margin-left:4px;">🎤 Nota de voz</span>' : ''}
                                    ${entry.photoPath ? '<span style="margin-left:8px;">📷 Foto</span>' : ''}
                                </div>
                            ` : ''}
                            <div class="entry-actions" style="margin-top: 0.5rem;">
                                <button class="btn-edit" data-entry-id="${entry.id}">✏️ Editar</button>
                                <button class="btn-delete" data-entry-id="${entry.id}">🗑️ Eliminar</button>
                            </div>
                        </div>
                    `;
                });

            content += `
                <div style="margin-top: 1rem; text-align: center;">
                    <button id="add-entry-for-date-btn" class="btn-primary" data-date="${date.getTime()}" style="padding: 0.5rem 1rem; font-size: 1rem;">
                        ➕ Añadir Registro para este Día
                    </button>
                </div>
            `;

            const modalId = 'day-entries-modal';
            const existingModal = document.getElementById(modalId);
            if (existingModal) {
                existingModal.remove();
            }

            const modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <button class="close-btn" id="close-day-modal">×</button>
                    ${content}
                </div>
            `;

            document.body.appendChild(modal);
            document.body.style.overflow = 'hidden';

            // Attach event listeners AFTER the modal is in the DOM
            setTimeout(() => {
                document.getElementById('close-day-modal').addEventListener('click', closeDayModal);

                document.querySelectorAll(`#${modalId} .btn-edit`).forEach(button => {
                    button.addEventListener('click', (e) => {
                        const entryId = e.currentTarget.dataset.entryId;
                        editEntryFromCalendar(entryId);
                    });
                });

                document.querySelectorAll(`#${modalId} .btn-delete`).forEach(button => {
                    button.addEventListener('click', (e) => {
                        const entryId = e.currentTarget.dataset.entryId;
                        deleteEntryFromCalendar(entryId);
                    });
                });

                document.getElementById('add-entry-for-date-btn').addEventListener('click', (e) => {
                    const dateString = e.currentTarget.dataset.date;
                    addNewEntryForDate(dateString);
                });
            }, 50); // Small delay to ensure DOM is ready

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeDayModal();
                }
            });
        }

        function closeDayModal() {
            const modal = document.getElementById('day-entries-modal');
            if (modal) {
                modal.remove();
            }
            document.body.style.overflow = '';
        }

        function addNewEntryForDate(dateInput) {
            closeDayModal();
            resetEditMode();
            openModal('entryModal');

            const d = new Date(dateInput);
            const localDateTime = toLocalDateTimeString(d);

            // Espera a que exista el input en WebView:
            waitForElement('entryDateTime', (input) => { input.value = localDateTime; });
        }


        function editEntryFromCalendar(entryId) {
            const entry = entries.find(e => e.id === entryId);
            if (!entry) { showCustomAlert('❌ Registro no encontrado', '❌ Error'); return; }

            closeDayModal();
            isEditMode = true;
            currentEditingEntryId = entryId;

            const modalTitle = document.getElementById('entryModalTitle');
            if (modalTitle) {
                modalTitle.textContent = 'Editar Registro';
            }

            populateSubstanceDropdown();
            restoreDropdownSelection('entrySubstanceDropdown', entry.substance, 'Selecciona una sustancia...');

            openModal('entryModal'); // tras esto aún puede tardar 1 frame

            waitForElement('entryDose',      el => el.value = entry.dose);
            waitForElement('entryUnitDropdown', () => {
                restoreDropdownSelection('entryUnitDropdown', entry.unit, 'Seleccionar unidad...');
            });
            waitForElement('entryDateTime',  el => {
                el.value = entry.date;
                // Actualizar también el display personalizado cuando se edita
                currentSelectedDate = new Date(entry.date);
                updateDateTimeDisplay();
            });
            waitForElement('entrySetDropdown', () => {
                restoreDropdownSelection('entrySetDropdown', entry.set || '', 'Seleccionar...');
            });
            waitForElement('entrySettingDropdown', () => {
                restoreDropdownSelection('entrySettingDropdown', entry.setting || '', 'Seleccionar...');
            });
            waitForElement('entryNotes',     el => el.value = entry.notes || '');

            // Cargar audio si existe
            if (entry.audioPath) {
                currentAudioFilename = entry.audioPath;
                updateAudioUI('player');
            } else {
                currentAudioFilename = null;
                updateAudioUI('initial');
            }

            if (entry.photoPath) {
                currentPhotoFilename = entry.photoPath;
            } else {
                currentPhotoFilename = null;
            }
            updatePhotoCard();
            updatePhotoModalControls();

            const submitBtn = document.querySelector('#entryForm button[type="submit"]');
            if (submitBtn) {
              submitBtn.innerHTML = '✅ Actualizar Registro';
              submitBtn.style.background = 'linear-gradient(135deg, var(--accent-orange), var(--secondary-pink))';
            }
        }



        function deleteEntryFromCalendar(entryId) {
            const entry = entries.find(e => e.id === entryId); // Use === for strict comparison
            if (!entry) {
                alert('❌ Registro no encontrado');
                return;
            }

            const confirmMessage = `¿Estás seguro de que quieres eliminar este registro?\n\n${entry.substance} - ${entry.dose} ${entry.unit}\n${new Date(entry.date).toLocaleString('es-ES')}`;

            showCustomConfirm(
                confirmMessage,
                '🗑️ Confirmar Eliminación',
                                 () => {
                     // Eliminar archivo de audio si existe
                     if (entry.audioPath) {
                         Android.deleteAudio(entry.audioPath);
                     }
                     if (entry.photoPath && Android.deletePhoto) {
                         Android.deletePhoto(entry.photoPath);
                     }

                     entries = entries.filter(e => e.id !== entryId); // Use !== for strict comparison
                     saveDataToStorage();

                     closeDayModal(); // Close the day entries modal

                    generateCalendar();
                    renderSubstanceList();
                    renderStats();
                    updateProfileCard(); // Update profile stats

                    showAutoCloseAlert('🗑️ Registro eliminado correctamente', '✅ Eliminado');
                }
            );
        }

        // Substance functions
        function addSubstance() {
            const nameInput = document.getElementById('substanceName');
            if (!nameInput) {
                showCustomAlert('Error: Campo de nombre no encontrado', '❌ Error del Sistema');
                return;
            }

            const name = nameInput.value.trim();

            if (!name || name.length === 0) {
                showCustomAlert('Por favor, introduce un nombre para la sustancia', '⚠️ Campo Requerido');
                nameInput.focus();
                return;
            }

            // Verificar si ya existe una sustancia con el mismo nombre (excluyendo la que estamos editando)
            const existingSubstance = substances.find(s =>
                s.name.toLowerCase() === name.toLowerCase() &&
                (!window.isEditingSubstance || s.id !== window.editingSubstanceId)
            );

            if (existingSubstance) {
                showCustomAlert('Esta sustancia ya existe', '⚠️ Sustancia Duplicada');
                return;
            }

            if (window.isEditingSubstance && window.editingSubstanceId) {
                // MODO EDICIÓN
                const substanceIndex = substances.findIndex(s => s.id === window.editingSubstanceId);
                if (substanceIndex !== -1) {
                    substances[substanceIndex] = {
                        ...substances[substanceIndex],
                        name: name,
                        color: selectedSubstanceColor,
                        updatedAt: new Date().toISOString()
                    };

                                             // Actualizar registros existentes si cambió el nombre
                         if (substances[substanceIndex].name !== name) {
                             entries.forEach(entry => {
                                 if (entry.substance === substances[substanceIndex].name) {
                                     entry.substance = name;
                                 }
                             });
                         }

                         saveDataToStorage();

                    showAutoCloseAlert(`✅ Sustancia "${name}" actualizada correctamente`, '✅ Sustancia Actualizada', 2000);
                }
            } else {
                // MODO CREACIÓN
                const emojiInput = document.getElementById('substanceEmoji');
                const customEmoji = emojiInput ? emojiInput.value.trim() : '';
                const substance = {
                    id: generateUniqueId(),
                    name: name,
                    color: selectedSubstanceColor,
                    emoji: customEmoji || getSubstanceEmoji(name), // Usar emoji personalizado o auto-detectar
                    createdAt: new Date().toISOString()
                };

                                     substances.push(substance);
                     saveDataToStorage();

                showAutoCloseAlert(`✅ Sustancia "${name}" añadida correctamente`, '✅ Sustancia Añadida', 2000);
            }

            // Limpiar y actualizar
            renderSubstanceList();
            generateCalendar();
            renderStats();
            updateProfileCard();

            // Actualizar el dropdown de sustancias si está abierto
            updateSubstanceDropdown();

            // Cerrar modal y redirigir al calendario después del alert
            setTimeout(() => {
                closeModal('substanceModal');
                // Redirect to calendar view
                switchView('calendar');
            }, 2500); // Wait for alert to fade out (2000ms) + extra time for smooth transition
            document.getElementById('substanceForm').reset();
            const emojiInput = document.getElementById('substanceEmoji');
            if (emojiInput) {
                emojiInput.value = ''; // Limpiar emoji personalizado
            }

            // Reset color selection
            document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
            selectedSubstanceColor = '#8B5CF6'; // Reset to default

            // Limpiar modo edición
            window.isEditingSubstance = false;
            window.editingSubstanceId = null;

            // Restaurar botón y título originales
            const submitBtn = document.querySelector('#substanceModal button[type="submit"]');
            if (submitBtn) {
                submitBtn.innerHTML = 'Añadir Sustancia';
                submitBtn.style.background = 'linear-gradient(135deg, var(--primary-purple), var(--secondary-pink))';
            }

            const modalTitle = document.querySelector('#substanceModal h3');
            if (modalTitle) {
                modalTitle.innerHTML = '➕ Añadir Nueva Sustancia';
            }
        }

        function renderSubstanceList() {
            const list = document.getElementById('substance-list');
            list.innerHTML = '';

            // Add "All substances" option first
            const allItem = document.createElement('li');
            allItem.className = 'substance-item';
            if (!selectedSubstanceFilter) {
                allItem.classList.add('active');
            }
            allItem.innerHTML = `
                <div class="substance-info">
                    <span>📋 Experiencias registradas</span>
                </div>
                <div class="substance-actions">
                    <span class="substance-count">${entries.length}</span>
                </div>
            `;
            allItem.querySelector('.substance-info').addEventListener('click', () => {
                filterBySubstance(null);
            });
            list.appendChild(allItem);

            substances.forEach(substance => {
                const count = entries.filter(entry => entry.substance === substance.name).length;

                const item = document.createElement('li');
                item.className = 'substance-item';

                // Add active class if this substance is selected
                if (selectedSubstanceFilter === substance.name) {
                    item.classList.add('active');
                }

                item.innerHTML = `
                    <div class="substance-info">
                        <span>${substance.name}</span>
                    </div>
                    <div class="substance-actions">
                        <span class="substance-count">${count}</span>
                        <button class="edit-substance-btn" data-substance-id="${substance.id}" title="Editar sustancia">✏️</button>
                        <button class="delete-substance-btn" data-substance-id="${substance.id}" title="Eliminar sustancia">×</button>
                    </div>
                `;
                item.style.borderLeft = `4px solid ${substance.color}`;
                item.style.backgroundColor = `${substance.color}15`; // Lighten color for background

                // Add click event for filtering (exclude the delete button)
                item.querySelector('.substance-info').addEventListener('click', () => {
                    filterBySubstance(substance.name);
                });

                // Attach event listener for edit button
                item.querySelector('.edit-substance-btn').addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent filtering when clicking edit
                    const substanceId = e.currentTarget.dataset.substanceId;
                    editSubstance(substanceId);
                });

                // Attach event listener for delete button
                item.querySelector('.delete-substance-btn').addEventListener('click', (e) => {
                    const substanceId = e.currentTarget.dataset.substanceId;
                    deleteSubstance(substanceId);
                });

                list.appendChild(item);
            });
        }

        function resetEditMode() {
            isEditMode = false;
            currentEditingEntryId = null;

            const modalTitle = document.getElementById('entryModalTitle');
            if (modalTitle) {
                modalTitle.textContent = 'Nuevo Registro';
            }

            const submitBtn = document.querySelector('#entryForm button[type="submit"]');
            if (submitBtn) {
                submitBtn.innerHTML = '💾 Guardar Registro';
                submitBtn.style.background = 'linear-gradient(135deg, var(--primary-purple), var(--secondary-pink))';
            }
            resetEntryForm(); // Also reset the form fields
        }

        function resetEntryForm() {
            const form = document.getElementById('entryForm');
            if (form) form.reset();

            // Resetear audio
            if (isPlaying) {
                Android.stopAudio();
                isPlaying = false;
            }
            currentAudioFilename = null;
            updateAudioUI('initial');
            updateVoiceNoteCard();

            currentPhotoFilename = null;
            updatePhotoCard();
            updatePhotoModalControls();

            // Fecha y hora por defecto: ahora (local)
            const now = new Date();
            const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
                .toISOString()
                .slice(0, 16);
            const dateTimeInput = document.getElementById('entryDateTime');
            if (dateTimeInput) {
                dateTimeInput.value = localDateTime;
                // Actualizar también el display personalizado
                currentSelectedDate = new Date(localDateTime);
                updateDateTimeDisplay();
            }

            // Sustancia
            const substanceHeaderText = document.querySelector('#entrySubstanceDropdown .dropdown-text');
            const substanceHiddenInput = document.getElementById('entrySubstance');
            if (substanceHeaderText && substanceHiddenInput) {
                substanceHeaderText.textContent = 'Selecciona una sustancia...';
                substanceHiddenInput.value = '';
                document.querySelectorAll('#entrySubstanceDropdown .dropdown-option').forEach(opt => opt.classList.remove('selected'));
            }

            // Unidad (volver a placeholder "Seleccionar unidad...")
            const unitHeaderText = document.querySelector('#entryUnitDropdown .dropdown-text');
            const unitHiddenInput = document.getElementById('entryUnit');
            if (unitHeaderText && unitHiddenInput) {
                unitHeaderText.textContent = 'Seleccionar unidad...';
                unitHiddenInput.value = '';
                document.querySelectorAll('#entryUnitDropdown .dropdown-option').forEach(opt => opt.classList.remove('selected'));
            }

            // Set (estado mental)
            const setHeaderText = document.querySelector('#entrySetDropdown .dropdown-text');
            const setHiddenInput = document.getElementById('entrySet');
            if (setHeaderText && setHiddenInput) {
                setHeaderText.textContent = 'Seleccionar...';
                setHiddenInput.value = '';
                document.querySelectorAll('#entrySetDropdown .dropdown-option').forEach(opt => opt.classList.remove('selected'));
            }

            // Setting (entorno)
            const settingHeaderText = document.querySelector('#entrySettingDropdown .dropdown-text');
            const settingHiddenInput = document.getElementById('entrySetting');
            if (settingHeaderText && settingHiddenInput) {
                settingHeaderText.textContent = 'Seleccionar...';
                settingHiddenInput.value = '';
                document.querySelectorAll('#entrySettingDropdown .dropdown-option').forEach(opt => opt.classList.remove('selected'));
            }

            // Notas
            const notesInput = document.getElementById('entryNotes');
            if (notesInput) notesInput.value = '';
        }

        function filterBySubstance(substanceName) {
            selectedSubstanceFilter = substanceName;
            // Update active state for substances
            document.querySelectorAll('.substance-item').forEach(item => {
                item.classList.remove('active');
            });

            if (substanceName === null) {
                //Mark "Experiencias registradas" as active
                document.querySelector('.substance-item:first-child').classList.add('active');
            } else {
                // Find and mark the specific substance as active
                document.querySelectorAll('.substance-item').forEach(item => {
                   const substanceText = item.querySelector('.substance-info span').textContent;
                    if (substanceText === substanceName) {
                        item.classList.add('active');
                    }
                });
            }

            generateCalendar();
            renderSubstanceList();
            renderStats();
        }

        function deleteSubstance(substanceId) {
            const substance = substances.find(s => s.id === substanceId); // Use === for strict comparison
            if (!substance) return;

            const hasEntries = entries.some(entry => entry.substance === substance.name);

            let confirmMessage = `¿Estás seguro de que quieres eliminar "${substance.name}"?`;
            if (hasEntries) {
                confirmMessage += '\n\n⚠️ Esta sustancia tiene registros asociados. Si la eliminas, también se eliminarán todos sus registros.';
            }

            showCustomConfirm(
                confirmMessage,
                '🗑️ Confirmar Eliminación',
                () => {
                    // Remove substance
                    substances = substances.filter(s => s.id !== substanceId); // Use !== for strict comparison

                                         // Remove related entries if any
                     if (hasEntries) {
                         entries = entries.filter(entry => entry.substance !== substance.name);
                     }

                     // Clear filter if we're filtering by this substance
                     if (selectedSubstanceFilter === substance.name) {
                         selectedSubstanceFilter = null;
                     }

                     // Guardar todos los datos
                     saveDataToStorage();

                    renderSubstanceList();
                    generateCalendar();
                    renderStats();
                    updateProfileCard(); // Update profile stats

                    showCustomAlert(`"${substance.name}" ha sido eliminada${hasEntries ? ' junto con sus registros' : ''}.`, '✅ Sustancia Eliminada');
                }
            );
        }

        function editSubstance(substanceId) {
            const substance = substances.find(s => s.id === substanceId);
            if (!substance) {
                showCustomAlert('❌ Sustancia no encontrada', '❌ Error');
                return;
            }

            // Abrir el modal de sustancia en modo edición
            openModal('substanceModal');

            // Configurar el modal para edición
            const nameInput = document.getElementById('substanceName');
            if (nameInput) {
                nameInput.value = substance.name;
            }
            selectedSubstanceColor = substance.color;

            // Marcar el color correcto como seleccionado
            document.querySelectorAll('.color-option').forEach(opt => {
                opt.classList.remove('selected');
                if (opt.dataset.color === substance.color) {
                    opt.classList.add('selected');
                }
            });

            // Cambiar el botón y título
            const submitBtn = document.querySelector('#substanceModal button[type="submit"]');
            if (submitBtn) {
                submitBtn.innerHTML = '✅ Actualizar Sustancia';
                submitBtn.style.background = 'linear-gradient(135deg, var(--accent-orange), var(--secondary-pink))';
            }

            // Cambiar el título del modal
            const modalTitle = document.querySelector('#substanceModal h3');
            if (modalTitle) {
                modalTitle.innerHTML = '✏️ Editar Sustancia';
            }

            // Configurar el modal para actualizar en lugar de crear
            window.editingSubstanceId = substanceId;
            window.isEditingSubstance = true;
        }

        function populateSubstanceDropdown() {


            const dropdownOptions = document.getElementById('entrySubstanceOptions');
            const hiddenInput = document.getElementById('entrySubstance');
            const headerText = document.querySelector('#entrySubstanceDropdown .dropdown-text');
            const currentValue = hiddenInput.value; // Guardar el valor actual

            // Limpiar opciones existentes (excepto la primera placeholder)
            dropdownOptions.innerHTML = '';

            // Añadir opción placeholder (no seleccionable)
            const placeholderOption = document.createElement('div');
            placeholderOption.className = 'dropdown-option';
            placeholderOption.setAttribute('data-value', '');
            placeholderOption.style.opacity = '0.6';
            placeholderOption.style.cursor = 'default';
            placeholderOption.innerHTML = `
                <span class="option-emoji">💊</span>
                <span class="option-text">Selecciona una sustancia...</span>
            `;
            dropdownOptions.appendChild(placeholderOption);

            // Añadir opciones de sustancias
            substances.forEach(substance => {
                const option = document.createElement('div');
                option.className = 'dropdown-option';
                option.setAttribute('data-value', substance.name);
                const emoji = substance.emoji || getSubstanceEmoji(substance.name);
                option.onclick = function() {
                    selectOption('entrySubstanceDropdown', substance.name, substance.name, emoji);
                };
                option.innerHTML = `
                    <span class="option-emoji">${emoji}</span>
                    <span class="option-text">${substance.name}</span>
                `;
                dropdownOptions.appendChild(option);
            });

            // Forzar reflow para asegurar que el scroll funcione
            dropdownOptions.style.display = 'none';
            dropdownOptions.offsetHeight; // Trigger reflow
            dropdownOptions.style.display = '';

            // Restaurar el valor si estamos en modo edición
            if (currentValue && isEditMode) {
                hiddenInput.value = currentValue;
                // Buscar y marcar la opción correspondiente
                const optionToSelect = dropdownOptions.querySelector(`[data-value="${currentValue}"]`);
                if (optionToSelect) {
                    const emoji = optionToSelect.querySelector('.option-emoji').textContent;
                    headerText.textContent = `${emoji} ${currentValue}`;
                    // Marcar la opción como seleccionada
                    optionToSelect.classList.add('selected');
                }
            }
        }

        // Function to generate truly unique IDs
        function generateUniqueId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
        }

        // Entry functions - Handles both add and edit
        function addEntry() {
            const substanceInput = document.getElementById('entrySubstance');
            const doseInput = document.getElementById('entryDose');
            const unitInput = document.getElementById('entryUnit');
            const dateTimeInput = document.getElementById('entryDateTime');
            const setInput = document.getElementById('entrySet');
            const settingInput = document.getElementById('entrySetting');
            const notesInput = document.getElementById('entryNotes');

            if (!substanceInput || !doseInput || !unitInput || !dateTimeInput) {
                showCustomAlert('Error: Elementos del formulario no encontrados', '❌ Error del Sistema');
                return;
            }

            const substance = substanceInput.value;
            const dose = parseFloat(doseInput.value);
            const unit = unitInput.value;
            const dateTime = dateTimeInput.value;
            const set = setInput ? setInput.value : '';
            const setting = settingInput ? settingInput.value : '';
            const notes = notesInput ? notesInput.value.trim() : '';

            // Validación mejorada para el campo sustancia
            if (!substance || substance === 'placeholder' || substance === '') {
                showCustomAlert('Por favor, selecciona una sustancia válida', '⚠️ Sustancia Requerida');
                return;
            }

            if (!dose || isNaN(dose) || dose <= 0) {
                showCustomAlert('Por favor, introduce una dosis válida mayor a 0', '⚠️ Dosis Inválida');
                return;
            }

            if (!unit || unit === '') {
                showCustomAlert('Por favor, selecciona una unidad válida', '⚠️ Unidad Requerida');
                return;
            }

            if (!dateTime) {
                showCustomAlert('Por favor, selecciona una fecha y hora válida', '⚠️ Fecha Requerida');
                return;
            }

            if (isEditMode && currentEditingEntryId) {
                // EDIT MODE
                // Buscar usando comparación flexible
                let existingEntryIndex = entries.findIndex(e => e.id === currentEditingEntryId);
                if (existingEntryIndex === -1) {
                    existingEntryIndex = entries.findIndex(e => e.id == currentEditingEntryId);
                }
                if (existingEntryIndex === -1) {
                    existingEntryIndex = entries.findIndex(e => String(e.id) === String(currentEditingEntryId));
                }
                if (existingEntryIndex === -1) {
                    existingEntryIndex = entries.findIndex(e => Number(e.id) === Number(currentEditingEntryId));
                }
                
                if (existingEntryIndex === -1) {
                    showCustomAlert('❌ Error: Registro no encontrado para actualizar.', '❌ Error');
                    resetEditMode();
                    return;
                }

                // Update existing entry
                entries[existingEntryIndex] = {
                    ...entries[existingEntryIndex], // Keep original properties like createdAt
                    substance: substance,
                    dose: dose,
                    unit: unit,
                    date: dateTime,
                    set: set || null, // Store null if empty
                    setting: setting || null, // Store null if empty
                    notes: notes || null, // Store null if empty
                    audioPath: currentAudioFilename || null,
                    photoPath: currentPhotoFilename || null,
                    updatedAt: new Date().toISOString()
                };

                showAutoCloseAlert(`✅ Registro actualizado: ${dose} ${unit} de ${substance}`, '✅ Registro Actualizado', 2000);
                closeModal('entryModal');
                // Redirect to calendar view
                switchView('calendar');
                generateCalendar();
                renderStats();
                renderSubstanceList();

            } else {
               // CREATION MODE
               const entry = {
                   id: generateUniqueId(),
                   substance: substance,
                   dose: dose,
                   unit: unit,
                   date: dateTime,
                   set: set || null,
                   setting: setting || null,
                   notes: notes || null,
                   audioPath: currentAudioFilename || null,
                   photoPath: currentPhotoFilename || null,
                   createdAt: new Date().toISOString()
               };
               entries.push(entry);
               showAutoCloseAlert(`✅ Registro guardado: ${dose} ${unit} de ${substance}`, '✅ Registro Guardado', 2000);

               closeModal('entryModal');
                // Redirect to calendar view
                switchView('calendar');
                generateCalendar();
                renderStats();
                renderSubstanceList();
            }

                             // Save and update
                 saveDataToStorage();

                 generateCalendar();
                 renderSubstanceList();
                 renderStats();

            // Clean up and redirect to calendar
            setTimeout(() => {
                closeModal('entryModal');
                resetEditMode();
                // Redirect to calendar view
                switchView('calendar');
            }, 2500); // Wait for alert to fade out (2000ms) + extra time for smooth transition
        }

        // Stats functions
        function renderStats() {
            const statsContainer = document.getElementById('stats-content');

            if (entries.length === 0) {
                statsContainer.innerHTML = '<div class="resource-card"><h4>No hay datos</h4><p>Añade algunos registros para ver estadísticas</p></div>';
                return;
            }

            const totalEntries = entries.length;
            const uniqueSubstances = [...new Set(entries.map(entry => entry.substance))];

            // Calculate average per month based on the span of entries
            let firstEntryDate = entries.length > 0 ? new Date(Math.min(...entries.map(e => new Date(e.date)))) : null;
            let lastEntryDate = entries.length > 0 ? new Date(Math.max(...entries.map(e => new Date(e.date)))) : null;

            let monthsSpan = 0;
            if (firstEntryDate && lastEntryDate) {
                monthsSpan = (lastEntryDate.getFullYear() - firstEntryDate.getFullYear()) * 12;
                monthsSpan -= firstEntryDate.getMonth();
                monthsSpan += lastEntryDate.getMonth();
                monthsSpan = Math.max(1, monthsSpan + 1); // Ensure at least 1 month
            } else {
                monthsSpan = 1; // Default to 1 month if no entries
            }

            const averagePerMonth = (totalEntries / monthsSpan).toFixed(1);


            // Most used substance
            const substanceCount = {};
            entries.forEach(entry => {
                substanceCount[entry.substance] = (substanceCount[entry.substance] || 0) + 1;
            });
            const mostUsed = Object.keys(substanceCount).length > 0 ? Object.keys(substanceCount).reduce((a, b) => substanceCount[a] > substanceCount[b] ? a : b) : 'N/A';

            // Recent activity
            const lastWeek = new Date();
            lastWeek.setDate(lastWeek.getDate() - 7);
            const recentEntries = entries.filter(entry => new Date(entry.date) > lastWeek).length;

            statsContainer.innerHTML = `
                <div class="resource-card">
                    <h4>Registros Totales</h4>
                    <p style="font-size: 2rem; color: var(--accent-cyan); font-weight: bold;">${totalEntries}</p>
                </div>
                <div class="resource-card">
                    <h4>Sustancias Únicas</h4>
                    <p style="font-size: 2rem; color: var(--secondary-pink); font-weight: bold;">${uniqueSubstances.length}</p>
                </div>
                <div class="resource-card">
                    <h4>Más Utilizada</h4>
                    <p style="font-size: 1.5rem; color: var(--primary-purple); font-weight: bold;">${mostUsed}</p>
                    <p>${substanceCount[mostUsed] || 0} veces</p>
                </div>
                <div class="resource-card">
                    <h4>Actividad Reciente</h4>
                    <p style="font-size: 2rem; color: var(--accent-orange); font-weight: bold;">${recentEntries}</p>
                    <p>Últimos 7 días</p>
                </div>
                <div class="resource-card">
                    <h4>Promedio Mensual</h4>
                    <p style="font-size: 2rem; color: var(--accent-cyan); font-weight: bold;">${averagePerMonth}</p>
                    <p>Registros por mes</p>
                </div>
            `;
        }

        // FUNCIÓN DE MIGRACIÓN MEJORADA - Añade esto al principio de tu script
        function migrateOldEntries() {
            let updatedCount = 0;

            entries.forEach(entry => {
                let updated = false;

                // Asegurar que todos los campos existan
                if (!entry.hasOwnProperty('set')) {
                    entry.set = '';
                    updated = true;
                }

                if (!entry.hasOwnProperty('setting')) {
                    entry.setting = '';
                    updated = true;
                }

                if (!entry.hasOwnProperty('unit')) {
                    entry.unit = '';
                    updated = true;
                }

                if (!entry.hasOwnProperty('notes')) {
                    entry.notes = '';
                    updated = true;
                }

                if (!entry.hasOwnProperty('createdAt')) {
                    entry.createdAt = new Date().toISOString();
                    updated = true;
                }

                if (!entry.hasOwnProperty('updatedAt')) {
                    entry.updatedAt = '';
                    updated = true;
                }

                if (updated) {
                    updatedCount++;
                }
            });

                             if (updatedCount > 0) {
                     saveDataToStorage();
                     return updatedCount;
                 }
            return 0;
        }

        // FUNCIÓN DE VALIDACIÓN ACTUALIZADA - Reemplaza la existente
        function validateDataBeforeExport() {
            // Primero migrar registros antiguos
            const migratedCount = migrateOldEntries();

            if (migratedCount > 0) {
                showCustomAlert(
                    `Se han actualizado ${migratedCount} registros con la nueva estructura. ` +
                    'Ahora puedes exportar correctamente con todos los campos (Set, Setting, etc.).',
                    '✅ Migración completada'
                );
                return;
            }

            // Verificar que todos los registros tengan la estructura correcta
            const invalidEntries = entries.filter(entry =>
                !entry.hasOwnProperty('set') || !entry.hasOwnProperty('setting')
            );

            if (invalidEntries.length > 0) {
                showCustomConfirm(
                    `Se encontraron ${invalidEntries.length} registros con estructura incompleta. ` +
                    '¿Desea corregirlos antes de exportar?',
                    'Estructura de datos incompleta',
                    () => {
                        // Redirigir a la vista de calendario para corregir los registros
                        switchView('calendar');
                    },
                    () => {
                        // Exportar de todos modos
                        exportToCSV();
                    }
                );
            } else {
                exportToCSV();
            }
        }

        // FUNCIÓN DE EXPORTACIÓN ACTUALIZADA - Reemplaza la existente
        function exportToCSV() {
            // Primero asegurarnos de que todos los registros están migrados
            migrateOldEntries();

            if (substances.length === 0 && entries.length === 0) {
                alert('No hay datos para exportar');
                return;
            }

            // Crear contenido CSV con formato consistente
            const csvLines = [];

            // Agregar BOM (Byte Order Mark) para UTF-8
            let csvContent = '\uFEFF';

            // Sección de SUSTANCIAS
            csvLines.push('SUSTANCIAS');
            csvLines.push('ID;Nombre;Color;Emoji;Fecha_Creacion;Fecha_Actualizacion');

            substances.forEach(s => {
                const emoji = s.emoji || getSubstanceEmoji(s.name);
                const updatedAt = s.updatedAt || '';

                csvLines.push(
                    `${s.id};"${s.name.replace(/"/g, '""')}";"${s.color}";"${emoji}";` +
                    `"${s.createdAt}";"${updatedAt}"`
                );
            });

            csvLines.push('');
            csvLines.push('REGISTROS');
            // Asegurar el orden correcto de columnas
            csvLines.push('ID;Sustancia;Dosis;Unidad;Fecha_Hora;Set;Setting;Notas;Fecha_Creacion;Fecha_Actualizacion');

            // Exportar registros - CON MANEJO MEJORADO DE CAMPOS
            entries.forEach(e => {
                const row = [
                    e.id,
                    `"${e.substance.replace(/"/g, '""')}"`,
                    e.dose,
                    `"${(e.unit || '').replace(/"/g, '""')}"`,
                    `"${e.date}"`,
                    `"${(e.set || '').replace(/"/g, '""')}"`,
                    `"${(e.setting || '').replace(/"/g, '""')}"`,
                    `"${(e.notes || '').replace(/"/g, '""')}"`,
                    `"${e.createdAt || ''}"`,
                    `"${e.updatedAt || ''}"`
                ];

                csvLines.push(row.join(';'));
            });

            csvContent += csvLines.join('\n');
            const fileName = `bitacora_psiconautica_${new Date().toISOString().split('T')[0]}.csv`;

            // Crear blob con tipo específico para CSV
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);

            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            link.style.display = 'none';

            document.body.appendChild(link);
            link.click();

            // Limpiar después de descargar
            setTimeout(() => {
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }, 100);

            // PRIMERO: Abrir ShareSheet inmediatamente
            shareExportedCSV(csvContent, fileName);

            // DESPUÉS: Mostrar alert de confirmación
            setTimeout(() => {
                showCustomAlert(
                    `✅ Archivo exportado correctamente\n\n📁 ${fileName}\n\nRevisa tu carpeta de Descargas`,
                    '✅ Exportación Completa'
                );
            }, 100);
        }

        // FUNCIÓN SIMPLE PARA COMPARTIR CSV YA EXPORTADO
        function shareExportedCSV(csvContent, filename) {
            // Llamar directamente a la función Android para compartir
            Android.shareCSV(csvContent, filename);
        }

        // FUNCIÓN DE IMPORTACIÓN ACTUALIZADA - Reemplaza la existente
        function importFromCSV(input) {
            const file = input.files[0];

            if (!file) {
                showCustomAlert('❌ No se seleccionó ningún archivo');
                return;
            }

            if (!file.name.toLowerCase().endsWith('.csv')) {
                showCustomAlert('❌ Solo se permiten archivos .csv');
                input.value = '';
                return;
            }
                                  
            const replaceData = confirm(
                '¿Qué hacer con los datos actuales?\n\n' +
                'ACEPTAR = Reemplazar todos los datos\n' +
                'CANCELAR = Agregar datos nuevos'
            );

            const reader = new FileReader();

            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    // Normalizar saltos de línea
                    let lines = csv.replace(/\r\n/g, '\n').replace(/\r/g, '\n').split('\n');

                    let currentSection = '';
                    let substancesImported = 0;
                    let entriesImported = 0;

                    if (replaceData) {
                        substances = [];
                        entries = [];
                    }

                    for (let i = 0; i < lines.length; i++) {
                        const line = lines[i].replace(/^\uFEFF/, '').trim();

                        // Detectar secciones (case-insensitive)
                        if (line.toUpperCase() === 'SUSTANCIAS') {
                            currentSection = 'substances';
                            continue;
                        } else if (line.toUpperCase() === 'REGISTROS') {
                            currentSection = 'entries';
                            continue;
                        }

                        if (line.length === 0) {
                            continue;
                        }

                        const columns = parseCSVLine(line);

                        // Si no hay secciones definidas, asumir formato antiguo
                        if (currentSection === '' && columns.length >= 4) {
                            // Formato antiguo: intentar detectar automáticamente
                            if (isSubstanceLine(columns)) {
                                currentSection = 'substances';
                            } else if (isEntryLine(columns)) {
                                currentSection = 'entries';
                            }
                        }

                        if (currentSection === 'substances' && columns.length >= 4) {
                            const substance = {
                                id: columns[0].replace(/"/g, '') || generateUniqueId(),
                                name: columns[1].replace(/"/g, ''),
                                color: columns[2].replace(/"/g, ''),
                                emoji: columns[3] ? columns[3].replace(/"/g, '') : getSubstanceEmoji(columns[1]),
                                createdAt: columns[4] ? columns[4].replace(/"/g, '') : new Date().toISOString()
                            };

                            if (replaceData || !substances.find(s => s.name.toLowerCase() === substance.name.toLowerCase())) {
                                substances.push(substance);
                                substancesImported++;
                            }
                        } else if (currentSection === 'entries' && columns.length >= 5) {
                            // Formato nuevo con más campos
                            const entry = {
                                id: columns[0].replace(/"/g, '') || generateUniqueId(),
                                substance: columns[1].replace(/"/g, ''),
                                dose: parseFloat(columns[2].replace(/"/g, '').replace(',', '.')) || 0,
                                unit: columns[3].replace(/"/g, ''),
                                date: columns[4].replace(/"/g, ''),
                                set: columns[5] ? columns[5].replace(/"/g, '') : null,
                                setting: columns[6] ? columns[6].replace(/"/g, '') : null,
                                notes: columns[7] ? columns[7].replace(/"/g, '') : null,
                                createdAt: columns[8] ? columns[8].replace(/"/g, '') : new Date().toISOString(),
                                updatedAt: columns[9] ? columns[9].replace(/"/g, '') : null
                            };

                            entries.push(entry);
                            entriesImported++;
                        }
                                            }

                    saveDataToStorage();

                    renderSubstanceList();
                    generateCalendar();
                    renderStats();

                    showCustomAlert(
                        `✅ Importación completada\n\n` +
                        `📋 ${substancesImported} sustancias\n` +
                        `📊 ${entriesImported} registros\n\n` +
                        `${replaceData ? '🔄 Datos reemplazados' : '➕ Datos agregados'}`
                    );

                } catch (error) {
                    console.error('Error al importar:', error);
                    showCustomAlert(`❌ Error al procesar archivo:\n\n${error.message}`);
                }
            };

            reader.onerror = function() {
                showCustomAlert('❌ Error al leer el archivo');
            };

            reader.readAsText(file, 'UTF-8');

            setTimeout(() => {
                input.value = '';
            }, 1000);
        }

        // Funciones auxiliares para detectar el tipo de línea
        function isSubstanceLine(columns) {
            // Una línea de sustancia típicamente tiene: ID, Nombre, Color, Emoji
            return columns.length >= 3 &&
                   !isNaN(columns[0]) && // ID es numérico
                   columns[2].startsWith('#'); // Color empieza con #
        }

        function isEntryLine(columns) {
            // Una línea de entrada típicamente tiene: ID, Sustancia, Dosis, Unidad, Fecha
            return columns.length >= 5 &&
                   !isNaN(columns[0]) && // ID es numérico
                   !isNaN(columns[2]); // Dosis es numérica
        }

        // Función para parsear líneas CSV (mejorada)
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            let quoteChar = '';

            for (let i = 0; i < line.length; i++) {
                const char = line[i];

                if ((char === '"' || char === "'") && !inQuotes) {
                    inQuotes = true;
                    quoteChar = char;
                } else if (char === quoteChar && inQuotes) {
                    inQuotes = false;
                } else if (char === ';' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }

            result.push(current);
            return result;
        }

        // Función para generar IDs únicos (necesaria para la importación)
        function generateUniqueId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
        }


        // AÑADE ESTA FUNCIÓN PARA AÑADIR UN BOTÓN DE MIGRACIÓN
        function addMigrationButton() {
            const dataView = document.getElementById('data-view');
            if (dataView) {
                // Crear contenedor para botones
                const buttonContainer = document.createElement('div');
                buttonContainer.style.marginTop = '2rem';
                buttonContainer.style.padding = '1rem';
                buttonContainer.style.backgroundColor = 'var(--darker-bg)';
                buttonContainer.style.borderRadius = '12px';
                buttonContainer.style.border = '1px solid var(--border-color)';

                // Título
                const title = document.createElement('h4');
                title.textContent = 'Migración de Datos';
                title.style.color = 'var(--accent-cyan)';
                title.style.marginBottom = '1rem';
                buttonContainer.appendChild(title);

                // Descripción
                const description = document.createElement('p');
                description.textContent = 'Si tienes registros antiguos, migra primero para incluir todos los campos (Set, Setting, etc.) en las exportaciones.';
                description.style.color = 'var(--text-muted)';
                description.style.marginBottom = '1rem';
                buttonContainer.appendChild(description);

                // Botón de migración
                const migrateButton = document.createElement('button');
                migrateButton.className = 'btn-primary';
                migrateButton.textContent = '🔄 Migrar registros antiguos';
                migrateButton.onclick = function() {
                    const migratedCount = migrateOldEntries();
                    if (migratedCount > 0) {
                        showCustomAlert(`✅ ${migratedCount} registros actualizados con la nueva estructura`);
                    } else {
                        showCustomAlert('ℹ️ Todos los registros ya tienen la estructura completa');
                    }
                };
                migrateButton.style.marginRight = '1rem';
                buttonContainer.appendChild(migrateButton);

                // Añadir al DOM
                dataView.querySelector('.calendar-container').appendChild(buttonContainer);
            }
        }

        // AÑADE ESTO AL FINAL DE TU ARCHIVO, DESPUÉS DE TODAS LAS FUNCIONES
        document.addEventListener('DOMContentLoaded', function() {
            // Añadir el botón de migración después de que se cargue la página
            setTimeout(addMigrationButton, 2000);

            // Verificar si hay registros que necesiten migración
            const needsMigration = entries.some(entry =>
                !entry.hasOwnProperty('set') || !entry.hasOwnProperty('setting')
            );

            if (needsMigration) {
                setTimeout(() => {
                    showCustomAlert(
                        '📋 Se han detectado registros antiguos.\n\n' +
                        'Para exportar correctamente con todos los campos (Set, Setting, etc.), ' +
                        'por favor ve a la pestaña "Datos" y haz clic en "Migrar registros antiguos" ' +
                        'antes de exportar.',
                        'Migración Requerida'
                    );
                }, 3000);
            }
        });


        function clearAllData() {
            showCustomConfirm(
                '¿Estás seguro de que quieres eliminar todos los datos? Esta acción no se puede deshacer.',
                '🗑️ Eliminar Todos los Datos',
                () => {
                    localStorage.removeItem('substances');
                    localStorage.removeItem('entries');
                    localStorage.removeItem('userProfile');

                    substances = getDefaultSubstances(); // Reset to default substances
                    entries = [];
                    userProfile = {};
                    selectedSubstanceFilter = null;

                                             saveDataToStorage(); // Save default substances

                    showCustomAlert('Todos los datos han sido eliminados', '🗑️ Datos Eliminados');
                }
            );
        }

        // ========================================
        // FUNCIONES DE BACKUP Y EXPORTACIÓN
        // ========================================

        /**
         * Crear backup manual (botón en Ajustes)
         *
         * CONCEPTO: Serializar localStorage completo
         * Convertimos todo el localStorage a JSON y lo enviamos a Android
         */
        function createManualBackup() {
            try {
                // Recopilar todos los datos de localStorage
                const backupData = collectBackupPayload();

                // Convertir a JSON
                const jsonString = JSON.stringify(backupData, null, 2);

                if (!window.Android || typeof Android.createManualBackup !== 'function') {
                    showCustomAlert('La función de backup manual solo está disponible en Android.', 'ℹ️ Información');
                    return;
                }

                // Llamar a Android
                const result = Android.createManualBackup(jsonString);

                if (result.startsWith('OK:')) {
                    const filename = result.substring(3);
                    console.log('Backup creado:', filename);
                    refreshBackupStatus();
                } else {
                    console.error('Error en backup:', result);
                }

            } catch (error) {
                console.error('Error al crear backup:', error);
                Android.showToast('❌ Error: ' + error.message);
            }
        }

        /**
         * Abrir modal de exportación de audios
         */
        function openAudioExportModal() {
            openModal('audioExportModal');

            // Setup del checkbox
            const checkbox = document.getElementById('encryptAudioZip');
            const passwordGroup = document.getElementById('passwordGroup');

            checkbox.addEventListener('change', function() {
                passwordGroup.style.display = this.checked ? 'block' : 'none';
            });
        }

        /**
         * Exportar audios en ZIP (con o sin cifrado)
         */
        function exportAudiosZip() {
            try {
                const encryptCheckbox = document.getElementById('encryptAudioZip');
                const passwordInput = document.getElementById('audioZipPassword');

                if (encryptCheckbox.checked) {
                    // Exportar con cifrado
                    const password = passwordInput.value.trim();

                    if (!password || password.length < 8) {
                        Android.showToast('⚠️ La contraseña debe tener al menos 8 caracteres');
                        return;
                    }

                    const result = Android.exportAudiosZipEncrypted(password);

                    if (result === 'OK') {
                        closeModal('audioExportModal');
                        // Reset form
                        encryptCheckbox.checked = false;
                        passwordInput.value = '';
                        document.getElementById('passwordGroup').style.display = 'none';
                    } else {
                        console.error('Error:', result);
                    }

                } else {
                    // Exportar sin cifrar
                    const result = Android.exportAudiosZip();

                    if (result === 'OK') {
                        closeModal('audioExportModal');
                        Android.showToast('✅ Audios exportados correctamente');
                    } else {
                        console.error('Error:', result);
                    }
                }

            } catch (error) {
                console.error('Error al exportar audios:', error);
                Android.showToast('❌ Error: ' + error.message);
            }
        }

        /**
         * Exportar todas las fotos en un ZIP
         */
        function exportPhotosZip() {
            if (!window.Android || typeof Android.exportPhotosZip !== 'function') {
                showCustomAlert('Esta función solo está disponible en Android.', 'ℹ️ Información');
                return;
            }

            try {
                const result = Android.exportPhotosZip();
                if (result !== 'OK') {
                    console.error('Error exportando fotos:', result);
                }
            } catch (error) {
                console.error('Error exportando fotos:', error);
                Android.showToast('❌ Error exportando fotos');
            }
        }

        /**
         * Mostrar confirmación e iniciar importación de un backup ZIP
         */
        function promptBackupImport() {
            if (!window.Android || typeof Android.importBackup !== 'function') {
                showCustomAlert('Importar backup solo está disponible en Android.', 'ℹ️ Información');
                return;
            }

            showCustomConfirm(
                'Esta acción reemplazará tus datos actuales (sustancias, registros, adjuntos).\n\n' +
                'Te recomendamos crear un backup manual antes de continuar.\n\n' +
                '¿Quieres importar un archivo de backup ahora?',
                '📥 Importar Backup',
                () => Android.importBackup()
            );
        }

        /**
         * Callback desde Android cuando el backup se importó correctamente
         *
         * @param payloadJson String con el contenido del data.json del backup
         * @param infoJson String opcional con información adicional (audios, fotos restauradas)
         */
        window.onBackupRestored = function(payloadJson, infoJson) {
            try {
                const payload = JSON.parse(payloadJson || '{}');
                const extraInfo = infoJson ? JSON.parse(infoJson) : {};

                substances = Array.isArray(payload.substances) ? payload.substances : [];
                entries = Array.isArray(payload.entries) ? payload.entries : [];
                userProfile = payload.userProfile || {};

                localStorage.setItem('substances', JSON.stringify(substances));
                localStorage.setItem('entries', JSON.stringify(entries));
                localStorage.setItem('userProfile', JSON.stringify(userProfile));

                if (payload.customUnits) {
                    localStorage.setItem('psychologger_custom_units', JSON.stringify(payload.customUnits));
                }
                if (payload.customSets) {
                    localStorage.setItem('psychologger_custom_sets', JSON.stringify(payload.customSets));
                }
                if (payload.customSettings) {
                    localStorage.setItem('psychologger_custom_settings', JSON.stringify(payload.customSettings));
                }

                saveDataToStorage();

                generateCalendar();
                renderStats();
                renderSubstanceList();
                refreshBackupStatus();

                currentAudioFilename = null;
                currentPhotoFilename = null;
                updateVoiceNoteCard();
                updatePhotoCard();
                updatePhotoModalControls();

                const restoredAudios = extraInfo && typeof extraInfo.audios === 'number' ? extraInfo.audios : 0;
                const restoredPhotos = extraInfo && typeof extraInfo.photos === 'number' ? extraInfo.photos : 0;
                const summary = `✅ Backup importado correctamente.\n\n🎤 Audios restaurados: ${restoredAudios}\n📸 Fotos restauradas: ${restoredPhotos}`;

                showCustomAlert(summary, '📥 Importación completada');
                switchView('calendar');

            } catch (error) {
                console.error('Error aplicando backup:', error);
                showCustomAlert('No se pudo aplicar el backup: ' + error.message, '❌ Error al importar');
            }
        };

        /**
         * Callback desde Android cuando la importación falla
         */
        window.onBackupRestoreError = function(message) {
            const humanMessage = message || 'No se pudo importar el backup seleccionado.';
            showCustomAlert(humanMessage, '❌ Error al importar backup');
        };

        function openExternalURL(url) {
            // Attempt to open in a new window/tab, which is generally handled by the system browser on mobile
            window.open(url, '_blank', 'noopener,noreferrer');
        }

        function toggleBooksSection() {
            const section = document.getElementById('books-section');
            const isVisible = section.style.display !== 'none';
            
            if (isVisible) {
                // Cerrar sección
                section.style.display = 'none';
            } else {
                // Abrir sección  
                section.style.display = 'block';
                
                // Scroll suave hacia la sección después de un pequeño delay
                // para que la animación se vea bien
                setTimeout(() => {
                    section.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }, 100);
            }
        }


        // ===== FUNCIONES DE MODALES =====

        // Close modals when clicking outside
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                closeModal(e.target.id);
            }
        });

        // Initialize color picker
        document.addEventListener('DOMContentLoaded', function() {
            // Set default color selection for substance modal
            const firstColorOption = document.querySelector('#substanceModal .color-option');
            if (firstColorOption) {
                firstColorOption.classList.add('selected');
                selectedSubstanceColor = firstColorOption.dataset.color;
            }
        });

        // Prevent modal close when clicking inside modal content
        document.addEventListener('click', function(e) {
            if (e.target.closest('.modal-content')) {
                e.stopPropagation();
            }
        });

        function forceFileSelect() {
            const input = document.getElementById('csvFileInput');
            if (input) {
                input.click();
            } else {
                showCustomAlert('Error: Input de archivo no encontrado.', '❌ Error');
            }
        }

        // ===== DIÁLOGOS PERSONALIZADOS =====

        function showCustomConfirm(message, title, onConfirm) {
            const modalId = 'custom-confirm-modal';
            const existingModal = document.getElementById(modalId);
            if (existingModal) {
                existingModal.remove();
            }

            const modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content custom-dialog">
                    <div class="custom-dialog-header">
                        <h3>${title}</h3>
                    </div>
                    <div class="custom-dialog-body">
                        <p>${message}</p>
                    </div>
                    <div class="custom-dialog-actions">
                        <button class="btn-secondary" onclick="closeCustomConfirm()">Cancelar</button>
                        <button class="btn-primary" onclick="confirmAndClose()">Aceptar</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            document.body.style.overflow = 'hidden';

            // Guardar la función de confirmación globalmente
            window.pendingConfirmAction = onConfirm;

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeCustomConfirm();
                }
            });
        }

        function showCustomAlert(message, title) {
            const modalId = 'custom-alert-modal';
            const existingModal = document.getElementById(modalId);
            if (existingModal) {
                existingModal.remove();
            }

            const modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content custom-dialog">
                    <div class="custom-dialog-header">
                        <h3>${title}</h3>
                    </div>
                    <div class="custom-dialog-body">
                        <p>${message}</p>
                    </div>
                    <div class="custom-dialog-actions">
                        <button class="btn-primary" onclick="closeCustomAlert()">Aceptar</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            document.body.style.overflow = 'hidden';

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeCustomAlert();
                }
            });
        }

        // Nueva función para alertas que se cierran automáticamente
        function showAutoCloseAlert(message, title, autoCloseDelay = 2000) {
            const modalId = 'auto-close-alert-modal';
            const existingModal = document.getElementById(modalId);
            if (existingModal) {
                existingModal.remove();
            }

            const modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content custom-dialog auto-close">
                    <div class="custom-dialog-header">
                        <h3>${title}</h3>
                        <div class="auto-close-progress">
                            <div class="progress-bar"></div>
                        </div>
                    </div>
                    <div class="custom-dialog-body">
                        <p>${message}</p>
                    </div>
                    <div class="custom-dialog-actions">
                        <button class="btn-primary" onclick="closeAutoCloseAlert()">Aceptar</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            document.body.style.overflow = 'hidden';

            // Animar la barra de progreso
            const progressBar = modal.querySelector('.progress-bar');
            if (progressBar) {
                progressBar.style.transition = `width ${autoCloseDelay}ms linear`;
                setTimeout(() => {
                    progressBar.style.width = '0%';
                }, 100);
            }

            // Cerrar automáticamente después del tiempo especificado
            setTimeout(() => {
                closeAutoCloseAlert();
            }, autoCloseDelay);

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeAutoCloseAlert();
                }
            });
        }

        function closeCustomConfirm() {
            const modal = document.getElementById('custom-confirm-modal');
            if (modal) {
                modal.remove();
            }
            document.body.style.overflow = '';
            window.pendingConfirmAction = null;
        }

        function closeCustomAlert() {
            const modal = document.getElementById('custom-alert-modal');
            if (modal) {
                modal.remove();
            }
            document.body.style.overflow = '';
        }

        function closeAutoCloseAlert() {
            const modal = document.getElementById('auto-close-alert-modal');
            if (modal) {
                const dialog = modal.querySelector('.custom-dialog');
                if (dialog) {
                    // Agregar clase de fade-out para la animación
                    dialog.classList.add('fade-out');
                    // Esperar a que termine la animación antes de cerrar
                    setTimeout(() => {
                        if (modal && modal.parentNode) {
                            modal.remove();
                        }
                        document.body.style.overflow = '';
                    }, 300); // 300ms = duración de la animación
                } else {
                    modal.remove();
                    document.body.style.overflow = '';
                }
            }
        }

        function confirmAndClose() {
            if (window.pendingConfirmAction) {
                window.pendingConfirmAction();
            }
            closeCustomConfirm();
                }

        // Función para mostrar modal de libro
        function showBookModal(title, author, description) {
            const modalId = 'book-info-modal';
            const existingModal = document.getElementById(modalId);
            if (existingModal) {
                existingModal.remove();
            }

            const modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content custom-dialog">
                    <div class="custom-dialog-header">
                        <h3>📚 ${title}</h3>
                        <button class="close-btn" onclick="closeBookModal()">×</button>
                    </div>
                    <div class="custom-dialog-body">
                        <p class="book-author-modal"><strong>Autor:</strong> ${author}</p>
                        <p class="book-desc-modal">${description}</p>
                        <div class="book-actions">
                            <button class="btn-primary" onclick="closeBookModal()">Cerrar</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            document.body.style.overflow = 'hidden';

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeBookModal();
                }
            });
        }

        function closeBookModal() {
            const modal = document.getElementById('book-info-modal');
            if (modal) {
                modal.remove();
                document.body.style.overflow = '';
            }
        }


        function closeBooksElegantModal() {
            const modal = document.getElementById('books-elegant-modal');
            if (modal) {
                modal.remove();
                document.body.style.overflow = '';
            }
        }

        function showBookDetails(index) {
            try {
                if (window.currentBooksDataElegant && window.currentBooksDataElegant[index]) {
                    const book = window.currentBooksDataElegant[index];
                    showBookModal(book[0], book[1], book[2]);
                }
            } catch (error) {
                console.error('Error mostrando detalles:', error);
            }
        }

        // NUEVAS funciones del modal
        function openBooksModal() {
            console.log('openBooksModal called');
            const modal = document.getElementById('books-modal');
            console.log('Modal element:', modal);
            if (!modal) return;
            modal.classList.remove('hidden');
            document.body.classList.add('modal-open');
            console.log('Modal should be visible now');

            // cerrar con Esc
            const onKey = (e) => {
              if (e.key === 'Escape') closeBooksModal();
            };
            modal.dataset.esc = '1';
            window.addEventListener('keydown', onKey, { once: true });
        }

        function closeBooksModal() {
            const modal = document.getElementById('books-modal');
            if (!modal) return;
            modal.classList.add('hidden');
            document.body.classList.remove('modal-open');
        }

            // ===== FUNCIONES PARA DROPDOWNS PERSONALIZADOS =====

            // Variable global para controlar qué dropdown está abierto
            let openDropdown = null;

            // Función para abrir/cerrar dropdowns
            function toggleDropdown(dropdownId) {

                const dropdown = document.getElementById(dropdownId);
                const options = dropdown.querySelector('.dropdown-options');
                const header = dropdown.querySelector('.dropdown-header');

                // Si hay otro dropdown abierto, cerrarlo
                if (openDropdown && openDropdown !== dropdown) {
                    const otherOptions = openDropdown.querySelector('.dropdown-options');
                    const otherHeader = openDropdown.querySelector('.dropdown-header');

                    // Deshabilitar pointer-events temporalmente
                    if (otherOptions) {
                        otherOptions.style.pointerEvents = 'none';
                        setTimeout(() => {
                            if (otherOptions) otherOptions.style.pointerEvents = '';
                        }, 200);
                    }

                    otherOptions.classList.remove('show');
                    otherHeader.classList.remove('active');
                }

                // Toggle del dropdown actual
                if (options.classList.contains('show')) {
                    // Deshabilitar pointer-events al cerrar
                    if (options) {
                        options.style.pointerEvents = 'none';
                        setTimeout(() => {
                            if (options) options.style.pointerEvents = '';
                        }, 200);
                    }

                    options.classList.remove('show');
                    header.classList.remove('active');
                    openDropdown = null;
                } else {
                    options.classList.add('show');
                    header.classList.add('active');
                    openDropdown = dropdown;
                }
            }

            // Función para seleccionar una opción
            function selectOption(dropdownId, value, text, emoji) {
                const dropdown = document.getElementById(dropdownId);
                const headerText = dropdown.querySelector('.dropdown-text');
                const hiddenInput = dropdown.querySelector('input[type="hidden"]');

                // Actualizar el texto mostrado
                headerText.textContent = `${emoji} ${text}`;

                // Actualizar el input hidden
                // Para unidades personalizadas, guardar solo el nombre, no el ID interno
                if (value.startsWith('custom_')) {
                    hiddenInput.value = text; // Guardar "Viaje" en lugar de "custom_psicodelicos_Viaje"
                } else {
                    hiddenInput.value = value; // Para unidades normales (mg, ug, etc.)
                }

                // Cerrar el dropdown
                const options = dropdown.querySelector('.dropdown-options');
                const header = dropdown.querySelector('.dropdown-header');

                // Deshabilitar pointer-events temporalmente para evitar clicks fantasma
                if (options) {
                    options.style.pointerEvents = 'none';
                    setTimeout(() => {
                        if (options) options.style.pointerEvents = '';
                    }, 200);
                }

                options.classList.remove('show');
                header.classList.remove('active');
                openDropdown = null;

                // Marcar la opción como seleccionada
                const allOptions = dropdown.querySelectorAll('.dropdown-option');
                allOptions.forEach(option => {
                    option.classList.remove('selected');
                    if (option.dataset.value === value) {
                        option.classList.add('selected');
                    }
                });

                // Validar que se haya seleccionado una sustancia válida
                if (dropdownId === 'entrySubstanceDropdown' && (!value || value === '')) {
                    headerText.textContent = 'Selecciona una sustancia...';
                    hiddenInput.value = '';
                }
            }

            // === FUNCIONES PARA UNIDADES PERSONALIZADAS ===

            function restoreDropdownSelection(dropdownId, storedValue, fallbackText = 'Seleccionar...') {
                const dropdown = document.getElementById(dropdownId);
                if (!dropdown) return;

                const headerText = dropdown.querySelector('.dropdown-text');
                const hiddenInput = dropdown.querySelector('input[type="hidden"]');
                const options = dropdown.querySelectorAll('.dropdown-option');

                options.forEach(option => option.classList.remove('selected'));

                if (!storedValue) {
                    if (headerText) headerText.textContent = fallbackText;
                    if (hiddenInput) hiddenInput.value = '';
                    return;
                }

                let matchedOption = null;
                options.forEach(option => {
                    const optionLabel = option.querySelector('.option-text')?.textContent?.trim() || option.textContent.trim();
                    const optionValue = option.dataset.value || '';

                    if (optionValue === storedValue) {
                        matchedOption = option;
                    } else if (!matchedOption && optionLabel.toLowerCase() === storedValue.toLowerCase()) {
                        matchedOption = option;
                    }
                });

                if (matchedOption) {
                    matchedOption.classList.add('selected');
                    const emoji = matchedOption.querySelector('.option-emoji')?.textContent?.trim() || '';
                    const text = matchedOption.querySelector('.option-text')?.textContent?.trim() || matchedOption.textContent.trim();

                    if (headerText) headerText.textContent = emoji ? `${emoji} ${text}` : text;

                    if (hiddenInput) {
                        if ((matchedOption.dataset.value || '').startsWith('custom_')) {
                            hiddenInput.value = text;
                        } else {
                            hiddenInput.value = matchedOption.dataset.value;
                        }
                    }
                } else {
                    if (headerText) headerText.textContent = storedValue;
                    if (hiddenInput) hiddenInput.value = storedValue;
                }
            }

            // Función para agregar unidad personalizada
            function addCustomUnit(category, buttonElement) {
                const container = buttonElement.closest('.custom-input-container');
                const input = container.querySelector('.custom-unit-field');
                const unitName = input.value.trim();
                
                // Validar que no esté vacío
                if (!unitName) {
                    showAlert('⚠️ Error', 'Por favor ingresa el nombre de la unidad personalizada.');
                    input.focus();
                    return;
                }
                
                // Validar longitud máxima
                if (unitName.length > 25) {
                    showAlert('⚠️ Error', 'El nombre de la unidad no puede exceder 25 caracteres.');
                    input.focus();
                    return;
                }
                
                // Verificar si ya existe
                if (customUnitExists(category, unitName)) {
                    showAlert('⚠️ Error', 'Esta unidad personalizada ya existe en esta categoría.');
                    input.focus();
                    return;
                }
                
                // Crear la nueva opción
                const newOption = createCustomUnitOption(category, unitName);
                
                // Insertar antes del campo personalizado
                container.parentNode.insertBefore(newOption, container);
                
                // Guardar en localStorage
                saveCustomUnit(category, unitName);
                
                // Limpiar campo y mostrar éxito
                input.value = '';
                showAlert('✅ Éxito', `Unidad "${unitName}" agregada correctamente a ${getCategoryDisplayName(category)}.`);
                
                // Seleccionar automáticamente la nueva unidad
                selectOption('entryUnitDropdown', `custom_${category}_${unitName}`, unitName, '✨');
            }
            
            // Crear elemento HTML para unidad personalizada
            function createCustomUnitOption(category, unitName) {
                const option = document.createElement('div');
                option.className = 'dropdown-option custom-unit';
                option.setAttribute('data-value', `custom_${category}_${unitName}`);
                option.setAttribute('data-category', category);
                option.setAttribute('data-unit-name', unitName);

                option.innerHTML = `
                    <div class="custom-unit-content" onclick="selectOption('entryUnitDropdown', 'custom_${category}_${unitName}', '${unitName}', '✨')">
                        <span class="option-emoji">✨</span>
                        <span class="option-text">${unitName}</span>
                    </div>
                    <div class="custom-unit-actions">
                        <button class="custom-unit-btn edit-custom-unit-btn" onclick="editCustomUnit('${category}', '${unitName}', this)" title="Editar unidad">
                            ✏️
                        </button>
                        <button class="custom-unit-btn delete-custom-unit-btn" onclick="deleteCustomUnit('${category}', '${unitName}', this)" title="Eliminar unidad">
                            🗑️
                        </button>
                    </div>
                `;

                return option;
            }
            
            // Verificar si una unidad personalizada ya existe
            function customUnitExists(category, unitName) {
                const existingOptions = document.querySelectorAll(`[data-value="custom_${category}_${unitName}"]`);
                return existingOptions.length > 0;
            }
            
            // Obtener nombre de categoría para mostrar
            function getCategoryDisplayName(category) {
                const categoryNames = {
                    'psicodelicos': 'PSICODÉLICOS',
                    'hongos': 'HONGOS/PLANTAS', 
                    'estimulantes': 'ESTIMULANTES/MDMA',
                    'polvo': 'POLVO/CRISTAL',
                    'liquidos': 'LÍQUIDOS',
                    'otras': 'OTRAS'
                };
                return categoryNames[category] || category.toUpperCase();
            }
            
            // Guardar unidad personalizada en localStorage
            function saveCustomUnit(category, unitName) {
                let customUnits = JSON.parse(localStorage.getItem('psychologger_custom_units') || '{}');
                if (!customUnits[category]) {
                    customUnits[category] = [];
                }
                if (!customUnits[category].includes(unitName)) {
                    customUnits[category].push(unitName);
                    localStorage.setItem('psychologger_custom_units', JSON.stringify(customUnits));
                    notifyBackupDataChanged();
                }
            }
            
            // Cargar unidades personalizadas al inicializar
            function loadCustomUnits() {
                const customUnits = JSON.parse(localStorage.getItem('psychologger_custom_units') || '{}');

                Object.keys(customUnits).forEach(category => {
                    customUnits[category].forEach(unitName => {
                        // Verificar que no exista ya
                        if (!customUnitExists(category, unitName)) {
                            const newOption = createCustomUnitOption(category, unitName);

                            // Buscar el contenedor de input de la categoría
                            const inputContainer = document.querySelector(`[data-category="${category}"].custom-input-container`);
                            if (inputContainer) {
                                inputContainer.parentNode.insertBefore(newOption, inputContainer);
                            }
                        }
                    });
                });
            }

            // Función para editar unidad personalizada
            function editCustomUnit(category, oldUnitName, buttonElement) {
                // Prevenir que se cierre el dropdown
                event.stopPropagation();

                const newName = prompt(`Editar nombre de la unidad en ${getCategoryDisplayName(category)}:`, oldUnitName);

                if (newName === null || newName.trim() === '') {
                    return; // Usuario canceló o no ingresó nada
                }

                const trimmedName = newName.trim();

                // Validar longitud
                if (trimmedName.length > 25) {
                    showAlert('⚠️ Error', 'El nombre de la unidad no puede exceder 25 caracteres.');
                    return;
                }

                // Verificar que el nuevo nombre no exista (excepto si es el mismo)
                if (trimmedName !== oldUnitName && customUnitExists(category, trimmedName)) {
                    showAlert('⚠️ Error', 'Ya existe una unidad con ese nombre en esta categoría.');
                    return;
                }

                // Si el nombre no cambió, no hacer nada
                if (trimmedName === oldUnitName) {
                    return;
                }

                // Actualizar en localStorage
                let customUnits = JSON.parse(localStorage.getItem('psychologger_custom_units') || '{}');
                if (customUnits[category]) {
                    const index = customUnits[category].indexOf(oldUnitName);
                    if (index !== -1) {
                        customUnits[category][index] = trimmedName;
                        localStorage.setItem('psychologger_custom_units', JSON.stringify(customUnits));
                        notifyBackupDataChanged();
                    }
                }

                // Actualizar la opción en el DOM
                const optionElement = buttonElement.closest('.dropdown-option.custom-unit');
                optionElement.setAttribute('data-value', `custom_${category}_${trimmedName}`);
                optionElement.setAttribute('data-unit-name', trimmedName);

                // Actualizar contenido
                const textSpan = optionElement.querySelector('.option-text');
                textSpan.textContent = trimmedName;

                // Actualizar eventos de los botones
                const editBtn = optionElement.querySelector('.edit-custom-unit-btn');
                const deleteBtn = optionElement.querySelector('.delete-custom-unit-btn');
                const content = optionElement.querySelector('.custom-unit-content');

                editBtn.setAttribute('onclick', `editCustomUnit('${category}', '${trimmedName}', this)`);
                deleteBtn.setAttribute('onclick', `deleteCustomUnit('${category}', '${trimmedName}', this)`);
                content.setAttribute('onclick', `selectOption('entryUnitDropdown', 'custom_${category}_${trimmedName}', '${trimmedName}', '✨')`);

                showAlert('✅ Éxito', `Unidad renombrada a "${trimmedName}" correctamente.`);
            }

            // Función para eliminar unidad personalizada
            function deleteCustomUnit(category, unitName, buttonElement) {
                // Prevenir que se cierre el dropdown
                event.stopPropagation();

                const confirmed = confirm(`¿Estás seguro de que deseas eliminar la unidad "${unitName}" de ${getCategoryDisplayName(category)}?\n\nEsta acción no se puede deshacer.`);

                if (!confirmed) {
                    return;
                }

                // Eliminar del localStorage
                let customUnits = JSON.parse(localStorage.getItem('psychologger_custom_units') || '{}');
                if (customUnits[category]) {
                    const index = customUnits[category].indexOf(unitName);
                    if (index !== -1) {
                        customUnits[category].splice(index, 1);
                        localStorage.setItem('psychologger_custom_units', JSON.stringify(customUnits));
                        notifyBackupDataChanged();
                    }
                }

                // Eliminar del DOM
                const optionElement = buttonElement.closest('.dropdown-option.custom-unit');
                optionElement.remove();

                showAlert('✅ Unidad Eliminada', `La unidad "${unitName}" ha sido eliminada correctamente.`);
            }

            // Función para eliminar unidad personalizada del localStorage
            function removeCustomUnitFromStorage(category, unitName) {
                let customUnits = JSON.parse(localStorage.getItem('psychologger_custom_units') || '{}');
                if (customUnits[category]) {
                    const index = customUnits[category].indexOf(unitName);
                    if (index !== -1) {
                        customUnits[category].splice(index, 1);
                        localStorage.setItem('psychologger_custom_units', JSON.stringify(customUnits));
                        notifyBackupDataChanged();
                        return true;
                    }
                }
                return false;
            }

            // Cerrar dropdowns al hacer clic fuera
            document.addEventListener('click', function(e) {
                // Verificar si el click fue en un dropdown-option (ignorar esos clicks)
                if (e.target.closest('.dropdown-option')) {
                    return;
                }

                // Verificar si el click fue dentro del dropdown abierto
                if (openDropdown && !openDropdown.contains(e.target)) {
                    const options = openDropdown.querySelector('.dropdown-options');
                    const header = openDropdown.querySelector('.dropdown-header');

                    // Deshabilitar pointer-events temporalmente para evitar clicks fantasma
                    if (options) {
                        options.style.pointerEvents = 'none';
                        setTimeout(() => {
                            if (options) options.style.pointerEvents = '';
                        }, 150);
                    }

                    options.classList.remove('show');
                    header.classList.remove('active');
                    openDropdown = null;
                }
            }, true); // Usar fase de captura para prevenir el problema

            // Cerrar dropdowns con la tecla Escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && openDropdown) {
                    const options = openDropdown.querySelector('.dropdown-options');
                    const header = openDropdown.querySelector('.dropdown-header');

                    // Deshabilitar pointer-events al cerrar
                    if (options) {
                        options.style.pointerEvents = 'none';
                        setTimeout(() => {
                            if (options) options.style.pointerEvents = '';
                        }, 200);
                    }

                    options.classList.remove('show');
                    header.classList.remove('active');
                    openDropdown = null;
                }
            });

            // Prevenir clicks durante el scroll en los dropdowns
            let isScrolling = false;
            let scrollTimeout;

            document.addEventListener('scroll', function(e) {
                if (e.target.classList && e.target.classList.contains('dropdown-options')) {
                    isScrolling = true;
                    clearTimeout(scrollTimeout);

                    // Resetear después de que termine el scroll
                    scrollTimeout = setTimeout(() => {
                        isScrolling = false;
                    }, 150);
                }
            }, true);

            // Interceptar clicks durante scroll
            document.addEventListener('mousedown', function(e) {
                if (isScrolling && e.target.closest('.dropdown-option')) {
                    e.preventDefault();
                    e.stopPropagation();
                }
            }, true);

            // === FUNCIONES PARA SETS Y SETTINGS PERSONALIZADOS ===
            function addCustomSet(buttonElement) {
                const container = buttonElement.closest('.custom-input-container');
                const input = container.querySelector('.custom-unit-field');
                const setName = input.value.trim();
                if (!setName) {
                    showAlert('⚠️ Error', 'Por favor ingresa el nombre del estado mental personalizado.');
                    input.focus();
                    return;
                }
                if (setName.length > 25) {
                    showAlert('⚠️ Error', 'El nombre del estado mental no puede exceder 25 caracteres.');
                    input.focus();
                    return;
                }
                if (customSetExists(setName)) {
                    showAlert('⚠️ Error', 'Este estado mental personalizado ya existe.');
                    input.focus();
                    return;
                }
                const newOption = createCustomSetOption(setName);
                container.parentNode.insertBefore(newOption, container);
                saveCustomSet(setName);
                input.value = '';
                showAlert('✅ Éxito', `Estado mental "${setName}" agregado correctamente.`);
                selectOption('entrySetDropdown', `custom_set_${setName}`, setName, '💭');
            }

            function addCustomSetting(buttonElement) {
                const container = buttonElement.closest('.custom-input-container');
                const input = container.querySelector('.custom-unit-field');
                const settingName = input.value.trim();
                if (!settingName) {
                    showAlert('⚠️ Error', 'Por favor ingresa el nombre del entorno personalizado.');
                    input.focus();
                    return;
                }
                if (settingName.length > 25) {
                    showAlert('⚠️ Error', 'El nombre del entorno no puede exceder 25 caracteres.');
                    input.focus();
                    return;
                }
                if (customSettingExists(settingName)) {
                    showAlert('⚠️ Error', 'Este entorno personalizado ya existe.');
                    input.focus();
                    return;
                }
                const newOption = createCustomSettingOption(settingName);
                container.parentNode.insertBefore(newOption, container);
                saveCustomSetting(settingName);
                input.value = '';
                showAlert('✅ Éxito', `Entorno "${settingName}" agregado correctamente.`);
                selectOption('entrySettingDropdown', `custom_setting_${settingName}`, settingName, '🌍');
            }

            function createCustomSetOption(setName) {
                const option = document.createElement('div');
                option.className = 'dropdown-option custom-unit';
                option.setAttribute('data-value', `custom_set_${setName}`);
                option.setAttribute('data-set-name', setName);
                option.innerHTML = `
                    <div class="custom-unit-content" onclick="selectOption('entrySetDropdown', 'custom_set_${setName}', '${setName}', '💭')">
                        <span class="option-emoji">💭</span>
                        <span class="option-text">${setName}</span>
                    </div>
                    <div class="custom-unit-actions">
                        <button class="custom-unit-btn edit-custom-unit-btn" onclick="editCustomSet('${setName}', this)" title="Editar estado mental">✏️</button>
                        <button class="custom-unit-btn delete-custom-unit-btn" onclick="deleteCustomSet('${setName}', this)" title="Eliminar estado mental">🗑️</button>
                    </div>
                `;
                return option;
            }

            function createCustomSettingOption(settingName) {
                const option = document.createElement('div');
                option.className = 'dropdown-option custom-unit';
                option.setAttribute('data-value', `custom_setting_${settingName}`);
                option.setAttribute('data-setting-name', settingName);
                option.innerHTML = `
                    <div class="custom-unit-content" onclick="selectOption('entrySettingDropdown', 'custom_setting_${settingName}', '${settingName}', '🌍')">
                        <span class="option-emoji">🌍</span>
                        <span class="option-text">${settingName}</span>
                    </div>
                    <div class="custom-unit-actions">
                        <button class="custom-unit-btn edit-custom-unit-btn" onclick="editCustomSetting('${settingName}', this)" title="Editar entorno">✏️</button>
                        <button class="custom-unit-btn delete-custom-unit-btn" onclick="deleteCustomSetting('${settingName}', this)" title="Eliminar entorno">🗑️</button>
                    </div>
                `;
                return option;
            }

            function customSetExists(setName) {
                return document.querySelectorAll(`[data-value="custom_set_${setName}"]`).length > 0;
            }

            function customSettingExists(settingName) {
                return document.querySelectorAll(`[data-value="custom_setting_${settingName}"]`).length > 0;
            }

            function saveCustomSet(setName) {
                let customSets = JSON.parse(localStorage.getItem('psychologger_custom_sets') || '[]');
                if (!customSets.includes(setName)) {
                    customSets.push(setName);
                    localStorage.setItem('psychologger_custom_sets', JSON.stringify(customSets));
                    notifyBackupDataChanged();
                }
            }

            function saveCustomSetting(settingName) {
                let customSettings = JSON.parse(localStorage.getItem('psychologger_custom_settings') || '[]');
                if (!customSettings.includes(settingName)) {
                    customSettings.push(settingName);
                    localStorage.setItem('psychologger_custom_settings', JSON.stringify(customSettings));
                    notifyBackupDataChanged();
                }
            }

            function editCustomSet(oldSetName, buttonElement) {
                const newName = prompt('Editar estado mental:', oldSetName);
                if (!newName || newName.trim() === '') return;
                const trimmedName = newName.trim();
                if (trimmedName === oldSetName) return;
                if (trimmedName.length > 25) {
                    showAlert('⚠️ Error', 'El nombre del estado mental no puede exceder 25 caracteres.');
                    return;
                }
                if (customSetExists(trimmedName)) {
                    showAlert('⚠️ Error', 'Ya existe un estado mental con ese nombre.');
                    return;
                }
                let customSets = JSON.parse(localStorage.getItem('psychologger_custom_sets') || '[]');
                const index = customSets.indexOf(oldSetName);
                if (index !== -1) {
                    customSets[index] = trimmedName;
                    localStorage.setItem('psychologger_custom_sets', JSON.stringify(customSets));
                    notifyBackupDataChanged();
                }
                const optionElement = buttonElement.closest('.dropdown-option.custom-unit');
                optionElement.setAttribute('data-value', `custom_set_${trimmedName}`);
                optionElement.setAttribute('data-set-name', trimmedName);
                optionElement.querySelector('.option-text').textContent = trimmedName;
                const editBtn = optionElement.querySelector('.edit-custom-unit-btn');
                const deleteBtn = optionElement.querySelector('.delete-custom-unit-btn');
                const content = optionElement.querySelector('.custom-unit-content');
                editBtn.setAttribute('onclick', `editCustomSet('${trimmedName}', this)`);
                deleteBtn.setAttribute('onclick', `deleteCustomSet('${trimmedName}', this)`);
                content.setAttribute('onclick', `selectOption('entrySetDropdown', 'custom_set_${trimmedName}', '${trimmedName}', '💭')`);
                showAlert('✅ Estado Mental Actualizado', `El estado mental ha sido actualizado a "${trimmedName}".`);
            }

            function editCustomSetting(oldSettingName, buttonElement) {
                const newName = prompt('Editar entorno:', oldSettingName);
                if (!newName || newName.trim() === '') return;
                const trimmedName = newName.trim();
                if (trimmedName === oldSettingName) return;
                if (trimmedName.length > 25) {
                    showAlert('⚠️ Error', 'El nombre del entorno no puede exceder 25 caracteres.');
                    return;
                }
                if (customSettingExists(trimmedName)) {
                    showAlert('⚠️ Error', 'Ya existe un entorno con ese nombre.');
                    return;
                }
                let customSettings = JSON.parse(localStorage.getItem('psychologger_custom_settings') || '[]');
                const index = customSettings.indexOf(oldSettingName);
                if (index !== -1) {
                    customSettings[index] = trimmedName;
                    localStorage.setItem('psychologger_custom_settings', JSON.stringify(customSettings));
                    notifyBackupDataChanged();
                }
                const optionElement = buttonElement.closest('.dropdown-option.custom-unit');
                optionElement.setAttribute('data-value', `custom_setting_${trimmedName}`);
                optionElement.setAttribute('data-setting-name', trimmedName);
                optionElement.querySelector('.option-text').textContent = trimmedName;
                const editBtn = optionElement.querySelector('.edit-custom-unit-btn');
                const deleteBtn = optionElement.querySelector('.delete-custom-unit-btn');
                const content = optionElement.querySelector('.custom-unit-content');
                editBtn.setAttribute('onclick', `editCustomSetting('${trimmedName}', this)`);
                deleteBtn.setAttribute('onclick', `deleteCustomSetting('${trimmedName}', this)`);
                content.setAttribute('onclick', `selectOption('entrySettingDropdown', 'custom_setting_${trimmedName}', '${trimmedName}', '🌍')`);
                showAlert('✅ Entorno Actualizado', `El entorno ha sido actualizado a "${trimmedName}".`);
            }

            function deleteCustomSet(setName, buttonElement) {
                if (!confirm(`¿Estás seguro de que quieres eliminar el estado mental "${setName}"?`)) return;
                let customSets = JSON.parse(localStorage.getItem('psychologger_custom_sets') || '[]');
                const index = customSets.indexOf(setName);
                if (index !== -1) {
                    customSets.splice(index, 1);
                    localStorage.setItem('psychologger_custom_sets', JSON.stringify(customSets));
                    notifyBackupDataChanged();
                }
                buttonElement.closest('.dropdown-option.custom-unit').remove();
                showAlert('✅ Estado Mental Eliminado', `El estado mental "${setName}" ha sido eliminado correctamente.`);
            }

            function deleteCustomSetting(settingName, buttonElement) {
                if (!confirm(`¿Estás seguro de que quieres eliminar el entorno "${settingName}"?`)) return;
                let customSettings = JSON.parse(localStorage.getItem('psychologger_custom_settings') || '[]');
                const index = customSettings.indexOf(settingName);
                if (index !== -1) {
                    customSettings.splice(index, 1);
                    localStorage.setItem('psychologger_custom_settings', JSON.stringify(customSettings));
                    notifyBackupDataChanged();
                }
                buttonElement.closest('.dropdown-option.custom-unit').remove();
                showAlert('✅ Entorno Eliminado', `El entorno "${settingName}" ha sido eliminado correctamente.`);
            }

            function loadCustomSetsAndSettings() {
                const customSets = JSON.parse(localStorage.getItem('psychologger_custom_sets') || '[]');
                customSets.forEach(setName => {
                    if (!customSetExists(setName)) {
                        const newOption = createCustomSetOption(setName);
                        const inputContainer = document.querySelector('#entrySetOptions .custom-input-container[data-category="set"]');
                        if (inputContainer) {
                            inputContainer.parentNode.insertBefore(newOption, inputContainer);
                        }
                    }
                });

                const customSettings = JSON.parse(localStorage.getItem('psychologger_custom_settings') || '[]');
                customSettings.forEach(settingName => {
                    if (!customSettingExists(settingName)) {
                        const newOption = createCustomSettingOption(settingName);
                        const inputContainer = document.querySelector('#entrySettingOptions .custom-input-container[data-category="setting"]');
                        if (inputContainer) {
                            inputContainer.parentNode.insertBefore(newOption, inputContainer);
                        }
                    }
                });
            }

        </script>

    </main>

    <!-- Modal de Libros -->
    <div id="books-modal" class="books-modal hidden" role="dialog" aria-modal="true" aria-labelledby="books-title">
      <div class="modal__backdrop" onclick="closeBooksModal()"></div>

      <div class="modal__panel" role="document">
        <div class="modal__header">
          <div class="modal__title">
            <span class="modal__emoji">📚</span>
            <h3 id="books-title">Biblioteca Recomendada</h3>
          </div>
          <button class="modal__close" type="button" aria-label="Cerrar" onclick="closeBooksModal()">✕</button>
        </div>

        <p class="modal__subtitle">
          Bibliografía para comprender desde la ciencia, la historia y la reducción de riesgos.
        </p>

        <div class="books-grid">
          <article class="book">
            <h4 class="book__title">PiHKAL: A Chemical Love Story</h4>
            <p class="book__meta">👤 Alexander & Ann Shulgin</p>
            <p class="book__desc">Obra fundamental sobre feniletilaminas y experiencias psicodélicas.</p>
          </article>

          <article class="book">
            <h4 class="book__title">TiHKAL: The Continuation</h4>
            <p class="book__meta">👤 Alexander & Ann Shulgin</p>
            <p class="book__desc">Segunda parte dedicada a triptaminas y sus efectos.</p>
          </article>

          <article class="book">
            <h4 class="book__title">Food of the Gods</h4>
            <p class="book__meta">👤 Terence McKenna</p>
            <p class="book__desc">Plantas psicoactivas y evolución humana.</p>
          </article>

          <article class="book">
            <h4 class="book__title">Ketamina: el nuevo milagro médico</h4>
            <p class="book__meta">👤 Dr. Manuel Sánchez</p>
            <p class="book__desc">Tratamiento para depresión resistente.</p>
          </article>

          <article class="book">
            <h4 class="book__title">Guía del explorador psicodélico</h4>
            <p class="book__meta">👤 James Fadiman</p>
            <p class="book__desc">Viajes seguros y terapéuticos.</p>
          </article>

          <article class="book">
            <h4 class="book__title">No todas las drogas son iguales</h4>
            <p class="book__meta">👤 David Nutt</p>
            <p class="book__desc">Análisis científico objetivo sobre drogas y políticas.</p>
          </article>

          <article class="book">
            <h4 class="book__title">Pharmacotheon</h4>
            <p class="book__meta">👤 Jonathan Ott</p>
            <p class="book__desc">Drogas enteógenas, fuentes vegetales e historia.</p>
          </article>
        </div>

        <div class="modal__note">
          💡 Estos libros son recomendaciones educativas para comprender mejor el tema desde una perspectiva científica, objetiva y de conocimiento, y no como una incitación al consumo.
        </div>
      </div>
    </div>

    <!-- MODAL DE SELECCIÓN DE FECHA Y HORA -->
    <div class="modal" id="dateTimeModal">
        <div class="modal-content datetime-modal">
            <button class="close-btn" onclick="closeDateTimeModal()">×</button>
            <h3>Establecer fecha y hora</h3>

            <div class="datetime-picker-container">
                <!-- Selección de Fecha -->
                <div class="date-section">
                    <div class="date-display">
                        <div class="date-row">
                            <div class="date-field">
                                <label>Día</label>
                                <div class="custom-select-wrapper" data-select-id="daySelect">
                                    <select id="daySelect" class="date-select">
                                        <!-- Se llena dinámicamente -->
                                    </select>
                                    <button type="button" class="custom-select-trigger" aria-haspopup="listbox" aria-expanded="false">
                                        <span class="custom-select-value">--</span>
                                    </button>
                                    <div class="custom-select-dropdown" role="listbox" id="daySelectDropdown"></div>
                                </div>
                            </div>
                            <div class="date-field">
                                <label>Mes</label>
                                <div class="custom-select-wrapper" data-select-id="monthSelect">
                                    <select id="monthSelect" class="date-select">
                                        <!-- Se llena dinámicamente -->
                                    </select>
                                    <button type="button" class="custom-select-trigger" aria-haspopup="listbox" aria-expanded="false">
                                        <span class="custom-select-value">--</span>
                                    </button>
                                    <div class="custom-select-dropdown" role="listbox" id="monthSelectDropdown"></div>
                                </div>
                            </div>
                            <div class="date-field">
                                <label>Año</label>
                                <div class="custom-select-wrapper" data-select-id="yearSelect">
                                    <select id="yearSelect" class="date-select">
                                        <!-- Se llena dinámicamente -->
                                    </select>
                                    <button type="button" class="custom-select-trigger" aria-haspopup="listbox" aria-expanded="false">
                                        <span class="custom-select-value">--</span>
                                    </button>
                                    <div class="custom-select-dropdown" role="listbox" id="yearSelectDropdown"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Selección de Hora -->
                <div class="time-section">
                    <div class="time-display">
                        <div class="time-row">
                            <div class="time-field">
                                <label>Hora</label>
                                <div class="custom-select-wrapper" data-select-id="hourSelect">
                                    <select id="hourSelect" class="time-select">
                                        <!-- Se llena dinámicamente -->
                                    </select>
                                    <button type="button" class="custom-select-trigger" aria-haspopup="listbox" aria-expanded="false">
                                        <span class="custom-select-value">--</span>
                                    </button>
                                    <div class="custom-select-dropdown" role="listbox" id="hourSelectDropdown"></div>
                                </div>
                            </div>
                            <div class="time-separator">:</div>
                            <div class="time-field">
                                <label>Min</label>
                                <div class="custom-select-wrapper" data-select-id="minuteSelect">
                                    <select id="minuteSelect" class="time-select">
                                        <!-- Se llena dinámicamente -->
                                    </select>
                                    <button type="button" class="custom-select-trigger" aria-haspopup="listbox" aria-expanded="false">
                                        <span class="custom-select-value">--</span>
                                    </button>
                                    <div class="custom-select-dropdown" role="listbox" id="minuteSelectDropdown"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="datetime-actions">
                <button class="btn-primary" onclick="setDateTime()">ESTABLECER</button>
                <button class="btn-secondary" onclick="closeDateTimeModal()">CANCELAR</button>
                <button class="btn-danger" onclick="clearDateTime()">BORRAR</button>
            </div>
        </div>
    </div>

</body>
</html>
