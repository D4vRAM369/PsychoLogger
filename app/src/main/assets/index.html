<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bit√°cora Psicon√°utica</title>
    <style>
        :root {
            --primary-purple: #8B5CF6;
            --secondary-pink: #EC4899;
            --accent-cyan: #06B6D4;
            --accent-orange: #F97316;
            --dark-bg: #0F0F23;
            --darker-bg: #080813;
            --card-bg: #1A1A2E;
            --text-light: #E5E7EB;
            --text-muted: #9CA3AF;
            --border-color: rgba(139, 92, 246, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            background: var(--dark-bg);
            min-height: 100vh;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            color: var(--text-light);
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, var(--dark-bg) 0%, var(--darker-bg) 100%);
            z-index: -10;
        }

        .animated-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -5;
            opacity: 0.15;
            background:
                radial-gradient(circle at 25% 75%, var(--primary-purple) 0%, transparent 40%),
                radial-gradient(circle at 75% 25%, var(--secondary-pink) 0%, transparent 40%),
                radial-gradient(circle at 50% 50%, var(--accent-cyan) 0%, transparent 40%);
            animation: backgroundMove 20s ease-in-out infinite;
        }

        @keyframes backgroundMove {
            0%, 100% {
                transform: scale(1) rotate(0deg);
                opacity: 0.15;
            }
            50% {
                transform: scale(1.1) rotate(180deg);
                opacity: 0.25;
            }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 5;
            padding-top: 1.5rem;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 2rem 0;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .mystical-symbol {
            font-size: 3rem;
            opacity: 0.8;
            animation: symbolGlow 4s ease-in-out infinite alternate;
            user-select: none;
        }

        .mystical-symbol.left {
            color: var(--accent-cyan);
        }

        .mystical-symbol.right {
            color: var(--secondary-pink);
        }

        @keyframes symbolGlow {
            0% {
                opacity: 0.8;
                transform: scale(1);
                filter: drop-shadow(0 0 10px currentColor);
            }
            100% {
                opacity: 1;
                transform: scale(1.1);
                filter: drop-shadow(0 0 20px currentColor);
            }
        }

        .header-title {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-purple), var(--secondary-pink), var(--accent-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            animation: colorShift 3s ease-in-out infinite;
        }

        @keyframes colorShift {
            0%, 100% { filter: hue-rotate(0deg); }
            50% { filter: hue-rotate(90deg); }
        }

        .header p {
            color: var(--text-muted);
            font-size: 1.1rem;
        }

        .main-content {
            flex: 1;
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2rem;
            margin-bottom: 5rem;
        }

        .sidebar {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            height: fit-content;
            backdrop-filter: blur(10px);
        }

        .sidebar h3 {
            margin-bottom: 1rem;
            color: var(--primary-purple);
            font-size: 1.2rem;
        }

        .substance-list {
            list-style: none;
        }

        .substance-item {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: rgba(139, 92, 246, 0.1);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .substance-item:hover {
            background: rgba(139, 92, 246, 0.2);
            border-color: var(--primary-purple);
            transform: translateX(5px);
        }

        .substance-item.active {
            background: linear-gradient(135deg, var(--primary-purple), var(--secondary-pink));
            border-color: var(--accent-cyan);
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(139, 92, 246, 0.3);
        }

        .substance-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
        }

        .substance-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .substance-count {
            background: var(--accent-cyan);
            color: var(--dark-bg);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .delete-substance-btn {
            background: var(--secondary-pink);
            border: none;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            opacity: 0.7;
        }

        .delete-substance-btn:hover {
            opacity: 1;
            background: #dc2626;
            transform: scale(1.1);
        }

        .add-substance-btn {
            width: 100%;
            padding: 0.75rem;
            background: linear-gradient(135deg, var(--accent-orange), var(--secondary-pink));
            border: none;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 1rem;
        }

        .add-substance-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(249, 115, 22, 0.3);
        }

        .calendar-container {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 2rem;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .calendar-nav {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .nav-btn {
            background: var(--primary-purple);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-btn:hover {
            background: var(--secondary-pink);
            transform: scale(1.1);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: var(--border-color);
            border-radius: 12px;
            overflow: hidden;
        }

        .calendar-day {
            aspect-ratio: 1;
            background: var(--darker-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            font-weight: 500;
        }

        .calendar-day:hover {
            opacity: 0.8;
            transform: scale(1.05);
        }

        .calendar-day.has-entry {
            color: white;
            font-weight: 600;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }

        .calendar-day.has-entry.single-substance {
        /* Color s√≥lido para una sola sustancia */
        }

        .calendar-day.has-entry.multiple-substances {
        /* Gradiente para m√∫ltiples sustancias */
            position: relative;
        }

        .calendar-day.has-entry.multiple-substances::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: inherit;
            z-index: -1;
        }

        .substance-indicators {
            position: absolute;
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 2px;
        }

        .substance-dot {
            width: 4px;
            height: 4px;
            border-radius: 50%;
            box-shadow: 0 0 2px rgba(0,0,0,0.3);
        }

        .day-header {
            background: var(--primary-purple);
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border-top: 1px solid var(--border-color);
            padding: 1rem;
            backdrop-filter: blur(20px);
            z-index: 1000;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 0.5rem;
            border-radius: 12px;
            min-width: 70px;
        }

        .nav-item:hover {
            background: rgba(139, 92, 246, 0.1);
            transform: translateY(-2px);
        }

        .nav-item.active {
            background: linear-gradient(135deg, var(--primary-purple), var(--secondary-pink));
            color: white;
        }

        .nav-icon {
            width: 24px;
            height: 24px;
            margin-bottom: 0.25rem;
        }

        .nav-label {
            font-size: 0.7rem;
            font-weight: 500;
        }

        /* Modal fixes for Android */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            backdrop-filter: blur(5px);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .modal.active {
            display: flex;  /* CAMBIO: de block a flex */
            align-items: flex-start;  /* NUEVO */
            justify-content: center;  /* NUEVO */
            padding: 0.5rem;  /* NUEVO */
            overflow-y: auto;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 2rem;
            max-width: 500px;
            width: calc(100% - 2rem);
            margin: 2rem auto;
            min-height: auto;
            border: 1px solid var(--border-color);
            position: relative;
            animation: modalSlideIn 0.3s ease;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
        }

        /* Ensure modal content is centered on small screens */
        @media (max-height: 800px) {
            .modal-content {
                margin: 1rem auto;
            }
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.3s ease;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .close-btn:hover {
            color: var(--text-light);
            background: rgba(139, 92, 246, 0.1);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--primary-purple);
            font-weight: 600;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            background: var(--darker-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-light);
            font-size: 1rem;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-purple);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-purple), var(--secondary-pink));
            border: none;
            color: white;
            padding: 0.75rem 2rem;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 0.5rem;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(139, 92, 246, 0.3);
        }

        .btn-secondary {
            background: var(--accent-cyan);
            border: none;
            color: white;
            padding: 0.75rem 2rem;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 0.5rem;
        }

        .btn-secondary:hover {
            background: var(--accent-orange);
            transform: translateY(-2px);
        }

        .resources-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .resource-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            text-decoration: none;
            color: inherit;
            cursor: pointer;
        }

        .resource-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary-purple);
            box-shadow: 0 20px 40px rgba(139, 92, 246, 0.1);
        }

        .resource-card h4 {
            color: var(--accent-cyan);
            margin-bottom: 0.5rem;
        }

        .entry-item {
            background: var(--darker-bg);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border-color);
        }

        .entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .entry-substance {
            color: var(--primary-purple);
            font-weight: 600;
        }

        .entry-time {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .entry-dose {
            color: var(--accent-cyan);
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .entry-notes {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .color-picker-container {
            margin: 1rem 0;
        }

        .color-options {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .color-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .color-option:hover {
            transform: scale(1.1);
            border-color: var(--text-light);
        }

        .color-option.selected {
            border-color: var(--accent-cyan);
            transform: scale(1.2);
        }

        .color-option.selected::after {
            content: '‚úì';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            text-shadow: 0 0 3px rgba(0,0,0,0.8);
        }

        .profile-section {
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: var(--darker-bg);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .profile-section h4 {
            color: var(--accent-cyan);
            margin-bottom: 1rem;
        }

        .char-counter {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-align: right;
            margin-top: 0.5rem;
        }

        .file-input {
            display: none;
        }

        .file-label {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            background: var(--accent-orange);
            color: white;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            width: 100%;
            margin-bottom: 0.5rem;
        }

        .file-label:hover {
            background: var(--secondary-pink);
            transform: translateY(-2px);
        }

         .profile-card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            border: 1px solid var(--border-color);
            max-width: 400px;
            margin: 0 auto;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-purple), var(--secondary-pink));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            margin: 0 auto 1rem;
        }

        .social-share-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }

        .social-share-btn {
            padding: 0.75rem;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .twitter-btn {
            background: #1DA1F2;
            color: white;
        }

        .whatsapp-btn {
            background: #25D366;
            color: white;
        }

        .telegram-btn {
            background: #0088cc;
            color: white;
        }

        .reddit-btn {
            background: #FF4500;
            color: white;
        }

        .favorite-substance {
            background: var(--darker-bg);
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            border: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .remove-btn {
            background: var(--secondary-pink);
            border: none;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .btn-edit, .btn-delete {
            background: var(--accent-cyan);
            border: none;
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            margin-right: 0.5rem;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .btn-delete {
            background: var(--secondary-pink);
        }

        .btn-edit:hover {
            background: var(--accent-orange);
        }

        .btn-delete:hover {
            background: #dc2626;
            transform translateY(-1px);
        }

        .entry-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid var(--border-color);
        }

        .quote-item {
            background: var(--darker-bg);
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            border-left: 4px solid var(--accent-cyan);
            position: relative;
        }

        .quote-text {
            font-style: italic;
            margin-bottom: 0.5rem;
        }

        .quote-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .header h1 {
                font-size: 2rem;
            }

            .header-content {
                gap: 1rem;
            }

            .mystical-symbol {
                font-size: 2rem;
            }

            .calendar-container {
                padding: 1rem;
            }

            .nav-label {
                font-size: 0.6rem;
            }

            .nav-item {
                min-width: 60px;
            }

            .modal-content {
                margin: 1rem;
                width: calc(100% - 2rem);
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>
<div class="animated-bg"></div>

<div class="container">
    <header class="header">
        <div class="header-content">
            <div class="mystical-symbol left">üëÅÔ∏è</div>
            <div class="header-title">
                <h1>Bit√°cora Psicon√°utica</h1>
                <p>Tu compa√±ero de viaje para un consumo consciente y responsable</p>
            </div>
            <div class="mystical-symbol right">üóùÔ∏è</div>
        </div>
    </header>

    <main id="main-content" class="main-content">
        <!-- Calendar View (Default) -->
        <div id="calendar-view" class="view active">
            <div class="sidebar">
                <h3>Sustancias</h3>
                <ul id="substance-list" class="substance-list">
                    <!-- Se llenar√°n din√°micamente -->
                </ul>
                <button class="add-substance-btn" onclick="openModal('substanceModal')">
                    + A√±adir Sustancia
                </button>
            </div>

            <div class="calendar-container">
                <div class="calendar-header">
                    <h2 id="current-month">Enero 2025</h2>
                    <div class="calendar-nav">
                        <button class="nav-btn" onclick="previousMonth()">‚Äπ</button>
                        <button class="nav-btn" onclick="nextMonth()">‚Ä∫</button>
                    </div>
                </div>
                <div class="calendar-grid" id="calendar-grid">
                    <!-- Calendar will be generated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Stats View -->
        <div id="stats-view" class="view" style="display: none;">
            <div class="calendar-container">
                <h2>Estad√≠sticas y An√°lisis</h2>
                <div class="resources-grid" id="stats-content">
                    <!-- Se llenar√°n din√°micamente -->
                </div>
            </div>
        </div>

        <!-- Resources View -->
        <div id="resources-view" class="view" style="display: none;">
            <div class="calendar-container">
                <h2>Recursos y Harm Reduction</h2>
                <div class="resources-grid">
                    <div class="resource-card" onclick="openExternalURL('https://erowid.org')">
                        <h4>Erowid</h4>
                        <p>Base de datos completa sobre sustancias psicoactivas, experiencias y efectos</p>
                    </div>
                    <div class="resource-card" onclick="openExternalURL('https://tripsit.me')">
                        <h4>TripSit</h4>
                        <p>Informaci√≥n sobre interacciones, dosificaci√≥n y asistencia en tiempo real</p>
                    </div>
                    <div class="resource-card" onclick="openExternalURL('https://maps.org')">
                        <h4>MAPS</h4>
                        <p>Organizaci√≥n sin √°nimo de lucro que investiga los potenciales usos m√©dicos, legales y culturales de los psicod√©licos</p>
                    </div>
                    <div class="resource-card" onclick="openExternalURL('https://psychonautwiki.org')">
                        <h4>PsychonautWiki</h4>
                        <p>Enciclopedia cient√≠fica de sustancias psicoactivas y sus efectos</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data View -->
        <div id="data-view" class="view" style="display: none;">
            <div class="calendar-container">
                <h2>Gesti√≥n de Datos</h2>
                <div class="resources-grid">
                    <div class="resource-card">
                        <h4>Exportar Datos</h4>
                        <p>Descargar todos tus datos en formato CSV</p>
                        <button class="btn-primary" onclick="exportToCSV()">Exportar CSV</button>
                    </div>
                    <div class="resource-card">
                        <h4>Importar Datos</h4>
                        <p>Cargar datos desde un archivo CSV</p>
                        <input type="file" id="csvFileInput" class="file-input" accept=".csv, text/csv" onchange="importFromCSV(this)" multiple="false">
                        <label for="csvFileInput" class="file-label">Seleccionar CSV</label>
                    </div>
                    <div class="resource-card">
                        <h4>Limpiar Datos</h4>
                        <p>Eliminar todos los datos almacenados</p>
                        <button class="btn-secondary" onclick="clearAllData()">Limpiar Todo</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile View -->
        <div id="profile-view" class="view" style="display: none;">
            <div class="calendar-container">
                <h2>Mi Perfil Psicon√°utico</h2>

                <div class="profile-section">
                    <h4>Informaci√≥n Personal</h4>
                    <div class="form-group">
                        <label>Nickname</label>
                        <input type="text" id="userNickname" placeholder="Tu nombre de psicon√°uta...">
                    </div>
                    <button class="btn-primary" onclick="saveProfile()">Guardar Perfil</button>
                </div>

                <div class="profile-section">
                    <h4>Gestionar Perfil</h4>
                    <button class="btn-primary" onclick="openModal('favoritesModal')">Mis Sustancias Favoritas</button>
                    <button class="btn-primary" onclick="openModal('socialModal')">Redes Sociales</button>
                    <button class="btn-primary" onclick="openModal('quotesModal')">Frases Destacadas</button>
                    <button class="btn-secondary" onclick="openModal('shareProfileModal')">Compartir Perfil</button>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Bottom Navigation -->
<nav class="bottom-nav">
    <div class="nav-container">
        <div class="nav-item active" onclick="switchView('calendar')">
            <div class="nav-icon">üìÖ</div>
            <div class="nav-label">Calendario</div>
        </div>
        <div class="nav-item" onclick="openModal('entryModal')">
            <div class="nav-icon">‚ûï</div>
            <div class="nav-label">A√±adir</div>
        </div>
        <div class="nav-item" onclick="switchView('stats')">
            <div class="nav-icon">üìä</div>
            <div class="nav-label">Stats</div>
        </div>
        <div class="nav-item" onclick="switchView('resources')">
            <div class="nav-icon">üîó</div>
            <div class="nav-label">Recursos</div>
        </div>
        <div class="nav-item" onclick="switchView('data')">
            <div class="nav-icon">üíæ</div>
            <div class="nav-label">Datos</div>
        </div>
        <div class="nav-item" onclick="switchView('profile')">
            <div class="nav-icon">üë§</div>
            <div class="nav-label">Perfil</div>
        </div>
    </div>
</nav>

<!-- Add Entry Modal - VERSI√ìN 2.0 -->
<div id="entryModal" class="modal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeModal('entryModal')">√ó</button>
        <h3>Nuevo Registro</h3>
        <form id="entryForm">
            <div class="form-group">
                <label>Sustancia *</label>
                <select id="entrySubstance" required>
                    <option value="">Selecciona una sustancia...</option>
                    <!-- Se llenar√°n din√°micamente -->
                </select>
            </div>

            <div class="form-group">
                <label>Dosis *</label>
                <input type="number" id="entryDose" placeholder="100" step="0.01" min="0" required>
            </div>

            <div class="form-group">
                <label>Unidad *</label>
                <select id="entryUnit" required>
                    <!-- Unidades espec√≠ficas para psicod√©licos -->
                    <optgroup label="Psicod√©licos">
                        <option value="ug">Œºg (microgramos)</option>
                        <option value="mg">mg (miligramos)</option>
                        <option value="tripi">tripi completo</option>
                        <option value="medio-tripi">1/2 tripi</option>
                        <option value="cuarto-tripi">1/4 tripi</option>
                        <option value="octavo-tripi">1/8 tripi</option>
                    </optgroup>

                    <!-- Unidades para hongos -->
                    <optgroup label="Hongos/Plantas">
                        <option value="g">g (gramos)</option>
                        <option value="mg">mg (miligramos)</option>
                        <option value="seta">seta completa</option>
                        <option value="media-seta">1/2 seta</option>
                    </optgroup>

                    <!-- Unidades para estimulantes -->
                    <optgroup label="Estimulantes/MDMA">
                        <option value="mg">mg (miligramos)</option>
                        <option value="pastilla">pastilla completa</option>
                        <option value="media-pastilla">1/2 pastilla</option>
                        <option value="cuarto-pastilla">1/4 pastilla</option>
                        <option value="punto">punto/bomba</option>
                    </optgroup>

                    <!-- Unidades para polvo -->
                    <optgroup label="Polvo/Cristal">
                        <option value="mg">mg (miligramos)</option>
                        <option value="g">g (gramos)</option>
                        <option value="raya">raya/l√≠nea</option>
                        <option value="tirito">tirito</option>
                        <option value="bump">bump</option>
                        <option value="key">key bump</option>
                    </optgroup>

                    <!-- Unidades l√≠quidas -->
                    <optgroup label="L√≠quidos">
                        <option value="ml">ml (mililitros)</option>
                        <option value="gotas">gotas</option>
                        <option value="vial">vial</option>
                    </optgroup>

                    <!-- Otras -->
                    <optgroup label="Otras">
                        <option value="calada">calada</option>
                        <option value="inhalacion">inhalaci√≥n</option>
                        <option value="aplicacion">aplicaci√≥n</option>
                        <option value="dosis">dosis</option>
                    </optgroup>
                </select>
            </div>

            <div class="form-group">
                <label>Fecha y Hora *</label>
                <input type="datetime-local" id="entryDateTime" required>
            </div>

            <div class="form-group">
                <label>Set (Estado mental)</label>
                <select id="entrySet">
                    <option value="">Seleccionar...</option>
                    <option value="excelente">üòä Excelente</option>
                    <option value="bueno">üôÇ Bueno</option>
                    <option value="neutral">üòê Neutral</option>
                    <option value="ansioso">üò∞ Ansioso</option>
                    <option value="triste">üò¢ Triste</option>
                    <option value="estresado">üò§ Estresado</option>
                    <option value="emocionado">ü§© Emocionado</option>
                </select>
            </div>

            <div class="form-group">
                <label>Setting (Entorno)</label>
                <select id="entrySetting">
                    <option value="">Seleccionar...</option>
                    <option value="casa">üè† En casa</option>
                    <option value="naturaleza">üå≤ Naturaleza</option>
                    <option value="fiesta">üéâ Fiesta/Evento</option>
                    <option value="festival">üé™ Festival</option>
                    <option value="amigos">üë• Con amigos</option>
                    <option value="solo">üë§ Solo/a</option>
                    <option value="pareja">üíë En pareja</option>
                    <option value="club">üé≠ Club nocturno</option>
                    <option value="concierto">üéµ Concierto</option>
                    <option value="ceremonia">üïØÔ∏è Ceremonia</option>
                </select>
            </div>

            <div class="form-group">
                <label>Notas adicionales</label>
                <textarea id="entryNotes" placeholder="ROA (v√≠a de administraci√≥n), efectos esperados, compa√±√≠a, m√∫sica, etc..." rows="4"></textarea>
                <small style="color: var(--text-muted); font-size: 0.8rem;">
                    üí° Tip: Incluye ROA (oral, sublingual, nasal, etc.), testing, pureza estimada, etc.
                </small>
            </div>

            <button type="submit" class="btn-primary">üíæ Guardar Registro</button>
        </form>
    </div>
</div>

<!-- Add Substance Modal -->
<div id="substanceModal" class="modal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeModal('substanceModal')">√ó</button>
        <h3>A√±adir Nueva Sustancia</h3>
        <form id="substanceForm">
            <div class="form-group">
                <label>Nombre</label>
                <input type="text" id="substanceName" placeholder="LSD, MDMA, Psilocibina..." required>
            </div>
            <div class="color-picker-container">
                <label>Color Identificativo</label>
                <div class="color-options">
                    <div class="color-option" data-color="#8B5CF6" style="background: #8B5CF6"></div>
                    <div class="color-option" data-color="#EC4899" style="background: #EC4899"></div>
                    <div class="color-option" data-color="#06B6D4" style="background: #06B6D4"></div>
                    <div class="color-option" data-color="#F97316" style="background: #F97316"></div>
                    <div class="color-option" data-color="#10B981" style="background: #10B981"></div>
                    <div class="color-option" data-color="#F59E0B" style="background: #F59E0B"></div>
                    <div class="color-option" data-color="#EF4444" style="background: #EF4444"></div>
                    <div class="color-option" data-color="#8B5A2B" style="background: #8B5A2B"></div>
                    <div class="color-option" data-color="#6366F1" style="background: #6366F1"></div>
                    <div class="color-option" data-color="#84CC16" style="background: #84CC16"></div>
                    <div class="color-option" data-color="#F472B6" style="background: #F472B6"></div>
                    <div class="color-option" data-color="#14B8A6" style="background: #14B8A6"></div>
                </div>
            </div>
            <button type="submit" class="btn-primary">A√±adir Sustancia</button>
        </form>
    </div>
</div>

<!-- Favorites Modal -->
<div id="favoritesModal" class="modal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeModal('favoritesModal')">√ó</button>
        <h3>Mis Sustancias Favoritas</h3>
        <div class="form-group">
            <label>A√±adir a Favoritos</label>
            <select id="favoriteSubstanceSelect">
                <option value="">Selecciona una sustancia...</option>
            </select>
            <button class="btn-primary" onclick="addToFavorites()">A√±adir a Favoritos</button>
        </div>
        <div id="favoritesList">
            <!-- Se llenar√°n din√°micamente -->
        </div>
    </div>
</div>

<!-- Social Modal -->
<div id="socialModal" class="modal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeModal('socialModal')">√ó</button>
        <h3>Mis Redes Sociales</h3>
        <div class="form-group">
            <label>Twitter/X</label>
            <input type="text" id="socialTwitter" placeholder="@usuario">
        </div>
        <div class="form-group">
            <label>Instagram</label>
            <input type="text" id="socialInstagram" placeholder="@usuario">
        </div>
        <div class="form-group">
            <label>Reddit</label>
            <input type="text" id="socialReddit" placeholder="u/usuario">
        </div>
        <div class="form-group">
            <label>Telegram</label>
            <input type="text" id="socialTelegram" placeholder="@usuario">
        </div>
        <div class="form-group">
            <label>Discord</label>
            <input type="text" id="socialDiscord" placeholder="usuario#1234">
        </div>
        <button class="btn-primary" onclick="saveSocialLinks()">Guardar Enlaces</button>
    </div>
</div>

<!-- Quotes Modal -->
<div id="quotesModal" class="modal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeModal('quotesModal')">√ó</button>
        <h3>Frases Destacadas</h3>
        <div class="form-group">
            <label>Nueva Frase</label>
            <textarea id="newQuote" placeholder="Escribe una frase destacada de tus experiencias..." maxlength="160"></textarea>
            <div class="char-counter">
                <span id="charCount">0</span>/160
            </div>
            <button class="btn-primary" onclick="addQuote()">A√±adir Frase</button>
        </div>
        <div id="quotesList">
            <!-- Se llenar√°n din√°micamente -->
        </div>
    </div>
</div>

<!-- Share Profile Modal -->
<div id="shareProfileModal" class="modal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeModal('shareProfileModal')">√ó</button>
        <h3>Compartir Perfil</h3>
        <div class="profile-card" id="profileCard">
            <div class="profile-avatar">üßô‚Äç‚ôÇÔ∏è</div>
            <h4 id="profileCardName">Psicon√°uta An√≥nimo</h4>
            <p>Explorador de la conciencia</p>
            <div id="profileCardStats">
                <p><strong>Sustancias probadas:</strong> <span id="substanceCount">0</span></p>
                <p><strong>Registros totales:</strong> <span id="entryCount">0</span></p>
            </div>
        </div>
        <div class="social-share-grid">
            <button class="social-share-btn twitter-btn" onclick="shareToTwitter()">Twitter</button>
            <button class="social-share-btn whatsapp-btn" onclick="shareToWhatsApp()">WhatsApp</button>
            <button class="social-share-btn telegram-btn" onclick="shareToTelegram()">Telegram</button>
            <button class="social-share-btn reddit-btn" onclick="shareToReddit()">Reddit</button>
        </div>
    </div>
</div>

<script>
    // Global variables
    let currentDate = new Date();
    let substances = JSON.parse(localStorage.getItem('substances')) || getDefaultSubstances();
    let entries = JSON.parse(localStorage.getItem('entries') || '[]');
    let userProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
    let selectedSubstanceColor = '#8B5CF6';
    let selectedSubstanceFilter = null; // Nueva variable para filtro

    // Default substances
    function getDefaultSubstances() {
        return [
            {
                id: 1,
                name: 'LSD',
                color: '#8B5CF6',
                createdAt: new Date().toISOString()
            },
            {
                id: 2,
                name: 'Ketamina',
                color: '#06B6D4',
                createdAt: new Date().toISOString()
            },
            {
                id: 3,
                name: 'Opio',
                color: '#8B5A2B',
                createdAt: new Date().toISOString()
            }
        ];
    }

    // Initialize app
    document.addEventListener('DOMContentLoaded', function() {
        initializeApp();
        setupEventListeners();
    });

    function initializeApp() {
        // Save default substances if first time
        if (!localStorage.getItem('substances')) {
            localStorage.setItem('substances', JSON.stringify(substances));
        }

        generateCalendar();
        renderSubstanceList();
        renderStats();
        loadUserProfile();
        updateProfileCard();

        // Set current datetime for entry form
        const now = new Date();
        const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
        document.getElementById('entryDateTime').value = localDateTime;
    }

    function setupEventListeners() {
        // Entry form
        document.getElementById('entryForm').addEventListener('submit', function(e) {
            e.preventDefault();
            addEntry();
        });

        // Substance form
        document.getElementById('substanceForm').addEventListener('submit', function(e) {
            e.preventDefault();
            addSubstance();
        });

        // Color picker
        document.querySelectorAll('.color-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
                this.classList.add('selected');
                selectedSubstanceColor = this.dataset.color;
            });
        });

        // Quote character counter
        const quoteTextarea = document.getElementById('newQuote');
        if (quoteTextarea) {
            quoteTextarea.addEventListener('input', function() {
                document.getElementById('charCount').textContent = this.value.length;
            });
        }
    }

    // Navigation functions - VERSI√ìN SIMPLIFICADA Y ROBUSTA
    function switchView(viewName) {
        console.log('Switching to view:', viewName); // Debug

        // Hide all views
        document.querySelectorAll('.view').forEach(view => {
            view.style.display = 'none';
        });

        // Show selected view
        const targetView = document.getElementById(viewName + '-view');
        if (targetView) {
            targetView.style.display = 'grid';
        } else {
            console.error('View not found:', viewName + '-view');
            return;
        }

        // Update navigation - m√©todo m√°s directo
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
        });

        // Activar el item correcto basado en el viewName
        const navMapping = {
            'calendar': 0,
            'stats': 2,
            'resources': 3,
            'data': 4,
            'profile': 5
        };

        const navItems = document.querySelectorAll('.nav-item');
        const navIndex = navMapping[viewName];
        if (navItems[navIndex]) {
            navItems[navIndex].classList.add('active');
        }

        // Regenerate content for specific views
        if (viewName === 'stats') {
            renderStats();
        }
    }

    // Funci√≥n para manejar clicks en navegaci√≥n
    function handleNavClick(viewName, element) {
        // Quitar active de todos
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
        });

        // A√±adir active al elemento clickeado
        if (element) {
            element.classList.add('active');
        }

        // Cambiar vista
        switchView(viewName);
    }

    // Modal functions
    function openModal(modalId) {
        const modal = document.getElementById(modalId);
        modal.classList.add('active');
        document.body.style.overflow = 'hidden'; // Prevent background scrolling

        // Populate dropdowns when opening modals
        if (modalId === 'entryModal') {
            populateSubstanceDropdown();
        } else if (modalId === 'favoritesModal') {
            populateFavoriteDropdown();
            renderFavorites();
        } else if (modalId === 'quotesModal') {
            renderQuotes();
        } else if (modalId === 'socialModal') {
            loadSocialLinks();
        } else if (modalId === 'shareProfileModal') {
            updateProfileCard();
        }
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
        document.body.style.overflow = ''; // Restore background scrolling
    }

    // Calendar functions
    function generateCalendar() {
    const grid = document.getElementById('calendar-grid');
    const monthName = currentDate.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
    document.getElementById('current-month').textContent = monthName.charAt(0).toUpperCase() + monthName.slice(1);

    // Clear grid
    grid.innerHTML = '';

    // Add day headers
    const dayHeaders = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
    dayHeaders.forEach(day => {
        const dayElement = document.createElement('div');
        dayElement.className = 'calendar-day day-header';
        dayElement.textContent = day;
        grid.appendChild(dayElement);
    });

    // Get first day of month and number of days
    const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
    const startDate = new Date(firstDay);
    startDate.setDate(startDate.getDate() - firstDay.getDay());

    // Generate calendar days
    for (let i = 0; i < 42; i++) {
        const day = new Date(startDate);
        day.setDate(startDate.getDate() + i);

        const dayElement = document.createElement('div');
        dayElement.className = 'calendar-day';
        dayElement.textContent = day.getDate();

        // Check if day has entries
        let dayEntries = entries.filter(entry => {
            const entryDate = new Date(entry.date);
            return entryDate.toDateString() === day.toDateString();
        });

        // Apply substance filter if one selected
        if (selectedSubstanceFilter) {
            dayEntries = dayEntries.filter(entry => entry.substance === selectedSubstanceFilter);
        }

        if (dayEntries.length > 0) {
            dayElement.classList.add('has-entry');

            // Get unique substances for this day
            const uniqueSubstances = [...new Set(dayEntries.map(entry => entry.substance))];

            if (uniqueSubstances.length === 1) {
                // Single substance - use solid color
                const substance = substances.find(s => s.name === uniqueSubstances[0]);
                const color = substance ? substance.color : '#8B5CF6';
                dayElement.classList.add('single-substance');
                dayElement.style.background = color;
                dayElement.style.boxShadow = `0 0 10px ${color}50`;
            } else if (uniqueSubstances.length > 1) {
                // Multiple substances - create gradient
                const colors = uniqueSubstances.map(substanceName => {
                    const substance = substances.find(s => s.name === substanceName);
                    return substance ? substance.color : '#8B5CF6';
                });

                dayElement.classList.add('multiple-substances');

                if (colors.length === 2) {
                    dayElement.style.background = `linear-gradient(135deg, ${colors[0]} 0%, ${colors[1]} 100%)`;
                } else if (colors.length === 3) {
                    dayElement.style.background = `linear-gradient(135deg, ${colors[0]} 0%, ${colors[1]} 50%, ${colors[2]} 100%)`;
                } else {
                    // More than 3 colors - create a more complex gradient
                    const step = 100 / colors.length;
                    const gradientStops = colors.map((color, index) => `${color} ${index * step}%`).join(', ');
                    dayElement.style.background = `linear-gradient(135deg, ${gradientStops})`;
                }

                // Add subtle animation for multiple substances
                dayElement.style.animation = 'colorShift 3s ease-in-out infinite';
            }

            // Add substance indicators (small dots)
            const indicators = document.createElement('div');
            indicators.className = 'substance-indicators';

            uniqueSubstances.slice(0, 4).forEach(substanceName => {
                const substance = substances.find(s => s.name === substanceName);
                const dot = document.createElement('div');
                dot.className = 'substance-dot';
                dot.style.backgroundColor = substance ? substance.color : '#8B5CF6';
                dot.title = substanceName; // Tooltip
                indicators.appendChild(dot);
            });

            dayElement.appendChild(indicators);
        }

        // Dim days from other months
        if (day.getMonth() !== currentDate.getMonth()) {
            dayElement.style.opacity = '0.3';
        }

        // Add click event
        dayElement.addEventListener('click', () => showDayEntries(day));

        grid.appendChild(dayElement);
    }
}

    function previousMonth() {
        currentDate.setMonth(currentDate.getMonth() - 1);
        generateCalendar();
    }

    function nextMonth() {
        currentDate.setMonth(currentDate.getMonth() + 1);
        generateCalendar();
    }

    function showDayEntries(date) {
        let dayEntries = entries.filter(entry => {
            const entryDate = new Date(entry.date);
            return entryDate.toDateString() === date.toDateString();
        });

        // Apply substance filter if selected
        if (selectedSubstanceFilter) {
            dayEntries = dayEntries.filter(entry => entry.substance === selectedSubstanceFilter);
        }

        if (dayEntries.length === 0) {
            // ‚úÖ NUEVA FUNCIONALIDAD: Crear entrada para este d√≠a
            if (confirm('No hay registros para este d√≠a. ¬øQuieres a√±adir uno?')) {
                openModal('entryModal');
                //Pre-llenar fecha seleccionada
                const localDateTime = new Date(date.getTime() - date.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
                document.getElementById('entryDateTime').value = localDateTime;
            }
            return;
        }

        let content = `<h3>üìÖ Registros del ${date.toLocaleDateString('es-ES', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        })}</h3>`;

        if (selectedSubstanceFilter) {
            content += `<p style="color: var(--accent-cyan); margin-bottom: 1rem;">Filtrado por: ${selectedSubstanceFilter}</p>`;
        }

        dayEntries.forEach(entry => {
            const time = new Date(entry.date).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            const substance = substances.find(s => s.name === entry.substance);
            const substanceColor = substance ? substance.color : '#8B5CF6';

            content += `
                <div class="entry-item" style="border-left: 4px solid ${substanceColor};">
                    <div class="entry-header">
                        <span class="entry-substance">${entry.substance}</span>
                        <span class="entry-time">${time}</span>
                    </div>
                    <div class="entry-dose">üíä ${entry.dose} ${entry.unit}</div>
                    ${entry.set ? `<div class="entry-meta">üß† Set: ${entry.set}</div>` : ''}
                    ${entry.setting ? `<div class="entry-meta">üèûÔ∏è Setting: ${entry.setting}</div>` : ''}
                    ${entry.notes ? `<div class="entry-notes">üìù ${entry.notes}</div>` : ''}
                    <div class="entry-actions" style="margin-top: 0.5rem;">
                        <button onclick="editEntryFromDaySafe(${entry.id})" class="btn-edit">‚úèÔ∏è Editar</button>
                        <button onclick="deleteEntry(${entry.id})" class="btn-delete">üóëÔ∏è Eliminar</button>
                    </div>
                </div>
            `;
        });

        // Bot√≥n para a√±adir entrada r√°pida
        content += `
             <div style="margin-top: 1rem; text-align: center;">
                <button onclick="addNewEntryForDate('${date.toISOString()}')" class="btn-primary" style="padding: 0.5rem 1rem; font-size: 1rem;">
                    ‚ûï A√±adir Registro para este D√≠a
                </button>
            </div>
        `;

        // Create temporary modal
        const modal = document.createElement('div');
        modal.className = 'modal active';
        modal.innerHTML = `
            <div class="modal-content">
                <button class="close-btn" onclick="closeDayModalSafe()">√ó</button>
                ${content}
            </div>
        `;
        document.body.appendChild(modal);
        document.body.style.overflow = 'hidden';
    }

    // ‚úÖ NUEVA: Funci√≥n para a√±adir entrada en fecha espec√≠fica
    function addNewEntryForDate(dateString) {
        // Cerrar modal actual
        document.querySelectorAll('.modal').forEach(modal => modal.remove());
        document.body.style.overflow = '';

        // Abrir formulario con fecha preseleccionada
        openModal('entryModal');
        const localDateTime = new Date(dateString).toISOString().slice(0, 16);
        document.getElementById('entryDateTime').value = localDateTime;
    }

    // ‚úÖ NUEVA: Funci√≥n para editar una entrada
    function editEntry(entryId) {
        const entry = entries.find(e => e.id === entryId);
        if (!entry) {
            alert('Registro no encontrado');
            return;
        }

        // Cerrar modal actual
        document.querySelectorAll('.modal').forEach(modal => modal.remove());
        document.body.style.overflow = '';

        // Llenar formulario con los datos existentes
        populateSubstanceDropdown(); // Asegurarse de que el dropdown est√© actualizado

        setTimeout(() => {
            document.getElementById('entrySubstance').value = entry.substance;
            document.getElementById('entryDose').value = entry.dose;
            document.getElementById('entryUnit').value = entry.unit;
            document.getElementById('entryDateTime').value = entry.date;
            document.getElementById('entrySet').value = entry.set || '';
            document.getElementById('entrySetting').value = entry.setting || '';

            // Extraer notas sin Set/Setting
            let cleanNotes = entry.notes || '';
            if (entry.set) cleanNotes = cleanNotes.replace(`Set: ${entry.set}. `, '');
            if (entry.setting) cleanNotes = cleanNotes.replace(`Setting: ${entry.setting}. `, '');
            document.getElementById('entryNotes').value = cleanNotes;
        }, 100); // Esperar un poco para que el dropdown se llene

        // Abrir modal de entrada
        openModal('entryModal');

        // Cambiar el bot√≥n de guardar a "Actualizar Registro"
        const form = document.getElementById('entryForm');
        const submitButton = form.querySelector('button[type="submit"]');
        const originalText = submitButton.innerHTML;

        submitButton.innerHTML = '‚úÖ Actualizar Registro';
        submitButton.style.background = 'linear-gradient(135deg, var(--accent-orange), var(--secondary-pink))';

        // Crear nueva funci√≥n de submit
        const newSubmitHandler = (e) => {
            e.preventDefault();
            updateEntry(entryId, originalText);
        };

        // Remover listener anterior y a√±adir nuevo
        form.removeEventListener('submit', form.currentSubmitHandler || (() => {}));
        form.addEventListener('submit', newSubmitHandler);
        form.currentSubmitHandler = newSubmitHandler; // Guardar referencia para remover despu√©s
    }

    // ‚úÖ NUEVA: Funci√≥n para actualizar entrada
    function updateEntry(entryId, originalButtonText) {
        const entryIndex = entries.findIndex(e => e.id === entryId);
        if (entryIndex === -1) {
            alert('Entrada no encontrada');
            return;
        }

        const substance = document.getElementById('entrySubstance').value;
        const dose = parseFloat(document.getElementById('entryDose').value);
        const unit = document.getElementById('entryUnit').value;
        const dateTime = document.getElementById('entryDateTime').value;
        const set = document.getElementById('entrySet').value;
        const setting = document.getElementById('entrySetting').value;
        const notes = document.getElementById('entryNotes').value.trim();

        if (!substance || !dose || !unit || !dateTime) {
            alert('Por favor, completa todos los campos obligatorios');
            return;
        }

        if (dose <= 0) {
            alert('La dosis debe ser un n√∫mero positivo');
            return;
        }

        // Construir notas completas
        let fullNotes = '';
        if (set) fullNotes += `Set: ${set}. `;
        if (setting) fullNotes += `Setting: ${setting}. `;
        if (notes) fullNotes += notes;

        // Actualizar entrada
        entries[entryIndex] = {
            ...entries[entryIndex],
            substance: substance,
            dose: dose,
            unit: unit,
            date: dateTime,
            set: set,
            setting: setting,
            notes: fullNotes || null,
            updatedAt: new Date().toISOString()
        };

        localStorage.setItem('entries', JSON.stringify(entries));

        generateCalendar();
        renderSubstanceList();
        closeModal('entryModal');

        // Restaurar formulario normal
        resetEntryForm(originalButtonText);

        alert('‚úÖ Registro actualizado correctamente');
    }

    // ‚úÖ NUEVA: Funci√≥n para eliminar entrada
    function deleteEntry(entryId) {
        const entry = entries.find(e => e.id === entryId);
        if (!entry) {
            alert('Entrada no encontrada');
            return;
        }

        if (confirm(`¬øEst√°s seguro de que quieres eliminar este registro?\n\n${entry.substance} - ${entry.dose} ${entry.unit}`)) {
            entries = entries.filter(e => e.id !== entryId);
            localStorage.setItem('entries', JSON.stringify(entries));

            generateCalendar();
            renderSubstanceList();
            renderStats();

            // Cerrar modal
            document.querySelectorAll('.modal').forEach(modal => modal.remove());
            document.body.style.overflow = '';

            alert('üóëÔ∏è Registro eliminado correctamente');
        }
    }

    // ‚úÖ NUEVA: Restaurar formulario a modo normal
    function resetEntryForm(originalButtonText = 'üíæ Guardar Registro') {
        const form = document.getElementById('entryForm');
        const submitBtn = form.querySelector('button[type="submit"]');

        submitBtn.innerHTML = originalButtonText;
        submitBtn.style.background = 'linear-gradient(135deg, var(--primary-purple), var(--secondary-pink))';

        // Restaurar handler original
        form.removeEventListener('submit', form.currentSubmitHandler || (() => {}));

        const originalHandler = function(e) {
            e.preventDefault();
            addEntry();
        };

        form.addEventListener('submit', originalHandler);
        form.currentSubmitHandler = originalHandler;
    }

    // Substance functions
    function addSubstance() {
        const name = document.getElementById('substanceName').value.trim();

        if (!name) {
            alert('Por favor, introduce un nombre para la sustancia');
            return;
        }

        if (substances.find(s => s.name.toLowerCase() === name.toLowerCase())) {
            alert('Esta sustancia ya existe');
            return;
        }

        const substance = {
            id: Date.now(),
            name: name,
            color: selectedSubstanceColor,
            createdAt: new Date().toISOString()
        };

        substances.push(substance);
        localStorage.setItem('substances', JSON.stringify(substances));

        renderSubstanceList();
        closeModal('substanceModal');
        document.getElementById('substanceForm').reset();

        // Reset color selection
        document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
        selectedSubstanceColor = '#8B5CF6';
    }

    function renderSubstanceList() {
        const list = document.getElementById('substance-list');
        list.innerHTML = '';

        // Add "All substances" option first
        const allItem = document.createElement('li');
        allItem.className = 'substance-item';
        if (!selectedSubstanceFilter) {
            allItem.classList.add('active');
        }
        allItem.innerHTML = `
            <div class="substance-info">
                <span>üìã Todas las sustancias</span>
            </div>
            <div class="substance-actions">
                <span class="substance-count">${entries.length}</span>
            </div>
        `;
        allItem.querySelector('.substance-info').addEventListener('click', () => {
            filterBySubstance(null);
        });
        list.appendChild(allItem);

        substances.forEach(substance => {
            const count = entries.filter(entry => entry.substance === substance.name).length;

            const item = document.createElement('li');
            item.className = 'substance-item';

            // Add active class if this substance is selected
            if (selectedSubstanceFilter === substance.name) {
                item.classList.add('active');
            }

            item.innerHTML = `
                <div class="substance-info">
                    <span>${substance.name}</span>
                </div>
                <div class="substance-actions">
                    <span class="substance-count">${count}</span>
                    <button class="delete-substance-btn" onclick="deleteSubstance(${substance.id})" title="Eliminar sustancia">√ó</button>
                </div>
            `;
            item.style.borderLeft = `4px solid ${substance.color}`;
            item.style.backgroundColor = `${substance.color}15`; // Lighten color for background

            // Add click event for filtering (exclude the delete button)
            item.querySelector('.substance-info').addEventListener('click', () => {
                filterBySubstance(substance.name);
            });

            list.appendChild(item);
        });
    }

    function filterBySubstance(substanceName) {
        selectedSubstanceFilter = substanceName;
        // Update active state for substances
        document.querySelectorAll('.substance-item').forEach(item => {
            item.classList.remove('active');
        });

        if (substanceName === null) {
            //Mark "Todas las sustancias" as active
            document.querySelector('.substance-item:first-child').classList.add('active');
        } else {
            // Find and mark the specific substance as active
            document.querySelectorAll('.substance-item').forEach(item => {
               const substanceText = item.querySelector('.substance-info span').textContent;
                if (substanceText === substanceName) {
                    item.classList.add('active');
                }
            });
        }

        generateCalendar();
        renderSubstanceList();
        renderStats();
    }

    function deleteSubstance(substanceId) {
        const substance = substances.find(s => s.id === substanceId);
        if (!substance) return;

        const hasEntries = entries.some(entry => entry.substance === substance.name);

        let confirmMessage = `¬øEst√°s seguro de que quieres eliminar "${substance.name}"?`;
        if (hasEntries) {
            confirmMessage += '\n\n‚ö†Ô∏è Esta sustancia tiene registros asociados. Si la eliminas, tambi√©n se eliminar√°n todos sus registros.';
        }

        if (confirm(confirmMessage)) {
            // Remove substance
            substances = substances.filter(s => s.id !== substanceId);

            // Remove related entries if any
            if (hasEntries) {
                entries = entries.filter(entry => entry.substance !== substance.name);
                localStorage.setItem('entries', JSON.stringify(entries));
            }

            // Clear filter if we're filtering by this substance
            if (selectedSubstanceFilter === substance.name) {
                selectedSubstanceFilter = null;
            }

            localStorage.setItem('substances', JSON.stringify(substances));

            renderSubstanceList();
            generateCalendar();
            renderStats();

            alert(`"${substance.name}" ha sido eliminada${hasEntries ? ' junto con sus registros' : ''}.`);
        }
    }

    function populateSubstanceDropdown() {
        const select = document.getElementById('entrySubstance');
        select.innerHTML = '<option value="">Selecciona una sustancia...</option>';

        substances.forEach(substance => {
            const option = document.createElement('option');
            option.value = substance.name;
            option.textContent = substance.name;
            select.appendChild(option);
        });
    }

    // Entry functions - VERSI√ìN 2.0
    function addEntry() {
        const substance = document.getElementById('entrySubstance').value;
        const dose = parseFloat(document.getElementById('entryDose').value);
        const unit = document.getElementById('entryUnit').value; // ‚úÖ CORREGIDO: obtener valor real
        const dateTime = document.getElementById('entryDateTime').value;
        const set = document.getElementById('entrySet').value;
        const setting = document.getElementById('entrySetting').value;
        const notes = document.getElementById('entryNotes').value.trim();

        // Validaci√≥n mejorada
        if (!substance || !dose || !unit || !dateTime) {
            alert('Por favor, completa todos los campos obligatorios (marcados con *)');
            return;
        }

        if (dose <= 0) {
            alert('La dosis debe ser mayor que 0');
            return;
        }

        // Construir notas completas
        let fullNotes = '';
        if (set) fullNotes += `Set: ${set}. `;
        if (setting) fullNotes += `Setting: ${setting}. `;
        if (notes) fullNotes += notes;

        const entry = {
            id: Date.now(),
            substance: substance,
            dose: dose,
            unit: unit, // ‚úÖ CORREGIDO: se guarda la unidad correcta
            date: dateTime,
            set: set,
            setting: setting,
            notes: fullNotes || null,
            createdAt: new Date().toISOString()
        };

        // Debugging: mostrar qu√© se va a guardar
        console.log('Guardando entrada:', entry);

        entries.push(entry);
        localStorage.setItem('entries', JSON.stringify(entries));

        generateCalendar();
        renderSubstanceList();
        closeModal('entryModal');
        document.getElementById('entryForm').reset();

        // Reset datetime to current
        const now = new Date();
        const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
        document.getElementById('entryDateTime').value = localDateTime;

        // Mensaje de confirmaci√≥n
        alert(`‚úÖ Registro guardado: ${dose} ${unit} de ${substance}`);
    }

    // Stats functions
    function renderStats() {
        const statsContainer = document.getElementById('stats-content');

        if (entries.length === 0) {
            statsContainer.innerHTML = '<div class="resource-card"><h4>No hay datos</h4><p>A√±ade algunos registros para ver estad√≠sticas</p></div>';
            return;
        }

        const totalEntries = entries.length;
        const uniqueSubstances = [...new Set(entries.map(entry => entry.substance))];
        const averagePerMonth = (totalEntries / 12).toFixed(1);

        // Most used substance
        const substanceCount = {};
        entries.forEach(entry => {
            substanceCount[entry.substance] = (substanceCount[entry.substance] || 0) + 1;
        });
        const mostUsed = Object.keys(substanceCount).reduce((a, b) => substanceCount[a] > substanceCount[b] ? a : b);

        // Recent activity
        const lastWeek = new Date();
        lastWeek.setDate(lastWeek.getDate() - 7);
        const recentEntries = entries.filter(entry => new Date(entry.date) > lastWeek).length;

        statsContainer.innerHTML = `
            <div class="resource-card">
                <h4>Registros Totales</h4>
                <p style="font-size: 2rem; color: var(--accent-cyan); font-weight: bold;">${totalEntries}</p>
            </div>
            <div class="resource-card">
                <h4>Sustancias √önicas</h4>
                <p style="font-size: 2rem; color: var(--secondary-pink); font-weight: bold;">${uniqueSubstances.length}</p>
            </div>
            <div class="resource-card">
                <h4>M√°s Utilizada</h4>
                <p style="font-size: 1.5rem; color: var(--primary-purple); font-weight: bold;">${mostUsed}</p>
                <p>${substanceCount[mostUsed]} veces</p>
            </div>
            <div class="resource-card">
                <h4>Actividad Reciente</h4>
                <p style="font-size: 2rem; color: var(--accent-orange); font-weight: bold;">${recentEntries}</p>
                <p>√öltimos 7 d√≠as</p>
            </div>
            <div class="resource-card">
                <h4>Promedio Mensual</h4>
                <p style="font-size: 2rem; color: var(--accent-cyan); font-weight: bold;">${averagePerMonth}</p>
                <p>Registros por mes</p>
            </div>
        `;
    }

    // Profile functions
    function saveProfile() {
        const nickname = document.getElementById('userNickname').value.trim();

        userProfile.nickname = nickname || 'Psicon√°uta An√≥nimo';
        localStorage.setItem('userProfile', JSON.stringify(userProfile));

        updateProfileCard();
        alert('Perfil guardado correctamente');
    }

    function loadUserProfile() {
        if (userProfile.nickname) {
            document.getElementById('userNickname').value = userProfile.nickname;
        }
    }

    function updateProfileCard() {
        const nickname = userProfile.nickname || 'Psicon√°uta An√≥nimo';
        document.getElementById('profileCardName').textContent = nickname;
        document.getElementById('substanceCount').textContent = substances.length;
        document.getElementById('entryCount').textContent = entries.length;
    }

    // Favorites functions
    function populateFavoriteDropdown() {
        const select = document.getElementById('favoriteSubstanceSelect');
        select.innerHTML = '<option value="">Selecciona una sustancia...</option>';

        substances.forEach(substance => {
            const option = document.createElement('option');
            option.value = substance.name;
            option.textContent = substance.name;
            select.appendChild(option);
        });
    }

    function addToFavorites() {
        const substanceName = document.getElementById('favoriteSubstanceSelect').value;

        if (!substanceName) {
            alert('Selecciona una sustancia');
            return;
        }

        if (!userProfile.favorites) {
            userProfile.favorites = [];
        }

        if (userProfile.favorites.includes(substanceName)) {
            alert('Esta sustancia ya est√° en favoritos');
            return;
        }

        userProfile.favorites.push(substanceName);
        localStorage.setItem('userProfile', JSON.stringify(userProfile));
        renderFavorites();
        document.getElementById('favoriteSubstanceSelect').value = '';
    }

    function renderFavorites() {
        const container = document.getElementById('favoritesList');

        if (!userProfile.favorites || userProfile.favorites.length === 0) {
            container.innerHTML = '<p>No tienes sustancias favoritas a√∫n</p>';
            return;
        }

        container.innerHTML = '';
        userProfile.favorites.forEach(favorite => {
            const item = document.createElement('div');
            item.className = 'favorite-substance';
            item.innerHTML = `
                <span>${favorite}</span>
                <button class="remove-btn" onclick="removeFromFavorites('${favorite}')">√ó</button>
            `;
            container.appendChild(item);
        });
    }

    function removeFromFavorites(substanceName) {
        userProfile.favorites = userProfile.favorites.filter(fav => fav !== substanceName);
        localStorage.setItem('userProfile', JSON.stringify(userProfile));
        renderFavorites();
    }

    // Social functions
    function saveSocialLinks() {
        userProfile.social = {
            twitter: document.getElementById('socialTwitter').value.trim(),
            instagram: document.getElementById('socialInstagram').value.trim(),
            reddit: document.getElementById('socialReddit').value.trim(),
            telegram: document.getElementById('socialTelegram').value.trim(),
            discord: document.getElementById('socialDiscord').value.trim()
        };

        localStorage.setItem('userProfile', JSON.stringify(userProfile));
        alert('Enlaces sociales guardados');
    }

    function loadSocialLinks() {
        if (userProfile.social) {
            document.getElementById('socialTwitter').value = userProfile.social.twitter || '';
            document.getElementById('socialInstagram').value = userProfile.social.instagram || '';
            document.getElementById('socialReddit').value = userProfile.social.reddit || '';
            document.getElementById('socialTelegram').value = userProfile.social.telegram || '';
            document.getElementById('socialDiscord').value = userProfile.social.discord || '';
        }
    }

    // Quotes functions
    function addQuote() {
        const quoteText = document.getElementById('newQuote').value.trim();

        if (!quoteText) {
            alert('Escribe una frase');
            return;
        }

        if (quoteText.length > 160) {
            alert('La frase no puede tener m√°s de 160 caracteres');
            return;
        }

        if (!userProfile.quotes) {
            userProfile.quotes = [];
        }

        const quote = {
            id: Date.now(),
            text: quoteText,
            date: new Date().toISOString()
        };

        userProfile.quotes.push(quote);
        localStorage.setItem('userProfile', JSON.stringify(userProfile));
        renderQuotes();
        document.getElementById('newQuote').value = '';
        document.getElementById('charCount').textContent = '0';
    }

    function renderQuotes() {
        const container = document.getElementById('quotesList');

        if (!userProfile.quotes || userProfile.quotes.length === 0) {
            container.innerHTML = '<p>No tienes frases destacadas a√∫n</p>';
            return;
        }

        container.innerHTML = '';
        userProfile.quotes.forEach(quote => {
            const item = document.createElement('div');
            item.className = 'quote-item';
            item.innerHTML = `
                <div class="quote-text">"${quote.text}"</div>
                <div class="quote-actions">
                    <button class="remove-btn" onclick="removeQuote(${quote.id})">√ó</button>
                </div>
            `;
            container.appendChild(item);
        });
    }

    function removeQuote(quoteId) {
        userProfile.quotes = userProfile.quotes.filter(quote => quote.id !== quoteId);
        localStorage.setItem('userProfile', JSON.stringify(userProfile));
        renderQuotes();
    }

    // Share functions
    function shareToTwitter() {
        const text = `üßô‚Äç‚ôÇÔ∏è ${userProfile.nickname || 'Psicon√°uta An√≥nimo'} - Explorador de la conciencia\nüíä ${substances.length} sustancias exploradas\nüìä ${entries.length} experiencias documentadas\n\n#Psicon√°utica #ConsciousUse`;
        const url = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`;
        openExternalURL(url);
    }

    function shareToWhatsApp() {
        const text = `üßô‚Äç‚ôÇÔ∏è ${userProfile.nickname || 'Psicon√°uta An√≥nimo'} - Explorador de la conciencia\nüíä ${substances.length} sustancias exploradas\nüìä ${entries.length} experiencias documentadas`;
        const url = `https://wa.me/?text=${encodeURIComponent(text)}`;
        openExternalURL(url);
    }

    function shareToTelegram() {
        const text = `üßô‚Äç‚ôÇÔ∏è ${userProfile.nickname || 'Psicon√°uta An√≥nimo'} - Explorador de la conciencia\nüíä ${substances.length} sustancias exploradas\nüìä ${entries.length} experiencias documentadas`;
        const url = `https://t.me/share/url?text=${encodeURIComponent(text)}`;
        openExternalURL(url);
    }

    function shareToReddit() {
        const title = `Mi perfil psicon√°utico: ${userProfile.nickname || 'Psicon√°uta An√≥nimo'}`;
        const text = `Explorador de la conciencia con ${substances.length} sustancias exploradas y ${entries.length} experiencias documentadas`;
        const url = `https://reddit.com/submit?title=${encodeURIComponent(title)}&text=${encodeURIComponent(text)}`;
        openExternalURL(url);
    }

    function exportToCSV() {
    if (substances.length === 0 && entries.length === 0) {
        alert('No hay datos para exportar');
        return;
    }

    // Crear el contenido CSV
    const csvContent = [
        'SUSTANCIAS',
        'ID,Nombre,Color,Fecha_Creacion',
        ...substances.map(s => `${s.id},"${s.name}","${s.color}","${s.createdAt}"`),
        '',
        'REGISTROS',
        'ID,Sustancia,Dosis,Unidad,Fecha_Hora,Notas,Fecha_Creacion',
        ...entries.map(e => `${e.id},"${e.substance}",${e.dose},"${e.unit}","${e.date}","${e.notes || ''}","${e.createdAt}"`)
    ].join('\n');

    const fileName = `bitacora_psicon√°utica_${new Date().toISOString().split('T')[0]}.csv`;

    // M√©todo unificado que funciona en web y Android
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);

    alert('Archivo CSV exportado exitosamente');
}

    function importFromCSV(input) {
    const file = input.files[0];

    if (!file) {
        alert('No se seleccion√≥ ning√∫n archivo');
        return;
    }

    if (!file.name.toLowerCase().endsWith('.csv')) {
        alert('Por favor selecciona un archivo CSV v√°lido (.csv)');
        input.value = '';
        return;
    }

    // Mostrar opciones como en TrackerTung
    const userChoice = confirm(
        '¬øQu√© quieres hacer con los datos existentes?\n\n' +
        'OK = Reemplazar todos los datos existentes\n' +
        'Cancelar = Agregar solo datos nuevos (evitando duplicados)'
    );

    const reader = new FileReader();

    reader.onload = function(e) {
        try {
            const csv = e.target.result;
            const lines = csv.split('\n');

            let currentSection = '';
            let substancesImported = 0;
            let entriesImported = 0;

            // Si el usuario eligi√≥ reemplazar (OK), limpiar datos existentes
            if (userChoice) {
                substances = [];
                entries = [];
            }

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();

                if (line === 'SUSTANCIAS') {
                    currentSection = 'substances';
                    i++; // Skip header
                    continue;
                } else if (line === 'REGISTROS') {
                    currentSection = 'entries';
                    i++; // Skip header
                    continue;
                }

                if (!line) continue;

                const columns = parseCSVLine(line);

                if (currentSection === 'substances' && columns.length >= 4) {
                    const substance = {
                        id: parseInt(columns[0]) || Date.now() + Math.random(),
                        name: columns[1].replace(/"/g, ''),
                        color: columns[2].replace(/"/g, ''),
                        createdAt: columns[3].replace(/"/g, '')
                    };

                    // Si no est√° reemplazando, verificar duplicados
                    if (!userChoice) {
                        if (!substances.find(s => s.name.toLowerCase() === substance.name.toLowerCase())) {
                            substances.push(substance);
                            substancesImported++;
                        }
                    } else {
                        substances.push(substance);
                        substancesImported++;
                    }
                } else if (currentSection === 'entries' && columns.length >= 7) {
                    const entry = {
                        id: parseInt(columns[0]) || Date.now() + Math.random(),
                        substance: columns[1].replace(/"/g, ''),
                        dose: parseFloat(columns[2]),
                        unit: columns[3].replace(/"/g, ''),
                        date: columns[4].replace(/"/g, ''),
                        notes: columns[5].replace(/"/g, ''),
                        createdAt: columns[6].replace(/"/g, '')
                    };

                    entries.push(entry);
                    entriesImported++;
                }
            }

            // Guardar en localStorage
            localStorage.setItem('substances', JSON.stringify(substances));
            localStorage.setItem('entries', JSON.stringify(entries));

            // Actualizar interfaz
            renderSubstanceList();
            generateCalendar();
            renderStats();

            alert(`Importaci√≥n completada:\n${substancesImported} sustancias\n${entriesImported} registros\n\n${userChoice ? 'Datos reemplazados' : 'Datos agregados'}`);

        } catch (error) {
            console.error('Error al importar:', error);
            alert('Error al procesar el archivo CSV. Verifica el formato.');
        }
    };

    reader.onerror = function() {
        alert('Error al leer el archivo seleccionado');
    };

    reader.readAsText(file, 'UTF-8');
    input.value = ''; // Limpiar input
}

    function parseCSVLine(line) {
        const result = [];
        let current = '';
        let inQuotes = false;

        for (let i = 0; i < line.length; i++) {
            const char = line[i];

            if (char === '"') {
                inQuotes = !inQuotes;
            } else if (char === ',' && !inQuotes) {
                result.push(current);
                current = '';
            } else {
                current += char;
            }
        }

        result.push(current);
        return result;
    }

    function clearAllData() {
        if (confirm('¬øEst√°s seguro de que quieres eliminar todos los datos? Esta acci√≥n no se puede deshacer.')) {
            localStorage.removeItem('substances');
            localStorage.removeItem('entries');
            localStorage.removeItem('userProfile');

            substances = getDefaultSubstances();
            entries = [];
            userProfile = {};
            selectedSubstanceFilter = null;

            localStorage.setItem('substances', JSON.stringify(substances));

            renderSubstanceList();
            generateCalendar();
            renderStats();
            loadUserProfile();
            updateProfileCard();

            alert('Todos los datos han sido eliminados');
        }
    }

    function openExternalURL(url) {
    // M√©todo 1: Intent de Android (si est√° disponible)
    if (typeof Android !== 'undefined' && Android.openUrl) {
        Android.openUrl(url);
        return;
    }

    // M√©todo 2: Para Cordova/PhoneGap
    if (window.cordova && window.cordova.InAppBrowser) {
        window.cordova.InAppBrowser.open(url, '_system');
        return;
    }

    // M√©todo 3: Para Android WebView
    const link = document.createElement('a');
    link.href = url;
    link.target = '_blank';
    link.rel = 'noopener noreferrer';

    // Intentar activar el selector de aplicaciones de Android
    const clickEvent = new MouseEvent('click', {
        view: window,
        bubbles: true,
        cancelable: true
    });

    document.body.appendChild(link);
    link.dispatchEvent(clickEvent);
    document.body.removeChild(link);

    // M√©todo 4: Como √∫ltimo recurso
    setTimeout(() => {
        window.open(url, '_blank', 'noopener,noreferrer');
    }, 100);
}

    // Close modals when clicking outside
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('modal')) {
            e.target.classList.remove('active');
            document.body.style.overflow = '';
        }
    });

    // Initialize color picker
    document.addEventListener('DOMContentLoaded', function() {
        // Set default color selection
        setTimeout(() => {
            const firstColorOption = document.querySelector('.color-option');
            if (firstColorOption) {
                firstColorOption.classList.add('selected');
            }
        }, 100);
    });

    // Prevent modal close when clicking inside modal content
    document.addEventListener('click', function(e) {
        if (e.target.closest('.modal-content')) {
            e.stopPropagation();
        }
    });

    // A√ëADIR ESTAS 3 FUNCIONES NUEVAS AL FINAL DEL SCRIPT:

    function closeDayModalSafe() {
        const modals = document.querySelectorAll('.modal.active');
        modals.forEach(modal => {
            modal.classList.remove('active');
            modal.remove();
        });

       // Restaurar scroll
       document.body.style.overflow = '';

        // Restaurar navegaci√≥n
        setTimeout(() => {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            const calendarNav = document.querySelector('.nav-item[onclick*="calendar"]');
            if (calendarNav) {
                calendarNav.classList.add('active');
            }
        }, 100);

        console.log('Modal del d√≠a cerrado de forma segura'); // Para debug
    }

    function openAddEntryForDateSafe(date) {
        closeDayModalSafe();

        populateSubstanceDropdown();
        resetEntryForm();

        // Establecer fecha espec√≠fica
        const targetDate = new Date(date);
        const localDateTime = new Date(targetDate.getTime() - targetDate.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
        document.getElementById('entryDateTime').value = localDateTime;

        openModal('entryModal');
    }

    function editEntryFromDaySafe(entryId) {
    console.log('Editando entrada:', entryId); // Para debug

    // Cerrar modal del d√≠a
    closeDayModalSafe();

    // Buscar la entrada
    const entry = entries.find(e => e.id === entryId);
    if (!entry) {
        alert('Registro no encontrado');
        return;
    }

    console.log('Entrada encontrada:', entry); // Para debug

    setTimeout(() => {
        // Llenar formulario
        populateSubstanceDropdown();

        setTimeout(() => {
            document.getElementById('entrySubstance').value = entry.substance;
            document.getElementById('entryDose').value = entry.dose;
            document.getElementById('entryUnit').value = entry.unit;
            document.getElementById('entryDateTime').value = entry.date;
            document.getElementById('entrySet').value = entry.set || '';
            document.getElementById('entrySetting').value = entry.setting || '';

            // Limpiar notas
            let cleanNotes = entry.notes || '';
            if (entry.set) cleanNotes = cleanNotes.replace(`Set: ${entry.set}. `, '');
            if (entry.setting) cleanNotes = cleanNotes.replace(`Setting: ${entry.setting}. `, '');
            document.getElementById('entryNotes').value = cleanNotes;

            console.log('Formulario llenado'); // Para debug
        }, 100);

        // Abrir modal
        openModal('entryModal');

        console.log('Modal abierto'); // Para debug

    }, 200);
}

</script>

</body>
</html>